# 验签确认弹窗功能说明

## 功能概述

在教师课程管理页面中,当教师点击"验签"按钮时,系统会显示一个确认对话框,提醒教师验签功能的使用规则和注意事项,确保教师在充分了解的情况下开启验签流程。

## 实现位置

### 1. 验签确认对话框组件
- **文件路径**: `apps/agendaedu-app/src/components/VerificationConfirmDialog.tsx`
- **组件名称**: `VerificationConfirmDialog`
- **功能**: 显示验签确认对话框,包含完整的提示信息和确认/取消按钮

### 2. 集成位置
- **文件路径**: `apps/agendaedu-app/src/pages/AttendanceSheet.tsx`
- **触发位置**: 教师在课程管理页面点击"验签"按钮
- **显示时机**: 课程进行中(上课10分钟后到课程结束)

## 交互流程

```
1. 教师点击"验签"按钮
   ↓
2. 显示验签确认对话框
   ↓
3. 教师阅读提示信息
   ↓
4. 教师选择操作:
   - 点击【确认】→ 开启验签流程,创建验签窗口
   - 点击【取消】→ 关闭对话框,不执行验签操作
   ↓
5. 如果确认:
   - 调用后端API创建验签窗口
   - 显示成功/失败提示
   - 学生需在2分钟内再次签到
```

## 弹窗内容

### 标题
- **文字**: "验签确认"
- **图标**: 橙色警告图标(AlertCircle)

### 正文内容
```
注意: 本功能是用来课中(上课十分钟后到课程结束)验证学生是否旷课。

点【确认】后,学生需在2分钟内再次签到,未签到者视为旷课。

开启本功能前,请告知学生准备好,2分钟后签到自动结束。

点【取消】不开启验签。
```

### 按钮配置
- **取消按钮**: 
  - 文字: "取消"
  - 样式: 灰色边框按钮
  - 功能: 关闭对话框,不执行验签操作
  
- **确认按钮**: 
  - 文字: "确认" (加载中显示"开启中...")
  - 样式: 蓝色主按钮
  - 功能: 开启验签流程,调用后端API

## 技术实现

### 状态管理
```typescript
// 验签确认对话框状态
const [isVerificationDialogOpen, setIsVerificationDialogOpen] = useState(false);
```

### 核心函数

#### 1. 打开验签确认对话框
```typescript
const handleOpenVerificationDialog = () => {
  if (!teacherData || !canCreateWindow || isCreatingWindow) {
    return;
  }
  setIsVerificationDialogOpen(true);
};
```

#### 2. 关闭验签确认对话框
```typescript
const handleCloseVerificationDialog = () => {
  if (!isCreatingWindow) {
    setIsVerificationDialogOpen(false);
  }
};
```

#### 3. 确认创建验签窗口
```typescript
const handleConfirmCreateVerificationWindow = async () => {
  // 1. 验证条件
  // 2. 调用后端API创建验签窗口
  // 3. 更新本地状态
  // 4. 关闭确认对话框
  // 5. 显示成功/失败提示
};
```

### 组件使用
```tsx
<VerificationConfirmDialog
  isOpen={isVerificationDialogOpen}
  onClose={handleCloseVerificationDialog}
  onConfirm={handleConfirmCreateVerificationWindow}
  isSubmitting={isCreatingWindow}
/>
```

## UI/UX 设计

### 视觉设计
- **背景遮罩**: 半透明黑色背景(bg-black bg-opacity-50)
- **弹窗容器**: 白色圆角卡片,最大宽度 lg (max-w-lg)
- **提示区域**: 橙色背景(bg-orange-50),橙色边框(border-orange-200)
- **文字颜色**: 
  - 标题: 深灰色(text-gray-900)
  - 正文: 灰色(text-gray-700)
  - 强调文字: 橙色(text-orange-700/800)

### 交互设计
- **关闭方式**:
  - 点击背景遮罩
  - 点击右上角关闭按钮(X)
  - 点击取消按钮
- **禁用状态**: 创建验签窗口时,所有关闭操作被禁用
- **加载状态**: 确认按钮显示加载动画和"开启中..."文字

## 后端接口

### 创建验签窗口
- **接口路径**: `POST /api/icalink/v1/courses/:course_id/verification-window`
- **请求参数**:
  ```json
  {
    "duration_minutes": 2
  }
  ```
- **响应数据**:
  ```json
  {
    "success": true,
    "data": {
      "window_id": "vw_123_1_1234567890",
      "start_time": "2024-01-01T10:00:00Z",
      "end_time": "2024-01-01T10:02:00Z",
      "verification_round": 1
    }
  }
  ```

## 注意事项

1. **时间限制**: 只有在课程开始后10分钟至课程结束时间内才能创建验签窗口
2. **并发控制**: 同一课程同时只能有一个活跃的验签窗口
3. **用户体验**: 提示信息清晰明确,确保教师充分理解验签功能的影响
4. **错误处理**: 创建失败时显示友好的错误提示,引导教师重试

## 测试建议

### 功能测试
1. 验证弹窗正常显示和关闭
2. 验证确认按钮正确调用API
3. 验证取消按钮正确关闭弹窗
4. 验证加载状态正确显示
5. 验证成功/失败提示正确显示

### 边界测试
1. 验证在不满足条件时按钮被禁用
2. 验证在创建过程中无法关闭弹窗
3. 验证网络错误时的错误处理
4. 验证并发创建的处理

### UI测试
1. 验证弹窗在不同屏幕尺寸下的显示
2. 验证文字内容完整显示,支持换行
3. 验证按钮样式和交互效果
4. 验证无障碍访问(aria-label等)

