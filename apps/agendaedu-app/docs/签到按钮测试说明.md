# 签到按钮显示条件和测试说明

## 📋 签到按钮显示条件

### 1. 基础显示条件（按钮是否出现）
签到按钮只有在以下条件**全部满足**时才会显示：
- ✅ 未签到：`!attendance_status.is_checked_in`
- ✅ 未请假：`attendance_status.status !== 'leave'`
- ✅ 非请假审批中：`attendance_status.status !== 'leave_pending'`

### 2. 可点击条件（按钮是否可用）
在按钮显示的基础上，还需要满足以下条件才能点击：

#### 正常模式：
- ✅ 在签到时间窗口内：`isInCheckinWindow`
- ✅ 满足上述基础显示条件

#### 测试模式：
- ✅ 仅需满足基础显示条件（忽略时间窗口限制）

## ⏰ 时间窗口设置

### 当前配置（已优化）：
- **签到开始时间**：上课前10分钟
- **签到结束时间**：上课后10分钟
- **前后端一致性**：✅ 已同步

### 计算逻辑：
```javascript
// 上课前10分钟到上课后10分钟
const courseStartTime = new Date(course.course_start_time);
const checkinStartTime = new Date(courseStartTime.getTime() - 10 * 60 * 1000);
const checkinEndTime = new Date(courseStartTime.getTime() + 10 * 60 * 1000);
```

## 🧪 测试模式配置

### 开启测试模式：
在 `apps/agendaedu-app/src/pages/StudentDashboard.tsx` 文件中：
```javascript
const isTestMode = true; // 设置为 true 开启测试模式
```

### 关闭测试模式：
```javascript
const isTestMode = false; // 设置为 false 恢复正常模式
```

### 测试模式特性：
1. **忽略时间窗口限制**：任何时间都可以签到（只要满足基础条件）
2. **显示调试信息**：在未签到状态下显示详细的时间窗口信息
3. **按钮文字提示**：显示"签到 (测试模式)"
4. **实时状态显示**：显示当前是否在时间窗口内、是否可以签到等信息

## 🔍 调试信息说明

在测试模式下，未签到状态会显示以下调试信息：
- 🧪 **测试模式**：提示当前处于测试模式
- **签到窗口**：显示具体的签到时间范围
- **在窗口内**：显示当前时间是否在签到窗口内
- **可以签到**：显示当前是否满足签到条件

## 📱 测试场景

### 场景1：正常签到测试
1. 确保 `isTestMode = true`
2. 访问课程页面
3. 检查是否显示"签到 (测试模式)"按钮
4. 点击签到按钮进行测试

### 场景2：时间窗口测试
1. 设置 `isTestMode = false`
2. 在不同时间访问课程页面：
   - 上课前11分钟：应显示"不在签到时间"
   - 上课前10分钟：应显示"签到"
   - 上课后10分钟：应显示"签到"
   - 上课后11分钟：应显示"不在签到时间"

### 场景3：状态限制测试
1. 已签到状态：按钮不应显示
2. 请假状态：按钮不应显示
3. 请假审批中：按钮不应显示

## 🚀 部署前注意事项

**⚠️ 重要提醒**：在生产环境部署前，务必将测试模式关闭：
```javascript
const isTestMode = false; // 生产环境必须设置为 false
```

## 🔧 相关文件

- **前端签到逻辑**：`apps/agendaedu-app/src/pages/StudentDashboard.tsx`
- **后端签到服务**：`apps/app-icalink/src/services/AttendanceService.ts`
- **时间窗口配置**：`apps/app-icalink/database/002_insert_default_configs.sql`
- **数据库更新脚本**：`apps/app-icalink/database/005_update_attendance_time_windows.sql`
