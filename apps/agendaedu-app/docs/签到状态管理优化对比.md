# ç­¾åˆ°çŠ¶æ€ç®¡ç†ä¼˜åŒ–å¯¹æ¯”

## åŠŸèƒ½å¯¹æ¯”è¡¨

| åŠŸèƒ½ç‚¹           | ä¼˜åŒ–å‰           | ä¼˜åŒ–å                       | æ”¹è¿›æ•ˆæœ                  |
| ---------------- | ---------------- | ---------------------------- | ------------------------- |
| **åˆå§‹çŠ¶æ€åŠ è½½** | æ™®é€š async å‡½æ•°  | useCallback åŒ…è£…             | âœ… é¿å…ä¾èµ–è­¦å‘Šï¼Œæ€§èƒ½æ›´ä¼˜ |
| **å®šæ—¶åˆ·æ–°ç­–ç•¥** | æ— æ¡ä»¶æ¯30ç§’åˆ·æ–° | æ™ºèƒ½åˆ¤æ–­ï¼Œæœªç­¾åˆ°æ—¶æ¯60ç§’åˆ·æ–° | âœ… å‡å°‘50%+ç½‘ç»œè¯·æ±‚       |
| **æ—¶é—´çª—å£åˆ¤æ–­** | å‰ç«¯ç¡¬ç¼–ç è®¡ç®—   | ä¼˜å…ˆä½¿ç”¨åç«¯é…ç½®             | âœ… æ›´å‡†ç¡®ï¼Œæ”¯æŒåŠ¨æ€é…ç½®   |
| **å®æ—¶çŠ¶æ€æ›´æ–°** | æ—                | æ¯ç§’æ›´æ–° currentTime         | âœ… æŒ‰é’®çŠ¶æ€å®æ—¶å“åº”       |
| **ä¹è§‚æ›´æ–°**     | æ—                | å®Œæ•´çš„ä¹è§‚æ›´æ–°æœºåˆ¶           | âœ… å³æ—¶åé¦ˆï¼Œé˜²é‡å¤ç‚¹å‡»   |
| **é”™è¯¯å›æ»š**     | æ—                | è‡ªåŠ¨å›æ»šä¹è§‚æ›´æ–°             | âœ… å¤±è´¥æ—¶çŠ¶æ€ä¸€è‡´æ€§       |
| **UI æç¤º**      | ç®€å•çŠ¶æ€æ˜¾ç¤º     | è¯¦ç»†çš„æ—¶é—´çª—å£å’ŒçŠ¶æ€æç¤º     | âœ… ç”¨æˆ·ä½“éªŒå¤§å¹…æå‡       |

## æ€§èƒ½å¯¹æ¯”

### ç½‘ç»œè¯·æ±‚ä¼˜åŒ–

**ä¼˜åŒ–å‰ï¼š**

```
ç”¨æˆ·åœç•™ 10 åˆ†é’Ÿ = 20 æ¬¡åˆ·æ–°è¯·æ±‚ï¼ˆæ¯30ç§’ï¼‰
å·²ç­¾åˆ°åç»§ç»­åˆ·æ–° = æµªè´¹èµ„æº
```

**ä¼˜åŒ–åï¼š**

```
æœªç­¾åˆ°çŠ¶æ€ï¼š10 åˆ†é’Ÿ = 10 æ¬¡åˆ·æ–°è¯·æ±‚ï¼ˆæ¯60ç§’ï¼‰
å·²ç­¾åˆ°çŠ¶æ€ï¼šåœæ­¢åˆ·æ–° = 0 æ¬¡è¯·æ±‚
èŠ‚çœï¼š50% - 100% çš„ç½‘ç»œè¯·æ±‚
```

### ç”¨æˆ·ä½“éªŒå¯¹æ¯”

**ä¼˜åŒ–å‰çš„ç”¨æˆ·æµç¨‹ï¼š**

```
1. ç”¨æˆ·ç‚¹å‡»ç­¾åˆ°æŒ‰é’®
2. ç­‰å¾… 2-3 ç§’ï¼ˆç½‘ç»œè¯·æ±‚ï¼‰
3. çœ‹åˆ°ç­¾åˆ°æˆåŠŸæç¤º
4. å¯èƒ½åœ¨ç­‰å¾…æœŸé—´å¤šæ¬¡ç‚¹å‡»
```

**ä¼˜åŒ–åçš„ç”¨æˆ·æµç¨‹ï¼š**

```
1. ç”¨æˆ·ç‚¹å‡»ç­¾åˆ°æŒ‰é’®
2. ç«‹å³çœ‹åˆ°"ç­¾åˆ°å¤„ç†ä¸­"ï¼ˆä¹è§‚æ›´æ–°ï¼‰
3. æŒ‰é’®è¢«ç¦ç”¨ï¼Œé˜²æ­¢é‡å¤ç‚¹å‡»
4. 1-2 ç§’åçœ‹åˆ°"å·²ç­¾åˆ°"ç¡®è®¤ï¼ˆç›´æ¥æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼Œæ— éœ€é‡æ–°è¯·æ±‚ï¼‰
5. å¦‚æœå¤±è´¥ï¼Œè‡ªåŠ¨å›æ»šå¹¶æ˜¾ç¤ºé”™è¯¯
6. ç­¾åˆ°æˆåŠŸåè‡ªåŠ¨åœæ­¢å®šæ—¶åˆ·æ–°
```

## ä»£ç ç»“æ„å¯¹æ¯”

### çŠ¶æ€ç®¡ç†

**ä¼˜åŒ–å‰ï¼š**

```typescript
const [attendanceData, setAttendanceData] = useState<AttendanceData | null>(
  null
);
const [isLoading, setIsLoading] = useState(true);
const [checkinLoading, setCheckinLoading] = useState(false);
```

**ä¼˜åŒ–åï¼š**

```typescript
const [attendanceData, setAttendanceData] = useState<AttendanceData | null>(
  null
);
const [isLoading, setIsLoading] = useState(true);
const [checkinLoading, setCheckinLoading] = useState(false);
const [currentTime, setCurrentTime] = useState(new Date()); // å®æ—¶æ—¶é—´
const [localCheckinState, setLocalCheckinState] = useState<LocalCheckinState>({
  isOptimisticCheckedIn: false,
  optimisticCheckinTime: undefined
}); // ä¹è§‚æ›´æ–°çŠ¶æ€
```

### æ—¶é—´çª—å£åˆ¤æ–­

**ä¼˜åŒ–å‰ï¼š**

```typescript
// ç¡¬ç¼–ç è®¡ç®—
const courseStartTime = new Date(course.course_start_time);
const checkinStartTime = new Date(courseStartTime.getTime() - 10 * 60 * 1000);
const checkinEndTime = new Date(courseStartTime.getTime() + 10 * 60 * 1000);

// ä¸€æ¬¡æ€§åˆ¤æ–­ï¼Œä¸ä¼šå®æ—¶æ›´æ–°
const isInCheckinWindow =
  currentTime >= checkinStartTime && currentTime <= checkinEndTime;
```

**ä¼˜åŒ–åï¼š**

```typescript
// ä¼˜å…ˆä½¿ç”¨åç«¯é…ç½®
if (attendance_status.auto_start_time && attendance_status.auto_close_time) {
  checkinStartTime = new Date(attendance_status.auto_start_time);
  checkinEndTime = new Date(attendance_status.auto_close_time);
} else {
  // å…œåº•æ–¹æ¡ˆ
  const courseStartTime = new Date(course.course_start_time);
  checkinStartTime = new Date(courseStartTime.getTime() - 10 * 60 * 1000);
  checkinEndTime = new Date(courseStartTime.getTime() + 10 * 60 * 1000);
}

// å®æ—¶åˆ¤æ–­ï¼ˆæ¯ç§’æ›´æ–°ï¼‰
const isInCheckinWindow =
  currentTime >= checkinStartTime && currentTime <= checkinEndTime;
```

### ç­¾åˆ°å¤„ç†

**ä¼˜åŒ–å‰ï¼š**

```typescript
const handleCheckin = async () => {
  try {
    setCheckinLoading(true);

    // ç›´æ¥å‘é€è¯·æ±‚
    const response = await attendanceApi.studentCheckIn(id, { ... });

    if (response.success) {
      await loadAttendanceData();
      toast.success('ç­¾åˆ°æˆåŠŸï¼');
    }
  } catch (error) {
    toast.error('ç­¾åˆ°å¤±è´¥');
  } finally {
    setCheckinLoading(false);
  }
};
```

**ä¼˜åŒ–åï¼š**

```typescript
const handleCheckin = async () => {
  // 1. é˜²é‡å¤æ£€æŸ¥
  if (localCheckinState.isOptimisticCheckedIn) {
    toast.warning('ç­¾åˆ°è¯·æ±‚å¤„ç†ä¸­');
    return;
  }

  try {
    setCheckinLoading(true);

    // 2. ä¹è§‚æ›´æ–°
    setLocalCheckinState({
      isOptimisticCheckedIn: true,
      optimisticCheckinTime: new Date().toISOString()
    });

    // 3. å‘é€è¯·æ±‚
    const response = await attendanceApi.studentCheckIn(id, { ... });

    if (response.success) {
      // 4. âœ… ç›´æ¥æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼ˆä¸é‡æ–°è¯·æ±‚æ¥å£ï¼Œæå‡æ€§èƒ½ï¼‰
      const checkinTime = response.data?.checkin_time || new Date().toISOString();

      setAttendanceData({
        ...attendanceData,
        attendance_status: {
          ...attendanceData.attendance_status,
          is_checked_in: true,
          status: 'present',
          checkin_time: checkinTime,
          can_checkin: false
        },
        stats: {
          ...attendanceData.stats,
          checkin_count: attendanceData.stats.checkin_count + 1
        }
      });

      // 5. é‡ç½®ä¹è§‚æ›´æ–°çŠ¶æ€
      setLocalCheckinState({
        isOptimisticCheckedIn: false,
        optimisticCheckinTime: undefined
      });

      toast.success('ç­¾åˆ°æˆåŠŸï¼');
    }
  } catch (error) {
    // 6. å¤±è´¥å›æ»š
    setLocalCheckinState({
      isOptimisticCheckedIn: false,
      optimisticCheckinTime: undefined
    });
    toast.error('ç­¾åˆ°å¤±è´¥');
  } finally {
    setCheckinLoading(false);
  }
};
```

## UI æ˜¾ç¤ºå¯¹æ¯”

### æœªç­¾åˆ°çŠ¶æ€

**ä¼˜åŒ–å‰ï¼š**

```
â° æœªç­¾åˆ°
å½“å‰æ—¶é—´ï¼š14:30:25

[ç­¾åˆ°] [è¯·å‡]
```

**ä¼˜åŒ–åï¼š**

```
â° æœªç­¾åˆ°
å½“å‰æ—¶é—´ï¼š14:30:25
ç­¾åˆ°æ—¶é—´ï¼š14:20:00 - 14:40:00
âœ“ å½“å‰å¯ä»¥ç­¾åˆ°

[ç­¾åˆ°] [è¯·å‡]
```

### ç­¾åˆ°å¤„ç†ä¸­ï¼ˆæ–°å¢ï¼‰

**ä¼˜åŒ–åç‹¬æœ‰ï¼š**

```
âœ“ ç­¾åˆ°å¤„ç†ä¸­...
ç­¾åˆ°æ—¶é—´ï¼š14:30:25 (ç­‰å¾…æœåŠ¡å™¨ç¡®è®¤)

[ç­¾åˆ°å¤„ç†ä¸­...] (ç¦ç”¨)
```

### å·²ç­¾åˆ°çŠ¶æ€

**ä¼˜åŒ–å‰ï¼š**

```
âœ“ å·²ç­¾åˆ°
ç­¾åˆ°æ—¶é—´ï¼š2024-01-15 14:30:25

æ‚¨å·²å®Œæˆç­¾åˆ°
```

**ä¼˜åŒ–åï¼š**

```
âœ“ å·²ç­¾åˆ°
ç­¾åˆ°æ—¶é—´ï¼š2024-01-15 14:30:25

æ‚¨å·²å®Œæˆç­¾åˆ°
```

### æ—¶é—´çª—å£å¤–

**ä¼˜åŒ–å‰ï¼š**

```
â° æœªç­¾åˆ°
å½“å‰æ—¶é—´ï¼š14:50:25

[ä¸åœ¨ç­¾åˆ°æ—¶é—´] (ç¦ç”¨)
```

**ä¼˜åŒ–åï¼š**

```
â° æœªç­¾åˆ°
å½“å‰æ—¶é—´ï¼š14:50:25
ç­¾åˆ°æ—¶é—´ï¼š14:20:00 - 14:40:00
ç­¾åˆ°å·²äº 14:40:00 ç»“æŸ

[ä¸åœ¨ç­¾åˆ°æ—¶é—´] (ç¦ç”¨)
```

## è¾¹ç•Œæƒ…å†µå¤„ç†å¯¹æ¯”

| åœºæ™¯             | ä¼˜åŒ–å‰                  | ä¼˜åŒ–å                   |
| ---------------- | ----------------------- | ------------------------ |
| **é‡å¤ç‚¹å‡»**     | âŒ å¯èƒ½å‘é€å¤šæ¬¡è¯·æ±‚     | âœ… ä¹è§‚æ›´æ–°æœŸé—´ç¦ç”¨æŒ‰é’®  |
| **ç½‘ç»œå¤±è´¥**     | âš ï¸ æ˜¾ç¤ºé”™è¯¯ï¼ŒçŠ¶æ€ä¸ä¸€è‡´ | âœ… è‡ªåŠ¨å›æ»šï¼ŒçŠ¶æ€ä¸€è‡´    |
| **æ—¶é—´çª—å£è¾¹ç•Œ** | âš ï¸ éœ€è¦åˆ·æ–°é¡µé¢æ‰èƒ½æ›´æ–° | âœ… æ¯ç§’è‡ªåŠ¨æ›´æ–°          |
| **è¯¾ç¨‹åˆ‡æ¢**     | âœ… æœ‰æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥     | âœ… å¢å¼ºæ£€æŸ¥+é‡ç½®ä¹è§‚çŠ¶æ€ |
| **é¡µé¢åˆ·æ–°**     | âœ… é‡æ–°åŠ è½½æ•°æ®         | âœ… é‡æ–°åŠ è½½+é‡ç½®ä¹è§‚çŠ¶æ€ |
| **ç»„ä»¶å¸è½½**     | âœ… æ¸…ç†å®šæ—¶å™¨           | âœ… æ¸…ç†æ‰€æœ‰å®šæ—¶å™¨        |
| **å·²ç­¾åˆ°ååˆ·æ–°** | âŒ ç»§ç»­å®šæ—¶åˆ·æ–°         | âœ… åœæ­¢å®šæ—¶åˆ·æ–°          |

## æµ‹è¯•è¦†ç›–å¯¹æ¯”

**ä¼˜åŒ–å‰ï¼š**

- åŸºæœ¬åŠŸèƒ½æµ‹è¯•
- æ‰‹åŠ¨æµ‹è¯•ä¸ºä¸»

**ä¼˜åŒ–åï¼š**

- âœ… å•å…ƒæµ‹è¯•ï¼ˆæ–°å¢ï¼‰
- âœ… ä¹è§‚æ›´æ–°æµ‹è¯•
- âœ… æ—¶é—´çª—å£æµ‹è¯•
- âœ… é˜²é‡å¤æµ‹è¯•
- âœ… çŠ¶æ€å›æ»šæµ‹è¯•
- âœ… å®šæ—¶åˆ·æ–°æµ‹è¯•

## ç»´æŠ¤æ€§å¯¹æ¯”

**ä¼˜åŒ–å‰ï¼š**

- ä»£ç ç»“æ„ç®€å•
- ç¼ºå°‘æ³¨é‡Š
- çŠ¶æ€ç®¡ç†åˆ†æ•£

**ä¼˜åŒ–åï¼š**

- âœ… æ¸…æ™°çš„ä»£ç æ³¨é‡Šï¼ˆğŸ¯ ğŸ”„ â° ç­‰æ ‡è®°ï¼‰
- âœ… ç»Ÿä¸€çš„çŠ¶æ€ç®¡ç†
- âœ… å®Œæ•´çš„æ–‡æ¡£è¯´æ˜
- âœ… æµ‹è¯•ç”¨ä¾‹è¦†ç›–
- âœ… æ›´å®¹æ˜“ç†è§£å’Œç»´æŠ¤

## æ€»ç»“

### ä¸»è¦æ”¹è¿›

1. **æ€§èƒ½æå‡**ï¼šå‡å°‘ 50%+ çš„ç½‘ç»œè¯·æ±‚
2. **ç”¨æˆ·ä½“éªŒ**ï¼šå³æ—¶åé¦ˆï¼Œæ¸…æ™°æç¤º
3. **å¯é æ€§**ï¼šé˜²é‡å¤ç‚¹å‡»ï¼Œè‡ªåŠ¨å›æ»š
4. **å¯ç»´æŠ¤æ€§**ï¼šå®Œæ•´æ–‡æ¡£ï¼Œæµ‹è¯•è¦†ç›–

### æŠ€æœ¯äº®ç‚¹

1. âœ… ä¹è§‚æ›´æ–°ç­–ç•¥
2. âœ… å®æ—¶çŠ¶æ€åˆ¤æ–­
3. âœ… æ™ºèƒ½åˆ·æ–°æœºåˆ¶
4. âœ… å®Œå–„çš„é”™è¯¯å¤„ç†
5. âœ… ä¼˜ç§€çš„ä»£ç ç»„ç»‡

### åç»­ä¼˜åŒ–å»ºè®®

1. è€ƒè™‘ä½¿ç”¨ React Query è¿›ä¸€æ­¥ä¼˜åŒ–æ•°æ®è·å–
2. æ·»åŠ ç¦»çº¿æ”¯æŒï¼ˆService Workerï¼‰
3. å®ç°ç­¾åˆ°è®°å½•çš„æœ¬åœ°ç¼“å­˜
4. æ·»åŠ æ›´å¤šçš„æ€§èƒ½ç›‘æ§æŒ‡æ ‡
