# ç­¾åˆ°çŠ¶æ€ç®¡ç†å¿«é€Ÿå‚è€ƒ

## æ ¸å¿ƒæ¦‚å¿µ

### 1. ä¹è§‚æ›´æ–°ï¼ˆOptimistic Updateï¼‰

**ä»€ä¹ˆæ˜¯ä¹è§‚æ›´æ–°ï¼Ÿ**
åœ¨ç­‰å¾…æœåŠ¡å™¨å“åº”ä¹‹å‰ï¼Œå…ˆæ›´æ–°æœ¬åœ°UIçŠ¶æ€ï¼Œç»™ç”¨æˆ·å³æ—¶åé¦ˆã€‚

**å®ç°æ–¹å¼ï¼š**

```typescript
// å®šä¹‰ä¹è§‚æ›´æ–°çŠ¶æ€
interface LocalCheckinState {
  isOptimisticCheckedIn: boolean;
  optimisticCheckinTime?: string;
}

// ç‚¹å‡»ç­¾åˆ°æ—¶ç«‹å³æ›´æ–°
setLocalCheckinState({
  isOptimisticCheckedIn: true,
  optimisticCheckinTime: new Date().toISOString()
});

// å¤±è´¥æ—¶å›æ»š
setLocalCheckinState({
  isOptimisticCheckedIn: false,
  optimisticCheckinTime: undefined
});
```

### 2. æ™ºèƒ½åˆ·æ–°æœºåˆ¶

**åˆ·æ–°ç­–ç•¥ï¼š**

- âœ… æœªç­¾åˆ°çŠ¶æ€ï¼šæ¯60ç§’åˆ·æ–°ä¸€æ¬¡
- âœ… å·²ç­¾åˆ°çŠ¶æ€ï¼šåœæ­¢åˆ·æ–°
- âœ… å·²è¯·å‡çŠ¶æ€ï¼šåœæ­¢åˆ·æ–°

**å®ç°ä»£ç ï¼š**

```typescript
useEffect(() => {
  if (!id || !attendanceData) return;

  const { attendance_status } = attendanceData;

  // å·²ç­¾åˆ°æˆ–å·²è¯·å‡ï¼Œåœæ­¢åˆ·æ–°
  if (
    attendance_status.is_checked_in ||
    attendance_status.status === 'leave' ||
    attendance_status.status === 'leave_pending'
  ) {
    return;
  }

  // æœªç­¾åˆ°çŠ¶æ€ï¼Œæ¯60ç§’åˆ·æ–°
  const interval = setInterval(() => {
    loadAttendanceData();
  }, 60000);

  return () => clearInterval(interval);
}, [id, attendanceData, loadAttendanceData]);
```

### 3. å®æ—¶æ—¶é—´çª—å£åˆ¤æ–­

**æ—¶é—´çª—å£æ¥æºä¼˜å…ˆçº§ï¼š**

1. åç«¯è¿”å›çš„ `auto_start_time` å’Œ `auto_close_time`
2. å‰ç«¯è®¡ç®—ï¼ˆå…œåº•æ–¹æ¡ˆï¼‰

**å®ç°ä»£ç ï¼š**

```typescript
// ä¼˜å…ˆä½¿ç”¨åç«¯é…ç½®
if (attendance_status.auto_start_time && attendance_status.auto_close_time) {
  checkinStartTime = new Date(attendance_status.auto_start_time);
  checkinEndTime = new Date(attendance_status.auto_close_time);
} else {
  // å…œåº•ï¼šå‰ç«¯è®¡ç®—
  const courseStartTime = new Date(course.course_start_time);
  checkinStartTime = new Date(courseStartTime.getTime() - 10 * 60 * 1000);
  checkinEndTime = new Date(courseStartTime.getTime() + 10 * 60 * 1000);
}

// å®æ—¶åˆ¤æ–­ï¼ˆé…åˆæ¯ç§’æ›´æ–°çš„ currentTimeï¼‰
const isInCheckinWindow =
  currentTime >= checkinStartTime && currentTime <= checkinEndTime;
```

## å…³é”®çŠ¶æ€å˜é‡

### æœåŠ¡å™¨çŠ¶æ€

```typescript
attendance_status: {
  is_checked_in: boolean;           // æœåŠ¡å™¨ç¡®è®¤çš„ç­¾åˆ°çŠ¶æ€
  status?: string;                  // è€ƒå‹¤çŠ¶æ€
  checkin_time?: string;            // æœåŠ¡å™¨ç¡®è®¤çš„ç­¾åˆ°æ—¶é—´
  can_checkin: boolean;             // æ˜¯å¦å¯ä»¥ç­¾åˆ°
  can_leave: boolean;               // æ˜¯å¦å¯ä»¥è¯·å‡
  auto_start_time: string;          // ç­¾åˆ°å¼€å§‹æ—¶é—´
  auto_close_time: string;          // ç­¾åˆ°ç»“æŸæ—¶é—´
}
```

### æœ¬åœ°çŠ¶æ€

```typescript
localCheckinState: {
  isOptimisticCheckedIn: boolean;   // ä¹è§‚æ›´æ–°çš„ç­¾åˆ°çŠ¶æ€
  optimisticCheckinTime?: string;   // ä¹è§‚æ›´æ–°çš„ç­¾åˆ°æ—¶é—´
}
```

### ç»¼åˆçŠ¶æ€

```typescript
// ç»¼åˆåˆ¤æ–­ï¼ˆæœåŠ¡å™¨çŠ¶æ€ + ä¹è§‚æ›´æ–°ï¼‰
const effectiveIsCheckedIn =
  attendance_status.is_checked_in || localCheckinState.isOptimisticCheckedIn;

const effectiveCheckinTime =
  attendance_status.checkin_time || localCheckinState.optimisticCheckinTime;
```

## ç­¾åˆ°æµç¨‹å›¾

```
ç”¨æˆ·ç‚¹å‡»ç­¾åˆ°
    â†“
æ£€æŸ¥ä¹è§‚æ›´æ–°çŠ¶æ€
    â†“
[æ˜¯] â†’ æ˜¾ç¤º"å¤„ç†ä¸­"æç¤º â†’ ç»“æŸ
    â†“
[å¦] â†’ ç»§ç»­
    â†“
è®¾ç½®ä¹è§‚æ›´æ–°çŠ¶æ€
    â†“
UIç«‹å³æ˜¾ç¤º"ç­¾åˆ°å¤„ç†ä¸­"
    â†“
è·å–ä½ç½®ä¿¡æ¯
    â†“
éªŒè¯ä½ç½®
    â†“
[å¤±è´¥] â†’ å›æ»šä¹è§‚æ›´æ–° â†’ æ˜¾ç¤ºé”™è¯¯ â†’ ç»“æŸ
    â†“
[æˆåŠŸ] â†’ å‘é€ç­¾åˆ°è¯·æ±‚
    â†“
[å¤±è´¥] â†’ å›æ»šä¹è§‚æ›´æ–° â†’ æ˜¾ç¤ºé”™è¯¯ â†’ ç»“æŸ
    â†“
[æˆåŠŸ] â†’ ç›´æ¥æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼ˆä¸é‡æ–°è¯·æ±‚æ¥å£ï¼‰
    â†“
é‡ç½®ä¹è§‚æ›´æ–°çŠ¶æ€
    â†“
æ˜¾ç¤º"ç­¾åˆ°æˆåŠŸ"
    â†“
è‡ªåŠ¨åœæ­¢å®šæ—¶åˆ·æ–°ï¼ˆå·²ç­¾åˆ°çŠ¶æ€ï¼‰
    â†“
ç»“æŸ
```

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆéœ€è¦ä¹è§‚æ›´æ–°ï¼Ÿ

**A:** æä¾›å³æ—¶åé¦ˆï¼Œæ”¹å–„ç”¨æˆ·ä½“éªŒã€‚ç”¨æˆ·ç‚¹å‡»åç«‹å³çœ‹åˆ°åé¦ˆï¼Œè€Œä¸æ˜¯ç­‰å¾…2-3ç§’çš„ç½‘ç»œè¯·æ±‚ã€‚

### Q2: ä¹è§‚æ›´æ–°å¤±è´¥äº†æ€ä¹ˆåŠï¼Ÿ

**A:** è‡ªåŠ¨å›æ»šåˆ°ä¹‹å‰çš„çŠ¶æ€ï¼Œå¹¶æ˜¾ç¤ºé”™è¯¯æç¤ºã€‚ç”¨æˆ·å¯ä»¥é‡æ–°å°è¯•ç­¾åˆ°ã€‚

### Q3: ä¸ºä»€ä¹ˆå·²ç­¾åˆ°åè¦åœæ­¢åˆ·æ–°ï¼Ÿ

**A:** å·²ç­¾åˆ°çŠ¶æ€ä¸ä¼šæ”¹å˜ï¼Œç»§ç»­åˆ·æ–°æµªè´¹ç½‘ç»œèµ„æºå’ŒæœåŠ¡å™¨èµ„æºã€‚

### Q4: æ—¶é—´çª—å£åˆ¤æ–­ä¸ºä»€ä¹ˆè¦å®æ—¶æ›´æ–°ï¼Ÿ

**A:** ç”¨æˆ·å¯èƒ½é•¿æ—¶é—´åœç•™åœ¨é¡µé¢ï¼Œæ—¶é—´çª—å£ä¼šå‘ç”Ÿå˜åŒ–ã€‚å®æ—¶æ›´æ–°ç¡®ä¿æŒ‰é’®çŠ¶æ€å‡†ç¡®ã€‚

### Q5: å¦‚ä½•é˜²æ­¢é‡å¤ç­¾åˆ°ï¼Ÿ

**A:** ä¸‰é‡ä¿æŠ¤ï¼š

1. ä¹è§‚æ›´æ–°æœŸé—´ç¦ç”¨æŒ‰é’®
2. sessionStorage è®°å½•æœ€åç­¾åˆ°æ—¶é—´ï¼ˆ5ç§’å†…ä¸å…è®¸é‡å¤ï¼‰
3. æœåŠ¡å™¨ç«¯éªŒè¯

## è°ƒè¯•æŠ€å·§

### 1. æŸ¥çœ‹ä¹è§‚æ›´æ–°çŠ¶æ€

åœ¨æµè§ˆå™¨æ§åˆ¶å°ï¼š

```javascript
// æŸ¥çœ‹å½“å‰ç»„ä»¶çŠ¶æ€ï¼ˆéœ€è¦ React DevToolsï¼‰
// æ‰¾åˆ° StudentDashboardContent ç»„ä»¶
// æŸ¥çœ‹ localCheckinState çš„å€¼
```

### 2. æµ‹è¯•æ—¶é—´çª—å£

ä¿®æ”¹æµ‹è¯•æ¨¡å¼ï¼š

```typescript
const isTestMode = true; // å¼€å¯æµ‹è¯•æ¨¡å¼
```

æµ‹è¯•æ¨¡å¼ä¼šæ˜¾ç¤ºè¯¦ç»†çš„æ—¶é—´çª—å£ä¿¡æ¯ã€‚

### 3. æ¨¡æ‹Ÿç½‘ç»œå»¶è¿Ÿ

åœ¨æµè§ˆå™¨å¼€å‘è€…å·¥å…·ä¸­ï¼š

1. æ‰“å¼€ Network æ ‡ç­¾
2. é€‰æ‹© "Slow 3G" æˆ–è‡ªå®šä¹‰ç½‘ç»œé€Ÿåº¦
3. æµ‹è¯•ä¹è§‚æ›´æ–°æ•ˆæœ

### 4. æŸ¥çœ‹åˆ·æ–°æ—¥å¿—

åœ¨æ§åˆ¶å°æŸ¥çœ‹ï¼š

```
ğŸ” åŠ è½½ç­¾åˆ°æ•°æ®...
ğŸ”„ è‡ªåŠ¨åˆ·æ–°ç­¾åˆ°çŠ¶æ€ï¼ˆæœªç­¾åˆ°çŠ¶æ€ï¼‰...
âœ… å·²ç­¾åˆ°æˆ–å·²è¯·å‡ï¼Œåœæ­¢å®šæ—¶åˆ·æ–°
```

## æ€§èƒ½ç›‘æ§

### å…³é”®æŒ‡æ ‡

1. **ç½‘ç»œè¯·æ±‚æ¬¡æ•°**
   - æœªç­¾åˆ°çŠ¶æ€ï¼š10åˆ†é’Ÿ â‰ˆ 10æ¬¡
   - å·²ç­¾åˆ°çŠ¶æ€ï¼š10åˆ†é’Ÿ = 0æ¬¡

2. **ç”¨æˆ·æ“ä½œå“åº”æ—¶é—´**
   - ç‚¹å‡»ç­¾åˆ° â†’ æ˜¾ç¤º"å¤„ç†ä¸­"ï¼š< 100ms
   - ç­¾åˆ°æˆåŠŸ â†’ æ˜¾ç¤º"å·²ç­¾åˆ°"ï¼š1-3ç§’

3. **å†…å­˜ä½¿ç”¨**
   - å®šæ—¶å™¨æ­£ç¡®æ¸…ç†
   - æ— å†…å­˜æ³„æ¼

### ç›‘æ§ä»£ç ç¤ºä¾‹

```typescript
// åœ¨ useEffect ä¸­æ·»åŠ æ—¥å¿—
useEffect(() => {
  console.log('ğŸ”„ åˆ·æ–°å®šæ—¶å™¨å¯åŠ¨', {
    isCheckedIn: attendance_status.is_checked_in,
    status: attendance_status.status,
    willRefresh:
      !attendance_status.is_checked_in &&
      attendance_status.status !== 'leave' &&
      attendance_status.status !== 'leave_pending'
  });
}, [id, attendanceData, loadAttendanceData]);
```

## æœ€ä½³å®è·µ

### âœ… DO

1. ä½¿ç”¨ä¹è§‚æ›´æ–°æä¾›å³æ—¶åé¦ˆ
2. å¤±è´¥æ—¶ç«‹å³å›æ»šçŠ¶æ€
3. å·²ç­¾åˆ°ååœæ­¢å®šæ—¶åˆ·æ–°
4. ä½¿ç”¨åç«¯è¿”å›çš„æ—¶é—´çª—å£é…ç½®
5. æ·»åŠ è¯¦ç»†çš„ç”¨æˆ·æç¤ºä¿¡æ¯

### âŒ DON'T

1. ä¸è¦åœ¨ä¹è§‚æ›´æ–°æœŸé—´å…è®¸é‡å¤æ“ä½œ
2. ä¸è¦å¿˜è®°æ¸…ç†å®šæ—¶å™¨
3. ä¸è¦ç¡¬ç¼–ç æ—¶é—´çª—å£é…ç½®
4. ä¸è¦åœ¨å·²ç­¾åˆ°çŠ¶æ€ä¸‹ç»§ç»­åˆ·æ–°
5. ä¸è¦å¿½ç•¥é”™è¯¯å¤„ç†

## ä»£ç æ³¨é‡Šçº¦å®š

æœ¬é¡¹ç›®ä½¿ç”¨ emoji æ ‡è®°é‡è¦ä»£ç æ®µï¼š

- ğŸ¯ æ ¸å¿ƒåŠŸèƒ½ç‚¹
- ğŸ”„ çŠ¶æ€æ›´æ–°/å›æ»š
- â° æ—¶é—´ç›¸å…³é€»è¾‘
- ğŸ”’ å®‰å…¨æ£€æŸ¥/éªŒè¯
- âœ… æˆåŠŸå¤„ç†
- âŒ é”™è¯¯å¤„ç†

ç¤ºä¾‹ï¼š

```typescript
// ğŸ¯ ä¹è§‚æ›´æ–°ï¼šç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼Œæä¾›å³æ—¶åé¦ˆ
setLocalCheckinState({
  isOptimisticCheckedIn: true,
  optimisticCheckinTime: new Date().toISOString()
});
```

## ç›¸å…³æ–‡æ¡£

- [ç­¾åˆ°çŠ¶æ€ç®¡ç†ä¼˜åŒ–è¯´æ˜.md](./ç­¾åˆ°çŠ¶æ€ç®¡ç†ä¼˜åŒ–è¯´æ˜.md) - è¯¦ç»†çš„ä¼˜åŒ–è¯´æ˜
- [ç­¾åˆ°çŠ¶æ€ç®¡ç†ä¼˜åŒ–å¯¹æ¯”.md](./ç­¾åˆ°çŠ¶æ€ç®¡ç†ä¼˜åŒ–å¯¹æ¯”.md) - ä¼˜åŒ–å‰åå¯¹æ¯”
- [StudentDashboard.test.tsx](../src/pages/__tests__/StudentDashboard.test.tsx) - æµ‹è¯•ç”¨ä¾‹

## æ›´æ–°æ—¥å¿—

### 2024-01-15

- âœ… å®ç°ä¹è§‚æ›´æ–°ç­–ç•¥
- âœ… ä¼˜åŒ–å®šæ—¶åˆ·æ–°æœºåˆ¶
- âœ… æ·»åŠ å®æ—¶æ—¶é—´çª—å£åˆ¤æ–­
- âœ… å®Œå–„é”™è¯¯å¤„ç†å’ŒçŠ¶æ€å›æ»š
- âœ… æ”¹è¿›UIæç¤ºä¿¡æ¯
