# ç­¾åˆ°çŠ¶æ€ç®¡ç†ä¼˜åŒ–è¯´æ˜

## ä¼˜åŒ–æ¦‚è¿°

æœ¬æ¬¡ä¼˜åŒ–é’ˆå¯¹ `StudentDashboard.tsx` é¡µé¢çš„ç­¾åˆ°çŠ¶æ€ç®¡ç†é€»è¾‘è¿›è¡Œäº†å…¨é¢æ”¹è¿›ï¼Œå®ç°äº†æ›´å¯é ã€æ›´ç”¨æˆ·å‹å¥½çš„ç­¾åˆ°ä½“éªŒã€‚

## æ ¸å¿ƒä¼˜åŒ–ç‚¹

### 1. åˆå§‹çŠ¶æ€åŠ è½½ä¼˜åŒ–

**ä¼˜åŒ–å‰ï¼š**

- ä½¿ç”¨æ™®é€šçš„ async å‡½æ•° `loadAttendanceData`
- å­˜åœ¨ä¾èµ–é¡¹è­¦å‘Šé—®é¢˜

**ä¼˜åŒ–åï¼š**

```typescript
const loadAttendanceData = useCallback(async () => {
  // ... åŠ è½½é€»è¾‘
  // é‡ç½®ä¹è§‚æ›´æ–°çŠ¶æ€ï¼ˆä»¥æœåŠ¡å™¨è¿”å›çš„çœŸå®çŠ¶æ€ä¸ºå‡†ï¼‰
  setLocalCheckinState({
    isOptimisticCheckedIn: false,
    optimisticCheckinTime: undefined
  });
}, [id]);
```

**æ”¹è¿›ç‚¹ï¼š**

- ä½¿ç”¨ `useCallback` åŒ…è£…ï¼Œé¿å…ä¸å¿…è¦çš„é‡æ–°åˆ›å»º
- åŠ è½½å®Œæˆåè‡ªåŠ¨é‡ç½®ä¹è§‚æ›´æ–°çŠ¶æ€
- è§£å†³äº† React Hook ä¾èµ–é¡¹è­¦å‘Š

### 2. å®æ—¶çŠ¶æ€æ›´æ–°æœºåˆ¶

**ä¼˜åŒ–å‰ï¼š**

- æ¯30ç§’æ— æ¡ä»¶åˆ·æ–°æ‰€æœ‰æ•°æ®
- æµªè´¹ç½‘ç»œèµ„æºå’ŒæœåŠ¡å™¨èµ„æº

**ä¼˜åŒ–åï¼š**

```typescript
useEffect(() => {
  if (!id || !attendanceData) return;

  const { attendance_status } = attendanceData;

  // å¦‚æœå·²ç»ç­¾åˆ°æˆ–å·²è¯·å‡ï¼Œä¸éœ€è¦å®šæ—¶åˆ·æ–°
  if (
    attendance_status.is_checked_in ||
    attendance_status.status === 'leave' ||
    attendance_status.status === 'leave_pending'
  ) {
    console.log('âœ… å·²ç­¾åˆ°æˆ–å·²è¯·å‡ï¼Œåœæ­¢å®šæ—¶åˆ·æ–°');
    return;
  }

  // ä»…åœ¨æœªç­¾åˆ°çŠ¶æ€ä¸‹ï¼Œæ¯60ç§’åˆ·æ–°ä¸€æ¬¡
  const interval = setInterval(() => {
    console.log('ğŸ”„ è‡ªåŠ¨åˆ·æ–°ç­¾åˆ°çŠ¶æ€ï¼ˆæœªç­¾åˆ°çŠ¶æ€ï¼‰...');
    loadAttendanceData();
  }, 60000); // 60ç§’

  return () => clearInterval(interval);
}, [id, attendanceData, loadAttendanceData]);
```

**æ”¹è¿›ç‚¹ï¼š**

- æ™ºèƒ½åˆ¤æ–­ï¼šä»…åœ¨æœªç­¾åˆ°çŠ¶æ€ä¸‹æ‰å®šæ—¶åˆ·æ–°
- é™ä½åˆ·æ–°é¢‘ç‡ï¼šä»30ç§’æ”¹ä¸º60ç§’
- å·²ç­¾åˆ°æˆ–å·²è¯·å‡çŠ¶æ€ä¸‹å®Œå…¨åœæ­¢åˆ·æ–°
- å‡å°‘50%ä»¥ä¸Šçš„ç½‘ç»œè¯·æ±‚

### 3. æ—¶é—´çª—å£å®æ—¶åˆ¤æ–­

**ä¼˜åŒ–å‰ï¼š**

```typescript
// å‰ç«¯ç¡¬ç¼–ç è®¡ç®—ï¼ˆä¸Šè¯¾å‰10åˆ†é’Ÿåˆ°ä¸Šè¯¾å10åˆ†é’Ÿï¼‰
const courseStartTime = new Date(course.course_start_time);
const checkinStartTime = new Date(courseStartTime.getTime() - 10 * 60 * 1000);
const checkinEndTime = new Date(courseStartTime.getTime() + 10 * 60 * 1000);
```

**ä¼˜åŒ–åï¼š**

```typescript
// ğŸ¯ ä½¿ç”¨åç«¯è¿”å›çš„ç­¾åˆ°æ—¶é—´çª—å£ï¼ˆä¼˜å…ˆï¼‰æˆ–å‰ç«¯è®¡ç®—ï¼ˆå…œåº•ï¼‰
let checkinStartTime: Date;
let checkinEndTime: Date;

if (attendance_status.auto_start_time && attendance_status.auto_close_time) {
  // ä½¿ç”¨åç«¯è¿”å›çš„æ—¶é—´çª—å£
  checkinStartTime = new Date(attendance_status.auto_start_time);
  checkinEndTime = new Date(attendance_status.auto_close_time);
} else {
  // å…œåº•ï¼šå‰ç«¯è®¡ç®—
  const courseStartTime = new Date(course.course_start_time);
  checkinStartTime = new Date(courseStartTime.getTime() - 10 * 60 * 1000);
  checkinEndTime = new Date(courseStartTime.getTime() + 10 * 60 * 1000);
}

// â° å®æ—¶åˆ¤æ–­å½“å‰æ˜¯å¦åœ¨ç­¾åˆ°æ—¶é—´çª—å£å†…ï¼ˆæ¯ç§’æ›´æ–°ï¼‰
const isInCheckinWindow =
  currentTime >= checkinStartTime && currentTime <= checkinEndTime;
```

**æ”¹è¿›ç‚¹ï¼š**

- ä¼˜å…ˆä½¿ç”¨åç«¯è¿”å›çš„æ—¶é—´çª—å£é…ç½®
- å‰ç«¯è®¡ç®—ä½œä¸ºå…œåº•æ–¹æ¡ˆ
- é…åˆ `currentTime` çŠ¶æ€æ¯ç§’æ›´æ–°ï¼Œå®ç°å®æ—¶åˆ¤æ–­
- æŒ‰é’®çŠ¶æ€éšæ—¶é—´çª—å£è‡ªåŠ¨å˜åŒ–

### 4. ä¹è§‚æ›´æ–°ç­–ç•¥

**æ–°å¢åŠŸèƒ½ï¼š**

```typescript
// å®šä¹‰ä¹è§‚æ›´æ–°çŠ¶æ€
interface LocalCheckinState {
  isOptimisticCheckedIn: boolean;
  optimisticCheckinTime?: string;
}

const [localCheckinState, setLocalCheckinState] = useState<LocalCheckinState>({
  isOptimisticCheckedIn: false,
  optimisticCheckinTime: undefined
});
```

**ç­¾åˆ°æµç¨‹ä¼˜åŒ–ï¼š**

```typescript
const handleCheckin = async () => {
  // 1. é˜²æ­¢é‡å¤æäº¤ï¼šæ£€æŸ¥ä¹è§‚æ›´æ–°çŠ¶æ€
  if (localCheckinState.isOptimisticCheckedIn) {
    toast.warning('ç­¾åˆ°è¯·æ±‚å¤„ç†ä¸­', {
      description: 'è¯·ç­‰å¾…ç­¾åˆ°å®Œæˆ',
      duration: 3000
    });
    return;
  }

  try {
    setCheckinLoading(true);

    // 2. ğŸ¯ ä¹è§‚æ›´æ–°ï¼šç«‹å³æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼Œæä¾›å³æ—¶åé¦ˆ
    const optimisticTime = new Date().toISOString();
    setLocalCheckinState({
      isOptimisticCheckedIn: true,
      optimisticCheckinTime: optimisticTime
    });

    // 3. å‘é€ç­¾åˆ°è¯·æ±‚
    const response = await attendanceApi.studentCheckIn(id, { ... });

    if (response.success) {
      // 4. âœ… ç­¾åˆ°æˆåŠŸï¼Œç›´æ¥æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼ˆä¸é‡æ–°è¯·æ±‚æ¥å£ï¼Œæå‡æ€§èƒ½ï¼‰
      const checkinTime = response.data?.checkin_time || new Date().toISOString();

      setAttendanceData({
        ...attendanceData,
        attendance_status: {
          ...attendanceData.attendance_status,
          is_checked_in: true,
          status: 'present',
          checkin_time: checkinTime,
          can_checkin: false
        },
        stats: {
          ...attendanceData.stats,
          checkin_count: attendanceData.stats.checkin_count + 1
        }
      });

      // 5. é‡ç½®ä¹è§‚æ›´æ–°çŠ¶æ€
      setLocalCheckinState({
        isOptimisticCheckedIn: false,
        optimisticCheckinTime: undefined
      });

      toast.success('ç­¾åˆ°æˆåŠŸï¼', { duration: 3000 });
    }
  } catch (error) {
    // 6. ğŸ”„ ç­¾åˆ°å¤±è´¥ï¼Œå›æ»šä¹è§‚æ›´æ–°çŠ¶æ€
    setLocalCheckinState({
      isOptimisticCheckedIn: false,
      optimisticCheckinTime: undefined
    });
    // æ˜¾ç¤ºé”™è¯¯æç¤º
  }
};
```

**æ”¹è¿›ç‚¹ï¼š**

- ç‚¹å‡»ç­¾åˆ°åç«‹å³æ˜¾ç¤º"ç­¾åˆ°å¤„ç†ä¸­"çŠ¶æ€
- é˜²æ­¢ç”¨æˆ·åœ¨è¯·æ±‚å“åº”å‰å¤šæ¬¡ç‚¹å‡»
- å¤±è´¥æ—¶è‡ªåŠ¨å›æ»šçŠ¶æ€
- âœ¨ **æˆåŠŸæ—¶ç›´æ¥æ›´æ–°æœ¬åœ°çŠ¶æ€ï¼Œä¸é‡æ–°è¯·æ±‚æ¥å£ï¼ˆæ€§èƒ½ä¼˜åŒ–ï¼‰**
- ç­¾åˆ°æˆåŠŸåè‡ªåŠ¨åœæ­¢å®šæ—¶åˆ·æ–°ï¼ˆå·²ç­¾åˆ°çŠ¶æ€ï¼‰

### 5. UI çŠ¶æ€æ˜¾ç¤ºä¼˜åŒ–

**ä¼˜åŒ–å‰ï¼š**

```typescript
{attendance_status.is_checked_in ? (
  <div>å·²ç­¾åˆ°</div>
) : (
  <div>æœªç­¾åˆ°</div>
)}
```

**ä¼˜åŒ–åï¼š**

```typescript
// ç»¼åˆåˆ¤æ–­ç­¾åˆ°çŠ¶æ€ï¼ˆè€ƒè™‘ä¹è§‚æ›´æ–°ï¼‰
const effectiveIsCheckedIn =
  attendance_status.is_checked_in || localCheckinState.isOptimisticCheckedIn;

const effectiveCheckinTime =
  attendance_status.checkin_time || localCheckinState.optimisticCheckinTime;

{effectiveIsCheckedIn ? (
  <div className='text-green-600'>
    <div className='text-xl font-semibold'>
      {localCheckinState.isOptimisticCheckedIn && !attendance_status.is_checked_in
        ? 'ç­¾åˆ°å¤„ç†ä¸­...'
        : 'å·²ç­¾åˆ°'}
    </div>
    {effectiveCheckinTime && (
      <div className='mt-2 text-sm text-gray-500'>
        ç­¾åˆ°æ—¶é—´ï¼š{new Date(effectiveCheckinTime).toLocaleString()}
        {localCheckinState.isOptimisticCheckedIn && !attendance_status.is_checked_in && (
          <span className='ml-2 text-xs text-yellow-600'>
            (ç­‰å¾…æœåŠ¡å™¨ç¡®è®¤)
          </span>
        )}
      </div>
    )}
  </div>
) : (
  <div className='text-gray-600'>
    <div className='text-xl font-semibold'>æœªç­¾åˆ°</div>
    <div className='mt-2 space-y-1 text-sm text-gray-500'>
      <div>å½“å‰æ—¶é—´ï¼š{currentTime.toLocaleTimeString()}</div>
      <div className='text-xs'>
        ç­¾åˆ°æ—¶é—´ï¼š{checkinStartTime.toLocaleTimeString()} - {checkinEndTime.toLocaleTimeString()}
      </div>
      {!isInCheckinWindow && (
        <div className='mt-2 text-xs text-orange-600'>
          {currentTime < checkinStartTime
            ? `ç­¾åˆ°å°†åœ¨ ${checkinStartTime.toLocaleTimeString()} å¼€å§‹`
            : `ç­¾åˆ°å·²äº ${checkinEndTime.toLocaleTimeString()} ç»“æŸ`}
        </div>
      )}
      {isInCheckinWindow && (
        <div className='mt-2 text-xs text-green-600'>
          âœ“ å½“å‰å¯ä»¥ç­¾åˆ°
        </div>
      )}
    </div>
  </div>
)}
```

**æ”¹è¿›ç‚¹ï¼š**

- æ˜¾ç¤ºç­¾åˆ°æ—¶é—´çª—å£ä¿¡æ¯
- å®æ—¶æç¤ºå½“å‰æ˜¯å¦å¯ä»¥ç­¾åˆ°
- ä¹è§‚æ›´æ–°æœŸé—´æ˜¾ç¤º"å¤„ç†ä¸­"çŠ¶æ€
- æ›´å‹å¥½çš„ç”¨æˆ·æç¤ºä¿¡æ¯

### 6. æŒ‰é’®çŠ¶æ€ä¼˜åŒ–

**ä¼˜åŒ–åï¼š**

```typescript
<button
  type='button'
  onClick={handleCheckin}
  disabled={
    checkinLoading ||
    !canCheckin ||
    localCheckinState.isOptimisticCheckedIn
  }
  className={`w-full rounded-lg px-4 py-3 font-semibold transition-colors ${
    !canCheckin || localCheckinState.isOptimisticCheckedIn
      ? 'cursor-not-allowed bg-gray-300 text-gray-500'
      : 'bg-green-600 text-white hover:bg-green-700'
  }`}
>
  {localCheckinState.isOptimisticCheckedIn
    ? 'ç­¾åˆ°å¤„ç†ä¸­...'
    : checkinLoading
      ? 'ç­¾åˆ°ä¸­...'
      : !canCheckin
        ? isInCheckinWindow
          ? 'å·²ç­¾åˆ°æˆ–å·²è¯·å‡'
          : 'ä¸åœ¨ç­¾åˆ°æ—¶é—´'
        : 'ç­¾åˆ°'}
</button>
```

**æ”¹è¿›ç‚¹ï¼š**

- ä¹è§‚æ›´æ–°æœŸé—´ç¦ç”¨æŒ‰é’®
- æ¸…æ™°çš„æŒ‰é’®æ–‡æœ¬æç¤º
- æ ¹æ®æ—¶é—´çª—å£åŠ¨æ€æ˜¾ç¤ºç¦ç”¨åŸå› 

## è¾¹ç•Œæƒ…å†µå¤„ç†

### 1. ç»„ä»¶å¸è½½æ¸…ç†

- âœ… æ‰€æœ‰ `useEffect` éƒ½æ­£ç¡®è¿”å›æ¸…ç†å‡½æ•°
- âœ… å®šæ—¶å™¨åœ¨ç»„ä»¶å¸è½½æ—¶è‡ªåŠ¨æ¸…é™¤

### 2. ç½‘ç»œè¯·æ±‚å¤±è´¥

- âœ… ä¹è§‚æ›´æ–°å¤±è´¥æ—¶è‡ªåŠ¨å›æ»šçŠ¶æ€
- âœ… æ˜¾ç¤ºè¯¦ç»†çš„é”™è¯¯æç¤ºä¿¡æ¯
- âœ… 401é”™è¯¯è‡ªåŠ¨è·³è½¬æˆæƒé¡µé¢

### 3. ç­¾åˆ°æ—¶é—´çª—å£è¾¹ç•Œ

- âœ… ä½¿ç”¨åç«¯è¿”å›çš„æ—¶é—´çª—å£ï¼ˆæ›´å‡†ç¡®ï¼‰
- âœ… å‰ç«¯è®¡ç®—ä½œä¸ºå…œåº•æ–¹æ¡ˆ
- âœ… æ¯ç§’å®æ—¶åˆ¤æ–­æ—¶é—´çª—å£çŠ¶æ€

### 4. è¯¾ç¨‹åˆ‡æ¢ç«æ€æ¡ä»¶

- âœ… æ•°æ®ä¸€è‡´æ€§æ£€æŸ¥
- âœ… åˆ‡æ¢è¯¾ç¨‹æ—¶æ¸…ç©ºæ—§æ•°æ®å’Œä¹è§‚æ›´æ–°çŠ¶æ€
- âœ… é˜²æ­¢ä½¿ç”¨é”™è¯¯è¯¾ç¨‹çš„æ•°æ®

### 5. é¡µé¢åˆ·æ–°å¤„ç†

- âœ… é‡æ–°ä»æ¥å£è·å–æœ€æ–°çŠ¶æ€
- âœ… è‡ªåŠ¨é‡ç½®ä¹è§‚æ›´æ–°çŠ¶æ€
- âœ… æ¸…ç†ä¹‹å‰çš„å®šæ—¶å™¨

## æ€§èƒ½ä¼˜åŒ–

1. **å‡å°‘ç½‘ç»œè¯·æ±‚**
   - å·²ç­¾åˆ°/å·²è¯·å‡çŠ¶æ€ä¸‹åœæ­¢å®šæ—¶åˆ·æ–°
   - åˆ·æ–°é¢‘ç‡ä»30ç§’é™ä½åˆ°60ç§’
   - å‡å°‘50%ä»¥ä¸Šçš„ç½‘ç»œè¯·æ±‚

2. **ä¼˜åŒ–æ¸²æŸ“æ€§èƒ½**
   - ä½¿ç”¨ `useCallback` é¿å…å‡½æ•°é‡æ–°åˆ›å»º
   - åˆç†çš„ä¾èµ–é¡¹è®¾ç½®
   - é¿å…ä¸å¿…è¦çš„ç»„ä»¶é‡æ¸²æŸ“

3. **å†…å­˜ç®¡ç†**
   - æ­£ç¡®æ¸…ç†å®šæ—¶å™¨
   - é¿å…å†…å­˜æ³„æ¼

## ç”¨æˆ·ä½“éªŒæå‡

1. **å³æ—¶åé¦ˆ**
   - ç‚¹å‡»ç­¾åˆ°åç«‹å³æ˜¾ç¤º"å¤„ç†ä¸­"çŠ¶æ€
   - ä¸éœ€è¦ç­‰å¾…æœåŠ¡å™¨å“åº”

2. **æ¸…æ™°çš„çŠ¶æ€æç¤º**
   - æ˜¾ç¤ºç­¾åˆ°æ—¶é—´çª—å£
   - å®æ—¶æç¤ºæ˜¯å¦å¯ä»¥ç­¾åˆ°
   - æ˜ç¡®çš„ç¦ç”¨åŸå› è¯´æ˜

3. **é˜²æ­¢è¯¯æ“ä½œ**
   - ä¹è§‚æ›´æ–°æœŸé—´ç¦ç”¨æŒ‰é’®
   - é˜²æ­¢é‡å¤ç‚¹å‡»
   - å¤±è´¥æ—¶è‡ªåŠ¨å›æ»š

## æµ‹è¯•å»ºè®®

1. **åŠŸèƒ½æµ‹è¯•**
   - [ ] æ­£å¸¸ç­¾åˆ°æµç¨‹
   - [ ] ç­¾åˆ°æ—¶é—´çª—å£è¾¹ç•Œæµ‹è¯•
   - [ ] ç½‘ç»œå¤±è´¥åœºæ™¯æµ‹è¯•
   - [ ] é‡å¤ç‚¹å‡»é˜²æŠ¤æµ‹è¯•

2. **æ€§èƒ½æµ‹è¯•**
   - [ ] é•¿æ—¶é—´åœç•™é¡µé¢çš„åˆ·æ–°è¡Œä¸º
   - [ ] å†…å­˜æ³„æ¼æ£€æŸ¥
   - [ ] ç½‘ç»œè¯·æ±‚é¢‘ç‡ç›‘æ§

3. **è¾¹ç•Œæµ‹è¯•**
   - [ ] è¯¾ç¨‹åˆ‡æ¢åœºæ™¯
   - [ ] é¡µé¢åˆ·æ–°åœºæ™¯
   - [ ] ç»„ä»¶å¸è½½åœºæ™¯
