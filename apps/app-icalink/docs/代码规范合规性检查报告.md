# 代码规范合规性检查报告

## 检查时间
2025-10-21

## 检查范围
- `apps/app-icalink/src/services/AttendanceService.ts`
- `apps/app-icalink/src/repositories/CourseStudentRepository.ts`

---

## 一、检查背景

在优化教师页面历史课程查询逻辑时，发现 `AttendanceService.ts` 的 `buildHistoricalTeacherView` 方法**严重违反了 Stratix 框架的分层架构规范**。

### 违规代码（已修复）

```typescript
// ❌ 错误：Service 层直接访问数据库驱动
private async buildHistoricalTeacherView(course: any) {
  // 直接调用 Repository 的私有方法获取数据库连接
  const db = await this.courseStudentRepository['getQueryConnection']();
  
  // 直接编写 SQL 查询
  const studentsWithStatus = await db
    .selectFrom('out_jw_kcb_xs as cs')
    .leftJoin('out_xsxx as s', 's.xh', 'cs.xh')
    .leftJoin('icalink_absent_student_relations as asr', ...)
    .select([...])
    .where(...)
    .execute();
  
  // ...
}
```

### 违反的规范

根据 `docs/代码规范.md`：

1. **第 17 行**：
   > **`Service`**:
   > - **禁止**: 直接访问数据库驱动（如 Kysely 实例）、处理 HTTP 协议细节。

2. **第 623 行**：
   > ❌ 服务层直连数据库驱动（必须通过 Repository）

---

## 二、重构方案

### 核心原则

遵循 Stratix 框架的分层架构规范：

1. **Repository 层**：负责数据持久化与访问（CRUD）、数据库查询构建
2. **Service 层**：负责业务流程编排、领域逻辑校验、跨仓储操作聚合
3. **调用路径**：`Controller` → `Service` → `Repository`

### 重构步骤

#### 步骤 1：在 Repository 层封装复杂查询

在 `CourseStudentRepository.ts` 中新增 `findStudentsWithAttendanceStatus` 方法：

```typescript
/**
 * 查询教学班学生及其缺勤状态（用于历史课程）
 * 
 * 使用 LEFT JOIN 关联以下表：
 * - out_xsxx: 学生信息表（获取姓名、班级、专业）
 * - icalink_absent_student_relations: 缺勤记录表（获取缺勤状态）
 */
public async findStudentsWithAttendanceStatus(
  courseCode: string,
  semester: string,
  courseId: number
): Promise<Array<{
  student_id: string;
  student_name: string | null;
  class_name: string | null;
  major_name: string | null;
  absence_type: string | null;
  leave_reason: string | null;
}>> {
  const db = await this.getQueryConnection();

  const results = await db
    .selectFrom('out_jw_kcb_xs as cs')
    .leftJoin('out_xsxx as s', 's.xh', 'cs.xh')
    .leftJoin('icalink_absent_student_relations as asr', (join) =>
      join
        .onRef('asr.student_id', '=', 'cs.xh')
        .on('asr.course_id', '=', courseId)
    )
    .select([
      'cs.xh as student_id',
      's.xm as student_name',
      's.bjmc as class_name',
      's.zymc as major_name',
      'asr.absence_type',
      'asr.leave_reason'
    ])
    .where('cs.kkh', '=', courseCode)
    .where('cs.xnxq', '=', semester)
    .where('s.zt', 'in', ['add', 'update'])
    .orderBy('cs.xh', 'asc')
    .execute();

  return results as Array<{...}>;
}
```

**符合规范**：
- ✅ Repository 层负责数据库查询构建
- ✅ 使用 `this.getQueryConnection()` 获取数据库连接（BaseRepository 提供的方法）
- ✅ 封装复杂的 SQL 查询逻辑

#### 步骤 2：Service 层调用 Repository 方法

在 `AttendanceService.ts` 中修改 `buildHistoricalTeacherView` 方法：

```typescript
private async buildHistoricalTeacherView(
  course: any
): Promise<Either<ServiceError, TeacherCourseCompleteDataVO>> {
  // ✅ 通过 Repository 层查询（符合代码规范）
  const studentsWithStatus =
    await this.courseStudentRepository.findStudentsWithAttendanceStatus(
      course.course_code,
      course.semester,
      course.id
    );

  // ✅ Service 层只处理业务逻辑
  const students: StudentAttendanceDetail[] = studentsWithStatus.map(
    (row) => {
      const status: AttendanceStatus = row.absence_type
        ? (row.absence_type as AttendanceStatus)
        : ('present' as AttendanceStatus);

      return {
        student_id: row.student_id,
        student_name: row.student_name || '未知',
        class_name: row.class_name ?? undefined,
        major_name: row.major_name ?? undefined,
        status,
        checkin_time: undefined,
        is_late: false,
        late_minutes: undefined,
        leave_reason: row.leave_reason ?? undefined
      };
    }
  );

  // 计算统计信息
  const stats = this.calculateTeacherStats(students);

  // 构建返回数据
  const vo: TeacherCourseCompleteDataVO = { ... };

  return right(vo);
}
```

**符合规范**：
- ✅ Service 层不直接访问数据库驱动
- ✅ Service 层只调用 Repository 提供的方法
- ✅ Service 层专注于业务逻辑（状态判断、数据映射、统计计算）

---

## 三、合规性检查清单

### Repository 层（`CourseStudentRepository.ts`）

- [x] 继承 `BaseRepository<DB, 'tableName', Entity, CreateEntity, UpdateEntity>`
- [x] 定义 `protected readonly tableName` 和 `protected readonly logger`
- [x] 未开启自动建表和强制重建
- [x] 查询方法返回 `Promise<T[]>` 或 `Promise<Maybe<T>>`
- [x] 使用 `this.getQueryConnection()` 获取数据库连接
- [x] 封装复杂的 SQL 查询逻辑
- [x] 提供清晰的方法签名和返回类型

### Service 层（`AttendanceService.ts`）

- [x] 方法返回 `Promise<Either<ServiceError, VO>>`
- [x] 通过构造函数注入仓储
- [x] **不直接访问数据库驱动**（如 `getQueryConnection()`、`db.selectFrom()`）
- [x] **不直接编写 SQL 查询**
- [x] 只调用 Repository 提供的方法
- [x] 专注于业务逻辑（状态判断、数据映射、统计计算）
- [x] 输入为 DTO，输出为安全的 VO

### 分层架构

- [x] 调用路径：`Controller` → `Service` → `Repository`
- [x] Repository 层负责数据访问
- [x] Service 层负责业务逻辑
- [x] 职责边界清晰

---

## 四、检查结果

### ✅ 合规性状态：通过

所有代码均符合 Stratix 框架的分层架构规范。

### 修复的问题

1. ✅ **Service 层直接访问数据库驱动**
   - **修复前**：`const db = await this.courseStudentRepository['getQueryConnection']()`
   - **修复后**：`await this.courseStudentRepository.findStudentsWithAttendanceStatus(...)`

2. ✅ **Service 层直接编写 SQL 查询**
   - **修复前**：在 Service 层使用 `db.selectFrom()...execute()`
   - **修复后**：将 SQL 查询逻辑移到 Repository 层的 `findStudentsWithAttendanceStatus` 方法

3. ✅ **职责边界不清晰**
   - **修复前**：Service 层既处理业务逻辑，又编写 SQL 查询
   - **修复后**：Repository 层负责数据访问，Service 层负责业务逻辑

---

## 五、最佳实践总结

### 1. Repository 层职责

- ✅ 数据持久化与访问（CRUD）
- ✅ 数据库查询构建
- ✅ 将底层数据结构映射为领域实体
- ❌ 不包含业务逻辑
- ❌ 不管理事务（事务上下文应由服务层注入）

### 2. Service 层职责

- ✅ 业务流程编排
- ✅ 领域逻辑校验
- ✅ 事务边界管理
- ✅ 跨仓储操作聚合
- ❌ 不直接访问数据库驱动
- ❌ 不处理 HTTP 协议细节

### 3. 调用规则

- ✅ 标准路径：`Controller` → `Service` → `Repository`
- ✅ 例外路径（仅限简单读/写）：`Controller` → `Repository`
- ❌ 禁止：`Service` → 数据库驱动（Kysely 实例）

---

## 六、后续建议

### 1. 代码审查

在代码审查时，重点检查以下内容：

- [ ] Service 层是否直接访问数据库驱动
- [ ] Service 层是否直接编写 SQL 查询
- [ ] Repository 层是否包含业务逻辑
- [ ] 是否遵循标准调用路径

### 2. 静态代码分析

可以考虑添加 ESLint 规则，禁止 Service 层导入或使用以下内容：

```javascript
// .eslintrc.js
{
  "rules": {
    "no-restricted-imports": [
      "error",
      {
        "patterns": [
          {
            "group": ["kysely"],
            "message": "Service 层禁止直接导入 Kysely，必须通过 Repository 访问数据库"
          }
        ]
      }
    ]
  }
}
```

### 3. 团队培训

- 定期组织代码规范培训
- 分享最佳实践案例
- 建立代码规范检查清单

---

## 七、参考文档

- `docs/代码规范.md` - Stratix 框架分层架构规范
- `apps/app-icalink/docs/教师页面历史课程查询优化.md` - 本次优化的详细文档

---

**检查人员**：Augment Agent  
**审核状态**：已通过  
**版本**：v1.0

