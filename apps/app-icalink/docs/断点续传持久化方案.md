# æ–­ç‚¹ç»­ä¼ æŒä¹…åŒ–æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜åˆ†æ

### å½“å‰å®ç°çš„é—®é¢˜

ç›®å‰ `WriteSheetService` ä¸­çš„ `syncProgress` åªå­˜å‚¨åœ¨å†…å­˜ä¸­ï¼š

```typescript
private syncProgress: SyncProgress | null = null;
```

**å­˜åœ¨çš„é—®é¢˜**ï¼š
- âŒ æœåŠ¡é‡å¯åï¼Œè¿›åº¦ä¿¡æ¯ä¸¢å¤±
- âŒ æ— æ³•çœŸæ­£å®ç°æ–­ç‚¹ç»­ä¼ 
- âŒ æ— æ³•æŸ¥è¯¢å†å²åŒæ­¥è®°å½•
- âŒ æ— æ³•ç›‘æ§å¤šä¸ªåŒæ­¥ä»»åŠ¡

### è§£å†³æ–¹æ¡ˆ

å°†åŒæ­¥è¿›åº¦æŒä¹…åŒ–åˆ°æ•°æ®åº“ä¸­ï¼Œä½¿ç”¨ä¸“é—¨çš„ `sync_progress` è¡¨å­˜å‚¨è¿›åº¦ä¿¡æ¯ã€‚

## ğŸ—„ï¸ æ•°æ®åº“è®¾è®¡

### sync_progress è¡¨ç»“æ„

| å­—æ®µå | ç±»å‹ | è¯´æ˜ | çº¦æŸ |
|--------|------|------|------|
| id | BIGINT | ä¸»é”® | PRIMARY KEY, AUTO_INCREMENT |
| task_name | VARCHAR(100) | ä»»åŠ¡åç§° | NOT NULL, UNIQUE |
| file_id | VARCHAR(50) | WPS æ–‡ä»¶ ID | NOT NULL |
| sheet_id | INTEGER | WPS Sheet ID | NOT NULL |
| status | VARCHAR(20) | åŒæ­¥çŠ¶æ€ | NOT NULL |
| total_count | INTEGER | æ€»è®°å½•æ•° | NOT NULL |
| synced_count | INTEGER | å·²åŒæ­¥è®°å½•æ•° | NOT NULL |
| current_offset | INTEGER | å½“å‰åç§»é‡ | NOT NULL |
| batch_size | INTEGER | æ‰¹æ¬¡å¤§å° | NOT NULL |
| started_at | TIMESTAMP | å¼€å§‹æ—¶é—´ | NULL |
| completed_at | TIMESTAMP | å®Œæˆæ—¶é—´ | NULL |
| last_updated_at | TIMESTAMP | æœ€åæ›´æ–°æ—¶é—´ | NOT NULL |
| error_message | TEXT | é”™è¯¯ä¿¡æ¯ | NULL |
| failure_count | INTEGER | å¤±è´¥æ¬¡æ•° | NOT NULL |
| created_at | TIMESTAMP | åˆ›å»ºæ—¶é—´ | NOT NULL |
| updated_at | TIMESTAMP | æ›´æ–°æ—¶é—´ | NOT NULL |

**ç´¢å¼•**ï¼š
- `idx_task_name`: UNIQUE INDEX on `task_name`
- `idx_status`: INDEX on `status`

**çŠ¶æ€å€¼**ï¼š
- `not_started`: æœªå¼€å§‹
- `in_progress`: è¿›è¡Œä¸­
- `completed`: å·²å®Œæˆ
- `failed`: å¤±è´¥
- `paused`: å·²æš‚åœ

## ğŸ“ æ–‡ä»¶ç»“æ„

å·²åˆ›å»ºä»¥ä¸‹æ–‡ä»¶ï¼š

### 1. ç±»å‹å®šä¹‰æ–‡ä»¶

**`apps/app-icalink/src/types/sync-progress-entity.ts`**

å®šä¹‰äº†ä¸‰ä¸ªç±»å‹ï¼š
- `SyncProgressEntity`: æ•°æ®åº“è¡¨å®ä½“ç±»å‹
- `CreateSyncProgressInput`: åˆ›å»ºè¿›åº¦çš„è¾“å…¥ç±»å‹
- `UpdateSyncProgressInput`: æ›´æ–°è¿›åº¦çš„è¾“å…¥ç±»å‹

### 2. Repository æ–‡ä»¶

**`apps/app-icalink/src/repositories/SyncProgressRepository.ts`**

æä¾›äº†ä»¥ä¸‹æ–¹æ³•ï¼š

| æ–¹æ³• | è¯´æ˜ | è¿”å›ç±»å‹ |
|------|------|---------|
| `findByTaskName(taskName)` | æ ¹æ®ä»»åŠ¡åç§°æŸ¥æ‰¾è¿›åº¦ | `Promise<SyncProgressEntity \| undefined>` |
| `findByStatus(status)` | æ ¹æ®çŠ¶æ€æŸ¥æ‰¾è¿›åº¦åˆ—è¡¨ | `Promise<SyncProgressEntity[]>` |
| `findInProgress()` | æŸ¥æ‰¾æ‰€æœ‰è¿›è¡Œä¸­çš„ä»»åŠ¡ | `Promise<SyncProgressEntity[]>` |
| `findFailed()` | æŸ¥æ‰¾æ‰€æœ‰å¤±è´¥çš„ä»»åŠ¡ | `Promise<SyncProgressEntity[]>` |
| `upsertByTaskName(taskName, data)` | åˆ›å»ºæˆ–æ›´æ–°è¿›åº¦ | `Promise<SyncProgressEntity \| undefined>` |
| `deleteByTaskName(taskName)` | åˆ é™¤æŒ‡å®šä»»åŠ¡çš„è¿›åº¦ | `Promise<boolean>` |
| `cleanupCompleted(daysToKeep)` | æ¸…ç†å·²å®Œæˆçš„è¿›åº¦ | `Promise<number>` |

## ğŸ”§ é›†æˆåˆ° WriteSheetService

### æ­¥éª¤ 1: æ³¨å…¥ SyncProgressRepository

```typescript
import SyncProgressRepository from '../repositories/SyncProgressRepository.js';

export default class WriteSheetService {
  constructor(
    private readonly logger: Logger,
    private readonly wasV7ApiDbsheet: WpsDBSheetAdapter,
    private readonly absentStudentRelationRepository: AbsentStudentRelationRepository,
    private readonly syncProgressRepository: SyncProgressRepository // æ–°å¢
  ) {
    // ...
  }
}
```

### æ­¥éª¤ 2: ä¿®æ”¹è¿›åº¦ç®¡ç†æ–¹æ³•

#### initializeSyncProgress()

```typescript
private async initializeSyncProgress(
  totalCount: number,
  resumeFromLast: boolean
): Promise<number> {
  const taskName = 'absent_student_relations_sync';

  // å¦‚æœè¦ä»ä¸Šæ¬¡ä½ç½®ç»§ç»­ï¼Œå°è¯•ä»æ•°æ®åº“åŠ è½½è¿›åº¦
  if (resumeFromLast) {
    const savedProgress = await this.syncProgressRepository.findByTaskName(taskName);
    
    if (savedProgress && savedProgress.status === 'in_progress') {
      this.logger.info('ä»æ•°æ®åº“æ¢å¤åŒæ­¥è¿›åº¦', {
        lastOffset: savedProgress.current_offset,
        syncedCount: savedProgress.synced_count
      });
      
      // æ›´æ–°çŠ¶æ€ä¸ºè¿›è¡Œä¸­
      await this.syncProgressRepository.upsertByTaskName(taskName, {
        status: 'in_progress',
        last_updated_at: new Date().toISOString()
      });
      
      return savedProgress.current_offset;
    }
  }

  // å¦åˆ™ä»å¤´å¼€å§‹ï¼Œåˆ›å»ºæ–°çš„è¿›åº¦è®°å½•
  await this.syncProgressRepository.upsertByTaskName(taskName, {
    file_id: this.WPS_FILE_ID,
    sheet_id: this.WPS_SHEET_ID,
    status: 'in_progress',
    total_count: totalCount,
    synced_count: 0,
    current_offset: 0,
    batch_size: this.batchSize,
    started_at: new Date().toISOString(),
    completed_at: null,
    last_updated_at: new Date().toISOString(),
    error_message: null,
    failure_count: 0
  });

  this.logger.info('åˆå§‹åŒ–æ–°çš„åŒæ­¥ä»»åŠ¡');
  return 0;
}
```

#### updateSyncProgress()

```typescript
private async updateSyncProgress(
  currentOffset: number,
  syncedCount: number
): Promise<void> {
  const taskName = 'absent_student_relations_sync';

  await this.syncProgressRepository.upsertByTaskName(taskName, {
    current_offset: currentOffset,
    synced_count: syncedCount,
    last_updated_at: new Date().toISOString()
  });

  this.logger.debug('åŒæ­¥è¿›åº¦å·²æ›´æ–°åˆ°æ•°æ®åº“', {
    currentOffset,
    syncedCount
  });
}
```

#### completeSyncProgress()

```typescript
private async completeSyncProgress(success: boolean): Promise<void> {
  const taskName = 'absent_student_relations_sync';

  await this.syncProgressRepository.upsertByTaskName(taskName, {
    status: success ? 'completed' : 'failed',
    completed_at: new Date().toISOString(),
    last_updated_at: new Date().toISOString()
  });

  this.logger.info('åŒæ­¥ä»»åŠ¡å®Œæˆï¼ŒçŠ¶æ€å·²ä¿å­˜åˆ°æ•°æ®åº“', {
    status: success ? 'completed' : 'failed'
  });
}
```

#### failSyncProgress()

```typescript
private async failSyncProgress(errorMessage: string): Promise<void> {
  const taskName = 'absent_student_relations_sync';

  const existing = await this.syncProgressRepository.findByTaskName(taskName);
  const failureCount = (existing?.failure_count || 0) + 1;

  await this.syncProgressRepository.upsertByTaskName(taskName, {
    status: 'failed',
    error_message: errorMessage,
    failure_count: failureCount,
    last_updated_at: new Date().toISOString()
  });

  this.logger.error('åŒæ­¥ä»»åŠ¡å¤±è´¥ï¼ŒçŠ¶æ€å·²ä¿å­˜åˆ°æ•°æ®åº“', {
    errorMessage,
    failureCount
  });
}
```

### æ­¥éª¤ 3: æ·»åŠ æŸ¥è¯¢è¿›åº¦çš„æ–¹æ³•

```typescript
/**
 * ä»æ•°æ®åº“è·å–å½“å‰åŒæ­¥è¿›åº¦
 * @returns åŒæ­¥è¿›åº¦ä¿¡æ¯
 */
async getSyncProgressFromDB(): Promise<SyncProgressEntity | undefined> {
  const taskName = 'absent_student_relations_sync';
  return await this.syncProgressRepository.findByTaskName(taskName);
}

/**
 * é‡ç½®åŒæ­¥è¿›åº¦ï¼ˆä»æ•°æ®åº“åˆ é™¤ï¼‰
 */
async resetSyncProgress(): Promise<void> {
  const taskName = 'absent_student_relations_sync';
  await this.syncProgressRepository.deleteByTaskName(taskName);
  this.logger.info('åŒæ­¥è¿›åº¦å·²ä»æ•°æ®åº“åˆ é™¤');
}
```

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: é¦–æ¬¡åŒæ­¥

```typescript
const service = new WriteSheetService(
  logger,
  wasV7ApiDbsheet,
  absentStudentRelationRepo,
  syncProgressRepo // æ³¨å…¥ SyncProgressRepository
);

// ä»å¤´å¼€å§‹åŒæ­¥
const summary = await service.triggerSync(false);
```

**æ•°æ®åº“è®°å½•**ï¼š
```json
{
  "task_name": "absent_student_relations_sync",
  "status": "in_progress",
  "total_count": 1000,
  "synced_count": 0,
  "current_offset": 0,
  "batch_size": 100,
  "started_at": "2024-01-01T10:00:00Z"
}
```

### ç¤ºä¾‹ 2: ä¸­æ–­åç»§ç»­

```typescript
// æœåŠ¡é‡å¯åï¼Œä»æ•°æ®åº“æ¢å¤è¿›åº¦
const summary = await service.triggerSync(true);
```

**æ•°æ®åº“è®°å½•**ï¼ˆæ¢å¤å‰ï¼‰ï¼š
```json
{
  "task_name": "absent_student_relations_sync",
  "status": "in_progress",
  "total_count": 1000,
  "synced_count": 500,
  "current_offset": 500,
  "batch_size": 100,
  "started_at": "2024-01-01T10:00:00Z",
  "last_updated_at": "2024-01-01T10:05:00Z"
}
```

### ç¤ºä¾‹ 3: æŸ¥è¯¢è¿›åº¦

```typescript
// ä»æ•°æ®åº“æŸ¥è¯¢å½“å‰è¿›åº¦
const progress = await service.getSyncProgressFromDB();

if (progress) {
  console.log(`è¿›åº¦: ${progress.synced_count}/${progress.total_count}`);
  console.log(`çŠ¶æ€: ${progress.status}`);
  console.log(`å½“å‰åç§»é‡: ${progress.current_offset}`);
}
```

### ç¤ºä¾‹ 4: é‡ç½®è¿›åº¦

```typescript
// ä»æ•°æ®åº“åˆ é™¤è¿›åº¦è®°å½•
await service.resetSyncProgress();

// é‡æ–°åŒæ­¥
await service.triggerSync(false);
```

### ç¤ºä¾‹ 5: æŸ¥è¯¢æ‰€æœ‰è¿›è¡Œä¸­çš„ä»»åŠ¡

```typescript
const inProgressTasks = await syncProgressRepo.findInProgress();

console.log(`å½“å‰æœ‰ ${inProgressTasks.length} ä¸ªä»»åŠ¡æ­£åœ¨è¿›è¡Œä¸­`);
inProgressTasks.forEach(task => {
  console.log(`- ${task.task_name}: ${task.synced_count}/${task.total_count}`);
});
```

### ç¤ºä¾‹ 6: æ¸…ç†å†å²è®°å½•

```typescript
// æ¸…ç†7å¤©å‰å·²å®Œæˆçš„åŒæ­¥è®°å½•
const deletedCount = await syncProgressRepo.cleanupCompleted(7);
console.log(`æ¸…ç†äº† ${deletedCount} æ¡å†å²è®°å½•`);
```

## ğŸ“Š å¯¹æ¯”ï¼šå†…å­˜ vs æ•°æ®åº“

| ç‰¹æ€§ | å†…å­˜å­˜å‚¨ | æ•°æ®åº“å­˜å‚¨ |
|------|---------|-----------|
| **æŒä¹…åŒ–** | âŒ æœåŠ¡é‡å¯ä¸¢å¤± | âœ… æ°¸ä¹…ä¿å­˜ |
| **æ–­ç‚¹ç»­ä¼ ** | âŒ æ— æ³•å®ç° | âœ… å®Œå…¨æ”¯æŒ |
| **å†å²è®°å½•** | âŒ æ— æ³•æŸ¥è¯¢ | âœ… å¯æŸ¥è¯¢ |
| **å¤šä»»åŠ¡æ”¯æŒ** | âŒ å•ä»»åŠ¡ | âœ… å¤šä»»åŠ¡ |
| **ç›‘æ§** | âŒ æ— æ³•ç›‘æ§ | âœ… å¯ç›‘æ§ |
| **æ€§èƒ½** | âœ… å¿«é€Ÿ | âš ï¸ ç¨æ…¢ï¼ˆå¯æ¥å—ï¼‰ |
| **å¤æ‚åº¦** | âœ… ç®€å• | âš ï¸ ç¨å¤æ‚ |

## ğŸ¯ ä¼˜åŠ¿

### 1. çœŸæ­£çš„æ–­ç‚¹ç»­ä¼ 

- âœ… æœåŠ¡é‡å¯åå¯ä»¥ä»ä¸Šæ¬¡ä¸­æ–­ä½ç½®ç»§ç»­
- âœ… ä¸ä¼šé‡å¤åŒæ­¥å·²å®Œæˆçš„æ•°æ®
- âœ… èŠ‚çœæ—¶é—´å’Œèµ„æº

### 2. å¯ç›‘æ§æ€§

- âœ… å¯ä»¥æŸ¥è¯¢å½“å‰åŒæ­¥è¿›åº¦
- âœ… å¯ä»¥æŸ¥çœ‹å†å²åŒæ­¥è®°å½•
- âœ… å¯ä»¥ç»Ÿè®¡å¤±è´¥æ¬¡æ•°

### 3. å¤šä»»åŠ¡æ”¯æŒ

- âœ… å¯ä»¥åŒæ—¶ç®¡ç†å¤šä¸ªåŒæ­¥ä»»åŠ¡
- âœ… æ¯ä¸ªä»»åŠ¡ç‹¬ç«‹çš„è¿›åº¦è®°å½•
- âœ… é€šè¿‡ `task_name` åŒºåˆ†ä¸åŒä»»åŠ¡

### 4. æ•…éšœæ¢å¤

- âœ… è®°å½•å¤±è´¥åŸå› å’Œæ¬¡æ•°
- âœ… æ”¯æŒé‡è¯•æœºåˆ¶
- âœ… å¯ä»¥åˆ†æå¤±è´¥æ¨¡å¼

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä»»åŠ¡å‘½åè§„èŒƒ

ä½¿ç”¨æ¸…æ™°çš„ä»»åŠ¡åç§°ï¼š

```typescript
const taskName = 'absent_student_relations_sync'; // âœ… æ¸…æ™°
const taskName = 'sync1'; // âŒ ä¸æ¸…æ™°
```

### 2. å®šæœŸæ¸…ç†

å®šæœŸæ¸…ç†å·²å®Œæˆçš„å†å²è®°å½•ï¼š

```typescript
// æ¯å¤©å‡Œæ™¨æ¸…ç†7å¤©å‰çš„è®°å½•
setInterval(async () => {
  await syncProgressRepo.cleanupCompleted(7);
}, 24 * 60 * 60 * 1000);
```

### 3. é”™è¯¯å¤„ç†

è®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯ï¼š

```typescript
try {
  // åŒæ­¥é€»è¾‘
} catch (error: any) {
  await this.failSyncProgress(
    `${error.message}\nStack: ${error.stack}`
  );
}
```

### 4. ç›‘æ§å‘Šè­¦

ç›‘æ§é•¿æ—¶é—´æœªå®Œæˆçš„ä»»åŠ¡ï¼š

```typescript
const inProgressTasks = await syncProgressRepo.findInProgress();

for (const task of inProgressTasks) {
  const duration = Date.now() - new Date(task.started_at!).getTime();
  
  if (duration > 60 * 60 * 1000) { // è¶…è¿‡1å°æ—¶
    console.warn(`ä»»åŠ¡ ${task.task_name} å·²è¿è¡Œ ${duration}msï¼Œå¯èƒ½å­˜åœ¨é—®é¢˜`);
  }
}
```

## ğŸ“ è¿ç§»æ­¥éª¤

### 1. åˆ›å»ºæ•°æ®åº“è¡¨

è¿è¡Œè¿ç§»è„šæœ¬åˆ›å»º `sync_progress` è¡¨ã€‚

### 2. æ³¨å†Œ Repository

åœ¨æ’ä»¶å…¥å£æ–‡ä»¶ä¸­æ³¨å†Œ `SyncProgressRepository`ï¼š

```typescript
container.register('syncProgressRepository', {
  useClass: SyncProgressRepository,
  lifecycle: Lifecycle.SCOPED
});
```

### 3. ä¿®æ”¹ WriteSheetService

- æ³¨å…¥ `SyncProgressRepository`
- ä¿®æ”¹è¿›åº¦ç®¡ç†æ–¹æ³•ä½¿ç”¨æ•°æ®åº“
- æ·»åŠ æŸ¥è¯¢å’Œé‡ç½®æ–¹æ³•

### 4. æµ‹è¯•

- æµ‹è¯•é¦–æ¬¡åŒæ­¥
- æµ‹è¯•ä¸­æ–­åç»§ç»­
- æµ‹è¯•é‡ç½®åŠŸèƒ½
- æµ‹è¯•æŸ¥è¯¢åŠŸèƒ½

## ğŸ”® æœªæ¥æ‰©å±•

### 1. Web UI

åˆ›å»ºç®¡ç†ç•Œé¢æ˜¾ç¤ºåŒæ­¥è¿›åº¦ï¼š

```typescript
@Get('/sync/progress')
async getProgress() {
  const progress = await this.syncProgressRepo.findByTaskName('...');
  return {
    percentage: Math.round((progress.synced_count / progress.total_count) * 100),
    ...progress
  };
}
```

### 2. æš‚åœ/æ¢å¤

æ”¯æŒæ‰‹åŠ¨æš‚åœå’Œæ¢å¤åŒæ­¥ï¼š

```typescript
async pauseSync() {
  await this.syncProgressRepo.upsertByTaskName(taskName, {
    status: 'paused'
  });
}

async resumeSync() {
  await this.triggerSync(true);
}
```

### 3. åŒæ­¥å†å²

è®°å½•æ¯æ¬¡åŒæ­¥çš„è¯¦ç»†å†å²ï¼š

```typescript
// åˆ›å»º sync_history è¡¨
// æ¯æ¬¡åŒæ­¥å®Œæˆåæ’å…¥ä¸€æ¡å†å²è®°å½•
```

## ğŸ“š æ€»ç»“

é€šè¿‡å°†åŒæ­¥è¿›åº¦æŒä¹…åŒ–åˆ°æ•°æ®åº“ï¼Œæˆ‘ä»¬å®ç°äº†ï¼š

- âœ… çœŸæ­£çš„æ–­ç‚¹ç»­ä¼ 
- âœ… æœåŠ¡é‡å¯åå¯æ¢å¤
- âœ… å¯æŸ¥è¯¢å’Œç›‘æ§
- âœ… æ”¯æŒå¤šä»»åŠ¡ç®¡ç†
- âœ… å®Œæ•´çš„æ•…éšœæ¢å¤æœºåˆ¶

**å»ºè®®**ï¼š
- åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨æ•°æ®åº“æŒä¹…åŒ–æ–¹æ¡ˆ
- å®šæœŸæ¸…ç†å†å²è®°å½•
- ç›‘æ§é•¿æ—¶é—´æœªå®Œæˆçš„ä»»åŠ¡
- è®°å½•è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯

æ‰€æœ‰ä»£ç éƒ½ç¬¦åˆ Stratix æ¡†æ¶è§„èŒƒï¼ğŸ‰

