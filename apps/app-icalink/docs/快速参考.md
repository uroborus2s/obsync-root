# WriteSheetService 快速参考

## 📋 字段映射速查表

| 数据库字段 | WPS 字段 | 类型 | 必填 |
|-----------|---------|------|------|
| course_stats_id | 课程统计ID | Number | ✅ |
| course_id | 课程ID | Number | ✅ |
| course_code | 课程代码 | SingleLineText | ✅ |
| course_name | 课程名称 | SingleLineText | ✅ |
| student_id | 学生ID | SingleLineText | ✅ |
| student_name | 学生姓名 | SingleLineText | ✅ |
| school_name | 学院名称 | SingleLineText | ❌ |
| class_name | 班级名称 | SingleLineText | ❌ |
| major_name | 专业名称 | SingleLineText | ❌ |
| absence_type | 缺勤类型 | SingleSelect | ✅ |
| stat_date | 统计日期 | Date | ✅ |
| semester | 学期 | SingleLineText | ✅ |
| teaching_week | 教学周 | Number | ✅ |
| week_day | 星期 | Number | ✅ |
| periods | 节次 | SingleLineText | ❌ |
| time_period | 时间段 | SingleSelect | ✅ |
| leave_reason | 请假原因 | MultiLineText | ❌ |

## 🎨 缺勤类型选项

| 数据库值 | 显示值 | 颜色 |
|---------|-------|------|
| absent | 缺勤 | 🟠 橙色 |
| truant | 旷课 | 🔴 红色 |
| leave | 请假 | 🟢 绿色 |
| leave_pending | 请假待审批 | 🟡 黄色 |

## ⏰ 时间段选项

| 数据库值 | 显示值 | 颜色 |
|---------|-------|------|
| am | 上午 | 🔵 蓝色 |
| pm | 下午 | 🟣 紫色 |

## 🚀 快速开始

### 1. 使用默认配置

```typescript
const service = new WriteSheetService(
  logger,
  wasV7ApiDbsheet,
  absentStudentRelationRepository
);
```

### 2. 自定义批量大小

```typescript
const service = new WriteSheetService(
  logger,
  wasV7ApiDbsheet,
  absentStudentRelationRepository,
  { batchSize: 50 }
);
```

### 3. 完整配置

```typescript
const service = new WriteSheetService(
  logger,
  wasV7ApiDbsheet,
  absentStudentRelationRepository,
  {
    batchSize: 200,
    fileId: 'your-file-id',
    sheetId: 2
  }
);
```

### 4. 手动触发同步

```typescript
const result = await service.triggerSync();
console.log(result);
// { success: true, message: '同步成功', count: 150 }
```

## ⚙️ 批量大小建议

| 场景 | 推荐值 |
|------|-------|
| 开发环境 | 50 |
| 测试环境 | 100 |
| 生产环境（稳定） | 150-200 |
| 生产环境（不稳定） | 50-100 |

## 📊 日志示例

```
[INFO] WriteSheetService 初始化完成 { fileId: '459309344199', sheetId: 1, batchSize: 100 }
[INFO] 准备写入 350 条记录到 WPS 多维表（批量大小: 100 条/批）
[INFO] 总共 350 条记录，分为 4 批处理
[INFO] [1/4] 开始写入第 1 批，共 100 条记录
[INFO] [1/4] 第 1 批写入成功，返回 100 条记录
[INFO] ✅ 所有记录写入完成！总计 350 条记录，分 4 批处理
```

## 🔧 常用配置代码

### 从环境变量读取

```typescript
const config = {
  batchSize: Number(process.env.WPS_BATCH_SIZE) || 100,
  fileId: process.env.WPS_FILE_ID || '459309344199',
  sheetId: Number(process.env.WPS_SHEET_ID) || 1
};
```

### 从配置文件读取

```typescript
import { wpsConfig } from './config/wps.config.js';

const env = process.env.NODE_ENV || 'development';
const config = wpsConfig[env];
```

## 🛠️ 创建 WPS 多维表字段

```typescript
import { 
  ABSENT_STUDENT_RELATION_FIELDS,
  createAbsentStudentRelationFields 
} from './config/wps-dbsheet-fields.js';

// 方式 1：使用辅助函数
await createAbsentStudentRelationFields(fileId, sheetId, wasV7ApiDbsheet);

// 方式 2：直接调用 API
await wasV7ApiDbsheet.createFields(fileId, sheetId, {
  fields: ABSENT_STUDENT_RELATION_FIELDS
});
```

## 📝 数据转换示例

```typescript
import { 
  getAbsenceTypeLabel,
  formatDateForWps,
  FIELD_NAME_MAPPING 
} from './config/wps-dbsheet-fields.js';

// 转换缺勤类型
const label = getAbsenceTypeLabel('absent'); // '缺勤'

// 格式化日期
const dateStr = formatDateForWps(new Date()); // '2024-01-15'

// 获取 WPS 字段名
const wpsFieldName = FIELD_NAME_MAPPING.course_code; // '课程代码'
```

## ❌ 常见错误

### 错误 1：批量大小无效

```
批量大小必须是大于 0 的整数，当前值: 0
```

**解决**：确保 batchSize 是正整数

```typescript
const batchSize = Number(config.batchSize);
if (Number.isInteger(batchSize) && batchSize > 0) {
  // OK
}
```

### 错误 2：字段映射错误

```
WPS 中显示的数据不正确
```

**解决**：检查字段名称映射

```typescript
// 确保使用 FIELD_NAME_MAPPING
[FIELD_NAME_MAPPING.course_code]: record.course_code
```

### 错误 3：API 请求超时

```
某些批次写入失败
```

**解决**：减小批量大小

```typescript
{ batchSize: 50 }  // 从 100 降到 50
```

## 📚 相关文档

- [使用说明](./WriteSheetService使用说明.md) - 详细的使用文档
- [配置指南](./WriteSheetService配置指南.md) - 配置选项说明
- [字段映射表](./WPS多维表字段映射表.md) - 完整的字段映射
- [优化总结](./批量写入优化总结.md) - 优化改进说明

## 🔍 调试技巧

### 1. 查看详细日志

```typescript
// 日志会显示每批的处理进度
[INFO] [1/4] 开始写入第 1 批，共 100 条记录
```

### 2. 验证字段值

```typescript
import { validateFieldValue } from './config/wps-dbsheet-fields.js';

const isValid = validateFieldValue('缺勤类型', '缺勤'); // true
```

### 3. 测试小批量

```typescript
// 先用小批量测试
const service = new WriteSheetService(logger, adapter, repo, { batchSize: 10 });
```

## 💡 最佳实践

1. ✅ 使用配置文件管理 WPS 配置
2. ✅ 根据环境调整批量大小
3. ✅ 监控同步成功率和耗时
4. ✅ 定期检查日志排查问题
5. ✅ 使用字段映射配置而非硬编码
6. ✅ 添加数据验证确保数据质量
7. ✅ 实现失败重试机制
8. ✅ 记录同步历史便于追溯

## 🎯 性能优化

| 优化项 | 说明 |
|-------|------|
| 批量处理 | 每批 100-200 条记录 |
| 数据限制 | 单次查询限制 1000 条 |
| 并发控制 | 避免同时多个同步任务 |
| 缓存策略 | 缓存字段映射配置 |
| 连接复用 | 复用 HTTP 连接 |

## 📞 获取帮助

遇到问题？查看以下资源：

1. 📖 查看详细文档
2. 🔍 搜索日志错误信息
3. 🧪 使用小批量测试
4. 💬 联系技术支持

