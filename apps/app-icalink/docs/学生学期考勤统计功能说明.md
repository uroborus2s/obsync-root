# 学生学期考勤统计功能说明

## 功能概述

实现了一个学生本学期课程和考勤情况统计功能，通过数据库视图 `v_student_semester_attendance_stats` 提供实时统计数据。

## 数据库视图

### 视图名称
`v_student_semester_attendance_stats`

### 视图字段

| 字段名 | 类型 | 说明 |
|--------|------|------|
| student_id | VARCHAR | 学生ID |
| student_name | VARCHAR | 学生姓名 |
| school_name | VARCHAR | 学院名称 |
| class_name | VARCHAR | 班级名称 |
| major_name | VARCHAR | 专业名称 |
| semester | VARCHAR | 学期（如：2024-2025-1） |
| total_courses | INT | 本学期总课程数（总课时数） |
| completed_courses | INT | 截止当前已上课程数（已上课时数） |
| absence_count | INT | 缺勤次数（包含旷课） |
| leave_count | INT | 请假次数（包含待审批） |
| attendance_count | INT | 出勤次数 |
| attendance_rate | DECIMAL(5,2) | 出勤率（百分比，保留2位小数） |

### 数据源

视图从以下表关联查询数据：

1. **syncdb.out_jw_kcb_xs** - 学生选课表（学生与课程关联）
2. **syncdb.out_xsxx** - 学生基本信息表
3. **icasync.icasync_attendance_courses** - 课程排课表
4. **icasync.icalink_absent_student_relations** - 学生缺勤关联表（历史考勤记录）

### 统计逻辑

#### 1. 总课程数（total_courses）
- 统计学生本学期所有已排课的课程数量
- 使用 `COUNT(DISTINCT ac.id)` 去重统计

#### 2. 已上课程数（completed_courses）
- 统计截止到**当前日期零点**（00:00:00）之前开始的课程
- 条件：`DATE(ac.start_time) < CURDATE()`

#### 3. 缺勤次数（absence_count）
- 统计类型为 `absent`（缺勤）或 `truant`（旷课）的记录
- 只统计已上课程的缺勤记录

#### 4. 请假次数（leave_count）
- 统计类型为 `leave`（请假）或 `leave_pending`（请假待审批）的记录
- 只统计已上课程的请假记录

#### 5. 出勤次数（attendance_count）
- 计算公式：`已上课程数 - 缺勤次数 - 请假次数`
- 没有缺勤记录的历史课程视为出勤

#### 6. 出勤率（attendance_rate）
- 计算公式：`(出勤次数 / 已上课程数) × 100`
- 保留2位小数
- 如果已上课程数为0，出勤率为0

## 部署步骤

### 1. 执行数据库迁移

```bash
# 在 MySQL 客户端中执行
mysql -u your_username -p icasync < apps/app-icalink/database/migrations/V4__add_student_semester_stats_view.sql
```

或者直接在数据库管理工具中执行 SQL 文件。

### 2. 验证视图创建

```sql
-- 查看视图结构
DESCRIBE v_student_semester_attendance_stats;

-- 查看视图定义
SHOW CREATE VIEW v_student_semester_attendance_stats;

-- 测试查询
SELECT * FROM v_student_semester_attendance_stats LIMIT 10;
```

## 使用示例

### 1. 查询特定学生的统计数据

```sql
SELECT * 
FROM v_student_semester_attendance_stats 
WHERE student_id = '202101001'
  AND semester = '2024-2025-1';
```

### 2. 查询班级统计排名

```sql
SELECT 
    student_id,
    student_name,
    total_courses,
    completed_courses,
    attendance_count,
    attendance_rate
FROM v_student_semester_attendance_stats 
WHERE class_name = '计算机2021-1班'
  AND semester = '2024-2025-1'
ORDER BY attendance_rate DESC;
```

### 3. 查找出勤率低的学生

```sql
SELECT 
    student_id,
    student_name,
    class_name,
    attendance_rate,
    absence_count,
    leave_count
FROM v_student_semester_attendance_stats
WHERE attendance_rate < 60
  AND completed_courses > 5  -- 至少上过5节课
  AND semester = '2024-2025-1'
ORDER BY attendance_rate ASC;
```

### 4. 学期整体统计

```sql
SELECT 
    semester,
    COUNT(*) AS student_count,
    ROUND(AVG(attendance_rate), 2) AS avg_attendance_rate,
    ROUND(AVG(total_courses), 2) AS avg_total_courses,
    ROUND(AVG(completed_courses), 2) AS avg_completed_courses
FROM v_student_semester_attendance_stats
GROUP BY semester
ORDER BY semester DESC;
```

## API 接口（已实现代码结构）

### 接口路径
`GET /api/icalink/v1/students/:student_id/attendance/stats`

### 请求参数

| 参数名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| student_id | String | 是 | 学生ID（路径参数） |
| semester | String | 否 | 学期（查询参数），默认当前学期 |

### 响应示例

```json
{
  "success": true,
  "message": "获取学生考勤统计成功",
  "data": {
    "student_id": "202101001",
    "student_name": "张三",
    "school_name": "计算机学院",
    "class_name": "计算机2021-1班",
    "major_name": "计算机科学与技术",
    "semester": "2024-2025-1",
    "total_courses": 48,
    "completed_courses": 32,
    "absence_count": 2,
    "leave_count": 3,
    "attendance_count": 27,
    "attendance_rate": 84.38
  }
}
```

## 代码结构

### 1. 类型定义
- **文件**: `src/types/student-attendance-stats.types.ts`
- **接口**: 
  - `VStudentSemesterAttendanceStats` - 视图实体
  - `StudentAttendanceStatsQuery` - 查询参数
  - `StudentAttendanceStatsResponse` - 响应数据

### 2. Repository 层
- **文件**: `src/repositories/StudentAttendanceStatsRepository.ts`
- **方法**:
  - `findByStudentAndSemester()` - 查询学生指定学期统计
  - `findAllSemestersByStudent()` - 查询学生所有学期统计
  - `findByClassAndSemester()` - 查询班级学期统计

### 3. Service 层
- **文件**: `src/services/StudentAttendanceStatsService.ts`
- **方法**:
  - `getStudentSemesterStats()` - 获取学生学期统计（含业务逻辑）

### 4. Controller 层
- **文件**: `src/controllers/AttendanceController.ts`
- **接口**: `GET /api/icalink/v1/students/:student_id/attendance/stats`

## 注意事项

### 1. 时间边界
- 统计截止时间为**当前日期的零点**（00:00:00）
- 使用 `DATE(ac.start_time) < CURDATE()` 确保只统计已发生的课程

### 2. 数据过滤
- 只统计状态为 `add` 或 `update` 的有效学生
- 只统计未删除的课程（`deleted_at IS NULL`）

### 3. 缺勤记录
- 历史课程的缺勤记录来自 `icalink_absent_student_relations` 表
- 没有缺勤记录的历史课程默认视为出勤

### 4. 性能优化
- 视图使用了 `COUNT(DISTINCT)` 避免重复统计
- 建议在查询时添加学期条件以提高性能
- 可以考虑为常用查询字段添加索引

## 测试建议

1. **数据完整性测试**
   - 验证总课程数是否正确
   - 验证已上课程数是否符合时间条件
   - 验证缺勤、请假、出勤数量总和是否等于已上课程数

2. **边界条件测试**
   - 学生无选课记录
   - 学生无考勤记录
   - 已上课程数为0的情况

3. **性能测试**
   - 大数据量下的查询性能
   - 并发查询测试

## 后续扩展建议

1. **增加更多统计维度**
   - 迟到次数统计
   - 按月份统计
   - 按课程类型统计

2. **增加趋势分析**
   - 出勤率变化趋势
   - 与班级平均值对比

3. **增加预警功能**
   - 出勤率低于阈值预警
   - 连续缺勤预警

4. **缓存优化**
   - 对统计结果进行缓存
   - 定时更新缓存数据

