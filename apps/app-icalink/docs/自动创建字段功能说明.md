# 自动创建字段功能说明

## 📋 功能概述

在初始化字段映射时，系统会自动检查 WPS 多维表中是否存在所有必需的字段。如果发现缺失字段，会自动创建这些字段，然后将字段映射关系保存到数据库。

## 🎯 核心功能

### 1. 自动检测缺失字段

系统会对比：
- **配置的字段**: `ABSENT_STUDENT_RELATION_FIELDS` 中定义的所有字段
- **WPS 现有字段**: 从 WPS API 获取的实际字段列表

找出所有缺失的字段。

### 2. 自动创建字段

对于每个缺失的字段：
- 使用配置中的**中文字段名**（如 "课程ID"、"学生姓名" 等）
- 使用配置中的**字段类型**（如 SingleLineText、Number、Date 等）
- 使用配置中的**字段配置**（如 data 属性中的额外配置）

### 3. 自动保存映射

创建字段后：
- 重新获取 WPS Schema 信息
- 获取新创建字段的 WPS 字段 ID
- 将映射关系保存到数据库
- 加载到内存缓存

## 🔧 实现细节

### 核心方法

#### createMissingWpsFields()

```typescript
private async createMissingWpsFields(
  existingFields: Array<{ id?: string; name: string; type: string }>
): Promise<number>
```

**功能**:
1. 对比配置字段和现有字段，找出缺失字段
2. 逐个创建缺失字段（避免批量创建可能的问题）
3. 每个字段创建后延迟 200ms（避免 API 频率限制）
4. 智能错误处理（字段已存在则跳过，其他错误记录但继续）

**返回**: 成功创建的字段数量

#### initializeFieldMapping() - 增强版

```typescript
async initializeFieldMapping(): Promise<boolean>
```

**完整流程**:
1. 从 WPS API 获取现有字段
2. **调用 `createMissingWpsFields()` 创建缺失字段** ⭐ 新增
3. 如果创建了新字段，重新获取 Schema
4. 构建字段映射数据
5. 保存映射到数据库
6. 加载映射到缓存

## 📊 工作流程

```
开始初始化字段映射
    ↓
获取 WPS 现有字段
    ↓
检查缺失字段
    ↓
有缺失字段？
    ├─ 是 → 逐个创建字段
    │         ↓
    │      重新获取 Schema
    │         ↓
    └─ 否 → 直接构建映射
              ↓
         保存映射到数据库
              ↓
         加载映射到缓存
              ↓
            完成
```

## 🎨 日志输出示例

### 场景 1: 首次初始化（需要创建字段）

```
[INFO] 开始初始化字段映射
[INFO] 从 WPS API 获取到 2 个字段
[INFO] 检查并创建缺失的 WPS 字段
[INFO] 发现 18 个缺失字段，开始创建...
[INFO] [1/18] 创建字段: 课程ID (SingleLineText)
[INFO] [1/18] ✅ 字段 "课程ID" 创建成功
[INFO] [2/18] 创建字段: 课程代码 (SingleLineText)
[INFO] [2/18] ✅ 字段 "课程代码" 创建成功
[INFO] [3/18] 创建字段: 课程名称 (SingleLineText)
[INFO] [3/18] ✅ 字段 "课程名称" 创建成功
...
[INFO] [18/18] 创建字段: 更新时间 (Date)
[INFO] [18/18] ✅ 字段 "更新时间" 创建成功
[INFO] 字段创建完成，成功创建 18/18 个字段
[INFO] 重新获取 WPS Schema 信息...
[INFO] 重新获取后共有 20 个字段
[INFO] 成功构建 18 个字段映射
[INFO] 成功保存 18 个字段映射到数据库
[INFO] 字段映射缓存已加载，共 18 个映射
```

### 场景 2: 字段已存在

```
[INFO] 开始初始化字段映射
[INFO] 从 WPS API 获取到 20 个字段
[INFO] 检查并创建缺失的 WPS 字段
[INFO] 所有字段都已存在，无需创建
[INFO] 成功构建 18 个字段映射
[INFO] 成功保存 18 个字段映射到数据库
[INFO] 字段映射缓存已加载，共 18 个映射
```

### 场景 3: 部分字段已存在

```
[INFO] 开始初始化字段映射
[INFO] 从 WPS API 获取到 15 个字段
[INFO] 检查并创建缺失的 WPS 字段
[INFO] 发现 5 个缺失字段，开始创建...
[INFO] [1/5] 创建字段: 专业名称 (SingleLineText)
[INFO] [1/5] ✅ 字段 "专业名称" 创建成功
[INFO] [2/5] 创建字段: 缺勤类型 (SingleSelect)
[WARN] [2/5] ⚠️ 字段 "缺勤类型" 已存在，跳过
[INFO] [3/5] 创建字段: 统计日期 (Date)
[INFO] [3/5] ✅ 字段 "统计日期" 创建成功
...
[INFO] 字段创建完成，成功创建 4/5 个字段
[INFO] 重新获取 WPS Schema 信息...
[INFO] 重新获取后共有 20 个字段
```

## 🚀 使用方式

### 方式 1: 通过 API 初始化

```typescript
// Controller 中
@Post('/init-field-mapping')
async initFieldMapping() {
  const success = await this.writeSheetService.initializeFieldMapping();
  return {
    success,
    message: success 
      ? '字段映射初始化成功（包括自动创建缺失字段）' 
      : '字段映射初始化失败'
  };
}
```

调用：
```bash
curl -X POST http://localhost:3000/api/sync/init-field-mapping
```

### 方式 2: 首次同步时自动初始化

首次调用同步时，系统会自动检查字段映射：
```bash
curl -X POST http://localhost:3000/api/sync/start
```

系统会自动：
1. 检查字段映射缓存是否存在
2. 如果不存在，调用 `initializeFieldMapping()`
3. 自动创建缺失字段
4. 开始同步

## ⚙️ 配置说明

### 字段定义配置

所有字段定义在 `ABSENT_STUDENT_RELATION_FIELDS` 中：

```typescript
// apps/app-icalink/src/config/wps-dbsheet-fields.ts
export const ABSENT_STUDENT_RELATION_FIELDS = [
  {
    name: 'ID',              // 中文字段名（用于创建字段）
    type: DBSheetFieldType.ID,
    data: {}
  },
  {
    name: '课程统计ID',
    type: DBSheetFieldType.SingleLineText,
    data: {}
  },
  {
    name: '课程ID',
    type: DBSheetFieldType.SingleLineText,
    data: {}
  },
  // ... 更多字段
];
```

### 字段名称映射

数据库字段名到中文字段名的映射：

```typescript
export const FIELD_NAME_MAPPING: Record<string, string> = {
  id: 'ID',
  course_stats_id: '课程统计ID',
  course_id: '课程ID',
  course_code: '课程代码',
  course_name: '课程名称',
  // ... 更多映射
};
```

## 🔍 错误处理

### 1. 字段已存在

**场景**: 字段在创建前已被其他进程创建

**处理**: 记录警告，跳过该字段，继续创建下一个

```
[WARN] [2/18] ⚠️ 字段 "课程ID" 已存在，跳过
```

### 2. 创建失败

**场景**: API 调用失败、权限不足等

**处理**: 记录错误，继续创建下一个字段

```
[ERROR] [5/18] ❌ 字段 "学生姓名" 创建失败: Permission denied
```

### 3. API 频率限制

**场景**: 创建字段过快触发 API 限制

**处理**: 每个字段创建后延迟 200ms

```typescript
// 延迟避免 API 频率限制
if (i < missingFields.length - 1) {
  await this.delay(200);
}
```

## 📈 性能优化

### 1. 逐个创建 vs 批量创建

**当前实现**: 逐个创建
- ✅ 更稳定，单个失败不影响其他字段
- ✅ 更容易定位问题
- ✅ 避免批量创建可能的 API 限制
- ⚠️ 速度较慢（但有延迟控制）

**可选优化**: 批量创建
- ✅ 速度更快
- ⚠️ 单个失败可能影响整批
- ⚠️ 错误定位困难

### 2. 延迟时间调整

当前延迟: **200ms**

可根据实际情况调整：
- **网络稳定 + API 配额充足**: 减少到 100ms
- **API 频率限制严格**: 增加到 500ms

```typescript
// 在 createMissingWpsFields 方法中
await this.delay(200); // 修改这个值
```

### 3. 重新获取 Schema

只在创建了新字段后才重新获取：

```typescript
if (createdCount > 0) {
  this.logger.info('重新获取 WPS Schema 信息...');
  schemasResponse = await this.wasV7ApiDbsheet.getSchemas(this.WPS_FILE_ID);
}
```

## 🎯 最佳实践

### 1. 首次部署

```bash
# 步骤 1: 初始化字段映射（会自动创建所有字段）
curl -X POST http://localhost:3000/api/sync/init-field-mapping

# 步骤 2: 开始同步
curl -X POST http://localhost:3000/api/sync/start
```

### 2. 添加新字段

1. 在 `ABSENT_STUDENT_RELATION_FIELDS` 中添加新字段定义
2. 在 `FIELD_NAME_MAPPING` 中添加映射关系
3. 重新初始化字段映射：
   ```bash
   curl -X POST http://localhost:3000/api/sync/init-field-mapping
   ```

### 3. 字段变更

如果 WPS 字段被手动删除或修改：
1. 重新初始化字段映射
2. 系统会自动检测并重新创建缺失字段

## 🐛 故障排查

### 问题 1: 字段创建失败

**检查**:
- WPS API 权限是否正确
- 文件 ID 和 Sheet ID 是否正确
- 网络连接是否正常
- API 配额是否充足

### 问题 2: 字段类型不匹配

**检查**:
- `ABSENT_STUDENT_RELATION_FIELDS` 中的字段类型是否正确
- WPS 是否支持该字段类型

### 问题 3: 映射未保存

**检查**:
- 数据库连接是否正常
- `wps_field_mapping` 表是否存在
- Repository 是否正确注册

## ✅ 总结

自动创建字段功能确保了：
1. **零配置部署** - 首次使用无需手动创建字段
2. **自动恢复** - 字段被删除后可自动重建
3. **灵活扩展** - 添加新字段只需修改配置
4. **智能处理** - 自动跳过已存在字段，容错性强

所有功能已完整实现并可以直接使用！🎉

