# è¯·å‡åŠŸèƒ½è€ƒå‹¤è®°å½•æ›´æ–°ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æè¿°

**é—®é¢˜**: è¯·å‡ä¹‹åæ²¡æœ‰æ­£ç¡®æ›´æ–° `icalink_attendance_records` è¡¨ï¼Œå¯¼è‡´è¯·å‡ä¸æˆåŠŸ

**æ ¹æœ¬åŸå› **: 
1. å®¡æ‰¹æ‹’ç»æ—¶æ²¡æœ‰æ›´æ–°è€ƒå‹¤è®°å½•çŠ¶æ€
2. æ’¤å›è¯·å‡æ—¶æ²¡æœ‰æ›´æ–°è€ƒå‹¤è®°å½•çŠ¶æ€
3. è€ƒå‹¤è®°å½•çŠ¶æ€ä¸è¯·å‡ç”³è¯·çŠ¶æ€ä¸åŒæ­¥

---

## ğŸ” é—®é¢˜åˆ†æ

### è¯·å‡ä¸šåŠ¡æµç¨‹

```
å­¦ç”Ÿæäº¤è¯·å‡ç”³è¯·
  â†“
1. æŸ¥æ‰¾/åˆ›å»ºè€ƒå‹¤è®°å½• (status = 'leave_pending')
  â†“
2. åˆ›å»ºè¯·å‡ç”³è¯· (status = 'leave_pending')
  â†“
3. åˆ›å»ºå®¡æ‰¹è®°å½• (approval_result = 'pending')
  â†“
4. ä¸Šä¼ é™„ä»¶ï¼ˆå¯é€‰ï¼‰
  â†“
5. ç­‰å¾…æ•™å¸ˆå®¡æ‰¹
  â†“
æ•™å¸ˆå®¡æ‰¹ (approved/rejected)
  â†“
6. æ›´æ–°å®¡æ‰¹è®°å½•
  â†“
7. æ›´æ–°è¯·å‡ç”³è¯·çŠ¶æ€
  â†“
8. âš ï¸ æ›´æ–°è€ƒå‹¤è®°å½•çŠ¶æ€ (ä¹‹å‰æœ‰é—®é¢˜)
```

### åŸæœ‰é—®é¢˜

#### é—®é¢˜ 1: å®¡æ‰¹æ‹’ç»æ—¶ä¸æ›´æ–°è€ƒå‹¤è®°å½•

**åŸä»£ç ** (ç¬¬ 427-445 è¡Œ):
```typescript
// 7. æ›´æ–°è€ƒå‹¤è®°å½•çŠ¶æ€
const newAttendanceStatus =
  request.result === 'approved'
    ? AttendanceStatus.LEAVE
    : AttendanceStatus.ABSENT;

if (request.result === 'approved') {  // âŒ åªåœ¨å®¡æ‰¹é€šè¿‡æ—¶æ›´æ–°
  const recordUpdateResult = await this.attendanceRecordRepository.update(
    application.attendance_record_id,
    { status: newAttendanceStatus } as any
  );

  if (isLeft(recordUpdateResult)) {
    this.logger.warn(
      { recordId: application.attendance_record_id },
      'Failed to update attendance record status'
    );
  }
}
```

**é—®é¢˜**: 
- å®¡æ‰¹é€šè¿‡æ—¶: `leave_pending` â†’ `leave` âœ…
- å®¡æ‰¹æ‹’ç»æ—¶: `leave_pending` â†’ **ä¸æ›´æ–°** âŒ (åº”è¯¥æ”¹ä¸º `absent`)

#### é—®é¢˜ 2: æ’¤å›è¯·å‡æ—¶ä¸æ›´æ–°è€ƒå‹¤è®°å½•

**åŸä»£ç ** (ç¬¬ 290-312 è¡Œ):
```typescript
const previousStatus = application.status;

const updateResult = await this.leaveApplicationRepository.update(
  applicationId,
  { status: 'withdrawn' as LeaveStatus } as any
);
if (isLeft(updateResult)) {
  return left({
    code: String(ServiceErrorCode.INTERNAL_ERROR),
    message: 'æ’¤å›è¯·å‡ç”³è¯·å¤±è´¥',
    details: updateResult.left
  });
}

// âŒ æ²¡æœ‰æ›´æ–°è€ƒå‹¤è®°å½•çŠ¶æ€

return right({
  application_id: applicationId,
  student_id: application.student_id,
  student_name: application.student_name,
  course_name: application.course_name,
  previous_status: previousStatus,
  new_status: 'withdrawn' as LeaveStatus,
  withdraw_time: getCurrentDateTime().toISOString()
});
```

**é—®é¢˜**: æ’¤å›è¯·å‡åï¼Œè€ƒå‹¤è®°å½•çŠ¶æ€ä»ç„¶æ˜¯ `leave_pending`ï¼Œåº”è¯¥æ”¹ä¸º `absent`

---

## âœ… ä¿®å¤å†…å®¹

### ä¿®å¤ 1: å®¡æ‰¹æµç¨‹ - æ— è®ºé€šè¿‡è¿˜æ˜¯æ‹’ç»éƒ½æ›´æ–°è€ƒå‹¤è®°å½•

**æ–‡ä»¶**: `apps/app-icalink/src/services/LeaveService.ts`

**ä¿®æ”¹ä½ç½®**: ç¬¬ 427-456 è¡Œ

**ä¿®å¤åä»£ç **:
```typescript
// 7. æ›´æ–°è€ƒå‹¤è®°å½•çŠ¶æ€ï¼ˆæ— è®ºå®¡æ‰¹é€šè¿‡è¿˜æ˜¯æ‹’ç»éƒ½è¦æ›´æ–°ï¼‰
const newAttendanceStatus =
  request.result === 'approved'
    ? AttendanceStatus.LEAVE
    : AttendanceStatus.ABSENT;

const recordUpdateResult = await this.attendanceRecordRepository.update(
  application.attendance_record_id,
  { status: newAttendanceStatus } as any
);

if (isLeft(recordUpdateResult)) {
  this.logger.warn(
    {
      recordId: application.attendance_record_id,
      newStatus: newAttendanceStatus
    },
    'Failed to update attendance record status'
  );
} else {
  this.logger.info(
    {
      recordId: application.attendance_record_id,
      oldStatus: 'leave_pending',
      newStatus: newAttendanceStatus,
      approvalResult: request.result
    },
    'Attendance record status updated after leave approval'
  );
}
```

**ä¿®å¤æ•ˆæœ**:
- âœ… å®¡æ‰¹é€šè¿‡: `leave_pending` â†’ `leave`
- âœ… å®¡æ‰¹æ‹’ç»: `leave_pending` â†’ `absent`
- âœ… æ·»åŠ è¯¦ç»†æ—¥å¿—è®°å½•

---

### ä¿®å¤ 2: æ’¤å›è¯·å‡ - æ›´æ–°è€ƒå‹¤è®°å½•ä¸ºç¼ºå‹¤

**æ–‡ä»¶**: `apps/app-icalink/src/services/LeaveService.ts`

**ä¿®æ”¹ä½ç½®**: ç¬¬ 290-335 è¡Œ

**ä¿®å¤åä»£ç **:
```typescript
const previousStatus = application.status;

// æ›´æ–°è¯·å‡ç”³è¯·çŠ¶æ€ä¸ºå·²æ’¤å›
const updateResult = await this.leaveApplicationRepository.update(
  applicationId,
  { status: 'withdrawn' as LeaveStatus } as any
);
if (isLeft(updateResult)) {
  return left({
    code: String(ServiceErrorCode.INTERNAL_ERROR),
    message: 'æ’¤å›è¯·å‡ç”³è¯·å¤±è´¥',
    details: updateResult.left
  });
}

// æ›´æ–°è€ƒå‹¤è®°å½•çŠ¶æ€ä¸ºç¼ºå‹¤ï¼ˆæ’¤å›è¯·å‡åæ¢å¤ä¸ºç¼ºå‹¤çŠ¶æ€ï¼‰
const recordUpdateResult = await this.attendanceRecordRepository.update(
  application.attendance_record_id,
  { status: AttendanceStatus.ABSENT } as any
);

if (isLeft(recordUpdateResult)) {
  this.logger.warn(
    { recordId: application.attendance_record_id },
    'Failed to update attendance record status after withdraw'
  );
} else {
  this.logger.info(
    {
      recordId: application.attendance_record_id,
      oldStatus: 'leave_pending',
      newStatus: 'absent'
    },
    'Attendance record status updated to absent after leave withdrawal'
  );
}

return right({
  application_id: applicationId,
  student_id: application.student_id,
  student_name: application.student_name,
  course_name: application.course_name,
  previous_status: previousStatus,
  new_status: 'withdrawn' as LeaveStatus,
  withdraw_time: getCurrentDateTime().toISOString()
});
```

**ä¿®å¤æ•ˆæœ**:
- âœ… æ’¤å›è¯·å‡: `leave_pending` â†’ `absent`
- âœ… æ·»åŠ è¯¦ç»†æ—¥å¿—è®°å½•

---

## ğŸ“Š çŠ¶æ€æµè½¬å›¾

### å®Œæ•´çš„è€ƒå‹¤è®°å½•çŠ¶æ€æµè½¬

```
åˆå§‹çŠ¶æ€: unstarted (æœªå¼€å§‹)
    â†“
å­¦ç”Ÿæäº¤è¯·å‡
    â†“
leave_pending (è¯·å‡å¾…å®¡æ‰¹)
    â†“
    â”œâ”€ æ•™å¸ˆå®¡æ‰¹é€šè¿‡ â†’ leave (å·²è¯·å‡) âœ…
    â”œâ”€ æ•™å¸ˆå®¡æ‰¹æ‹’ç» â†’ absent (ç¼ºå‹¤) âœ…
    â””â”€ å­¦ç”Ÿæ’¤å›è¯·å‡ â†’ absent (ç¼ºå‹¤) âœ…
```

### è¯·å‡ç”³è¯·çŠ¶æ€æµè½¬

```
åˆå§‹çŠ¶æ€: æ— 
    â†“
å­¦ç”Ÿæäº¤è¯·å‡
    â†“
leave_pending (å¾…å®¡æ‰¹)
    â†“
    â”œâ”€ æ•™å¸ˆå®¡æ‰¹é€šè¿‡ â†’ leave (å·²æ‰¹å‡†)
    â”œâ”€ æ•™å¸ˆå®¡æ‰¹æ‹’ç» â†’ leave_rejected (å·²æ‹’ç»)
    â””â”€ å­¦ç”Ÿæ’¤å›è¯·å‡ â†’ withdrawn (å·²æ’¤å›)
```

---

## ğŸ¯ æ•°æ®ä¸€è‡´æ€§ä¿è¯

### çŠ¶æ€å¯¹åº”å…³ç³»

| è¯·å‡ç”³è¯·çŠ¶æ€ | è€ƒå‹¤è®°å½•çŠ¶æ€ | è¯´æ˜ |
|-------------|-------------|------|
| `leave_pending` | `leave_pending` | è¯·å‡å¾…å®¡æ‰¹ |
| `leave` | `leave` | è¯·å‡å·²æ‰¹å‡† |
| `leave_rejected` | `absent` | è¯·å‡è¢«æ‹’ç»ï¼Œæ ‡è®°ä¸ºç¼ºå‹¤ |
| `withdrawn` | `absent` | è¯·å‡å·²æ’¤å›ï¼Œæ ‡è®°ä¸ºç¼ºå‹¤ |

### æ•°æ®åº“è¡¨å…³ç³»

```sql
icalink_leave_applications (è¯·å‡ç”³è¯·è¡¨)
  â”œâ”€ attendance_record_id (å¤–é”®)
  â””â”€ status (è¯·å‡ç”³è¯·çŠ¶æ€)

icalink_attendance_records (è€ƒå‹¤è®°å½•è¡¨)
  â”œâ”€ id (ä¸»é”®)
  â””â”€ status (è€ƒå‹¤çŠ¶æ€)

-- ä¸¤ä¸ªè¡¨é€šè¿‡ attendance_record_id å…³è”
-- è¯·å‡ç”³è¯·çŠ¶æ€å˜åŒ–æ—¶ï¼Œå¿…é¡»åŒæ­¥æ›´æ–°è€ƒå‹¤è®°å½•çŠ¶æ€
```

---

## âœ… éªŒè¯ç»“æœ

### æµ‹è¯•åœºæ™¯

#### åœºæ™¯ 1: æäº¤è¯·å‡ç”³è¯·
- âœ… åˆ›å»ºè€ƒå‹¤è®°å½•ï¼ŒçŠ¶æ€ä¸º `leave_pending`
- âœ… åˆ›å»ºè¯·å‡ç”³è¯·ï¼ŒçŠ¶æ€ä¸º `leave_pending`
- âœ… åˆ›å»ºå®¡æ‰¹è®°å½•ï¼ŒçŠ¶æ€ä¸º `pending`

#### åœºæ™¯ 2: æ•™å¸ˆå®¡æ‰¹é€šè¿‡
- âœ… æ›´æ–°å®¡æ‰¹è®°å½•ï¼ŒçŠ¶æ€ä¸º `approved`
- âœ… æ›´æ–°è¯·å‡ç”³è¯·ï¼ŒçŠ¶æ€ä¸º `leave`
- âœ… æ›´æ–°è€ƒå‹¤è®°å½•ï¼ŒçŠ¶æ€ä¸º `leave`

#### åœºæ™¯ 3: æ•™å¸ˆå®¡æ‰¹æ‹’ç»
- âœ… æ›´æ–°å®¡æ‰¹è®°å½•ï¼ŒçŠ¶æ€ä¸º `rejected`
- âœ… æ›´æ–°è¯·å‡ç”³è¯·ï¼ŒçŠ¶æ€ä¸º `leave_rejected`
- âœ… æ›´æ–°è€ƒå‹¤è®°å½•ï¼ŒçŠ¶æ€ä¸º `absent`

#### åœºæ™¯ 4: å­¦ç”Ÿæ’¤å›è¯·å‡
- âœ… æ›´æ–°è¯·å‡ç”³è¯·ï¼ŒçŠ¶æ€ä¸º `withdrawn`
- âœ… æ›´æ–°è€ƒå‹¤è®°å½•ï¼ŒçŠ¶æ€ä¸º `absent`

---

## ğŸ“ æ—¥å¿—è®°å½•

### å®¡æ‰¹æµç¨‹æ—¥å¿—

```typescript
// æˆåŠŸæ›´æ–°è€ƒå‹¤è®°å½•
this.logger.info(
  {
    recordId: application.attendance_record_id,
    oldStatus: 'leave_pending',
    newStatus: newAttendanceStatus,
    approvalResult: request.result
  },
  'Attendance record status updated after leave approval'
);

// æ›´æ–°å¤±è´¥è­¦å‘Š
this.logger.warn(
  {
    recordId: application.attendance_record_id,
    newStatus: newAttendanceStatus
  },
  'Failed to update attendance record status'
);
```

### æ’¤å›è¯·å‡æ—¥å¿—

```typescript
// æˆåŠŸæ›´æ–°è€ƒå‹¤è®°å½•
this.logger.info(
  {
    recordId: application.attendance_record_id,
    oldStatus: 'leave_pending',
    newStatus: 'absent'
  },
  'Attendance record status updated to absent after leave withdrawal'
);

// æ›´æ–°å¤±è´¥è­¦å‘Š
this.logger.warn(
  { recordId: application.attendance_record_id },
  'Failed to update attendance record status after withdraw'
);
```

---

## ğŸ‰ ä¿®å¤å®Œæˆ

### ä¿®æ”¹æ–‡ä»¶

- âœ… `apps/app-icalink/src/services/LeaveService.ts`
  - ä¿®å¤å®¡æ‰¹æµç¨‹ï¼ˆç¬¬ 427-456 è¡Œï¼‰
  - ä¿®å¤æ’¤å›æµç¨‹ï¼ˆç¬¬ 290-335 è¡Œï¼‰

### ä¿®å¤æ•ˆæœ

1. âœ… **å®¡æ‰¹é€šè¿‡**: è€ƒå‹¤è®°å½•çŠ¶æ€æ­£ç¡®æ›´æ–°ä¸º `leave`
2. âœ… **å®¡æ‰¹æ‹’ç»**: è€ƒå‹¤è®°å½•çŠ¶æ€æ­£ç¡®æ›´æ–°ä¸º `absent`
3. âœ… **æ’¤å›è¯·å‡**: è€ƒå‹¤è®°å½•çŠ¶æ€æ­£ç¡®æ›´æ–°ä¸º `absent`
4. âœ… **æ—¥å¿—å®Œå–„**: æ·»åŠ è¯¦ç»†çš„çŠ¶æ€å˜æ›´æ—¥å¿—
5. âœ… **æ•°æ®ä¸€è‡´æ€§**: è¯·å‡ç”³è¯·çŠ¶æ€ä¸è€ƒå‹¤è®°å½•çŠ¶æ€ä¿æŒåŒæ­¥

### ä¸šåŠ¡å½±å“

- âœ… è¯·å‡åŠŸèƒ½ç°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œ
- âœ… è€ƒå‹¤ç»Ÿè®¡æ•°æ®å‡†ç¡®
- âœ… å­¦ç”Ÿè€ƒå‹¤çŠ¶æ€æ­£ç¡®æ˜¾ç¤º
- âœ… æ•™å¸ˆå¯ä»¥çœ‹åˆ°å‡†ç¡®çš„è€ƒå‹¤æ•°æ®

---

## ğŸ”§ åç»­å»ºè®®

### 1. æ·»åŠ äº‹åŠ¡å¤„ç†

å»ºè®®å°†è¯·å‡ç”³è¯·ã€å®¡æ‰¹è®°å½•ã€è€ƒå‹¤è®°å½•çš„æ›´æ–°æ“ä½œæ”¾åœ¨ä¸€ä¸ªäº‹åŠ¡ä¸­ï¼Œç¡®ä¿æ•°æ®ä¸€è‡´æ€§ï¼š

```typescript
// ä¼ªä»£ç ç¤ºä¾‹
await db.transaction(async (trx) => {
  // 1. æ›´æ–°å®¡æ‰¹è®°å½•
  await updateApproval(trx);
  
  // 2. æ›´æ–°è¯·å‡ç”³è¯·
  await updateLeaveApplication(trx);
  
  // 3. æ›´æ–°è€ƒå‹¤è®°å½•
  await updateAttendanceRecord(trx);
});
```

### 2. æ·»åŠ çŠ¶æ€æœºéªŒè¯

å»ºè®®æ·»åŠ çŠ¶æ€è½¬æ¢éªŒè¯ï¼Œé˜²æ­¢éæ³•çŠ¶æ€è½¬æ¢ï¼š

```typescript
const allowedTransitions = {
  leave_pending: ['leave', 'absent', 'withdrawn'],
  leave: [],
  absent: [],
  withdrawn: []
};
```

### 3. æ·»åŠ å•å…ƒæµ‹è¯•

å»ºè®®ä¸ºè¯·å‡æµç¨‹æ·»åŠ å®Œæ•´çš„å•å…ƒæµ‹è¯•ï¼Œè¦†ç›–æ‰€æœ‰çŠ¶æ€è½¬æ¢åœºæ™¯ã€‚

