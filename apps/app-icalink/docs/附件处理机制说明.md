# è¯·å‡é™„ä»¶å›¾ç‰‡å¤„ç†æœºåˆ¶è¯¦è§£

## ğŸ“‹ æ¦‚è¿°

`apps/app-icalink` é¡¹ç›®é‡‡ç”¨**æ··åˆå­˜å‚¨ç­–ç•¥**å¤„ç†è¯·å‡ç”³è¯·çš„é™„ä»¶å›¾ç‰‡ï¼Œæ”¯æŒä¸¤ç§å­˜å‚¨æ–¹å¼ï¼š
1. **OSS å¯¹è±¡å­˜å‚¨**ï¼ˆæ¨èï¼Œç”¨äºæ–°æ•°æ®ï¼‰
2. **æ•°æ®åº“ BLOB å­˜å‚¨**ï¼ˆå…¼å®¹æ—§æ•°æ®ï¼‰

---

## ğŸ—„ï¸ æ•°æ®åº“è¡¨ç»“æ„

### `icalink_leave_attachments` è¡¨

```typescript
export interface IcalinkLeaveAttachment {
  id: number;                          // ä¸»é”®
  leave_application_id: number;        // å…³è”çš„è¯·å‡ç”³è¯·ID
  image_name: string;                  // å›¾ç‰‡æ–‡ä»¶å
  image_size: number;                  // å›¾ç‰‡å¤§å°ï¼ˆå­—èŠ‚ï¼‰
  image_type: ImageType;               // MIMEç±»å‹ï¼ˆimage/jpeg, image/pngç­‰ï¼‰
  image_extension: string;             // æ–‡ä»¶æ‰©å±•åï¼ˆjpg, pngç­‰ï¼‰
  image_content?: Buffer | null;       // å›¾ç‰‡äºŒè¿›åˆ¶å†…å®¹ï¼ˆæ•°æ®åº“å­˜å‚¨æ¨¡å¼ï¼‰
  image_width?: number;                // å›¾ç‰‡å®½åº¦
  image_height?: number;               // å›¾ç‰‡é«˜åº¦
  thumbnail_content?: Buffer;          // ç¼©ç•¥å›¾äºŒè¿›åˆ¶å†…å®¹ï¼ˆæ•°æ®åº“å­˜å‚¨æ¨¡å¼ï¼‰
  upload_time: Date;                   // ä¸Šä¼ æ—¶é—´
  created_by?: string;                 // åˆ›å»ºè€…
  metadata?: {                         // å…ƒæ•°æ®ï¼ˆJSONæ ¼å¼ï¼‰
    storage_type: 'oss' | 'database' | 'filesystem';
    original_filename: string;
    created_at: string;
    oss?: {                            // OSSå­˜å‚¨ä¿¡æ¯
      bucket_name: string;             // å­˜å‚¨æ¡¶åç§°
      object_path: string;             // åŸå›¾è·¯å¾„
      thumbnail_path: string;          // ç¼©ç•¥å›¾è·¯å¾„
      etag: string;                    // ETag
      version_id: string;              // ç‰ˆæœ¬ID
      uploaded_at: string;             // ä¸Šä¼ æ—¶é—´
    };
  };
}
```

---

## ğŸ”„ é™„ä»¶å¤„ç†æµç¨‹

### 1. **ä¸Šä¼ æµç¨‹**ï¼ˆ`processLeaveAttachments`ï¼‰

```typescript
// è°ƒç”¨ç¤ºä¾‹
const result = await leaveService.processLeaveAttachments(
  applicationId,
  [
    {
      name: 'sick_note.jpg',
      type: 'image/jpeg',
      size: 102400,
      content: 'base64EncodedString...'  // Base64ç¼–ç çš„å›¾ç‰‡
    }
  ]
);
```

**å¤„ç†æ­¥éª¤**ï¼š

1. **éªŒè¯æ–‡ä»¶**
   - æ£€æŸ¥æ–‡ä»¶ç±»å‹ï¼ˆåªæ”¯æŒ `image/*`ï¼‰
   - å°† Base64 è½¬æ¢ä¸º Buffer
   - è®¡ç®—æ–‡ä»¶å¤§å°

2. **åˆ›å»ºæ•°æ®åº“è®°å½•**
   ```typescript
   const attachment = {
     leave_application_id: applicationId,
     image_name: 'sick_note.jpg',
     image_type: 'image/jpeg',
     image_size: 102400,
     image_extension: 'jpg',
     upload_time: new Date(),
     metadata: {
       storage_type: 'oss',
       original_filename: 'sick_note.jpg',
       created_at: '2024-01-01T00:00:00.000Z'
     }
   };
   ```

3. **ä¸Šä¼ åˆ° OSS**
   ```typescript
   const uploadResult = await osspStorageService.uploadImage(
     'leave-attachments',  // bucketåç§°
     fileBuffer,
     {
       fileName: 'sick_note.jpg',
       mimeType: 'image/jpeg',
       extension: 'jpg',
       generateThumbnail: true,  // è‡ªåŠ¨ç”Ÿæˆç¼©ç•¥å›¾
       metadata: {
         'application-id': '123',
         'attachment-id': '456'
       }
     }
   );
   ```

4. **æ›´æ–°æ•°æ®åº“å…ƒæ•°æ®**
   ```typescript
   await leaveAttachmentRepository.update(attachmentId, {
     metadata: {
       storage_type: 'oss',
       original_filename: 'sick_note.jpg',
       created_at: '2024-01-01T00:00:00.000Z',
       oss: {
         bucket_name: 'leave-attachments',
         object_path: 'applications/123/456/sick_note.jpg',
         thumbnail_path: 'applications/123/456/thumb_sick_note.jpg',
         etag: 'abc123...',
         version_id: 'v1',
         uploaded_at: '2024-01-01T00:00:00.000Z'
       }
     }
   });
   ```

---

### 2. **ä¸‹è½½æµç¨‹**ï¼ˆ`downloadAttachmentById`ï¼‰

```typescript
// è°ƒç”¨ç¤ºä¾‹
const result = await leaveService.downloadAttachmentById(
  attachmentId,
  userInfo,
  thumbnail  // true=ä¸‹è½½ç¼©ç•¥å›¾, false=ä¸‹è½½åŸå›¾
);
```

**å¤„ç†æ­¥éª¤**ï¼š

1. **æŸ¥è¯¢é™„ä»¶è®°å½•**
   ```typescript
   const attachment = await leaveAttachmentRepository.findById(attachmentId);
   ```

2. **æƒé™éªŒè¯**
   - æ£€æŸ¥ç”¨æˆ·æ˜¯å¦æœ‰æƒé™è®¿é—®è¯¥é™„ä»¶
   - éªŒè¯é™„ä»¶æ‰€å±çš„è¯·å‡ç”³è¯·

3. **æ ¹æ®å­˜å‚¨ç±»å‹ä¸‹è½½**

   **æ–¹å¼Aï¼šä» OSS ä¸‹è½½**
   ```typescript
   if (metadata.storage_type === 'oss' && metadata.oss) {
     const objectPath = thumbnail 
       ? metadata.oss.thumbnail_path 
       : metadata.oss.object_path;
     
     const downloadResult = await osspStorageService.downloadImage(
       metadata.oss.bucket_name,
       objectPath
     );
     
     return {
       fileName: downloadResult.fileName,
       fileContent: downloadResult.fileContent,  // Buffer
       mimeType: downloadResult.mimeType,
       fileSize: downloadResult.fileSize
     };
   }
   ```

   **æ–¹å¼Bï¼šä»æ•°æ®åº“ä¸‹è½½**ï¼ˆé™çº§æ–¹æ¡ˆï¼‰
   ```typescript
   const imageContent = thumbnail 
     ? attachment.thumbnail_content 
     : attachment.image_content;
   
   return {
     fileName: attachment.image_name,
     fileContent: imageContent,  // Buffer
     mimeType: attachment.image_type,
     fileSize: imageContent.length
   };
   ```

4. **è¿”å›å›¾ç‰‡æ•°æ®**
   - è¿”å› Buffer æ ¼å¼çš„å›¾ç‰‡å†…å®¹
   - åŒ…å«æ–‡ä»¶åã€MIMEç±»å‹ã€æ–‡ä»¶å¤§å°ç­‰å…ƒä¿¡æ¯

---

### 3. **è·å–é¢„ç­¾åURL**ï¼ˆ`getAttachmentPresignedUrl`ï¼‰

ç”¨äºå‰ç«¯ç›´æ¥ä» OSS ä¸‹è½½å›¾ç‰‡ï¼Œé¿å…æµé‡ç»è¿‡åº”ç”¨æœåŠ¡å™¨ã€‚

```typescript
// è°ƒç”¨ç¤ºä¾‹
const url = await leaveService.getAttachmentPresignedUrl(
  attachmentId,
  userInfo,
  thumbnail
);

// è¿”å›ç¤ºä¾‹
// "https://oss.example.com/leave-attachments/applications/123/456/sick_note.jpg?signature=..."
```

**å¤„ç†æ­¥éª¤**ï¼š

1. æŸ¥è¯¢é™„ä»¶è®°å½•
2. éªŒè¯å­˜å‚¨ç±»å‹ä¸º OSS
3. è°ƒç”¨ OSS æœåŠ¡ç”Ÿæˆé¢„ç­¾å URLï¼ˆæœ‰æ•ˆæœŸé€šå¸¸ä¸º 1 å°æ—¶ï¼‰
4. è¿”å› URL ç»™å‰ç«¯

---

## ğŸ–¼ï¸ å›¾ç‰‡å‹ç¼©å’Œç¼©ç•¥å›¾

### ç¼©ç•¥å›¾ç”Ÿæˆï¼ˆä½¿ç”¨ Sharp åº“ï¼‰

```typescript
const thumbnail = await sharp(imageBuffer)
  .resize(200, 200, {
    fit: 'inside',              // ä¿æŒå®½é«˜æ¯”
    withoutEnlargement: true    // ä¸æ”¾å¤§å°å›¾
  })
  .jpeg({ quality: 80 })
  .toBuffer();
```

### å›¾ç‰‡å‹ç¼©ç­–ç•¥

```typescript
// å‹ç¼©è§„åˆ™
if (originalSize > 5MB) {
  quality = 70;
} else if (originalSize > 3MB) {
  quality = 75;
} else {
  quality = 85;
}

// å°ºå¯¸é™åˆ¶
if (width > 1920 || height > 1920) {
  // ç­‰æ¯”ç¼©æ”¾åˆ° 1920px
  const ratio = Math.min(1920 / width, 1920 / height);
  targetWidth = Math.round(width * ratio);
  targetHeight = Math.round(height * ratio);
}

// æ ¼å¼è½¬æ¢
if (mimeType === 'image/png') {
  // PNG è½¬ JPEG ä»¥è·å¾—æ›´å¥½çš„å‹ç¼©ç‡
  compressedBuffer = await sharp(imageBuffer)
    .jpeg({ quality, progressive: true, mozjpeg: true })
    .toBuffer();
}
```

---

## ğŸŒ Controller å±‚å¤„ç†

### æŸ¥çœ‹é™„ä»¶å›¾ç‰‡ï¼ˆå†…è”æ˜¾ç¤ºï¼‰

```typescript
@Get('/api/icalink/v1/attendance/attachments/:id/image')
async getAttachmentImage(request, reply) {
  const result = await leaveService.downloadAttachmentById(
    attachmentId,
    userIdentity,
    request.query.thumbnail
  );
  
  // è¿”å›å›¾ç‰‡äºŒè¿›åˆ¶æ•°æ®
  reply.raw.writeHead(200, {
    'Content-Type': result.mimeType,
    'Content-Disposition': `inline; filename="${result.fileName}"`,
    'Cache-Control': 'public, max-age=3600',
    'Content-Length': result.fileSize.toString()
  });
  reply.raw.end(result.fileContent);
}
```

### ä¸‹è½½é™„ä»¶æ–‡ä»¶

```typescript
@Get('/api/icalink/v1/attendance/attachments/:id/download')
async downloadAttachmentFile(request, reply) {
  const result = await leaveService.downloadAttachmentById(
    attachmentId,
    userIdentity,
    request.query.thumbnail
  );
  
  // è¿”å›ä¸‹è½½æ–‡ä»¶
  reply.raw.writeHead(200, {
    'Content-Type': result.mimeType,
    'Content-Disposition': `attachment; filename="${result.fileName}"`,
    'Content-Length': result.fileSize.toString()
  });
  reply.raw.end(result.fileContent);
}
```

---

## ğŸ” å®‰å…¨æœºåˆ¶

### 1. æƒé™éªŒè¯
- å­¦ç”Ÿåªèƒ½è®¿é—®è‡ªå·±çš„è¯·å‡ç”³è¯·é™„ä»¶
- æ•™å¸ˆå¯ä»¥è®¿é—®éœ€è¦å®¡æ‰¹çš„è¯·å‡ç”³è¯·é™„ä»¶
- ç®¡ç†å‘˜å¯ä»¥è®¿é—®æ‰€æœ‰é™„ä»¶

### 2. æ–‡ä»¶ç±»å‹é™åˆ¶
- åªå…è®¸ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶ï¼ˆ`image/*`ï¼‰
- éªŒè¯ MIME ç±»å‹å’Œæ–‡ä»¶æ‰©å±•å

### 3. æ–‡ä»¶å¤§å°é™åˆ¶
- å•ä¸ªæ–‡ä»¶æœ€å¤§ 10MBï¼ˆå¯é…ç½®ï¼‰
- è‡ªåŠ¨å‹ç¼©è¶…è¿‡ 1.5MB çš„å›¾ç‰‡

---

## ğŸ“Š å­˜å‚¨ç­–ç•¥å¯¹æ¯”

| ç‰¹æ€§ | OSS å­˜å‚¨ | æ•°æ®åº“å­˜å‚¨ |
|------|---------|-----------|
| **æ€§èƒ½** | â­â­â­â­â­ é«˜ | â­â­â­ ä¸­ |
| **æ‰©å±•æ€§** | â­â­â­â­â­ æ— é™ | â­â­ å—é™ |
| **æˆæœ¬** | â­â­â­â­ æŒ‰é‡ä»˜è´¹ | â­â­â­ æ•°æ®åº“ç©ºé—´ |
| **CDNåŠ é€Ÿ** | âœ… æ”¯æŒ | âŒ ä¸æ”¯æŒ |
| **å¤‡ä»½** | âœ… è‡ªåŠ¨ | âš ï¸ éœ€æ‰‹åŠ¨ |
| **è¿ç§»** | â­â­â­ ä¸­ç­‰ | â­â­â­â­ ç®€å• |
| **é€‚ç”¨åœºæ™¯** | ç”Ÿäº§ç¯å¢ƒ | å¼€å‘/æµ‹è¯•ç¯å¢ƒ |

---

## ğŸš€ æœ€ä½³å®è·µ

### 1. æ–°æ•°æ®ä½¿ç”¨ OSS å­˜å‚¨
```typescript
// æ¨èï¼šä½¿ç”¨ OSS å­˜å‚¨
const result = await leaveService.processLeaveAttachments(
  applicationId,
  images
);
```

### 2. æ—§æ•°æ®ä¿æŒæ•°æ®åº“å­˜å‚¨
```typescript
// å…¼å®¹ï¼šä»æ•°æ®åº“è¯»å–æ—§æ•°æ®
if (metadata.storage_type === 'database') {
  return downloadFromDatabase(attachment, thumbnail);
}
```

### 3. é™çº§ç­–ç•¥
```typescript
// OSS ä¸‹è½½å¤±è´¥æ—¶è‡ªåŠ¨é™çº§åˆ°æ•°æ®åº“
try {
  return await downloadFromOSS(attachment, thumbnail);
} catch (error) {
  logger.warn('OSS download failed, falling back to database');
  return await downloadFromDatabase(attachment, thumbnail);
}
```

### 4. ä½¿ç”¨é¢„ç­¾å URL
```typescript
// å‰ç«¯ç›´æ¥ä» OSS ä¸‹è½½ï¼Œå‡è½»æœåŠ¡å™¨å‹åŠ›
const url = await leaveService.getAttachmentPresignedUrl(
  attachmentId,
  userInfo,
  thumbnail
);
// å‰ç«¯ä½¿ç”¨ <img src={url} /> ç›´æ¥æ˜¾ç¤º
```

---

## ğŸ“ API æ¥å£ç¤ºä¾‹

### æäº¤è¯·å‡ç”³è¯·ï¼ˆå¸¦é™„ä»¶ï¼‰

```http
POST /api/icalink/v1/leave-applications
Content-Type: application/json

{
  "attendance_record_id": "123",
  "leave_type": "sick",
  "leave_reason": "æ„Ÿå†’å‘çƒ§",
  "images": [
    {
      "name": "sick_note.jpg",
      "type": "image/jpeg",
      "size": 102400,
      "content": "base64EncodedString..."
    }
  ]
}
```

### æŸ¥çœ‹é™„ä»¶å›¾ç‰‡

```http
GET /api/icalink/v1/attendance/attachments/456/image?thumbnail=true
```

### ä¸‹è½½é™„ä»¶æ–‡ä»¶

```http
GET /api/icalink/v1/attendance/attachments/456/download
```

---

## ğŸ”§ ä¾èµ–æœåŠ¡

### OsspStorageServiceï¼ˆOSS å­˜å‚¨æœåŠ¡ï¼‰

```typescript
interface OsspStorageService {
  // ä¸Šä¼ å›¾ç‰‡
  uploadImage(
    bucketName: string,
    fileContent: Buffer,
    options: {
      fileName: string;
      mimeType: string;
      extension: string;
      generateThumbnail: boolean;
      metadata: Record<string, string>;
    }
  ): Promise<ServiceResult<{
    objectPath: string;
    thumbnailPath: string;
    etag: string;
    versionId: string;
  }>>;

  // ä¸‹è½½å›¾ç‰‡
  downloadImage(
    bucketName: string,
    objectPath: string
  ): Promise<ServiceResult<{
    fileName: string;
    fileContent: Buffer;
    mimeType: string;
    fileSize: number;
  }>>;

  // è·å–é¢„ç­¾åURL
  getPresignedUrl(
    bucketName: string,
    objectPath: string
  ): Promise<ServiceResult<string>>;
}
```

---

## âš ï¸ å½“å‰çŠ¶æ€

### âœ… å·²å®ç°
- æ•°æ®åº“è¡¨ç»“æ„å®šä¹‰
- Repository å±‚ï¼ˆLeaveAttachmentRepositoryï¼‰
- å®Œæ•´çš„ä¸Šä¼ /ä¸‹è½½é€»è¾‘ï¼ˆåœ¨å¤‡ä»½æ–‡ä»¶ä¸­ï¼‰

### âš ï¸ å¾…å®ç°ï¼ˆå·²æ³¨é‡Šï¼‰
- `downloadAttachmentById` æ–¹æ³•
- `queryLeaveApplications` æ–¹æ³•ï¼ˆåŒ…å«é™„ä»¶æ•°é‡ç»Ÿè®¡ï¼‰
- Controller å±‚çš„é™„ä»¶æ¥å£

### ğŸ”¨ éœ€è¦è¡¥å……
- OsspStorageService çš„å®é™…å®ç°
- å›¾ç‰‡å‹ç¼©åŠŸèƒ½çš„é›†æˆ
- æƒé™éªŒè¯é€»è¾‘çš„å®Œå–„

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- **Service**: `src/services/LeaveService.ts.backup`ï¼ˆå®Œæ•´å®ç°ï¼‰
- **Repository**: `src/repositories/LeaveAttachmentRepository.ts`
- **Types**: `src/types/database.ts`ï¼ˆIcalinkLeaveAttachmentï¼‰
- **Controller**: `src/controllers/AttendanceController.ts`ï¼ˆå·²æ³¨é‡Šçš„é™„ä»¶æ¥å£ï¼‰

