# å­¦ç”Ÿå‡ºå‹¤ç»Ÿè®¡è§†å›¾è¯´æ˜æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

æœ¬æ–‡æ¡£è¯´æ˜äº†ä¸¤ä¸ªç”¨äºç»Ÿè®¡å­¦ç”Ÿå‡ºå‹¤æ•°æ®çš„ MySQL è§†å›¾çš„ç»“æ„ã€å­—æ®µå«ä¹‰å’Œä½¿ç”¨æ–¹æ³•ã€‚

**åˆ›å»ºæ—¶é—´**: 2025-10-25
**é€‚ç”¨ç‰ˆæœ¬**: MySQL 5.6+
**æ•°æ®æ¥æº**: `icalink_attendance_records_history` (å†å²å‡ºå‹¤è®°å½•è¡¨)

---

## ğŸ“Š è§†å›¾ 1: `view_student_overall_attendance_stats`

### åŠŸèƒ½è¯´æ˜

æŒ‰å­¦ç”Ÿæ±‡æ€»æˆªæ­¢åˆ°å½“æ—¥ï¼ˆä¸åŒ…æ‹¬å½“æ—¥ï¼‰çš„æ•´ä½“å‡ºå‹¤ç»Ÿè®¡æ•°æ®ã€‚

### ç»Ÿè®¡ç»´åº¦

- **æŒ‰å­¦ç”Ÿæ±‡æ€»**
- **æˆªæ­¢åˆ°æ˜¨å¤©**ï¼ˆ`ac.start_time < CURDATE()`ï¼‰
- **æŒ‰å­¦æœŸåˆ†ç»„**

### å­—æ®µè¯´æ˜

| å­—æ®µå           | ç±»å‹         | è¯´æ˜                                                                 | ç¤ºä¾‹å€¼        |
| ---------------- | ------------ | -------------------------------------------------------------------- | ------------- |
| `student_id`     | VARCHAR(100) | å­¦ç”ŸIDï¼ˆå­¦å·ï¼‰                                                       | `2021001`     |
| `student_name`   | VARCHAR(200) | å­¦ç”Ÿå§“å                                                             | `å¼ ä¸‰`        |
| `class_name`     | VARCHAR(200) | ç­çº§åç§°                                                             | `è½¯å·¥2101ç­`  |
| `major_name`     | VARCHAR(200) | ä¸“ä¸šåç§°                                                             | `è½¯ä»¶å·¥ç¨‹`    |
| `school_name`    | VARCHAR(200) | å­¦é™¢åç§°                                                             | `è®¡ç®—æœºå­¦é™¢`  |
| `semester`       | VARCHAR(20)  | å­¦æœŸ                                                                 | `2024-2025-1` |
| `total_courses`  | INT          | è¯¥å­¦ç”Ÿé€‰ä¿®çš„è¯¾ç¨‹æ€»æ•°                                                 | `8`           |
| `total_sessions` | INT          | æˆªæ­¢åˆ°æ˜¨å¤©çš„è¯¾èŠ‚æ€»æ•°                                                 | `120`         |
| `present_count`  | INT          | å‡ºå‹¤æ€»æ•°ï¼ˆstatus = 'present'ï¼‰                                       | `110`         |
| `late_count`     | INT          | è¿Ÿåˆ°æ€»æ•°ï¼ˆstatus = 'late'ï¼‰                                          | `5`           |
| `leave_count`    | INT          | è¯·å‡æ€»æ•°ï¼ˆstatus IN ('leave', 'leave_pending', 'pending_approval')ï¼‰ | `3`           |
| `absent_count`   | INT          | ç¼ºå‹¤æ€»æ•°ï¼ˆstatus IN ('absent', 'truant')ï¼‰                           | `2`           |
| `stat_date`      | DATE         | ç»Ÿè®¡æˆªæ­¢æ—¥æœŸï¼ˆå½“å‰æ—¥æœŸï¼‰                                             | `2025-10-25`  |

### æ•°æ®æ¥æº

- **ä¸»è¡¨**: `icalink_attendance_records_history` (å†å²å‡ºå‹¤è®°å½•è¡¨)
- **å…³è”è¡¨**:
  - `v_teaching_class` (å­¦ç”Ÿé€‰è¯¾è§†å›¾)
  - `icasync.icasync_attendance_courses` (è¯¾ç¨‹è¡¨)

### ä½¿ç”¨ç¤ºä¾‹

#### ç¤ºä¾‹ 1: æŸ¥è¯¢æŸä¸ªå­¦ç”Ÿçš„æ•´ä½“ç¼ºå‹¤ç»Ÿè®¡

```sql
SELECT *
FROM view_student_overall_attendance_stats
WHERE student_id = '2021001';
```

**ç»“æœç¤ºä¾‹**:

```
student_id | student_name | class_name    | total_courses | total_sessions | absent_count | leave_count | stat_date
-----------|--------------|---------------|---------------|----------------|--------------|-------------|----------
2021001    | å¼ ä¸‰         | è½¯å·¥2101ç­    | 8             | 120            | 5            | 3           | 2025-10-25
```

#### ç¤ºä¾‹ 2: æŸ¥è¯¢æŸä¸ªå­¦æœŸæ‰€æœ‰å­¦ç”Ÿçš„æ•´ä½“ç¼ºå‹¤ç»Ÿè®¡ï¼ŒæŒ‰ç¼ºå‹¤æ¬¡æ•°é™åº

```sql
SELECT *
FROM view_student_overall_attendance_stats
WHERE semester = '2024-2025-1'
ORDER BY absent_count DESC
LIMIT 10;
```

#### ç¤ºä¾‹ 3: æŸ¥è¯¢ç¼ºå‹¤æ¬¡æ•°è¶…è¿‡10æ¬¡çš„å­¦ç”Ÿ

```sql
SELECT
    student_id,
    student_name,
    class_name,
    total_sessions,
    absent_count,
    ROUND(absent_count * 100.0 / total_sessions, 2) AS absent_rate
FROM view_student_overall_attendance_stats
WHERE absent_count > 10
ORDER BY absent_count DESC;
```

#### ç¤ºä¾‹ 4: ç»Ÿè®¡å„ç­çº§çš„å¹³å‡ç¼ºå‹¤æ¬¡æ•°

```sql
SELECT
    class_name,
    COUNT(*) AS student_count,
    AVG(absent_count) AS avg_absent_count,
    AVG(leave_count) AS avg_leave_count
FROM view_student_overall_attendance_stats
WHERE semester = '2024-2025-1'
GROUP BY class_name
ORDER BY avg_absent_count DESC;
```

---

## ğŸ“Š è§†å›¾ 2: `view_student_course_attendance_stats`

### åŠŸèƒ½è¯´æ˜

æŒ‰å­¦ç”Ÿ + è¯¾ç¨‹æ±‡æ€»æˆªæ­¢åˆ°å½“æ—¥ï¼ˆä¸åŒ…æ‹¬å½“æ—¥ï¼‰çš„å‡ºå‹¤ç»Ÿè®¡æ•°æ®ã€‚

### ç»Ÿè®¡ç»´åº¦

- **æŒ‰å­¦ç”Ÿ + è¯¾ç¨‹æ±‡æ€»**
- **æˆªæ­¢åˆ°æ˜¨å¤©**ï¼ˆ`ac.start_time < CURDATE()`ï¼‰
- **æŒ‰å­¦æœŸåˆ†ç»„**

### å­—æ®µè¯´æ˜

| å­—æ®µå            | ç±»å‹         | è¯´æ˜                                                                         | ç¤ºä¾‹å€¼                  |
| ----------------- | ------------ | ---------------------------------------------------------------------------- | ----------------------- |
| `student_id`      | VARCHAR(100) | å­¦ç”ŸIDï¼ˆå­¦å·ï¼‰                                                               | `2021001`               |
| `student_name`    | VARCHAR(200) | å­¦ç”Ÿå§“å                                                                     | `å¼ ä¸‰`                  |
| `class_name`      | VARCHAR(200) | ç­çº§åç§°                                                                     | `è½¯å·¥2101ç­`            |
| `major_name`      | VARCHAR(200) | ä¸“ä¸šåç§°                                                                     | `è½¯ä»¶å·¥ç¨‹`              |
| `school_name`     | VARCHAR(200) | å­¦é™¢åç§°                                                                     | `è®¡ç®—æœºå­¦é™¢`            |
| `course_code`     | VARCHAR(100) | è¯¾ç¨‹ä»£ç ï¼ˆå¼€è¯¾å·ï¼‰                                                           | `202420252003013016705` |
| `course_name`     | VARCHAR(200) | è¯¾ç¨‹åç§°                                                                     | `æ•°æ®ç»“æ„`              |
| `semester`        | VARCHAR(20)  | å­¦æœŸ                                                                         | `2024-2025-1`           |
| `total_sessions`  | INT          | è¯¥è¯¾ç¨‹æˆªæ­¢åˆ°æ˜¨å¤©çš„è¯¾èŠ‚æ€»æ•°                                                   | `16`                    |
| `present_count`   | INT          | è¯¥è¯¾ç¨‹çš„å‡ºå‹¤æ€»æ•°ï¼ˆstatus = 'present'ï¼‰                                       | `14`                    |
| `late_count`      | INT          | è¯¥è¯¾ç¨‹çš„è¿Ÿåˆ°æ€»æ•°ï¼ˆstatus = 'late'ï¼‰                                          | `1`                     |
| `leave_count`     | INT          | è¯¥è¯¾ç¨‹çš„è¯·å‡æ€»æ•°ï¼ˆstatus IN ('leave', 'leave_pending', 'pending_approval')ï¼‰ | `1`                     |
| `absent_count`    | INT          | è¯¥è¯¾ç¨‹çš„ç¼ºå‹¤æ€»æ•°ï¼ˆstatus IN ('absent', 'truant')ï¼‰                           | `0`                     |
| `attendance_rate` | DECIMAL(5,2) | å‡ºå‹¤ç‡ï¼ˆ%ï¼‰                                                                  | `93.75`                 |

### å‡ºå‹¤ç‡è®¡ç®—å…¬å¼

```
å‡ºå‹¤ç‡ = (å‡ºå‹¤æ¬¡æ•° + è¿Ÿåˆ°æ¬¡æ•°) / æ€»è¯¾èŠ‚æ•° * 100
```

**æ³¨æ„**:

- å‡ºå‹¤ï¼ˆpresentï¼‰å’Œè¿Ÿåˆ°ï¼ˆlateï¼‰è®¡å…¥å‡ºå‹¤ç‡
- è¯·å‡ï¼ˆleaveã€leave_pendingã€pending_approvalï¼‰ä¸è®¡å…¥å‡ºå‹¤ç‡
- ç¼ºå‹¤ï¼ˆabsentã€truantï¼‰ä¸è®¡å…¥å‡ºå‹¤ç‡

### æ•°æ®æ¥æº

- **ä¸»è¡¨**: `icalink_attendance_records_history` (å†å²å‡ºå‹¤è®°å½•è¡¨)
- **å…³è”è¡¨**:
  - `v_teaching_class` (å­¦ç”Ÿé€‰è¯¾è§†å›¾)
  - `icasync.icasync_attendance_courses` (è¯¾ç¨‹è¡¨)

### ä½¿ç”¨ç¤ºä¾‹

#### ç¤ºä¾‹ 1: æŸ¥è¯¢æŸä¸ªå­¦ç”Ÿåœ¨æŸé—¨è¯¾ç¨‹çš„ç¼ºå‹¤ç»Ÿè®¡

```sql
SELECT *
FROM view_student_course_attendance_stats
WHERE student_id = '2021001'
  AND course_code = '202420252003013016705';
```

**ç»“æœç¤ºä¾‹**:

```
student_id | student_name | course_name | total_sessions | absent_count | leave_count | attendance_rate
-----------|--------------|-------------|----------------|--------------|-------------|----------------
2021001    | å¼ ä¸‰         | æ•°æ®ç»“æ„    | 16             | 2            | 1           | 87.50
```

#### ç¤ºä¾‹ 2: æŸ¥è¯¢æŸé—¨è¯¾ç¨‹æ‰€æœ‰å­¦ç”Ÿçš„ç¼ºå‹¤ç»Ÿè®¡ï¼ŒæŒ‰å‡ºå‹¤ç‡å‡åº

```sql
SELECT *
FROM view_student_course_attendance_stats
WHERE course_code = '202420252003013016705'
ORDER BY attendance_rate ASC
LIMIT 20;
```

#### ç¤ºä¾‹ 3: æŸ¥è¯¢å‡ºå‹¤ç‡ä½äº60%çš„å­¦ç”Ÿè¯¾ç¨‹è®°å½•

```sql
SELECT
    student_id,
    student_name,
    course_name,
    total_sessions,
    absent_count,
    attendance_rate
FROM view_student_course_attendance_stats
WHERE attendance_rate < 60
ORDER BY attendance_rate ASC;
```

#### ç¤ºä¾‹ 4: æŸ¥è¯¢æŸä¸ªå­¦ç”Ÿæ‰€æœ‰è¯¾ç¨‹çš„ç¼ºå‹¤æƒ…å†µ

```sql
SELECT
    course_name,
    total_sessions,
    absent_count,
    leave_count,
    attendance_rate
FROM view_student_course_attendance_stats
WHERE student_id = '2021001'
ORDER BY attendance_rate ASC;
```

#### ç¤ºä¾‹ 5: ç»Ÿè®¡å„è¯¾ç¨‹çš„å¹³å‡å‡ºå‹¤ç‡

```sql
SELECT
    course_code,
    course_name,
    COUNT(*) AS student_count,
    AVG(attendance_rate) AS avg_attendance_rate,
    AVG(absent_count) AS avg_absent_count
FROM view_student_course_attendance_stats
WHERE semester = '2024-2025-1'
GROUP BY course_code, course_name
ORDER BY avg_attendance_rate ASC;
```

---

## æ•°æ®å…³ç³»è¯´æ˜

### è¡¨å…³ç³»å›¾

```
icalink_absent_student_relations (ç¼ºå‹¤è®°å½•è¡¨)
    â”œâ”€â”€ student_id â†’ syncdb.out_xsxx.xh (å­¦ç”Ÿä¿¡æ¯)
    â”œâ”€â”€ course_code â†’ syncdb.out_jw_kcb_xs.kkh (å­¦ç”Ÿé€‰è¯¾)
    â””â”€â”€ course_code â†’ icasync.icasync_attendance_courses.course_code (è¯¾ç¨‹ä¿¡æ¯)
```

### å…³é”®å­—æ®µå…³è”

| è¡¨å                                 | å…³é”®å­—æ®µ      | å…³è”è¯´æ˜           |
| ------------------------------------ | ------------- | ------------------ |
| `icalink_absent_student_relations`   | `student_id`  | å­¦ç”ŸIDï¼ˆå­¦å·ï¼‰     |
| `icalink_absent_student_relations`   | `course_code` | è¯¾ç¨‹ä»£ç ï¼ˆå¼€è¯¾å·ï¼‰ |
| `syncdb.out_jw_kcb_xs`               | `xh`          | å­¦å·               |
| `syncdb.out_jw_kcb_xs`               | `kkh`         | å¼€è¯¾å·             |
| `icasync.icasync_attendance_courses` | `course_code` | è¯¾ç¨‹ä»£ç            |

---

## æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. ç´¢å¼•å»ºè®®

ç¡®ä¿ä»¥ä¸‹ç´¢å¼•å­˜åœ¨ä»¥æå‡æŸ¥è¯¢æ€§èƒ½ï¼š

```sql
-- icalink_absent_student_relations è¡¨
ALTER TABLE icalink_absent_student_relations
ADD INDEX idx_student_semester (student_id, semester);

ALTER TABLE icalink_absent_student_relations
ADD INDEX idx_course_semester (course_code, semester);

ALTER TABLE icalink_absent_student_relations
ADD INDEX idx_stat_date (stat_date);

-- icasync_attendance_courses è¡¨
ALTER TABLE icasync.icasync_attendance_courses
ADD INDEX idx_course_start_time (course_code, start_time);
```

### 2. æŸ¥è¯¢ä¼˜åŒ–å»ºè®®

- **ä½¿ç”¨ç´¢å¼•å­—æ®µ**: å°½é‡åœ¨ WHERE å­å¥ä¸­ä½¿ç”¨ `student_id`ã€`course_code`ã€`semester` ç­‰å·²å»ºç«‹ç´¢å¼•çš„å­—æ®µ
- **é™åˆ¶ç»“æœé›†**: ä½¿ç”¨ `LIMIT` é™åˆ¶è¿”å›çš„è®°å½•æ•°
- **é¿å…å…¨è¡¨æ‰«æ**: å§‹ç»ˆæ·»åŠ  WHERE æ¡ä»¶è¿‡æ»¤æ•°æ®

### 3. ç‰©åŒ–è§†å›¾å»ºè®®ï¼ˆå¯é€‰ï¼‰

å¦‚æœæ•°æ®é‡éå¸¸å¤§ï¼ˆè¶…è¿‡100ä¸‡æ¡è®°å½•ï¼‰ï¼Œå¯ä»¥è€ƒè™‘ï¼š

1. **åˆ›å»ºç‰©åŒ–è¡¨**ä»£æ›¿è§†å›¾
2. **å®šæ—¶æ›´æ–°**ç‰©åŒ–è¡¨ï¼ˆä¾‹å¦‚æ¯å¤©å‡Œæ™¨æ›´æ–°ä¸€æ¬¡ï¼‰
3. **æ·»åŠ æ›´æ–°æ—¶é—´æˆ³**å­—æ®µè®°å½•æœ€åæ›´æ–°æ—¶é—´

---

## æ³¨æ„äº‹é¡¹

### 1. æ—¶é—´èŒƒå›´

- ä¸¤ä¸ªè§†å›¾éƒ½åªç»Ÿè®¡**æˆªæ­¢åˆ°æ˜¨å¤©**çš„æ•°æ®ï¼ˆ`stat_date < CURDATE()`ï¼‰
- ä¸åŒ…æ‹¬å½“å¤©çš„æ•°æ®ï¼Œç¡®ä¿æ•°æ®çš„ç¨³å®šæ€§

### 2. ç¼ºå‹¤ç±»å‹

- **ç¼ºå‹¤**: `absent`ï¼ˆç¼ºå‹¤ï¼‰ã€`truant`ï¼ˆæ—·è¯¾ï¼‰
- **è¯·å‡**: `leave`ï¼ˆå·²æ‰¹å‡†è¯·å‡ï¼‰ã€`leave_pending`ï¼ˆå¾…å®¡æ‰¹è¯·å‡ï¼‰

### 3. å‡ºå‹¤ç‡è®¡ç®—

- å‡ºå‹¤ç‡ = (æ€»è¯¾èŠ‚æ•° - ç¼ºå‹¤æ¬¡æ•°) / æ€»è¯¾èŠ‚æ•° \* 100
- **è¯·å‡ç®—ä½œå‡ºå‹¤**ï¼Œä¸å½±å“å‡ºå‹¤ç‡
- **ç¼ºå‹¤å’Œæ—·è¯¾**ä¼šé™ä½å‡ºå‹¤ç‡

### 4. NULL å€¼å¤„ç†

- å¦‚æœæŸä¸ªå­¦ç”Ÿæ²¡æœ‰ä»»ä½•ç¼ºå‹¤è®°å½•ï¼Œåˆ™ä¸ä¼šå‡ºç°åœ¨è§†å›¾ä¸­
- å¦‚æœæŸé—¨è¯¾ç¨‹æ²¡æœ‰ä»»ä½•è¯¾èŠ‚ï¼Œ`total_sessions` ä¸º 0ï¼Œ`attendance_rate` ä¸º NULL

---

## å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆæˆ‘çš„å­¦ç”Ÿæ²¡æœ‰å‡ºç°åœ¨è§†å›¾ä¸­ï¼Ÿ

**A**: è§†å›¾åªåŒ…å«æœ‰ç¼ºå‹¤è®°å½•çš„å­¦ç”Ÿã€‚å¦‚æœå­¦ç”Ÿä»æœªç¼ºå‹¤æˆ–è¯·å‡ï¼Œåˆ™ä¸ä¼šå‡ºç°åœ¨è§†å›¾ä¸­ã€‚

### Q2: å¦‚ä½•æŸ¥è¯¢åŒ…æ‹¬å½“å¤©çš„æ•°æ®ï¼Ÿ

**A**: ä¿®æ”¹ WHERE æ¡ä»¶ï¼Œå°† `stat_date < CURDATE()` æ”¹ä¸º `stat_date <= CURDATE()`ã€‚

### Q3: å‡ºå‹¤ç‡ä¸ºä»€ä¹ˆæ˜¯ NULLï¼Ÿ

**A**: å½“ `total_sessions` ä¸º 0 æ—¶ï¼ˆè¯¥è¯¾ç¨‹è¿˜æ²¡æœ‰ä»»ä½•è¯¾èŠ‚ï¼‰ï¼Œå‡ºå‹¤ç‡ä¼šæ˜¾ç¤ºä¸º NULLã€‚

### Q4: å¦‚ä½•æå‡æŸ¥è¯¢æ€§èƒ½ï¼Ÿ

**A**:

1. ç¡®ä¿å·²åˆ›å»ºæ¨èçš„ç´¢å¼•
2. åœ¨ WHERE å­å¥ä¸­æ·»åŠ  `semester` æ¡ä»¶
3. ä½¿ç”¨ `LIMIT` é™åˆ¶ç»“æœé›†
4. è€ƒè™‘ä½¿ç”¨ç‰©åŒ–è¡¨ä»£æ›¿è§†å›¾

---

## æ›´æ–°æ—¥å¿—

| ç‰ˆæœ¬  | æ—¥æœŸ       | è¯´æ˜                       |
| ----- | ---------- | -------------------------- |
| 1.0.0 | 2025-10-25 | åˆå§‹ç‰ˆæœ¬ï¼Œåˆ›å»ºä¸¤ä¸ªç»Ÿè®¡è§†å›¾ |

---

## è”ç³»æ–¹å¼

å¦‚æœ‰é—®é¢˜æˆ–å»ºè®®ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿã€‚
