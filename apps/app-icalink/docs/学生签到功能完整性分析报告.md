# å­¦ç”Ÿç­¾åˆ°åŠŸèƒ½å®Œæ•´æ€§åˆ†ææŠ¥å‘Š

## æ‰§è¡Œæ‘˜è¦

æœ¬æŠ¥å‘Šå¯¹ app-icalink ä¸­çš„å­¦ç”Ÿç­¾åˆ°åŠŸèƒ½è¿›è¡Œäº†å…¨é¢çš„å®Œæ•´æ€§æ£€æŸ¥å’Œåˆ†æï¼Œé‡ç‚¹å…³æ³¨æ­£å¸¸ç­¾åˆ°æ¨¡å¼å’Œçª—å£æœŸç­¾åˆ°æ¨¡å¼çš„å®ç°æƒ…å†µã€‚

**åˆ†æç»“è®ºï¼šå‘ç°å¤šä¸ªä¸¥é‡ç¼ºé™·ï¼Œçª—å£æœŸç­¾åˆ°åŠŸèƒ½æœªå®Œæ•´å®ç°ã€‚**

---

## 1. åŠŸèƒ½éœ€æ±‚å›é¡¾

### 1.1 æ­£å¸¸ç­¾åˆ°æ¨¡å¼

- **æ—¶é—´çª—å£**ï¼šè¯¾å‰10åˆ†é’Ÿè‡³è¯¾å10åˆ†é’Ÿå†…
- **æäº¤æ•°æ®**ï¼šæ ‡å‡†ç­¾åˆ°æ•°æ®ï¼ˆä½ç½®ã€ç»çº¬åº¦ç­‰ï¼‰
- **ç‰¹å¾**ï¼šä¸åŒ…å« window_id å‚æ•°

### 1.2 çª—å£æœŸç­¾åˆ°æ¨¡å¼

- **æ—¶é—´çª—å£**ï¼šåœ¨ verification_windows å®šä¹‰çš„æ—¶é—´çª—å£å†…ï¼ˆé€šå¸¸ä¸º2-5åˆ†é’Ÿï¼‰
- **æäº¤æ•°æ®**ï¼šç­¾åˆ°æ•°æ® + window_id å‚æ•°
- **åˆ¤æ–­é€»è¾‘**ï¼šæ ¹æ®æ˜¯å¦å­˜åœ¨ verification_windows æ¥åˆ¤æ–­å½“å‰æ˜¯å¦å¤„äºçª—å£æœŸ
- **ç‰¹æ®Šå¤„ç†è¦æ±‚**ï¼š
  1. éœ€è¦ä¿®æ”¹ç­¾åˆ°çŠ¶æ€
  2. å¿…é¡»å°†ç­¾åˆ°ä¿¡æ¯ä¿å­˜åˆ° attendance_record å­—æ®µä¸­
  3. æ›´æ–° verification_status ä¸º 'verified'
  4. è®°å½• verification_round

---

## 2. ä»£ç ç»“æ„åˆ†æ

### 2.1 Controller å±‚

**æ–‡ä»¶**ï¼š`apps/app-icalink/src/controllers/AttendanceController.ts`

**ç­¾åˆ°æ¥å£**ï¼š`POST /api/icalink/v1/attendance/:course_id/checkin`

```typescript
@Post('/api/icalink/v1/attendance/:course_id/checkin')
async checkin(
  request: FastifyRequest<{
    Params: { course_id: string };
    Body: CheckinRequest;
  }>,
  reply: FastifyReply
): Promise<ApiResponse<CheckinResponse>>
```

**åˆ†æ**ï¼š

- âœ… æ¥å£å®šä¹‰æ­£ç¡®
- âœ… å‚æ•°éªŒè¯å®Œæ•´
- âœ… è°ƒç”¨ Service å±‚å¤„ç†ç­¾åˆ°é€»è¾‘

### 2.2 Service å±‚

**æ–‡ä»¶**ï¼š`apps/app-icalink/src/services/AttendanceService.ts`

**ç­¾åˆ°æ–¹æ³•**ï¼š`checkin(dto: CheckinDTO)`

**ä¸šåŠ¡æµç¨‹**ï¼š

1. âœ… æƒé™éªŒè¯ï¼ˆç¡®ä¿ç”¨æˆ·æ˜¯å­¦ç”Ÿï¼‰
2. âœ… è¯¾ç¨‹éªŒè¯ï¼ˆæ ¹æ® id æŸ¥æ‰¾è¯¾ç¨‹ï¼‰
3. âœ… é€‰è¯¾éªŒè¯ï¼ˆæ£€æŸ¥å­¦ç”Ÿæ˜¯å¦æ³¨å†Œäº†è¯¥è¯¾ç¨‹ï¼‰
4. âœ… æ—¶é—´çª—å£éªŒè¯ï¼ˆæ£€æŸ¥æ˜¯å¦åœ¨ç­¾åˆ°æ—¶é—´çª—å£å†…ï¼‰
5. âœ… å°†ç­¾åˆ°ä»»åŠ¡åŠ å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼ˆå¼‚æ­¥å¤„ç†ï¼‰

**æ—¶é—´çª—å£éªŒè¯é€»è¾‘**ï¼š`calculateCanCheckin()`

```typescript
private calculateCanCheckin(
  now: Date,
  courseStartTime: Date,
  currentStatus: AttendanceStatus,
  latestWindow: any
): boolean {
  // æ£€æŸ¥çª—å£ç­¾åˆ°æ—¶é—´
  if (latestWindow && latestWindow.status === 'open') {
    const windowOpenTime = new Date(latestWindow.open_time);
    const windowValidUntil = new Date(
      windowOpenTime.getTime() + 2 * 60 * 1000
    );
    if (now >= windowOpenTime && now <= windowValidUntil) {
      return true;
    }
  }

  // æ£€æŸ¥è‡ªä¸»ç­¾åˆ°æ—¶é—´
  const selfCheckinStart = new Date(
    courseStartTime.getTime() - 10 * 60 * 1000
  );
  const selfCheckinEnd = new Date(courseStartTime.getTime() + 10 * 60 * 1000);
  if (now >= selfCheckinStart && now <= selfCheckinEnd) {
    return true;
  }

  return false;
}
```

**åˆ†æ**ï¼š

- âœ… æ­£ç¡®åˆ¤æ–­çª—å£æœŸç­¾åˆ°æ—¶é—´ï¼ˆçª—å£å¼€å¯å2åˆ†é’Ÿå†…ï¼‰
- âœ… æ­£ç¡®åˆ¤æ–­æ­£å¸¸ç­¾åˆ°æ—¶é—´ï¼ˆè¯¾å‰10åˆ†é’Ÿè‡³è¯¾å10åˆ†é’Ÿï¼‰
- âš ï¸ ä½†æœªåŒºåˆ†ä¸¤ç§ç­¾åˆ°æ¨¡å¼çš„ä¸åŒå¤„ç†é€»è¾‘

### 2.3 Repository å±‚

**æ–‡ä»¶**ï¼š`apps/app-icalink/src/repositories/AttendanceRecordRepository.ts`

**æŸ¥è¯¢æ–¹æ³•**ï¼š`findByCourseAndStudent()`

```typescript
public async findByCourseAndStudent(
  courseId: number,
  studentId: string
): Promise<{
  id: number;
  checkin_time: Date | null;
  status: string;
  last_checkin_source: string;
  last_checkin_reason: string;
  window_id: string;
} | null>
```

**åˆ†æ**ï¼š

- âœ… æ”¯æŒæŸ¥è¯¢ç­¾åˆ°è®°å½•
- âœ… è¿”å› window_id å­—æ®µ
- âš ï¸ ç¼ºå°‘æ›´æ–°ç­¾åˆ°è®°å½•çš„æ–¹æ³•ï¼ˆç”¨äºçª—å£æœŸç­¾åˆ°ï¼‰

---

## 3. å…³é”®ç¼ºé™·åˆ†æ

### ğŸ”´ ç¼ºé™· 1ï¼šCheckinRequest ç±»å‹å®šä¹‰ç¼ºå°‘ window_id å­—æ®µ

**ä½ç½®**ï¼š`apps/app-icalink/src/types/api.ts:197-203`

**å½“å‰å®šä¹‰**ï¼š

```typescript
export interface CheckinRequest {
  location?: string;
  latitude?: number;
  longitude?: number;
  accuracy?: number;
  remark?: string;
}
```

**é—®é¢˜**ï¼š

- âŒ ç¼ºå°‘ `window_id?: string` å­—æ®µ
- âŒ æ— æ³•åŒºåˆ†æ­£å¸¸ç­¾åˆ°å’Œçª—å£æœŸç­¾åˆ°

**å½±å“**ï¼š

- å‰ç«¯æ— æ³•ä¼ é€’ window_id å‚æ•°
- åç«¯æ— æ³•è¯†åˆ«çª—å£æœŸç­¾åˆ°è¯·æ±‚

**ä¿®å¤å»ºè®®**ï¼š

```typescript
export interface CheckinRequest {
  location?: string;
  latitude?: number;
  longitude?: number;
  accuracy?: number;
  remark?: string;
  window_id?: string; // çª—å£æœŸç­¾åˆ°æ—¶å¿…å¡«
}
```

---

### ğŸ”´ ç¼ºé™· 2ï¼šç­¾åˆ°é˜Ÿåˆ—å¤„ç†å™¨ç¼ºå¤±

**ä½ç½®**ï¼š`apps/app-icalink/src/stratix.config.ts:42-48`

**å½“å‰çŠ¶æ€**ï¼š

```typescript
// Queue worker disabled - CheckinJobHandler removed
// const container = fastify.diContainer;
// const queueAdapter = container.resolve('queueAdapter');
// const checkinJobHandler = container.resolve(CheckinJobHandler);
// queueAdapter.process('checkin', (job: any) =>
//   checkinJobHandler.process(job)
// );
```

**é—®é¢˜**ï¼š

- âŒ ç­¾åˆ°é˜Ÿåˆ—å¤„ç†å™¨å·²è¢«ç¦ç”¨
- âŒ CheckinJobHandler å·²è¢«åˆ é™¤
- âŒ ç­¾åˆ°ä»»åŠ¡è™½ç„¶è¢«åŠ å…¥é˜Ÿåˆ—ï¼Œä½†æ²¡æœ‰ Worker å¤„ç†

**å½±å“**ï¼š

- **ä¸¥é‡**ï¼šæ‰€æœ‰ç­¾åˆ°è¯·æ±‚éƒ½æ— æ³•è¢«å®é™…å¤„ç†
- ç­¾åˆ°ä»»åŠ¡ä¼šä¸€ç›´å †ç§¯åœ¨é˜Ÿåˆ—ä¸­
- å­¦ç”Ÿç­¾åˆ°åä¸ä¼šæœ‰ä»»ä½•å®é™…æ•ˆæœ

**ä¿®å¤å»ºè®®**ï¼š

1. é‡æ–°å®ç° CheckinJobHandler
2. åœ¨ stratix.config.ts ä¸­æ³¨å†Œ Worker
3. å®ç°çª—å£æœŸç­¾åˆ°çš„ç‰¹æ®Šå¤„ç†é€»è¾‘

---

### ğŸ”´ ç¼ºé™· 3ï¼šçª—å£æœŸç­¾åˆ°çš„ç‰¹æ®Šå¤„ç†é€»è¾‘ç¼ºå¤±

**é—®é¢˜**ï¼š
å³ä½¿ç­¾åˆ°é˜Ÿåˆ—å¤„ç†å™¨å­˜åœ¨ï¼Œå½“å‰ä»£ç ä¹Ÿæ²¡æœ‰å®ç°çª—å£æœŸç­¾åˆ°çš„ç‰¹æ®Šå¤„ç†é€»è¾‘ã€‚

**ç¼ºå¤±çš„é€»è¾‘**ï¼š

1. **åˆ¤æ–­æ˜¯å¦ä¸ºçª—å£æœŸç­¾åˆ°**

   ```typescript
   // åº”è¯¥æ ¹æ® request.window_id åˆ¤æ–­
   const isWindowCheckin = !!request.window_id;
   ```

2. **éªŒè¯çª—å£çŠ¶æ€**

   ```typescript
   if (isWindowCheckin) {
     const window = await verificationWindowRepository.findByWindowId(
       request.window_id
     );
     if (!window || window.status !== 'open') {
       return error('éªŒè¯çª—å£å·²å…³é—­');
     }
   }
   ```

3. **æ›´æ–°ç­¾åˆ°è®°å½•ï¼ˆçª—å£æœŸç­¾åˆ°ï¼‰**

   ```typescript
   if (isWindowCheckin) {
     await attendanceRecordRepository.update(record.id, {
       status: 'present',
       last_checkin_source: 'window',
       window_id: request.window_id,
       verification_status: 'verified',
       verification_round: window.verification_round,
       last_verification_time: new Date(),
       checkin_time: new Date()
       // ... å…¶ä»–å­—æ®µ
     });
   }
   ```

4. **ä¿å­˜åˆ° attendance_record å­—æ®µ**
   - æ ¹æ®éœ€æ±‚æè¿°ï¼Œçª—å£æœŸç­¾åˆ°éœ€è¦å°†ç­¾åˆ°ä¿¡æ¯ä¿å­˜åˆ° attendance_record å­—æ®µ
   - å½“å‰ä»£ç ä¸­æ²¡æœ‰è¿™ä¸ªå­—æ®µçš„å¤„ç†é€»è¾‘

---

### ğŸŸ¡ ç¼ºé™· 4ï¼šæ•°æ®åº“å­—æ®µç¼ºå¤±

**ä½ç½®**ï¼š`apps/app-icalink/src/types/database.ts:80-111`

**å½“å‰å®šä¹‰**ï¼š

```typescript
export interface IcalinkAttendanceRecord {
  id: ColumnType<number, number | undefined, number>;
  attendance_course_id: number;
  student_id: string;
  student_name: string;
  // ... å…¶ä»–å­—æ®µ
  last_checkin_source?: 'regular' | 'window' | 'manual';
  last_checkin_reason?: string;
  window_id?: string;
  // âŒ ç¼ºå°‘ä»¥ä¸‹å­—æ®µï¼š
  // verification_status?: 'pending' | 'verified' | 'failed';
  // verification_round?: number;
  // last_verification_time?: Date;
}
```

**é—®é¢˜**ï¼š

- âŒ ç¼ºå°‘ `verification_status` å­—æ®µ
- âŒ ç¼ºå°‘ `verification_round` å­—æ®µ
- âŒ ç¼ºå°‘ `last_verification_time` å­—æ®µ

**å½±å“**ï¼š

- æ— æ³•è®°å½•éªŒè¯ç­¾åˆ°çš„çŠ¶æ€
- æ— æ³•è¿½è¸ªéªŒè¯è½®æ¬¡
- æ— æ³•è®°å½•æœ€åéªŒè¯æ—¶é—´

**ä¿®å¤å»ºè®®**ï¼š

1. åœ¨æ•°æ®åº“è¡¨ä¸­æ·»åŠ è¿™äº›å­—æ®µ
2. æ›´æ–° TypeScript ç±»å‹å®šä¹‰
3. æ›´æ–° Repository çš„ Schema å®šä¹‰

---

### ğŸŸ¡ ç¼ºé™· 5ï¼šRepository ç¼ºå°‘çª—å£æœŸç­¾åˆ°ç›¸å…³æ–¹æ³•

**ä½ç½®**ï¼š`apps/app-icalink/src/repositories/AttendanceRecordRepository.ts`

**ç¼ºå¤±çš„æ–¹æ³•**ï¼š

1. **æ›´æ–°éªŒè¯çŠ¶æ€**

   ```typescript
   async updateVerificationStatus(
     recordId: number,
     windowId: string,
     verificationRound: number
   ): Promise<void>
   ```

2. **æ‰¹é‡æ›´æ–°éªŒè¯çŠ¶æ€**ï¼ˆç”¨äºçª—å£å¼€å¯æ—¶ï¼‰

   ```typescript
   async batchUpdateVerificationStatus(
     courseId: number,
     verificationRound: number,
     status: 'pending'
   ): Promise<number>
   ```

3. **æ‰¹é‡åˆ¤å®šéªŒè¯å¤±è´¥**ï¼ˆç”¨äºçª—å£å…³é—­æ—¶ï¼‰
   ```typescript
   async batchJudgeVerificationFailed(
     courseId: number,
     verificationRound: number
   ): Promise<{ truantCount: number; absentCount: number }>
   ```

---

## 4. æ–‡æ¡£ä¸å®ç°çš„å·®å¼‚

### 4.1 æŠ€æœ¯è®¾è®¡æ–‡æ¡£

**æ–‡ä»¶**ï¼š`apps/app-icalink/docs/ç­¾åˆ°ç³»ç»ŸåŠŸèƒ½æ‰©å±•-å®Œæ•´æŠ€æœ¯æ–¹æ¡ˆ.md`

æ–‡æ¡£ä¸­è¯¦ç»†æè¿°äº†çª—å£æœŸç­¾åˆ°çš„å®Œæ•´æµç¨‹ï¼š

1. **å¼€å¯éªŒè¯çª—å£**ï¼ˆå·²å®ç°ï¼‰
   - âœ… åˆ›å»º verification_window è®°å½•
   - âœ… æ‰¹é‡æ›´æ–°ç­¾åˆ°è®°å½•çš„ verification_status ä¸º 'pending'

2. **çª—å£æœŸç­¾åˆ°**ï¼ˆæœªå®ç°ï¼‰
   - âŒ éªŒè¯çª—å£çŠ¶æ€
   - âŒ æ›´æ–°ç­¾åˆ°è®°å½•
   - âŒ è®°å½•å®¡è®¡æ—¥å¿—
   - âŒ æ›´æ–°çª—å£å®é™…ç­¾åˆ°äººæ•°

3. **çª—å£å…³é—­åˆ¤å®š**ï¼ˆæœªå®ç°ï¼‰
   - âŒ æ‰¹é‡åˆ¤å®šæœªéªŒè¯è®°å½•ä¸º 'truant'
   - âŒ æ‰¹é‡æ’å…¥å®¡è®¡æ—¥å¿—
   - âŒ åˆ›å»ºæ—·è¯¾ç¼ºå‹¤è®°å½•

### 4.2 å®ç°çŠ¶æ€å¯¹æ¯”

| åŠŸèƒ½æ¨¡å—       | æ–‡æ¡£è¦æ±‚ | å®ç°çŠ¶æ€ | å®Œæˆåº¦ |
| -------------- | -------- | -------- | ------ |
| åˆ›å»ºç­¾åˆ°çª—å£   | âœ…       | âœ…       | 100%   |
| çª—å£æœŸç­¾åˆ°åˆ¤æ–­ | âœ…       | âš ï¸       | 50%    |
| çª—å£æœŸç­¾åˆ°å¤„ç† | âœ…       | âŒ       | 0%     |
| ç­¾åˆ°è®°å½•æ›´æ–°   | âœ…       | âŒ       | 0%     |
| éªŒè¯çŠ¶æ€ç®¡ç†   | âœ…       | âŒ       | 0%     |
| çª—å£å…³é—­åˆ¤å®š   | âœ…       | âŒ       | 0%     |
| å®¡è®¡æ—¥å¿—è®°å½•   | âœ…       | âŒ       | 0%     |

---

## 5. ä¿®å¤å»ºè®®

### 5.1 ç´§æ€¥ä¿®å¤ï¼ˆP0ï¼‰

1. **é‡æ–°å®ç°ç­¾åˆ°é˜Ÿåˆ—å¤„ç†å™¨**
   - åˆ›å»º `CheckinJobHandler` ç±»
   - å®ç°ç­¾åˆ°ä»»åŠ¡çš„å®é™…å¤„ç†é€»è¾‘
   - åœ¨ stratix.config.ts ä¸­æ³¨å†Œ Worker

2. **æ·»åŠ  window_id å­—æ®µåˆ° CheckinRequest**
   - æ›´æ–°ç±»å‹å®šä¹‰
   - å‰ç«¯ä¼ é€’ window_id å‚æ•°

3. **å®ç°çª—å£æœŸç­¾åˆ°çš„ç‰¹æ®Šå¤„ç†é€»è¾‘**
   - åˆ¤æ–­æ˜¯å¦ä¸ºçª—å£æœŸç­¾åˆ°
   - éªŒè¯çª—å£çŠ¶æ€
   - æ›´æ–°ç­¾åˆ°è®°å½•
   - æ›´æ–°éªŒè¯çŠ¶æ€

### 5.2 é‡è¦ä¿®å¤ï¼ˆP1ï¼‰

4. **æ·»åŠ æ•°æ®åº“å­—æ®µ**
   - verification_status
   - verification_round
   - last_verification_time

5. **æ‰©å±• Repository æ–¹æ³•**
   - updateVerificationStatus
   - batchUpdateVerificationStatus
   - batchJudgeVerificationFailed

### 5.3 ä¼˜åŒ–æ”¹è¿›ï¼ˆP2ï¼‰

6. **å®ç°çª—å£å…³é—­åˆ¤å®šé€»è¾‘**
   - å®šæ—¶ä»»åŠ¡æ‰«æè¶…æ—¶çª—å£
   - æ‰¹é‡åˆ¤å®šæœªéªŒè¯è®°å½•
   - åˆ›å»ºç¼ºå‹¤è®°å½•

7. **æ·»åŠ å®¡è®¡æ—¥å¿—**
   - è®°å½•ç­¾åˆ°å°è¯•
   - è®°å½•éªŒè¯ç»“æœ
   - è®°å½•çª—å£æ“ä½œ

---

## 6. æ€»ç»“

### 6.1 ä¸»è¦é—®é¢˜

1. **ç­¾åˆ°é˜Ÿåˆ—å¤„ç†å™¨ç¼ºå¤±**ï¼šè¿™æ˜¯æœ€ä¸¥é‡çš„é—®é¢˜ï¼Œå¯¼è‡´æ‰€æœ‰ç­¾åˆ°è¯·æ±‚éƒ½æ— æ³•è¢«å®é™…å¤„ç†
2. **çª—å£æœŸç­¾åˆ°é€»è¾‘æœªå®ç°**ï¼šè™½ç„¶æœ‰çª—å£æœŸåˆ¤æ–­ï¼Œä½†ç¼ºå°‘å®é™…çš„å¤„ç†é€»è¾‘
3. **ç±»å‹å®šä¹‰ä¸å®Œæ•´**ï¼šCheckinRequest ç¼ºå°‘ window_id å­—æ®µ
4. **æ•°æ®åº“å­—æ®µç¼ºå¤±**ï¼šç¼ºå°‘éªŒè¯çŠ¶æ€ç›¸å…³å­—æ®µ
5. **Repository æ–¹æ³•ä¸è¶³**ï¼šç¼ºå°‘çª—å£æœŸç­¾åˆ°ç›¸å…³çš„æ•°æ®æ“ä½œæ–¹æ³•

### 6.2 å½±å“è¯„ä¼°

- **åŠŸèƒ½å®Œæ•´æ€§**ï¼šçº¦ 30%ï¼ˆä»…çª—å£åˆ›å»ºåŠŸèƒ½å®Œæ•´ï¼‰
- **å¯ç”¨æ€§**ï¼š0%ï¼ˆç­¾åˆ°å¤„ç†å™¨ç¼ºå¤±ï¼ŒåŠŸèƒ½å®Œå…¨ä¸å¯ç”¨ï¼‰
- **æ•°æ®ä¸€è‡´æ€§**ï¼šä½ï¼ˆç¼ºå°‘éªŒè¯çŠ¶æ€å­—æ®µï¼‰

### 6.3 å»ºè®®ä¼˜å…ˆçº§

1. **ç«‹å³ä¿®å¤**ï¼šé‡æ–°å®ç°ç­¾åˆ°é˜Ÿåˆ—å¤„ç†å™¨
2. **ç´§æ€¥ä¿®å¤**ï¼šå®ç°çª—å£æœŸç­¾åˆ°çš„ç‰¹æ®Šå¤„ç†é€»è¾‘
3. **é‡è¦ä¿®å¤**ï¼šæ·»åŠ ç¼ºå¤±çš„æ•°æ®åº“å­—æ®µå’Œç±»å‹å®šä¹‰
4. **åç»­ä¼˜åŒ–**ï¼šå®ç°çª—å£å…³é—­åˆ¤å®šå’Œå®¡è®¡æ—¥å¿—

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**ï¼š2025-10-21
**åˆ†æäººå‘˜**ï¼šAugment Agent
**ç‰ˆæœ¬**ï¼šv1.0
