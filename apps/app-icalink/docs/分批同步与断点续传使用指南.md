# 分批同步与断点续传使用指南

## 📋 功能概述

WriteSheetService 现在支持分批同步和断点续传功能，可以：

1. **获取总记录数**：在同步开始前获取数据库中的总记录数
2. **分批读取数据**：使用 LIMIT 和 OFFSET 分页读取数据
3. **分批写入 WPS**：每批数据独立写入 WPS 多维表
4. **记录同步进度**：记录当前同步的偏移量（行号）
5. **断点续传**：支持从上次中断的位置继续同步
6. **详细日志**：完整的进度追踪和统计信息

## 🎯 核心特性

### 1. 分批同步

- **批量大小可配置**：默认 100 条/批，可通过构造函数配置
- **自动分批处理**：自动计算总批次数并逐批处理
- **进度显示**：实时显示当前批次和总批次 `[1/10]`
- **百分比进度**：显示已同步百分比 `(50%)`

### 2. 断点续传

- **进度记录**：记录当前偏移量（currentOffset）和已同步数量（syncedCount）
- **自动恢复**：可以从上次中断位置继续同步
- **状态管理**：跟踪同步状态（未开始/进行中/已完成/失败/暂停）
- **失败重试**：支持失败后重新同步

### 3. 错误处理

- **批次隔离**：单个批次失败不影响其他批次
- **错误收集**：收集所有错误信息到摘要中
- **失败统计**：统计成功批次和失败批次数量
- **可选中断**：可配置失败时是否立即停止

## 🚀 使用方法

### 方式 1：从头开始同步

```typescript
const service = new WriteSheetService(logger, wasV7ApiDbsheet, repo);

// 从头开始同步
const summary = await service.triggerSync(false);

console.log(summary);
// {
//   success: true,
//   totalCount: 1000,
//   syncedCount: 1000,
//   failedCount: 0,
//   totalBatches: 10,
//   successBatches: 10,
//   failedBatches: 0,
//   startedAt: Date,
//   completedAt: Date,
//   duration: 12345,
//   errors: []
// }
```

### 方式 2：断点续传

```typescript
// 第一次同步（假设中断了）
const summary1 = await service.triggerSync(false);
// 同步了 500 条后中断

// 从上次位置继续
const summary2 = await service.triggerSync(true);
// 从第 500 条继续同步剩余的 500 条
```

### 方式 3：查看同步进度

```typescript
// 开始同步
service.triggerSync(false);

// 在另一个地方查看进度
const progress = service.getSyncProgress();
console.log(progress);
// {
//   fileId: '459309344199',
//   sheetId: 1,
//   status: 'in_progress',
//   totalCount: 1000,
//   syncedCount: 500,
//   currentOffset: 500,
//   batchSize: 100,
//   startedAt: Date,
//   lastUpdatedAt: Date
// }
```

### 方式 4：重置进度

```typescript
// 清除断点信息，下次从头开始
service.resetSyncProgress();

// 重新同步
await service.triggerSync(false);
```

## 📊 日志输出示例

### 完整同步流程

```
[INFO] 手动触发同步 { resumeFromLast: false }
[INFO] 开始同步缺勤学生关系数据到 WPS 多维表 { resumeFromLast: false }
[INFO] 数据库中共有 1000 条缺勤记录
[INFO] 初始化新的同步任务 { fileId: '459309344199', sheetId: 1, status: 'in_progress', totalCount: 1000, syncedCount: 0, currentOffset: 0, batchSize: 100, ... }
[INFO] 从偏移量 0 开始同步 { totalCount: 1000, batchSize: 100, estimatedBatches: 10 }

[INFO] [1/10] 开始同步第 1 批，偏移量: 0
[INFO] [1/10] 读取到 100 条记录
[DEBUG] 批次 1: 准备写入 100 条记录
[DEBUG] 批次 1: 写入成功 { requestCount: 100, responseCount: 100 }
[INFO] [1/10] ✅ 第 1 批同步成功，已同步 100/1000 条记录 (10%)

[INFO] [2/10] 开始同步第 2 批，偏移量: 100
[INFO] [2/10] 读取到 100 条记录
[DEBUG] 批次 2: 准备写入 100 条记录
[DEBUG] 批次 2: 写入成功 { requestCount: 100, responseCount: 100 }
[INFO] [2/10] ✅ 第 2 批同步成功，已同步 200/1000 条记录 (20%)

...

[INFO] [10/10] 开始同步第 10 批，偏移量: 900
[INFO] [10/10] 读取到 100 条记录
[DEBUG] 批次 10: 准备写入 100 条记录
[DEBUG] 批次 10: 写入成功 { requestCount: 100, responseCount: 100 }
[INFO] [10/10] ✅ 第 10 批同步成功，已同步 1000/1000 条记录 (100%)

[INFO] 同步任务完成 { status: 'completed', syncedCount: 1000, totalCount: 1000 }
[INFO] 同步完成 { success: true, totalCount: 1000, syncedCount: 1000, failedCount: 0, totalBatches: 10, successBatches: 10, failedBatches: 0, duration: 12345, errors: [] }
```

### 断点续传流程

```
[INFO] 手动触发同步 { resumeFromLast: true }
[INFO] 开始同步缺勤学生关系数据到 WPS 多维表 { resumeFromLast: true }
[INFO] 数据库中共有 1000 条缺勤记录
[INFO] 从上次中断位置继续同步 { lastOffset: 500, syncedCount: 500 }
[INFO] 从偏移量 500 开始同步 { totalCount: 1000, batchSize: 100, estimatedBatches: 5 }

[INFO] [6/10] 开始同步第 6 批，偏移量: 500
[INFO] [6/10] 读取到 100 条记录
[INFO] [6/10] ✅ 第 6 批同步成功，已同步 600/1000 条记录 (60%)

...
```

### 部分失败流程

```
[INFO] [3/10] 开始同步第 3 批，偏移量: 200
[INFO] [3/10] 读取到 100 条记录
[ERROR] 批次 3: 写入失败 Error: Network timeout
[ERROR] [3/10] ❌ 第 3 批同步失败: Network timeout

[INFO] [4/10] 开始同步第 4 批，偏移量: 300
[INFO] [4/10] 读取到 100 条记录
[INFO] [4/10] ✅ 第 4 批同步成功，已同步 400/1000 条记录 (40%)

...

[INFO] 同步完成 { success: false, totalCount: 1000, syncedCount: 900, failedCount: 100, totalBatches: 10, successBatches: 9, failedBatches: 1, errors: ['第 3 批同步失败: Network timeout'] }
```

## 🔧 配置参数

### 批量大小配置

```typescript
// 默认 100 条/批
const service = new WriteSheetService(logger, adapter, repo);

// 自定义批量大小
const service = new WriteSheetService(logger, adapter, repo, {
  batchSize: 50 // 每批 50 条
});
```

### 批量大小建议

| 场景 | 推荐批量大小 | 说明 |
|------|------------|------|
| 小数据量（< 1000） | 100-200 | 快速完成 |
| 中等数据量（1000-10000） | 100 | 平衡性能和稳定性 |
| 大数据量（> 10000） | 50-100 | 降低单次请求压力 |
| 网络不稳定 | 50 | 减少失败风险 |
| 网络稳定 | 200 | 提高效率 |

## 📈 性能指标

### 同步速度估算

假设：
- 批量大小：100 条/批
- 单批处理时间：1-2 秒（包含读取、转换、写入、延迟）
- 批次间延迟：100ms

**1000 条记录**：
- 总批次：10 批
- 预计耗时：10-20 秒

**10000 条记录**：
- 总批次：100 批
- 预计耗时：100-200 秒（约 2-3 分钟）

### 优化建议

1. **增加批量大小**：在网络稳定的情况下，可以增加到 200 条/批
2. **减少延迟**：如果 API 没有频率限制，可以减少批次间延迟
3. **并发处理**：未来可以支持多批次并发写入（需要注意 API 限制）

## 🎨 同步状态说明

### SyncStatus 枚举

| 状态 | 值 | 说明 |
|------|---|------|
| NOT_STARTED | 'not_started' | 未开始 |
| IN_PROGRESS | 'in_progress' | 同步中 |
| COMPLETED | 'completed' | 已完成 |
| FAILED | 'failed' | 失败 |
| PAUSED | 'paused' | 已暂停 |

### SyncProgress 接口

```typescript
interface SyncProgress {
  fileId: string;           // WPS 文件 ID
  sheetId: number;          // WPS Sheet ID
  status: SyncStatus;       // 同步状态
  totalCount: number;       // 总记录数
  syncedCount: number;      // 已同步记录数
  currentOffset: number;    // 当前偏移量（下次从这里开始）
  batchSize: number;        // 批次大小
  startedAt?: Date;         // 开始时间
  completedAt?: Date;       // 完成时间
  lastUpdatedAt?: Date;     // 最后更新时间
  errorMessage?: string;    // 错误信息
  failureCount?: number;    // 失败次数
}
```

### SyncSummary 接口

```typescript
interface SyncSummary {
  success: boolean;         // 是否成功
  totalCount: number;       // 总记录数
  syncedCount: number;      // 成功同步数
  failedCount: number;      // 失败数
  totalBatches: number;     // 总批次数
  successBatches: number;   // 成功批次数
  failedBatches: number;    // 失败批次数
  startedAt: Date;          // 开始时间
  completedAt: Date;        // 完成时间
  duration: number;         // 耗时（毫秒）
  errors: string[];         // 错误信息列表
}
```

## 💡 最佳实践

### 1. 首次同步

```typescript
// 清除旧的进度记录
service.resetSyncProgress();

// 从头开始同步
const summary = await service.triggerSync(false);

if (summary.success) {
  console.log(`✅ 同步成功：${summary.syncedCount}/${summary.totalCount} 条记录`);
} else {
  console.error(`❌ 同步失败：${summary.errors.join(', ')}`);
}
```

### 2. 定时同步

```typescript
// 每小时同步一次
setInterval(async () => {
  try {
    const summary = await service.triggerSync(false);
    console.log('定时同步完成', summary);
  } catch (error) {
    console.error('定时同步失败', error);
  }
}, 3600000); // 1 小时
```

### 3. 失败重试

```typescript
async function syncWithRetry(maxRetries = 3) {
  for (let i = 0; i < maxRetries; i++) {
    try {
      const summary = await service.triggerSync(i > 0); // 重试时使用断点续传
      
      if (summary.success) {
        console.log('同步成功');
        return summary;
      } else if (summary.failedBatches > 0) {
        console.log(`第 ${i + 1} 次尝试，部分失败，准备重试...`);
        await delay(5000); // 等待 5 秒
      }
    } catch (error) {
      console.error(`第 ${i + 1} 次尝试失败`, error);
      if (i < maxRetries - 1) {
        await delay(5000);
      }
    }
  }
  
  throw new Error('达到最大重试次数');
}
```

### 4. 监控同步进度

```typescript
// 启动同步
service.triggerSync(false);

// 定期检查进度
const progressInterval = setInterval(() => {
  const progress = service.getSyncProgress();
  
  if (progress) {
    const percentage = Math.round((progress.syncedCount / progress.totalCount) * 100);
    console.log(`同步进度: ${progress.syncedCount}/${progress.totalCount} (${percentage}%)`);
    
    if (progress.status === 'completed' || progress.status === 'failed') {
      clearInterval(progressInterval);
    }
  }
}, 1000); // 每秒检查一次
```

## 🐛 故障排查

### 问题 1：同步中断后无法继续

**症状**：调用 `triggerSync(true)` 但从头开始同步

**原因**：进度信息丢失（服务重启或进度被重置）

**解决方案**：
```typescript
// 检查进度是否存在
const progress = service.getSyncProgress();
if (!progress) {
  console.log('没有进度记录，从头开始');
  await service.triggerSync(false);
} else {
  console.log('从上次位置继续');
  await service.triggerSync(true);
}
```

### 问题 2：部分批次失败

**症状**：某些批次写入失败，但同步继续

**原因**：网络不稳定或 API 限制

**解决方案**：
```typescript
// 1. 减小批量大小
const service = new WriteSheetService(logger, adapter, repo, {
  batchSize: 50
});

// 2. 增加重试机制
await syncWithRetry(3);
```

### 问题 3：同步速度慢

**症状**：同步大量数据耗时很长

**原因**：批量大小太小或批次间延迟太长

**解决方案**：
```typescript
// 增加批量大小
const service = new WriteSheetService(logger, adapter, repo, {
  batchSize: 200
});

// 或者减少批次间延迟（修改代码中的 delay(100)）
```

## 📚 相关文档

- [WriteSheetService 使用说明](./WriteSheetService使用说明.md)
- [WPS 多维表字段映射表](./WPS多维表字段映射表.md)
- [快速参考](./快速参考.md)

## 🔮 未来优化

1. **进度持久化**：将进度保存到数据库，支持服务重启后继续
2. **并发处理**：支持多批次并发写入，提高同步速度
3. **增量同步**：只同步新增或修改的记录
4. **暂停/恢复**：支持手动暂停和恢复同步
5. **同步历史**：记录每次同步的历史记录
6. **Web UI**：提供可视化的同步进度界面

## 📝 总结

分批同步和断点续传功能为大数据量同步提供了可靠的解决方案：

✅ **分批处理**：避免一次性加载大量数据导致内存溢出
✅ **断点续传**：支持从中断位置继续，不需要重新同步
✅ **进度追踪**：实时显示同步进度和百分比
✅ **错误隔离**：单个批次失败不影响其他批次
✅ **详细日志**：完整的日志记录便于调试和监控
✅ **灵活配置**：可配置批量大小和同步策略

建议在生产环境中使用此功能进行大数据量同步，并配合监控和告警机制确保同步的可靠性。

