# Stratix æ¶ˆæ¯é˜Ÿåˆ—å¯åŠ¨æœºåˆ¶è¯¦è§£

## ğŸ“‹ æ¦‚è¿°

Stratix æ¡†æ¶ä½¿ç”¨ **BullMQ** ä½œä¸ºæ¶ˆæ¯é˜Ÿåˆ—å®ç°ï¼Œé€šè¿‡ `@stratix/queue` æ’ä»¶æä¾›ç»Ÿä¸€çš„é˜Ÿåˆ—ç®¡ç†æ¥å£ã€‚æ¶ˆæ¯é˜Ÿåˆ—é‡‡ç”¨ **Adapter æ¨¡å¼**ï¼Œéµå¾ª Stratix æ¡†æ¶çš„æ’ä»¶åŒ–æ¶æ„å’Œä¾èµ–æ³¨å…¥åŸåˆ™ã€‚

---

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### æ ¸å¿ƒç»„ä»¶

1. **@stratix/queue æ’ä»¶**
   - ä½ç½®ï¼š`packages/queue/src/index.ts`
   - èŒè´£ï¼šæ’ä»¶å…¥å£ï¼Œä½¿ç”¨ `withRegisterAutoDI` å¯ç”¨è‡ªåŠ¨ä¾èµ–æ³¨å…¥
   - ç”Ÿå‘½å‘¨æœŸï¼šåº”ç”¨çº§ SINGLETON

2. **QueueAdapter**
   - ä½ç½®ï¼š`packages/queue/src/adapters/queue.adapter.ts`
   - èŒè´£ï¼šå°è£… BullMQ çš„ Queue å’Œ Worker æ“ä½œ
   - æ³¨å†Œåç§°ï¼š`queueAdapter`
   - ç”Ÿå‘½å‘¨æœŸï¼šSINGLETONï¼ˆåº”ç”¨çº§å•ä¾‹ï¼‰

3. **RedisAdapter**
   - ä½ç½®ï¼š`@stratix/redis` æ’ä»¶
   - èŒè´£ï¼šæä¾› Redis è¿æ¥ï¼ˆBullMQ ä¾èµ– Redisï¼‰
   - æ³¨å†Œåç§°ï¼š`redisClient`
   - ç”Ÿå‘½å‘¨æœŸï¼šSINGLETON

---

## ğŸš€ å¯åŠ¨æµç¨‹

### 1. æ’ä»¶æ³¨å†Œé˜¶æ®µï¼ˆåº”ç”¨å¯åŠ¨æ—¶ï¼‰

```typescript
// apps/app-icalink/src/stratix.config.ts

export default (sensitiveConfig: Record<string, any> = {}): StratixConfig => {
  return {
    plugins: [
      // ç¬¬ä¸€æ­¥ï¼šæ³¨å†Œ Redis æ’ä»¶ï¼ˆQueueAdapter çš„ä¾èµ–ï¼‰
      {
        name: '@stratix/redis',
        plugin: redisPlugin,
        options: {
          host: redisConfig.host || 'localhost',
          port: redisConfig.port || 6379,
          password: redisConfig.password,
          db: redisConfig.db || 0
        }
      },
      
      // ç¬¬äºŒæ­¥ï¼šæ³¨å†Œ Queue æ’ä»¶
      {
        name: '@stratix/queue',
        plugin: queuePlugin,
        options: {
          defaultJobOptions: {
            removeOnComplete: true,      // è‡ªåŠ¨åˆ é™¤å·²å®Œæˆçš„ä»»åŠ¡
            removeOnFail: 100,            // ä¿ç•™æœ€è¿‘100ä¸ªå¤±è´¥ä»»åŠ¡
            attempts: 3,                  // æœ€å¤šé‡è¯•3æ¬¡
            backoff: {
              type: 'exponential',
              delay: 1000                 // 1s, 2s, 4s æŒ‡æ•°é€€é¿
            }
          }
        }
      }
    ]
  };
};
```

**å¯åŠ¨é¡ºåº**ï¼š
1. Stratix åº”ç”¨å¯åŠ¨
2. æŒ‰é¡ºåºåŠ è½½æ’ä»¶ï¼š`@stratix/redis` â†’ `@stratix/queue`
3. `@stratix/queue` æ’ä»¶è°ƒç”¨ `withRegisterAutoDI`
4. è‡ªåŠ¨æ‰«æ `adapters/*.{ts,js}` ç›®å½•
5. å‘ç°å¹¶æ³¨å†Œ `QueueAdapter` åˆ°å®¹å™¨ï¼ˆåç§°ï¼š`queueAdapter`ï¼‰

### 2. QueueAdapter åˆå§‹åŒ–

```typescript
// packages/queue/src/adapters/queue.adapter.ts

export default class QueueAdapter implements IQueueAdapter {
  constructor(container: AwilixContainer) {
    // ä»å®¹å™¨è§£æä¾èµ–
    const options = container.resolve<QueuePluginOptions>('config');
    this.logger = container.resolve<Logger>('logger');
    this.redisClient = container.resolve<RedisAdapter>('redisClient');
    
    // ä¿å­˜é»˜è®¤é…ç½®
    this.defaultQueueOptions = options.defaultQueueOptions;
    this.defaultWorkerOptions = options.defaultWorkerOptions;
    
    this.logger.info('QueueAdapter initialized');
  }
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… QueueAdapter åœ¨æ’ä»¶åŠ è½½æ—¶ç«‹å³åˆå§‹åŒ–
- âœ… ä¾èµ– `redisClient`ï¼ˆå¿…é¡»å…ˆæ³¨å†Œ Redis æ’ä»¶ï¼‰
- âœ… ä¸ä¼šç«‹å³åˆ›å»º Queue æˆ– Workerï¼ˆå»¶è¿Ÿåˆ›å»ºï¼‰

### 3. Queue å»¶è¿Ÿåˆ›å»ºï¼ˆé¦–æ¬¡ä½¿ç”¨æ—¶ï¼‰

```typescript
public getQueue(queueName: string): Queue {
  if (!this.queues.has(queueName)) {
    this.logger.info(`Creating new queue: ${queueName}`);
    const queue = new Queue(queueName, {
      connection: this.redisClient.getClient(),  // ä½¿ç”¨ Redis è¿æ¥
      ...this.defaultQueueOptions
    });
    this.queues.set(queueName, queue);
  }
  return this.queues.get(queueName)!;
}
```

**è§¦å‘æ—¶æœº**ï¼š
- è°ƒç”¨ `queueAdapter.add('queue-name', data)` æ—¶
- è°ƒç”¨ `queueAdapter.process('queue-name', processor)` æ—¶

### 4. Worker æ³¨å†Œï¼ˆåº”ç”¨å¯åŠ¨åï¼‰

```typescript
// apps/app-icalink/src/stratix.config.ts

hooks: {
  afterFastifyCreated: async (fastify: any) => {
    // å½“å‰å·²ç¦ç”¨ - CheckinJobHandler å·²åˆ é™¤
    // const container = fastify.diContainer;
    // const queueAdapter = container.resolve('queueAdapter');
    // const checkinJobHandler = container.resolve(CheckinJobHandler);
    // queueAdapter.process('checkin', (job: any) =>
    //   checkinJobHandler.process(job)
    // );
  }
}
```

**Worker æ³¨å†Œæµç¨‹**ï¼š
1. Fastify å®ä¾‹åˆ›å»ºå®Œæˆåè§¦å‘ `afterFastifyCreated` é’©å­
2. ä»å®¹å™¨è§£æ `queueAdapter` å’Œ Job Handler
3. è°ƒç”¨ `queueAdapter.process(queueName, processor)` æ³¨å†Œ Worker
4. Worker å¼€å§‹ç›‘å¬é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡

---

## ğŸ”„ ç”Ÿå‘½å‘¨æœŸç®¡ç†

### å¯åŠ¨é˜¶æ®µ

```
åº”ç”¨å¯åŠ¨
  â†“
åŠ è½½ @stratix/redis æ’ä»¶
  â†“
åŠ è½½ @stratix/queue æ’ä»¶
  â†“
withRegisterAutoDI è‡ªåŠ¨æ‰«æ
  â†“
æ³¨å†Œ QueueAdapter (SINGLETON)
  â†“
QueueAdapter æ„é€ å‡½æ•°æ‰§è¡Œ
  â†“
è§£æ redisClient ä¾èµ–
  â†“
QueueAdapter åˆå§‹åŒ–å®Œæˆ
  â†“
afterFastifyCreated é’©å­è§¦å‘
  â†“
æ³¨å†Œ Worker (å¯é€‰)
  â†“
åº”ç”¨å°±ç»ª
```

### è¿è¡Œé˜¶æ®µ

```
ä¸šåŠ¡ä»£ç è°ƒç”¨ queueAdapter.add()
  â†“
getQueue() æ£€æŸ¥é˜Ÿåˆ—æ˜¯å¦å­˜åœ¨
  â†“
ä¸å­˜åœ¨ â†’ åˆ›å»ºæ–° Queue å®ä¾‹
  â†“
Queue è¿æ¥åˆ° Redis
  â†“
æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—
  â†“
Worker ç›‘å¬åˆ°æ–°ä»»åŠ¡
  â†“
æ‰§è¡Œ processor å‡½æ•°
  â†“
ä»»åŠ¡å®Œæˆ/å¤±è´¥
  â†“
æ ¹æ®é…ç½®åˆ é™¤æˆ–ä¿ç•™ä»»åŠ¡
```

### å…³é—­é˜¶æ®µ

```typescript
// QueueAdapter.onClose() æ–¹æ³•

public async close(): Promise<void> {
  this.logger.info('Closing all queues and workers...');
  
  // å…³é—­æ‰€æœ‰ Queue
  await Promise.all(
    Array.from(this.queues.values()).map((q) => q.close())
  );
  
  // å…³é—­æ‰€æœ‰ Worker
  await Promise.all(
    Array.from(this.workers.values()).map((w) => w.close())
  );
  
  // å…³é—­ Redis è¿æ¥
  await this.redisClient.getClient().quit();
  
  this.logger.info('All queues and workers closed.');
}
```

**è§¦å‘æ—¶æœº**ï¼š
- åº”ç”¨æ­£å¸¸å…³é—­ï¼ˆSIGTERMã€SIGINTï¼‰
- Stratix æ¡†æ¶è°ƒç”¨æ‰€æœ‰ Adapter çš„ `onClose()` é’©å­

---

## ğŸ“Š å½“å‰é¡¹ç›®ä½¿ç”¨æƒ…å†µ

### app-icalink é¡¹ç›®é…ç½®

```typescript
// apps/app-icalink/src/stratix.config.ts

{
  name: '@stratix/queue',
  plugin: queuePlugin,
  options: {
    defaultJobOptions: {
      removeOnComplete: true,    // âœ… è‡ªåŠ¨æ¸…ç†å·²å®Œæˆä»»åŠ¡
      removeOnFail: 100,         // âœ… ä¿ç•™100ä¸ªå¤±è´¥ä»»åŠ¡ç”¨äºè°ƒè¯•
      attempts: 3,               // âœ… å¤±è´¥åé‡è¯•3æ¬¡
      backoff: {
        type: 'exponential',
        delay: 1000              // âœ… æŒ‡æ•°é€€é¿ï¼š1s, 2s, 4s
      }
    }
  }
}
```

### å½“å‰çŠ¶æ€

**âœ… å·²å¯ç”¨**ï¼š
- `@stratix/queue` æ’ä»¶å·²æ³¨å†Œ
- `QueueAdapter` å·²åˆå§‹åŒ–
- Redis è¿æ¥å·²å»ºç«‹

**âš ï¸ å·²ç¦ç”¨**ï¼š
- Worker æ³¨å†Œä»£ç å·²æ³¨é‡Šï¼ˆ`afterFastifyCreated` é’©å­ä¸­ï¼‰
- `CheckinJobHandler` å·²åˆ é™¤

**ğŸ“ ä½¿ç”¨ç¤ºä¾‹**ï¼ˆAttendanceService.tsï¼‰ï¼š

```typescript
// æ·»åŠ ç­¾åˆ°ä»»åŠ¡åˆ°é˜Ÿåˆ—
await this.queueAdapter.add('checkin', {
  courseId: course.id,
  studentInfo,
  request: checkinData,
  courseStartTime: courseStartTime.toISOString()
});
```

---

## ğŸ”§ ä½¿ç”¨æŒ‡å—

### 1. æ·»åŠ ä»»åŠ¡åˆ°é˜Ÿåˆ—

```typescript
// åœ¨ Service ä¸­æ³¨å…¥ queueAdapter
constructor(
  @RESOLVER.inject('queueAdapter') private readonly queueAdapter: IQueueAdapter
) {}

// æ·»åŠ ä»»åŠ¡
async submitTask(data: any): Promise<void> {
  await this.queueAdapter.add('my-queue', data, {
    delay: 5000,           // å»¶è¿Ÿ5ç§’æ‰§è¡Œ
    priority: 10,          // ä¼˜å…ˆçº§ï¼ˆæ•°å­—è¶Šå°ä¼˜å…ˆçº§è¶Šé«˜ï¼‰
    attempts: 5,           // è¦†ç›–é»˜è®¤é‡è¯•æ¬¡æ•°
    removeOnComplete: true // å®Œæˆåè‡ªåŠ¨åˆ é™¤
  });
}
```

### 2. æ³¨å†Œ Worker å¤„ç†ä»»åŠ¡

```typescript
// åœ¨ stratix.config.ts çš„ afterFastifyCreated é’©å­ä¸­

hooks: {
  afterFastifyCreated: async (fastify: any) => {
    const container = fastify.diContainer;
    const queueAdapter = container.resolve('queueAdapter');
    const myJobHandler = container.resolve(MyJobHandler);
    
    // æ³¨å†Œ Worker
    queueAdapter.process('my-queue', async (job: Job) => {
      return myJobHandler.process(job);
    }, {
      concurrency: 5,  // å¹¶å‘å¤„ç†5ä¸ªä»»åŠ¡
      limiter: {
        max: 10,       // æ¯10ç§’æœ€å¤šå¤„ç†10ä¸ªä»»åŠ¡
        duration: 10000
      }
    });
  }
}
```

### 3. åˆ›å»º Job Handler

```typescript
// src/handlers/MyJobHandler.ts

import { Logger } from '@stratix/core';
import { Job } from 'bullmq';

export default class MyJobHandler {
  constructor(
    @RESOLVER.inject('logger') private readonly logger: Logger
  ) {}
  
  async process(job: Job): Promise<any> {
    this.logger.info(`Processing job ${job.id}`, job.data);
    
    try {
      // å¤„ç†ä»»åŠ¡é€»è¾‘
      const result = await this.doWork(job.data);
      
      // æ›´æ–°è¿›åº¦ï¼ˆå¯é€‰ï¼‰
      await job.updateProgress(50);
      
      return result;
    } catch (error) {
      this.logger.error(`Job ${job.id} failed`, error);
      throw error; // æŠ›å‡ºé”™è¯¯è§¦å‘é‡è¯•
    }
  }
  
  private async doWork(data: any): Promise<any> {
    // å®é™…ä¸šåŠ¡é€»è¾‘
    return { success: true };
  }
}
```

---

## ğŸ¯ æœ€ä½³å®è·µ

### 1. é˜Ÿåˆ—å‘½åè§„èŒƒ

```typescript
// âœ… æ¨èï¼šä½¿ç”¨è¯­ä¹‰åŒ–çš„é˜Ÿåˆ—åç§°
'checkin'           // ç­¾åˆ°é˜Ÿåˆ—
'leave-approval'    // è¯·å‡å®¡æ‰¹é˜Ÿåˆ—
'email-notification' // é‚®ä»¶é€šçŸ¥é˜Ÿåˆ—
'data-sync'         // æ•°æ®åŒæ­¥é˜Ÿåˆ—

// âŒ é¿å…ï¼šä½¿ç”¨é€šç”¨åç§°
'queue1'
'task'
'job'
```

### 2. é”™è¯¯å¤„ç†

```typescript
// âœ… æ¨èï¼šåŒºåˆ†å¯é‡è¯•å’Œä¸å¯é‡è¯•çš„é”™è¯¯
async process(job: Job): Promise<any> {
  try {
    return await this.doWork(job.data);
  } catch (error) {
    if (error instanceof ValidationError) {
      // éªŒè¯é”™è¯¯ä¸åº”é‡è¯•
      this.logger.error('Validation failed, will not retry', error);
      throw new Error('VALIDATION_FAILED'); // æ ‡è®°ä¸ºä¸å¯é‡è¯•
    }
    
    if (error instanceof NetworkError) {
      // ç½‘ç»œé”™è¯¯åº”è¯¥é‡è¯•
      this.logger.warn('Network error, will retry', error);
      throw error;
    }
    
    throw error;
  }
}
```

### 3. ä»»åŠ¡ä¼˜å…ˆçº§

```typescript
// é«˜ä¼˜å…ˆçº§ä»»åŠ¡ï¼ˆç´§æ€¥ï¼‰
await queueAdapter.add('notifications', data, { priority: 1 });

// æ™®é€šä¼˜å…ˆçº§ä»»åŠ¡
await queueAdapter.add('notifications', data, { priority: 5 });

// ä½ä¼˜å…ˆçº§ä»»åŠ¡ï¼ˆæ‰¹é‡å¤„ç†ï¼‰
await queueAdapter.add('notifications', data, { priority: 10 });
```

### 4. å»¶è¿Ÿä»»åŠ¡

```typescript
// 5åˆ†é’Ÿåæ‰§è¡Œ
await queueAdapter.add('reminder', data, {
  delay: 5 * 60 * 1000
});

// å®šæ—¶ä»»åŠ¡ï¼ˆæ¯å¤©å‡Œæ™¨2ç‚¹ï¼‰
await queueAdapter.add('daily-report', data, {
  repeat: {
    pattern: '0 2 * * *'  // Cron è¡¨è¾¾å¼
  }
});
```

---

## ğŸ” ç›‘æ§å’Œè°ƒè¯•

### æŸ¥çœ‹é˜Ÿåˆ—çŠ¶æ€

```typescript
const queue = queueAdapter.getQueue('checkin');

// è·å–é˜Ÿåˆ—ç»Ÿè®¡
const counts = await queue.getJobCounts();
console.log(counts);
// {
//   waiting: 10,
//   active: 2,
//   completed: 100,
//   failed: 5,
//   delayed: 3
// }

// è·å–å¤±è´¥çš„ä»»åŠ¡
const failedJobs = await queue.getFailed();
failedJobs.forEach(job => {
  console.log(`Job ${job.id} failed:`, job.failedReason);
});
```

### Worker äº‹ä»¶ç›‘å¬

```typescript
const worker = queueAdapter.process('checkin', processor);

worker.on('completed', (job: Job, result: any) => {
  logger.info(`Job ${job.id} completed`, result);
});

worker.on('failed', (job: Job | undefined, error: Error) => {
  logger.error(`Job ${job?.id} failed`, error);
});

worker.on('progress', (job: Job, progress: number) => {
  logger.info(`Job ${job.id} progress: ${progress}%`);
});
```

---

## ğŸ“š ç›¸å…³æ–‡ä»¶

- **æ’ä»¶å…¥å£**: `packages/queue/src/index.ts`
- **QueueAdapter**: `packages/queue/src/adapters/queue.adapter.ts`
- **ç±»å‹å®šä¹‰**: `packages/queue/src/types/index.ts`
- **åº”ç”¨é…ç½®**: `apps/app-icalink/src/stratix.config.ts`
- **ä½¿ç”¨ç¤ºä¾‹**: `apps/app-icalink/src/services/AttendanceService.ts`

---

## ğŸš¨ æ³¨æ„äº‹é¡¹

1. **Redis ä¾èµ–**ï¼šæ¶ˆæ¯é˜Ÿåˆ—ä¾èµ– Redisï¼Œå¿…é¡»å…ˆæ³¨å†Œ `@stratix/redis` æ’ä»¶
2. **å»¶è¿Ÿåˆ›å»º**ï¼šQueue å’Œ Worker æ˜¯å»¶è¿Ÿåˆ›å»ºçš„ï¼Œä¸ä¼šåœ¨åº”ç”¨å¯åŠ¨æ—¶ç«‹å³åˆ›å»º
3. **ç”Ÿå‘½å‘¨æœŸ**ï¼šQueueAdapter æ˜¯ SINGLETONï¼Œæ•´ä¸ªåº”ç”¨å…±äº«åŒä¸€ä¸ªå®ä¾‹
4. **ä¼˜é›…å…³é—­**ï¼šåº”ç”¨å…³é—­æ—¶ä¼šè‡ªåŠ¨è°ƒç”¨ `onClose()` æ¸…ç†æ‰€æœ‰é˜Ÿåˆ—å’Œè¿æ¥
5. **é”™è¯¯å¤„ç†**ï¼šä»»åŠ¡å¤±è´¥ä¼šæ ¹æ®é…ç½®è‡ªåŠ¨é‡è¯•ï¼Œé‡è¯•æ¬¡æ•°ç”¨å°½åæ ‡è®°ä¸ºå¤±è´¥

