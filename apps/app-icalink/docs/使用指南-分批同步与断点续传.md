# ä½¿ç”¨æŒ‡å— - åˆ†æ‰¹åŒæ­¥ä¸æ–­ç‚¹ç»­ä¼ 

## ğŸ“‹ å‰ç½®æ¡ä»¶

### 1. æ•°æ®åº“è¡¨å·²åˆ›å»º âœ…

ç¡®ä¿å·²æ‰§è¡Œ SQL è„šæœ¬ï¼š
```bash
mysql -u your_user -p your_database < apps/app-icalink/sql/create_tables.sql
```

æˆ–è€…åœ¨ MySQL å®¢æˆ·ç«¯ä¸­ï¼š
```sql
source apps/app-icalink/sql/create_tables.sql;
```

### 2. Repository å·²æ³¨å†Œ

ç¡®ä¿åœ¨æ’ä»¶å…¥å£æ–‡ä»¶ä¸­æ³¨å†Œäº†æ–°çš„ Repositoryï¼š

```typescript
// apps/app-icalink/src/index.ts
import { withRegisterAutoDI } from '@stratix/core';

export default withRegisterAutoDI(async (fastify, opts) => {
  // ... å…¶ä»–é…ç½®
  
  // æ³¨å†Œ Repositoryï¼ˆå¦‚æœä½¿ç”¨è‡ªåŠ¨å‘ç°ï¼Œå¯èƒ½å·²è‡ªåŠ¨æ³¨å†Œï¼‰
  // å¦‚æœéœ€è¦æ‰‹åŠ¨æ³¨å†Œï¼š
  // container.register('syncProgressRepository', {
  //   useClass: SyncProgressRepository,
  //   lifecycle: Lifecycle.SCOPED
  // });
  
  // container.register('wpsFieldMappingRepository', {
  //   useClass: WpsFieldMappingRepository,
  //   lifecycle: Lifecycle.SCOPED
  // });
}, {
  autoDiscovery: {
    repositories: true,
    services: true,
    controllers: true
  }
});
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### æ­¥éª¤ 1: åˆå§‹åŒ–å­—æ®µæ˜ å°„

**é¦–æ¬¡ä½¿ç”¨å‰å¿…é¡»åˆå§‹åŒ–å­—æ®µæ˜ å°„ï¼**

#### æ–¹å¼ 1: é€šè¿‡ API åˆå§‹åŒ–ï¼ˆæ¨èï¼‰

åˆ›å»ºä¸€ä¸ª Controller æ–¹æ³•ï¼š

```typescript
// apps/app-icalink/src/controllers/SyncController.ts
import { Controller, Post, Get } from '@stratix/core';
import WriteSheetService from '../services/wirteSheetService.js';

@Controller('/api/sync')
export default class SyncController {
  constructor(private readonly writeSheetService: WriteSheetService) {}

  @Post('/init-field-mapping')
  async initFieldMapping() {
    const success = await this.writeSheetService.initializeFieldMapping();
    return {
      success,
      message: success ? 'å­—æ®µæ˜ å°„åˆå§‹åŒ–æˆåŠŸ' : 'å­—æ®µæ˜ å°„åˆå§‹åŒ–å¤±è´¥'
    };
  }
}
```

ç„¶åè°ƒç”¨ APIï¼š
```bash
curl -X POST http://localhost:3000/api/sync/init-field-mapping
```

#### æ–¹å¼ 2: è‡ªåŠ¨åˆå§‹åŒ–

é¦–æ¬¡åŒæ­¥æ—¶ä¼šè‡ªåŠ¨æ£€æŸ¥å¹¶åˆå§‹åŒ–å­—æ®µæ˜ å°„ï¼Œæ— éœ€æ‰‹åŠ¨æ“ä½œã€‚

### æ­¥éª¤ 2: å¼€å§‹åŒæ­¥

#### æ–¹å¼ 1: é€šè¿‡ API åŒæ­¥

```typescript
@Controller('/api/sync')
export default class SyncController {
  constructor(private readonly writeSheetService: WriteSheetService) {}

  /**
   * å¼€å§‹æ–°çš„åŒæ­¥ä»»åŠ¡ï¼ˆä»å¤´å¼€å§‹ï¼‰
   */
  @Post('/start')
  async startSync() {
    const summary = await this.writeSheetService.triggerSync(false);
    return summary;
  }

  /**
   * æ–­ç‚¹ç»­ä¼ ï¼ˆä»ä¸Šæ¬¡ä¸­æ–­ä½ç½®ç»§ç»­ï¼‰
   */
  @Post('/resume')
  async resumeSync() {
    const summary = await this.writeSheetService.triggerSync(true);
    return summary;
  }

  /**
   * æŸ¥çœ‹åŒæ­¥è¿›åº¦
   */
  @Get('/progress')
  async getProgress() {
    const progress = await this.writeSheetService.getSyncProgress();
    return progress;
  }

  /**
   * é‡ç½®åŒæ­¥è¿›åº¦
   */
  @Post('/reset')
  async resetProgress() {
    await this.writeSheetService.resetSyncProgress();
    return { success: true, message: 'åŒæ­¥è¿›åº¦å·²é‡ç½®' };
  }
}
```

è°ƒç”¨ APIï¼š
```bash
# å¼€å§‹æ–°çš„åŒæ­¥
curl -X POST http://localhost:3000/api/sync/start

# æ–­ç‚¹ç»­ä¼ 
curl -X POST http://localhost:3000/api/sync/resume

# æŸ¥çœ‹è¿›åº¦
curl http://localhost:3000/api/sync/progress

# é‡ç½®è¿›åº¦
curl -X POST http://localhost:3000/api/sync/reset
```

#### æ–¹å¼ 2: é€šè¿‡ä»£ç ç›´æ¥è°ƒç”¨

```typescript
import { container } from '@stratix/core';
import WriteSheetService from './services/wirteSheetService.js';

// è·å–æœåŠ¡å®ä¾‹
const service = container.resolve<WriteSheetService>('writeSheetService');

// å¼€å§‹åŒæ­¥
const summary = await service.triggerSync(false);
console.log('åŒæ­¥å®Œæˆ:', summary);

// æ–­ç‚¹ç»­ä¼ 
const resumeSummary = await service.triggerSync(true);
console.log('ç»­ä¼ å®Œæˆ:', resumeSummary);
```

## ğŸ“Š åŒæ­¥æµç¨‹è¯¦è§£

### å®Œæ•´æµç¨‹

```
1. åˆå§‹åŒ–å­—æ®µæ˜ å°„
   â†“
2. åŠ è½½å­—æ®µæ˜ å°„ç¼“å­˜
   â†“
3. è·å–æ•°æ®åº“æ€»è®°å½•æ•°
   â†“
4. åˆå§‹åŒ–/æ¢å¤åŒæ­¥è¿›åº¦
   â†“
5. åˆ†æ‰¹è¯»å–æ•°æ®
   â†“
6. è½¬æ¢ä¸º WPS æ ¼å¼ï¼ˆä½¿ç”¨å­—æ®µæ˜ å°„ï¼‰
   â†“
7. å†™å…¥ WPS å¤šç»´è¡¨
   â†“
8. æ›´æ–°åŒæ­¥è¿›åº¦
   â†“
9. é‡å¤æ­¥éª¤ 5-8 ç›´åˆ°å®Œæˆ
   â†“
10. æ ‡è®°åŒæ­¥å®Œæˆ
```

### æ—¥å¿—è¾“å‡ºç¤ºä¾‹

```
[INFO] å¼€å§‹åŒæ­¥ç¼ºå‹¤å­¦ç”Ÿå…³ç³»æ•°æ®åˆ° WPS å¤šç»´è¡¨ { resumeFromLast: false }
[INFO] å­—æ®µæ˜ å°„ç¼“å­˜æœªåŠ è½½ï¼Œå¼€å§‹åŠ è½½...
[INFO] å­—æ®µæ˜ å°„ç¼“å­˜å·²åŠ è½½ï¼Œå…± 18 ä¸ªæ˜ å°„
[INFO] æ•°æ®åº“ä¸­å…±æœ‰ 1000 æ¡ç¼ºå‹¤è®°å½•
[INFO] åˆå§‹åŒ–æ–°çš„åŒæ­¥ä»»åŠ¡ { totalCount: 1000, batchSize: 100 }
[INFO] ä»åç§»é‡ 0 å¼€å§‹åŒæ­¥ { totalCount: 1000, batchSize: 100, estimatedBatches: 10 }
[INFO] [1/10] å¼€å§‹åŒæ­¥ç¬¬ 1 æ‰¹ï¼Œåç§»é‡: 0
[INFO] [1/10] è¯»å–åˆ° 100 æ¡è®°å½•
[INFO] [1/10] å‡†å¤‡å†™å…¥ 100 æ¡è®°å½•åˆ° WPS å¤šç»´è¡¨
[INFO] [1/10] âœ… ç¬¬ 1 æ‰¹åŒæ­¥æˆåŠŸï¼Œå·²åŒæ­¥ 100/1000 æ¡è®°å½• (10%)
[INFO] [2/10] å¼€å§‹åŒæ­¥ç¬¬ 2 æ‰¹ï¼Œåç§»é‡: 100
...
[INFO] [10/10] âœ… ç¬¬ 10 æ‰¹åŒæ­¥æˆåŠŸï¼Œå·²åŒæ­¥ 1000/1000 æ¡è®°å½• (100%)
[INFO] åŒæ­¥ä»»åŠ¡å®Œæˆ { status: 'completed', syncedCount: 1000, totalCount: 1000 }
[INFO] åŒæ­¥å®Œæˆ { success: true, totalCount: 1000, syncedCount: 1000, ... }
```

## ğŸ”„ æ–­ç‚¹ç»­ä¼ åœºæ™¯

### åœºæ™¯ 1: åŒæ­¥ä¸­æ–­

å‡è®¾åŒæ­¥åˆ°ç¬¬ 5 æ‰¹æ—¶æœåŠ¡å´©æºƒï¼š

```
[INFO] [5/10] âœ… ç¬¬ 5 æ‰¹åŒæ­¥æˆåŠŸï¼Œå·²åŒæ­¥ 500/1000 æ¡è®°å½• (50%)
[ERROR] æœåŠ¡å´©æºƒ...
```

é‡å¯æœåŠ¡åï¼Œè°ƒç”¨æ–­ç‚¹ç»­ä¼ ï¼š

```bash
curl -X POST http://localhost:3000/api/sync/resume
```

è¾“å‡ºï¼š
```
[INFO] ä»ä¸Šæ¬¡ä¸­æ–­ä½ç½®ç»§ç»­åŒæ­¥ { lastOffset: 500, syncedCount: 500 }
[INFO] ä»åç§»é‡ 500 å¼€å§‹åŒæ­¥ { totalCount: 1000, batchSize: 100, estimatedBatches: 5 }
[INFO] [6/10] å¼€å§‹åŒæ­¥ç¬¬ 6 æ‰¹ï¼Œåç§»é‡: 500
...
```

### åœºæ™¯ 2: æŸ¥çœ‹è¿›åº¦

åœ¨åŒæ­¥è¿‡ç¨‹ä¸­æˆ–ä¸­æ–­åï¼Œå¯ä»¥æŸ¥çœ‹è¿›åº¦ï¼š

```bash
curl http://localhost:3000/api/sync/progress
```

è¿”å›ï¼š
```json
{
  "fileId": "your_file_id",
  "sheetId": 123,
  "status": "in_progress",
  "totalCount": 1000,
  "syncedCount": 500,
  "currentOffset": 500,
  "batchSize": 100,
  "startedAt": "2024-01-01T10:00:00.000Z",
  "lastUpdatedAt": "2024-01-01T10:05:00.000Z",
  "failureCount": 0
}
```

### åœºæ™¯ 3: é‡æ–°å¼€å§‹

å¦‚æœæƒ³ä»å¤´å¼€å§‹åŒæ­¥ï¼ˆå¿½ç•¥ä¹‹å‰çš„è¿›åº¦ï¼‰ï¼š

```bash
# æ–¹å¼ 1: é‡ç½®è¿›åº¦åå¼€å§‹
curl -X POST http://localhost:3000/api/sync/reset
curl -X POST http://localhost:3000/api/sync/start

# æ–¹å¼ 2: ç›´æ¥å¼€å§‹æ–°åŒæ­¥ï¼ˆä¸ç»­ä¼ ï¼‰
curl -X POST http://localhost:3000/api/sync/start
```

## âš™ï¸ é…ç½®é€‰é¡¹

### æ‰¹æ¬¡å¤§å°

åœ¨åˆ›å»º WriteSheetService æ—¶é…ç½®ï¼š

```typescript
const service = new WriteSheetService(
  logger,
  wasV7ApiDbsheet,
  absentStudentRelationRepository,
  syncProgressRepository,
  wpsFieldMappingRepository,
  {
    batchSize: 50,  // æ¯æ‰¹ 50 æ¡è®°å½•
    fileId: 'your_file_id',
    sheetId: 123
  }
);
```

**å»ºè®®å€¼**:
- å°æ•°æ®é›†ï¼ˆ< 1000 æ¡ï¼‰: 100
- ä¸­ç­‰æ•°æ®é›†ï¼ˆ1000-10000 æ¡ï¼‰: 100-200
- å¤§æ•°æ®é›†ï¼ˆ> 10000 æ¡ï¼‰: 50-100

### å»¶è¿Ÿæ—¶é—´

æ‰¹æ¬¡é—´å»¶è¿Ÿåœ¨ä»£ç ä¸­ç¡¬ç¼–ç ä¸º 100msï¼Œå¯ä»¥æ ¹æ®éœ€è¦è°ƒæ•´ï¼š

```typescript
// åœ¨ syncAbsentStudentRelationsToWps æ–¹æ³•ä¸­
await this.delay(100); // ä¿®æ”¹è¿™ä¸ªå€¼
```

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜ 1: å­—æ®µæ˜ å°„åˆå§‹åŒ–å¤±è´¥

**ç—‡çŠ¶**: 
```
[ERROR] å­—æ®µæ˜ å°„åˆå§‹åŒ–å¤±è´¥ï¼Œæ— æ³•ç»§ç»­åŒæ­¥
```

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥ WPS API è¿æ¥æ˜¯å¦æ­£å¸¸
2. æ£€æŸ¥ WPS å¤šç»´è¡¨æ˜¯å¦å·²åˆ›å»ºå­—æ®µ
3. æ£€æŸ¥æ•°æ®åº“è¿æ¥æ˜¯å¦æ­£å¸¸
4. æŸ¥çœ‹è¯¦ç»†é”™è¯¯æ—¥å¿—

### é—®é¢˜ 2: åŒæ­¥è¿›åº¦æœªä¿å­˜

**ç—‡çŠ¶**: é‡å¯åæ— æ³•ç»­ä¼ 

**è§£å†³æ–¹æ¡ˆ**:
1. æ£€æŸ¥æ•°æ®åº“è¡¨ `sync_progress` æ˜¯å¦å­˜åœ¨
2. æ£€æŸ¥ Repository æ˜¯å¦æ­£ç¡®æ³¨å†Œ
3. æŸ¥çœ‹æ•°æ®åº“é”™è¯¯æ—¥å¿—

### é—®é¢˜ 3: å­—æ®µæ˜ å°„ä¸åŒ¹é…

**ç—‡çŠ¶**: 
```
[WARN] æœªæ‰¾åˆ°å­—æ®µ xxx çš„ WPS å­—æ®µ IDï¼Œä½¿ç”¨ä¸­æ–‡å­—æ®µå
```

**è§£å†³æ–¹æ¡ˆ**:
1. é‡æ–°åˆå§‹åŒ–å­—æ®µæ˜ å°„
2. æ£€æŸ¥ WPS å¤šç»´è¡¨å­—æ®µåæ˜¯å¦ä¸é…ç½®ä¸€è‡´
3. æ£€æŸ¥ `FIELD_NAME_MAPPING` é…ç½®æ˜¯å¦æ­£ç¡®

### é—®é¢˜ 4: API é¢‘ç‡é™åˆ¶

**ç—‡çŠ¶**: 
```
[ERROR] ç¬¬ X æ‰¹åŒæ­¥å¤±è´¥: Rate limit exceeded
```

**è§£å†³æ–¹æ¡ˆ**:
1. å¢åŠ æ‰¹æ¬¡é—´å»¶è¿Ÿæ—¶é—´
2. å‡å°æ‰¹æ¬¡å¤§å°
3. è”ç³» WPS å¢åŠ  API é…é¢

## ğŸ“ˆ æ€§èƒ½ä¼˜åŒ–å»ºè®®

### 1. æ‰¹æ¬¡å¤§å°ä¼˜åŒ–

- **ç½‘ç»œç¨³å®š**: å¯ä»¥å¢å¤§æ‰¹æ¬¡å¤§å°ï¼ˆ200-500ï¼‰
- **ç½‘ç»œä¸ç¨³å®š**: å‡å°æ‰¹æ¬¡å¤§å°ï¼ˆ50-100ï¼‰
- **API é™åˆ¶ä¸¥æ ¼**: å‡å°æ‰¹æ¬¡å¤§å°å¹¶å¢åŠ å»¶è¿Ÿ

### 2. å­—æ®µæ˜ å°„ç¼“å­˜

- å­—æ®µæ˜ å°„ä¼šåœ¨é¦–æ¬¡åŒæ­¥æ—¶åŠ è½½åˆ°å†…å­˜
- åç»­åŒæ­¥ä¼šå¤ç”¨ç¼“å­˜ï¼Œæ— éœ€é‡å¤æŸ¥è¯¢æ•°æ®åº“
- å¦‚æœ WPS å­—æ®µå‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦é‡æ–°åˆå§‹åŒ–æ˜ å°„

### 3. æ•°æ®åº“ç´¢å¼•

ç¡®ä¿ä»¥ä¸‹å­—æ®µæœ‰ç´¢å¼•ï¼š
```sql
-- sync_progress è¡¨
CREATE INDEX idx_task_name ON sync_progress(task_name);
CREATE INDEX idx_status ON sync_progress(status);

-- wps_field_mapping è¡¨
CREATE INDEX idx_file_sheet ON wps_field_mapping(file_id, sheet_id);
CREATE INDEX idx_db_field ON wps_field_mapping(db_field_name);
```

### 4. å¹¶å‘æ§åˆ¶

é¿å…åŒæ—¶è¿è¡Œå¤šä¸ªåŒæ­¥ä»»åŠ¡ï¼š
```typescript
// åœ¨å¼€å§‹åŒæ­¥å‰æ£€æŸ¥
const progress = await service.getSyncProgress();
if (progress && progress.status === 'in_progress') {
  throw new Error('å·²æœ‰åŒæ­¥ä»»åŠ¡æ­£åœ¨è¿›è¡Œä¸­');
}
```

## ğŸ¯ æœ€ä½³å®è·µ

1. **é¦–æ¬¡ä½¿ç”¨**: å…ˆåˆå§‹åŒ–å­—æ®µæ˜ å°„ï¼Œå†å¼€å§‹åŒæ­¥
2. **å®šæœŸåŒæ­¥**: ä½¿ç”¨å®šæ—¶ä»»åŠ¡å®šæœŸåŒæ­¥æ–°æ•°æ®
3. **ç›‘æ§è¿›åº¦**: å®šæœŸæŸ¥è¯¢åŒæ­¥è¿›åº¦ï¼ŒåŠæ—¶å‘ç°é—®é¢˜
4. **é”™è¯¯å¤„ç†**: è®°å½•å¤±è´¥æ‰¹æ¬¡ï¼Œæ‰‹åŠ¨å¤„ç†æˆ–é‡è¯•
5. **æ•°æ®éªŒè¯**: åŒæ­¥å®ŒæˆåéªŒè¯æ•°æ®å®Œæ•´æ€§
6. **æ¸…ç†æ—§æ•°æ®**: å®šæœŸæ¸…ç†å·²å®Œæˆçš„åŒæ­¥è®°å½•

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·æŸ¥çœ‹ï¼š
- è¯¦ç»†æ—¥å¿—è¾“å‡º
- æ•°æ®åº“è¡¨æ•°æ®
- WPS API æ–‡æ¡£
- ä»£ç æ³¨é‡Šå’Œæ–‡æ¡£

ç¥ä½¿ç”¨æ„‰å¿«ï¼ğŸ‰

