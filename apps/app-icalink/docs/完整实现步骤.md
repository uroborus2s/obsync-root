# å®Œæ•´å®ç°æ­¥éª¤

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### 1. æ•°æ®åº“è¡¨è®¾è®¡

å·²åˆ›å»º SQL æ–‡ä»¶ï¼š`apps/app-icalink/sql/create_tables.sql`

åŒ…å«ä¸¤å¼ è¡¨ï¼š
- `sync_progress`: åŒæ­¥è¿›åº¦è¡¨
- `wps_field_mapping`: WPS å­—æ®µæ˜ å°„è¡¨

### 2. ç±»å‹å®šä¹‰

å·²åˆ›å»ºï¼š
- `apps/app-icalink/src/types/sync-progress-entity.ts` - åŒæ­¥è¿›åº¦å®ä½“ç±»å‹
- `apps/app-icalink/src/types/wps-field-mapping.ts` - å­—æ®µæ˜ å°„ç±»å‹

### 3. Repository å±‚

å·²åˆ›å»ºï¼š
- `apps/app-icalink/src/repositories/SyncProgressRepository.ts` - åŒæ­¥è¿›åº¦ Repository
- `apps/app-icalink/src/repositories/WpsFieldMappingRepository.ts` - å­—æ®µæ˜ å°„ Repository

### 4. Service å±‚éƒ¨åˆ†å®Œæˆ

å·²åœ¨ `WriteSheetService` ä¸­æ·»åŠ ï¼š
- âœ… æ³¨å…¥ `SyncProgressRepository` å’Œ `WpsFieldMappingRepository`
- âœ… `initializeFieldMapping()` - åˆå§‹åŒ–å­—æ®µæ˜ å°„
- âœ… `loadFieldMappingCache()` - åŠ è½½å­—æ®µæ˜ å°„åˆ°ç¼“å­˜

## ğŸš§ å¾…å®Œæˆçš„å·¥ä½œ

### 1. ä¿®æ”¹åŒæ­¥è¿›åº¦ç®¡ç†æ–¹æ³•

éœ€è¦å°†ä»¥ä¸‹æ–¹æ³•æ”¹ä¸ºä½¿ç”¨æ•°æ®åº“æŒä¹…åŒ–ï¼š

#### initializeSyncProgress()
```typescript
// å½“å‰ï¼šä»å†…å­˜è¯»å–
private initializeSyncProgress(totalCount: number, resumeFromLast: boolean): number

// ä¿®æ”¹ä¸ºï¼šä»æ•°æ®åº“è¯»å–
private async initializeSyncProgress(totalCount: number, resumeFromLast: boolean): Promise<number>
```

#### updateSyncProgress()
```typescript
// å½“å‰ï¼šæ›´æ–°å†…å­˜
private updateSyncProgress(currentOffset: number, syncedCount: number): void

// ä¿®æ”¹ä¸ºï¼šæ›´æ–°æ•°æ®åº“
private async updateSyncProgress(currentOffset: number, syncedCount: number): Promise<void>
```

#### completeSyncProgress()
```typescript
// å½“å‰ï¼šæ›´æ–°å†…å­˜
private completeSyncProgress(success: boolean): void

// ä¿®æ”¹ä¸ºï¼šæ›´æ–°æ•°æ®åº“
private async completeSyncProgress(success: boolean): Promise<void>
```

#### failSyncProgress()
```typescript
// å½“å‰ï¼šæ›´æ–°å†…å­˜
private failSyncProgress(errorMessage: string): void

// ä¿®æ”¹ä¸ºï¼šæ›´æ–°æ•°æ®åº“
private async failSyncProgress(errorMessage: string): Promise<void>
```

### 2. ä¿®æ”¹å…¬å…± API æ–¹æ³•

#### getSyncProgress()
```typescript
// å½“å‰ï¼šè¿”å›å†…å­˜ä¸­çš„è¿›åº¦
getSyncProgress(): SyncProgress | null

// ä¿®æ”¹ä¸ºï¼šä»æ•°æ®åº“æŸ¥è¯¢
async getSyncProgress(): Promise<SyncProgress | null>
```

#### resetSyncProgress()
```typescript
// å½“å‰ï¼šæ¸…ç©ºå†…å­˜
resetSyncProgress(): void

// ä¿®æ”¹ä¸ºï¼šä»æ•°æ®åº“åˆ é™¤
async resetSyncProgress(): Promise<void>
```

### 3. ä¿®æ”¹æ•°æ®è½¬æ¢æ–¹æ³•

éœ€è¦ä½¿ç”¨å­—æ®µæ˜ å°„ç¼“å­˜æ¥è½¬æ¢æ•°æ®ï¼š

#### convertToWpsRecord()
```typescript
// å½“å‰ï¼šä½¿ç”¨ç¡¬ç¼–ç çš„å­—æ®µå
private convertToWpsRecord(record: IcalinkAbsentStudentRelation): any

// ä¿®æ”¹ä¸ºï¼šä½¿ç”¨å­—æ®µæ˜ å°„ç¼“å­˜ï¼ˆWPS å­—æ®µ IDï¼‰
private convertToWpsRecord(record: IcalinkAbsentStudentRelation): any
```

### 4. ä¿®æ”¹ä¸»åŒæ­¥æ–¹æ³•

#### syncAbsentStudentRelationsToWps()

éœ€è¦ï¼š
1. åœ¨å¼€å§‹å‰è°ƒç”¨ `loadFieldMappingCache()` åŠ è½½å­—æ®µæ˜ å°„
2. å°†æ‰€æœ‰åŒæ­¥è¿›åº¦æ–¹æ³•è°ƒç”¨æ”¹ä¸º await
3. ä½¿ç”¨å­—æ®µæ˜ å°„ç¼“å­˜è½¬æ¢æ•°æ®

## ğŸ“‹ å®ç°è®¡åˆ’

### æ­¥éª¤ 1: åˆ›å»ºæ•°æ®åº“è¡¨

```bash
# æ‰§è¡Œ SQL æ–‡ä»¶
mysql -u your_user -p your_database < apps/app-icalink/sql/create_tables.sql
```

### æ­¥éª¤ 2: æ³¨å†Œ Repository

åœ¨æ’ä»¶å…¥å£æ–‡ä»¶ä¸­æ³¨å†Œï¼š

```typescript
// apps/app-icalink/src/index.ts
container.register('syncProgressRepository', {
  useClass: SyncProgressRepository,
  lifecycle: Lifecycle.SCOPED
});

container.register('wpsFieldMappingRepository', {
  useClass: WpsFieldMappingRepository,
  lifecycle: Lifecycle.SCOPED
});
```

### æ­¥éª¤ 3: ä¿®æ”¹ WriteSheetService

ç”±äºä¿®æ”¹è¾ƒå¤šï¼Œå»ºè®®åˆ†æ­¥éª¤è¿›è¡Œï¼š

1. å…ˆä¿®æ”¹åŒæ­¥è¿›åº¦ç®¡ç†æ–¹æ³•ï¼ˆinitializeSyncProgress, updateSyncProgress ç­‰ï¼‰
2. å†ä¿®æ”¹å…¬å…± API æ–¹æ³•ï¼ˆgetSyncProgress, resetSyncProgressï¼‰
3. æœ€åä¿®æ”¹æ•°æ®è½¬æ¢æ–¹æ³•ï¼ˆconvertToWpsRecordï¼‰
4. æ›´æ–°ä¸»åŒæ­¥æ–¹æ³•ï¼ˆsyncAbsentStudentRelationsToWpsï¼‰

### æ­¥éª¤ 4: æµ‹è¯•

1. æµ‹è¯•å­—æ®µæ˜ å°„åˆå§‹åŒ–
2. æµ‹è¯•é¦–æ¬¡åŒæ­¥
3. æµ‹è¯•æ–­ç‚¹ç»­ä¼ 
4. æµ‹è¯•è¿›åº¦æŸ¥è¯¢
5. æµ‹è¯•è¿›åº¦é‡ç½®

## ğŸ¯ å…³é”®ä¿®æ”¹ç‚¹

### 1. å­—æ®µæ˜ å°„ä½¿ç”¨

**å½“å‰æ–¹å¼**ï¼ˆç¡¬ç¼–ç å­—æ®µåï¼‰ï¼š
```typescript
const wpsRecord = {
  ID: record.id,
  è¯¾ç¨‹ç»Ÿè®¡ID: record.course_stats_id,
  è¯¾ç¨‹ID: record.course_id,
  // ...
};
```

**æ–°æ–¹å¼**ï¼ˆä½¿ç”¨å­—æ®µ IDï¼‰ï¼š
```typescript
// ä»ç¼“å­˜è·å–å­—æ®µ ID
const idFieldId = this.getWpsFieldId('id');
const courseStatsIdFieldId = this.getWpsFieldId('course_stats_id');

const wpsRecord = {
  [idFieldId]: record.id,
  [courseStatsIdFieldId]: record.course_stats_id,
  // ...
};
```

### 2. åŒæ­¥è¿›åº¦æŒä¹…åŒ–

**å½“å‰æ–¹å¼**ï¼ˆå†…å­˜ï¼‰ï¼š
```typescript
this.syncProgress = {
  fileId: this.WPS_FILE_ID,
  sheetId: this.WPS_SHEET_ID,
  status: SyncStatus.IN_PROGRESS,
  // ...
};
```

**æ–°æ–¹å¼**ï¼ˆæ•°æ®åº“ï¼‰ï¼š
```typescript
await this.syncProgressRepository.upsertByTaskName(
  this.SYNC_TASK_NAME,
  {
    file_id: this.WPS_FILE_ID,
    sheet_id: this.WPS_SHEET_ID,
    status: 'in_progress',
    // ...
  }
);
```

## ğŸ“ æ³¨æ„äº‹é¡¹

### 1. å­—æ®µæ˜ å°„åˆå§‹åŒ–æ—¶æœº

å»ºè®®åœ¨æœåŠ¡å¯åŠ¨æ—¶è‡ªåŠ¨åˆå§‹åŒ–å­—æ®µæ˜ å°„ï¼š

```typescript
constructor(...) {
  // ...
  
  // å¼‚æ­¥åˆå§‹åŒ–å­—æ®µæ˜ å°„
  this.initializeFieldMapping().catch((error) => {
    this.logger.error('å­—æ®µæ˜ å°„åˆå§‹åŒ–å¤±è´¥', error);
  });
}
```

æˆ–è€…æä¾›ä¸€ä¸ªæ‰‹åŠ¨åˆå§‹åŒ–çš„ APIï¼š

```typescript
@Post('/init-field-mapping')
async initFieldMapping() {
  const success = await this.writeSheetService.initializeFieldMapping();
  return { success };
}
```

### 2. å­—æ®µæ˜ å°„ç¼“å­˜åˆ·æ–°

å¦‚æœ WPS å¤šç»´è¡¨çš„å­—æ®µå‘ç”Ÿå˜åŒ–ï¼Œéœ€è¦é‡æ–°åˆå§‹åŒ–å­—æ®µæ˜ å°„ï¼š

```typescript
// æ¸…ç©ºç¼“å­˜
this.fieldMappingCache = null;

// é‡æ–°åˆå§‹åŒ–
await this.initializeFieldMapping();
```

### 3. é”™è¯¯å¤„ç†

æ‰€æœ‰æ•°æ®åº“æ“ä½œéƒ½éœ€è¦æ·»åŠ é”™è¯¯å¤„ç†ï¼š

```typescript
try {
  await this.syncProgressRepository.upsertByTaskName(...);
} catch (error: any) {
  this.logger.error('æ›´æ–°åŒæ­¥è¿›åº¦å¤±è´¥', error);
  // å†³å®šæ˜¯å¦ç»§ç»­æ‰§è¡Œ
}
```

### 4. æ€§èƒ½ä¼˜åŒ–

- å­—æ®µæ˜ å°„ç¼“å­˜é¿å…æ¯æ¬¡æŸ¥è¯¢æ•°æ®åº“
- åŒæ­¥è¿›åº¦ä¸éœ€è¦æ¯æ¡è®°å½•éƒ½æ›´æ–°ï¼Œå¯ä»¥æ¯æ‰¹æ¬¡æ›´æ–°ä¸€æ¬¡
- ä½¿ç”¨æ‰¹é‡æ“ä½œå‡å°‘æ•°æ®åº“è®¿é—®æ¬¡æ•°

## ğŸ”„ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³æ‰§è¡Œ**ï¼šåˆ›å»ºæ•°æ®åº“è¡¨
2. **ä»£ç ä¿®æ”¹**ï¼šæŒ‰ç…§ä¸Šè¿°è®¡åˆ’ä¿®æ”¹ WriteSheetService
3. **æµ‹è¯•éªŒè¯**ï¼šå®Œæ•´æµ‹è¯•æ‰€æœ‰åŠŸèƒ½
4. **æ–‡æ¡£æ›´æ–°**ï¼šæ›´æ–°ä½¿ç”¨æ–‡æ¡£

éœ€è¦æˆ‘ç»§ç»­å®Œæˆä»£ç ä¿®æ”¹å—ï¼Ÿ

