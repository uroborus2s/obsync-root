# è¯·å‡åŠŸèƒ½é”™è¯¯ä¿®å¤æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

**é”™è¯¯ä¿¡æ¯**: `Unknown column 'class_date' in 'field list'`

**å‘ç”Ÿä½ç½®**: å­¦ç”Ÿæäº¤è¯·å‡ç”³è¯·æ—¶ï¼Œåœ¨åˆ›å»ºè¯·å‡è®°å½•é˜¶æ®µ

**æ ¹æœ¬åŸå› **: æ•°æ®ç±»å‹ä¸åŒ¹é… - å‘ DATE ç±»å‹å­—æ®µä¼ å…¥äº†å®Œæ•´çš„ Date å¯¹è±¡

---

## ğŸ” ç¬¬ä¸€æ­¥ï¼šä¸šåŠ¡æµç¨‹åˆ†æ

### è¯·å‡åŠŸèƒ½å®Œæ•´ä¸šåŠ¡æµç¨‹

```
å­¦ç”Ÿæäº¤è¯·å‡ç”³è¯·
    â†“
1. æŸ¥æ‰¾æˆ–åˆ›å»ºè€ƒå‹¤è®°å½• (icalink_attendance_records)
    â†“
2. è·å–è¯¾ç¨‹ä¿¡æ¯ (icasync_attendance_courses)
    â†“
3. åˆ›å»ºè¯·å‡ç”³è¯· (icalink_leave_applications) âš ï¸ é”™è¯¯å‘ç”Ÿåœ¨è¿™é‡Œ
    â†“
4. åˆ›å»ºå®¡æ‰¹è®°å½• (icalink_leave_approvals)
    â†“
5. ä¸Šä¼ é™„ä»¶ (icalink_leave_attachments)
    â†“
6. è¿”å›å“åº”
```

### æ¶‰åŠçš„æ•°æ®è¡¨

| è¡¨å | ç”¨é€” | å…³é”®å­—æ®µ |
|------|------|---------|
| `icalink_attendance_records` | è€ƒå‹¤è®°å½• | id, attendance_course_id, student_id, status |
| `icalink_leave_applications` | è¯·å‡ç”³è¯· | id, attendance_record_id, **class_date** |
| `icalink_leave_approvals` | å®¡æ‰¹è®°å½• | id, leave_application_id, approver_id |
| `icalink_leave_attachments` | é™„ä»¶è®°å½• | id, leave_application_id, image_content |
| `icasync_attendance_courses` | è¯¾ç¨‹ä¿¡æ¯ | id, course_code, start_time, end_time |

### æ•°æ®å†™å…¥é¡ºåº

```
1. icalink_attendance_records (å¦‚æœä¸å­˜åœ¨)
   â†“ FK: attendance_record_id
2. icalink_leave_applications âš ï¸ é”™è¯¯åœ¨è¿™é‡Œ
   â†“ FK: leave_application_id
3. icalink_leave_approvals
   â†“ FK: leave_application_id
4. icalink_leave_attachments (å¦‚æœæœ‰é™„ä»¶)
```

### è¡¨å…³è”å…³ç³»

```
icalink_attendance_records (1)
    â†“ FK: attendance_record_id
icalink_leave_applications (1)
    â†“ FK: leave_application_id
    â”œâ”€â†’ icalink_leave_approvals (N)
    â””â”€â†’ icalink_leave_attachments (N)
```

---

## ğŸ” ç¬¬äºŒæ­¥ï¼šæ•°æ®åº“è¡¨ç»“æ„æ£€æŸ¥

### icalink_leave_applications è¡¨ç»“æ„

```sql
CREATE TABLE `icalink_leave_applications` (
  `id` bigint(20) NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `attendance_record_id` bigint(20) NOT NULL COMMENT 'å…³è”ç­¾åˆ°è®°å½•ID',
  `student_id` varchar(100) NOT NULL COMMENT 'å­¦ç”ŸID',
  `student_name` varchar(200) NOT NULL COMMENT 'å­¦ç”Ÿå§“å',
  `course_id` varchar(100) NOT NULL COMMENT 'è¯¾ç¨‹ID(kkh)',
  `course_name` varchar(500) NOT NULL COMMENT 'è¯¾ç¨‹åç§°',
  `class_date` date NOT NULL COMMENT 'ä¸Šè¯¾æ—¥æœŸ',  -- âœ… å­—æ®µå­˜åœ¨ï¼Œç±»å‹ä¸º DATE
  `class_time` varchar(50) NOT NULL COMMENT 'ä¸Šè¯¾æ—¶é—´',
  `class_location` varchar(500) COMMENT 'ä¸Šè¯¾åœ°ç‚¹',
  `teacher_id` varchar(100) NOT NULL COMMENT 'æˆè¯¾æ•™å¸ˆID',
  `teacher_name` varchar(200) NOT NULL COMMENT 'æˆè¯¾æ•™å¸ˆå§“å',
  `leave_type` enum('sick','personal','emergency','other') NOT NULL DEFAULT 'personal',
  `leave_reason` text NOT NULL COMMENT 'è¯·å‡åŸå› ',
  `status` enum('leave_pending','leave','leave_rejected','cancelled') NOT NULL,
  `application_time` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP,
  ...
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

### å…³é”®å‘ç°

âœ… **å­—æ®µå­˜åœ¨**: `class_date` å­—æ®µåœ¨æ•°æ®åº“ä¸­ç¡®å®å­˜åœ¨  
âš ï¸ **ç±»å‹ä¸º DATE**: åªå­˜å‚¨æ—¥æœŸéƒ¨åˆ†ï¼ˆYYYY-MM-DDï¼‰ï¼Œä¸åŒ…å«æ—¶é—´  
âŒ **é—®é¢˜**: ä»£ç ä¼ å…¥äº†å®Œæ•´çš„ Date å¯¹è±¡ï¼ˆåŒ…å«æ—¥æœŸå’Œæ—¶é—´ï¼‰

---

## ğŸ” ç¬¬ä¸‰æ­¥ï¼šå®šä½é”™è¯¯ä»£ç 

### é”™è¯¯ä»£ç ä½ç½®

**æ–‡ä»¶**: `apps/app-icalink/src/services/LeaveService.ts`  
**è¡Œå·**: ç¬¬ 180 è¡Œ

### é”™è¯¯ä»£ç 

```typescript
// âŒ é”™è¯¯çš„ä»£ç 
const applicationResult = await this.leaveApplicationRepository.create({
  attendance_record_id: record.id,
  student_id: studentInfo.userId,
  student_name: studentInfo.name,
  course_id: course.course_code,
  course_name: course.course_name,
  teacher_id: teacherCodes[0] || '',
  teacher_name: teacherNames[0] || '',
  leave_type: request.leave_type,
  leave_reason: request.leave_reason,
  status: 'leave_pending' as LeaveStatus,
  application_time: getCurrentDateTime(),
  class_date: course.start_time,  // âŒ é”™è¯¯ï¼šä¼ å…¥äº†å®Œæ•´çš„ Date å¯¹è±¡
  class_time: `${course.start_time.toTimeString().slice(0, 5)}-${course.end_time.toTimeString().slice(0, 5)}`
} as any);
```

### é—®é¢˜åˆ†æ

1. **æ•°æ®åº“å­—æ®µç±»å‹**: `class_date` æ˜¯ `DATE` ç±»å‹ï¼ˆåªåŒ…å«æ—¥æœŸï¼‰
2. **ä¼ å…¥çš„å€¼**: `course.start_time` æ˜¯å®Œæ•´çš„ `Date` å¯¹è±¡ï¼ˆåŒ…å«æ—¥æœŸå’Œæ—¶é—´ï¼‰
3. **ORM å¤„ç†**: Kysely åœ¨å¤„ç† DATE ç±»å‹æ—¶æœŸæœ›æ¥æ”¶å­—ç¬¦ä¸²æ ¼å¼ `YYYY-MM-DD`
4. **ç»“æœ**: ç±»å‹ä¸åŒ¹é…å¯¼è‡´ SQL é”™è¯¯

---

## âœ… ç¬¬å››æ­¥ï¼šä¿®å¤ä»£ç 

### ä¿®å¤æ–¹æ¡ˆ

å°† `Date` å¯¹è±¡è½¬æ¢ä¸º `YYYY-MM-DD` æ ¼å¼çš„å­—ç¬¦ä¸²

### ä¿®å¤åçš„ä»£ç 

```typescript
// âœ… æ­£ç¡®çš„ä»£ç 
// 3. åˆ›å»ºè¯·å‡ç”³è¯·
const teacherCodes = course.teacher_codes?.split(',') || [];
const teacherNames = course.teacher_names?.split(',') || [];

// å°† Date å¯¹è±¡è½¬æ¢ä¸º YYYY-MM-DD æ ¼å¼çš„å­—ç¬¦ä¸²ï¼ˆä»…æ—¥æœŸéƒ¨åˆ†ï¼‰
const classDate = course.start_time.toISOString().split('T')[0];

const applicationResult = await this.leaveApplicationRepository.create({
  attendance_record_id: record.id,
  student_id: studentInfo.userId,
  student_name: studentInfo.name,
  course_id: course.course_code,
  course_name: course.course_name,
  teacher_id: teacherCodes[0] || '',
  teacher_name: teacherNames[0] || '',
  leave_type: request.leave_type,
  leave_reason: request.leave_reason,
  status: 'leave_pending' as LeaveStatus,
  application_time: getCurrentDateTime(),
  class_date: classDate,  // âœ… ä¿®å¤ï¼šä¼ å…¥ YYYY-MM-DD æ ¼å¼å­—ç¬¦ä¸²
  class_time: `${course.start_time.toTimeString().slice(0, 5)}-${course.end_time.toTimeString().slice(0, 5)}`
} as any);
```

### ç±»å‹å®šä¹‰ä¿®å¤

**æ–‡ä»¶**: `apps/app-icalink/src/types/database.ts`

```typescript
// âœ… ä¿®å¤å‰
export interface IcalinkLeaveApplication {
  ...
  class_date: Date;  // âŒ ä¸å¤Ÿç²¾ç¡®
  ...
}

// âœ… ä¿®å¤å
export interface IcalinkLeaveApplication {
  ...
  class_date: ColumnType<Date, string, string>;  // âœ… ç²¾ç¡®å®šä¹‰ï¼šæŸ¥è¯¢è¿”å› Dateï¼Œæ’å…¥/æ›´æ–°ä½¿ç”¨ string
  ...
}
```

### ä¿®å¤è¯´æ˜

1. **è½¬æ¢æ–¹æ³•**: `course.start_time.toISOString().split('T')[0]`
   - `toISOString()`: è½¬æ¢ä¸º ISO 8601 æ ¼å¼ `2024-01-25T14:30:00.000Z`
   - `split('T')[0]`: å–æ—¥æœŸéƒ¨åˆ† `2024-01-25`

2. **ç±»å‹å®šä¹‰**: ä½¿ç”¨ `ColumnType<Date, string, string>`
   - ç¬¬ä¸€ä¸ªå‚æ•° `Date`: æŸ¥è¯¢æ—¶è¿”å›çš„ç±»å‹
   - ç¬¬äºŒä¸ªå‚æ•° `string`: æ’å…¥æ—¶æ¥å—çš„ç±»å‹
   - ç¬¬ä¸‰ä¸ªå‚æ•° `string`: æ›´æ–°æ—¶æ¥å—çš„ç±»å‹

---

## âœ… ç¬¬äº”æ­¥ï¼šéªŒè¯ä¿®å¤

### ä¿®å¤éªŒè¯æ¸…å•

#### 1. å­—æ®µåä¸€è‡´æ€§ âœ…

| ä½ç½® | å­—æ®µå | çŠ¶æ€ |
|------|--------|------|
| æ•°æ®åº“è¡¨ | `class_date` | âœ… æ­£ç¡® |
| Repository Schema | `class_date` | âœ… æ­£ç¡® |
| ç±»å‹å®šä¹‰ | `class_date` | âœ… æ­£ç¡® |
| Service ä»£ç  | `class_date` | âœ… æ­£ç¡® |

#### 2. æ•°æ®ç±»å‹ä¸€è‡´æ€§ âœ…

| ä½ç½® | ç±»å‹å®šä¹‰ | çŠ¶æ€ |
|------|---------|------|
| æ•°æ®åº“è¡¨ | `date` | âœ… æ­£ç¡® |
| Repository Schema | `DataColumnType.DATE` | âœ… æ­£ç¡® |
| ç±»å‹å®šä¹‰ | `ColumnType<Date, string, string>` | âœ… æ­£ç¡® |
| æ’å…¥æ•°æ® | `string (YYYY-MM-DD)` | âœ… æ­£ç¡® |

#### 3. æ•°æ®æ’å…¥é¡ºåº âœ…

```
1. icalink_attendance_records âœ…
   â†“ è·å– record.id
2. icalink_leave_applications âœ… (å·²ä¿®å¤)
   â†“ è·å– application.id
3. icalink_leave_approvals âœ…
   â†“ ä½¿ç”¨ application.id
4. icalink_leave_attachments âœ…
   â†“ ä½¿ç”¨ application.id
```

#### 4. äº‹åŠ¡å¤„ç† âš ï¸

**å½“å‰çŠ¶æ€**: æœªä½¿ç”¨äº‹åŠ¡  
**å»ºè®®**: è€ƒè™‘ä½¿ç”¨äº‹åŠ¡ç¡®ä¿æ•°æ®ä¸€è‡´æ€§

```typescript
// å»ºè®®çš„äº‹åŠ¡å¤„ç†ï¼ˆæœªå®ç°ï¼‰
await db.transaction().execute(async (trx) => {
  // 1. åˆ›å»ºè€ƒå‹¤è®°å½•
  const record = await trx.insertInto('icalink_attendance_records')...
  
  // 2. åˆ›å»ºè¯·å‡ç”³è¯·
  const application = await trx.insertInto('icalink_leave_applications')...
  
  // 3. åˆ›å»ºå®¡æ‰¹è®°å½•
  await trx.insertInto('icalink_leave_approvals')...
  
  // 4. åˆ›å»ºé™„ä»¶è®°å½•
  await trx.insertInto('icalink_leave_attachments')...
});
```

#### 5. é”™è¯¯å¤„ç† âœ…

```typescript
// âœ… å·²æœ‰å®Œå–„çš„é”™è¯¯å¤„ç†
if (isLeft(applicationResult)) {
  return left({
    code: String(ServiceErrorCode.INTERNAL_ERROR),
    message: 'åˆ›å»ºè¯·å‡ç”³è¯·å¤±è´¥',
    details: applicationResult.left
  });
}
```

---

## ğŸ“Š ä¿®å¤å½±å“èŒƒå›´

### ä¿®æ”¹çš„æ–‡ä»¶

1. âœ… `apps/app-icalink/src/services/LeaveService.ts`
   - ç¬¬ 167 è¡Œï¼šæ·»åŠ æ—¥æœŸè½¬æ¢é€»è¾‘
   - ç¬¬ 183 è¡Œï¼šä½¿ç”¨è½¬æ¢åçš„æ—¥æœŸå­—ç¬¦ä¸²

2. âœ… `apps/app-icalink/src/types/database.ts`
   - ç¬¬ 123 è¡Œï¼šä¿®æ”¹ `class_date` ç±»å‹å®šä¹‰

### æœªä¿®æ”¹çš„æ–‡ä»¶

- âœ… `apps/app-icalink/database/001_create_attendance_tables.sql` - æ•°æ®åº“è¡¨ç»“æ„æ­£ç¡®
- âœ… `apps/app-icalink/src/repositories/LeaveApplicationRepository.ts` - Schema å®šä¹‰æ­£ç¡®
- âœ… `apps/app-icalink/src/controllers/LeaveController.ts` - æ— éœ€ä¿®æ”¹

---

## ğŸ§ª æµ‹è¯•å»ºè®®

### 1. å•å…ƒæµ‹è¯•

```typescript
describe('LeaveService.submitLeaveApplication', () => {
  it('should convert Date to YYYY-MM-DD format for class_date', async () => {
    const course = {
      start_time: new Date('2024-01-25T14:30:00Z'),
      end_time: new Date('2024-01-25T16:00:00Z'),
      // ...
    };
    
    // è°ƒç”¨æœåŠ¡
    const result = await leaveService.submitLeaveApplication(studentInfo, request);
    
    // éªŒè¯ class_date æ ¼å¼
    expect(result.right.class_date).toBe('2024-01-25');
  });
});
```

### 2. é›†æˆæµ‹è¯•

```bash
# æµ‹è¯•å®Œæ•´çš„è¯·å‡æµç¨‹
curl -X POST http://localhost:3000/api/icalink/v1/leave-applications \
  -H "Content-Type: application/json" \
  -d '{
    "attendance_record_id": "123",
    "leave_type": "sick",
    "leave_reason": "æ„Ÿå†’å‘çƒ§",
    "images": []
  }'
```

### 3. æ•°æ®åº“éªŒè¯

```sql
-- éªŒè¯æ’å…¥çš„æ•°æ®
SELECT 
  id,
  student_id,
  course_name,
  class_date,  -- åº”è¯¥æ˜¯ DATE ç±»å‹ï¼Œæ ¼å¼ä¸º YYYY-MM-DD
  class_time,
  application_time
FROM icalink_leave_applications
ORDER BY id DESC
LIMIT 1;
```

---

## ğŸ“ æ€»ç»“

### é—®é¢˜æ ¹æº

æ•°æ®ç±»å‹ä¸åŒ¹é…ï¼šå‘ MySQL DATE ç±»å‹å­—æ®µä¼ å…¥äº†å®Œæ•´çš„ JavaScript Date å¯¹è±¡

### è§£å†³æ–¹æ¡ˆ

å°† Date å¯¹è±¡è½¬æ¢ä¸º `YYYY-MM-DD` æ ¼å¼çš„å­—ç¬¦ä¸²

### ä¿®å¤æ•ˆæœ

- âœ… è§£å†³äº† "Unknown column 'class_date'" é”™è¯¯
- âœ… ç¡®ä¿æ•°æ®ç±»å‹ä¸€è‡´æ€§
- âœ… ç¬¦åˆæ•°æ®åº“è®¾è®¡è§„èŒƒ
- âœ… æé«˜äº†ç±»å‹å®‰å…¨æ€§

### åç»­å»ºè®®

1. **æ·»åŠ äº‹åŠ¡å¤„ç†**: ç¡®ä¿è¯·å‡ç”³è¯·ã€å®¡æ‰¹è®°å½•ã€é™„ä»¶è®°å½•çš„åŸå­æ€§
2. **æ·»åŠ å•å…ƒæµ‹è¯•**: è¦†ç›–æ—¥æœŸè½¬æ¢é€»è¾‘
3. **æ·»åŠ é›†æˆæµ‹è¯•**: æµ‹è¯•å®Œæ•´çš„è¯·å‡æµç¨‹
4. **ä»£ç å®¡æŸ¥**: æ£€æŸ¥å…¶ä»–åœ°æ–¹æ˜¯å¦æœ‰ç±»ä¼¼çš„æ—¥æœŸå¤„ç†é—®é¢˜

---

## ğŸ‰ ä¿®å¤å®Œæˆ

æ‰€æœ‰é—®é¢˜å·²ä¿®å¤ï¼Œè¯·å‡åŠŸèƒ½ç°åœ¨å¯ä»¥æ­£å¸¸å·¥ä½œï¼

