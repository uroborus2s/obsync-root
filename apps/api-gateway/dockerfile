# API Gateway ç‹¬ç«‹é¡¹ç›® Dockerfile - å¤šé˜¶æ®µæ„å»º
FROM --platform=$BUILDPLATFORM node:22-alpine AS builder
WORKDIR /app

# å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–
RUN apk add --no-cache wget

# å®‰è£… pnpm
RUN npm install -g pnpm

# å¤åˆ¶ package.json å’Œç›¸å…³é…ç½®æ–‡ä»¶
COPY package.json tsconfig.json .npmrc ./

# é…ç½® pnpm ä½¿ç”¨è…¾è®¯äº‘é•œåƒ
RUN pnpm config set registry http://mirrors.cloud.tencent.com/npm/

# å®‰è£…ä¾èµ– (ä¼šä¼˜å…ˆä½¿ç”¨ .npmrc ä¸­çš„ç§æœ‰ä»“åº“é…ç½®)
RUN pnpm install

# å¤åˆ¶æºä»£ç 
COPY src ./src

# æ„å»ºåº”ç”¨
RUN pnpm run build

# ç”Ÿäº§è¿è¡Œé˜¶æ®µ
FROM node:22-alpine AS runner
WORKDIR /app

# å®‰è£…å¿…è¦çš„ç³»ç»Ÿä¾èµ–
RUN apk add --no-cache wget curl

# è®¾ç½®ç¯å¢ƒå˜é‡
ENV NODE_ENV=production
ENV PORT=8090
ENV HOST=0.0.0.0

# åˆ›å»ºérootç”¨æˆ·
RUN addgroup --system --gid 1001 nodejs && \
    adduser --system --uid 1001 appuser

# å®‰è£… pnpm
RUN npm install -g pnpm

# é…ç½® npm è…¾è®¯äº‘åŠ é€Ÿå™¨
RUN pnpm config set registry http://mirrors.cloud.tencent.com/npm/

# å¤åˆ¶ package.json å’Œ .npmrc
COPY --chown=appuser:nodejs package.json ./
COPY --chown=appuser:nodejs .npmrc ./

# å®‰è£…ç”Ÿäº§ä¾èµ–
RUN pnpm install --prod && \
    pnpm store prune

# å¤åˆ¶æ„å»ºäº§ç‰©
COPY --from=builder --chown=appuser:nodejs /app/dist ./dist

# åˆ‡æ¢åˆ°érootç”¨æˆ·
USER appuser

# æš´éœ²ç«¯å£
EXPOSE 8090

# ğŸ”§ ä¼˜åŒ–å¥åº·æ£€æŸ¥é…ç½®
HEALTHCHECK --interval=30s --timeout=20s --start-period=60s --retries=5 \
    CMD curl -f --connect-timeout 5 --max-time 15 http://localhost:8090/health/simple || exit 1

# å¯åŠ¨å‘½ä»¤
CMD ["node", "dist/index.js"]
