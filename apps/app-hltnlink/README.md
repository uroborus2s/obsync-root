# @wps/hltnlink - æ•°æ®åŒæ­¥åº”ç”¨

åŸºäº Stratix æ¡†æ¶çš„ç°ä»£åŒ–æ•°æ®åŒæ­¥åº”ç”¨ï¼Œæä¾›ä»å¤–éƒ¨APIè¯»å–æ•°æ®å¹¶åŒæ­¥åˆ°SQLiteæ•°æ®åº“å’ŒWPSæ—¥å†çš„å®Œæ•´è§£å†³æ–¹æ¡ˆã€‚

## ğŸš€ åŠŸèƒ½ç‰¹æ€§

### æ ¸å¿ƒåŠŸèƒ½
- **å¤–éƒ¨APIæ•°æ®è¯»å–**ï¼šæ”¯æŒtokenç®¡ç†ã€åˆ†é¡µè¯»å–ã€è‡ªåŠ¨é‡è¯•
- **æ•°æ®è½¬æ¢ä¸éªŒè¯**ï¼šå®Œæ•´çš„æ•°æ®æ ¼å¼è½¬æ¢å’ŒéªŒè¯æœºåˆ¶
- **æ•°æ®åº“å­˜å‚¨**ï¼šåŸºäºSQLiteçš„é«˜æ•ˆæ•°æ®å­˜å‚¨
- **æ—¥å†åŒæ­¥**ï¼šä¸WPSæ—¥å†çš„æ— ç¼é›†æˆ
- **å·¥ä½œæµç®¡ç†**ï¼šåŸºäº@stratix/tasksçš„ä»»åŠ¡è°ƒåº¦å’Œæ‰§è¡Œ

### æŠ€æœ¯ç‰¹æ€§
- **å‡½æ•°å¼æ¶æ„**ï¼šåŸºäºStratixæ¡†æ¶çš„ç°ä»£åŒ–æ¶æ„è®¾è®¡
- **è‡ªåŠ¨ä¾èµ–æ³¨å…¥**ï¼šä½¿ç”¨withRegisterAutoDIå®ç°è‡ªåŠ¨æ¨¡å—å‘ç°
- **ç±»å‹å®‰å…¨**ï¼šå®Œæ•´çš„TypeScriptç±»å‹å®šä¹‰
- **é”™è¯¯å¤„ç†**ï¼šç»Ÿä¸€çš„é”™è¯¯å¤„ç†å’Œæ—¥å¿—è®°å½•
- **å¥åº·æ£€æŸ¥**ï¼šå®Œæ•´çš„ç³»ç»Ÿå¥åº·ç›‘æ§

## ğŸ“ é¡¹ç›®ç»“æ„

```
apps/app-hltnlink/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ types/                    # ç±»å‹å®šä¹‰
â”‚   â”‚   â”œâ”€â”€ api.ts               # APIæ¥å£ç±»å‹
â”‚   â”‚   â”œâ”€â”€ database.ts          # æ•°æ®åº“å®ä½“ç±»å‹
â”‚   â”‚   â”œâ”€â”€ service.ts           # æœåŠ¡å±‚ç±»å‹
â”‚   â”‚   â”œâ”€â”€ workflow.ts          # å·¥ä½œæµç±»å‹
â”‚   â”‚   â””â”€â”€ index.ts             # ç±»å‹å¯¼å‡º
â”‚   â”œâ”€â”€ adapters/                # é€‚é…å™¨å±‚
â”‚   â”‚   â”œâ”€â”€ ExternalApiAdapter.ts    # å¤–éƒ¨APIé€‚é…å™¨
â”‚   â”‚   â”œâ”€â”€ CalendarSyncAdapter.ts   # æ—¥å†åŒæ­¥é€‚é…å™¨
â”‚   â”‚   â””â”€â”€ index.ts             # é€‚é…å™¨å¯¼å‡º
â”‚   â”œâ”€â”€ services/                # æœåŠ¡å±‚
â”‚   â”‚   â”œâ”€â”€ interfaces/          # æœåŠ¡æ¥å£
â”‚   â”‚   â”œâ”€â”€ implementations/     # æœåŠ¡å®ç°
â”‚   â”‚   â””â”€â”€ index.ts             # æœåŠ¡å¯¼å‡º
â”‚   â”œâ”€â”€ executors/               # ä»»åŠ¡æ‰§è¡Œå™¨
â”‚   â”‚   â”œâ”€â”€ DataSyncExecutor.ts      # æ•°æ®åŒæ­¥æ‰§è¡Œå™¨
â”‚   â”‚   â”œâ”€â”€ CalendarSyncExecutor.ts  # æ—¥å†åŒæ­¥æ‰§è¡Œå™¨
â”‚   â”‚   â””â”€â”€ index.ts             # æ‰§è¡Œå™¨å¯¼å‡º
â”‚   â”œâ”€â”€ workflows/               # å·¥ä½œæµå®šä¹‰
â”‚   â”‚   â””â”€â”€ DataSyncWorkflow.ts      # æ•°æ®åŒæ­¥å·¥ä½œæµ
â”‚   â”œâ”€â”€ plugins/                 # Stratixæ’ä»¶
â”‚   â”‚   â””â”€â”€ hltnlink/
â”‚   â”‚       â””â”€â”€ index.ts         # æ’ä»¶å…¥å£
â”‚   â”œâ”€â”€ __tests__/               # æµ‹è¯•æ–‡ä»¶
â”‚   â”‚   â””â”€â”€ basic.test.ts        # åŸºç¡€åŠŸèƒ½æµ‹è¯•
â”‚   â”œâ”€â”€ index.ts                 # åº”ç”¨å…¥å£
â”‚   â””â”€â”€ stratix.config.ts        # Stratixé…ç½®
â”œâ”€â”€ package.json
â”œâ”€â”€ tsconfig.json
â””â”€â”€ README.md
```

## ğŸ› ï¸ æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: Stratix Framework (åŸºäºFastify 5 + Awilix 12)
- **è¯­è¨€**: TypeScript 5.8
- **æ•°æ®åº“**: SQLite (é€šè¿‡@stratix/database)
- **ä»»åŠ¡è°ƒåº¦**: @stratix/tasks
- **æ—¥å†é›†æˆ**: @stratix/was-v7
- **HTTPå®¢æˆ·ç«¯**: Axios
- **æµ‹è¯•**: Vitest
- **åŒ…ç®¡ç†**: pnpm

## ğŸ“‹ æ ¸å¿ƒç»„ä»¶

### 1. é€‚é…å™¨å±‚ (Adapters)

#### ExternalApiAdapter
- **åŠŸèƒ½**: å¤–éƒ¨APIæ•°æ®è¯»å–
- **ç‰¹æ€§**: Tokenè‡ªåŠ¨åˆ·æ–°ã€åˆ†é¡µè¯»å–ã€é”™è¯¯é‡è¯•
- **æ–¹æ³•**:
  - `readOnePage()`: è¯»å–å•é¡µæ•°æ®
  - `readAllPages()`: è¯»å–æ‰€æœ‰é¡µæ•°æ®
  - `readMultipleDataTypes()`: æ‰¹é‡è¯»å–å¤šç§æ•°æ®ç±»å‹

#### CalendarSyncAdapter
- **åŠŸèƒ½**: WPSæ—¥å†åŒæ­¥
- **ç‰¹æ€§**: äº‹ä»¶è½¬æ¢ã€é‡å¤è§„åˆ™ã€æ‰¹é‡æ“ä½œ
- **æ–¹æ³•**:
  - `syncSchedulesToCalendar()`: åŒæ­¥è¯¾è¡¨åˆ°æ—¥å†
  - `convertScheduleToEvent()`: è¯¾è¡¨è½¬æ—¥å†äº‹ä»¶

### 2. æœåŠ¡å±‚ (Services)

#### DataSyncService
- **åŠŸèƒ½**: æ•°æ®åŒæ­¥æ ¸å¿ƒæœåŠ¡
- **æ–¹æ³•**:
  - `executeFullSync()`: æ‰§è¡Œå®Œæ•´åŒæ­¥
  - `executeIncrementalSync()`: æ‰§è¡Œå¢é‡åŒæ­¥
  - `syncSchedulesToCalendar()`: åŒæ­¥åˆ°æ—¥å†

#### DataTransformService
- **åŠŸèƒ½**: æ•°æ®æ ¼å¼è½¬æ¢
- **æ–¹æ³•**:
  - `transformCourseData()`: è½¬æ¢è¯¾ç¨‹æ•°æ®
  - `transformStudentData()`: è½¬æ¢å­¦ç”Ÿæ•°æ®
  - `transformTeacherData()`: è½¬æ¢æ•™å¸ˆæ•°æ®
  - `transformScheduleData()`: è½¬æ¢è¯¾è¡¨æ•°æ®

### 3. æ‰§è¡Œå™¨å±‚ (Executors)

#### DataSyncExecutor
- **åŠŸèƒ½**: æ•°æ®åŒæ­¥ä»»åŠ¡æ‰§è¡Œå™¨
- **é…ç½®**: æ”¯æŒå®Œæ•´çš„JSON Schemaé…ç½®éªŒè¯
- **ç‰¹æ€§**: è‡ªåŠ¨é‡è¯•ã€è¿›åº¦è·Ÿè¸ªã€é”™è¯¯å¤„ç†

#### CalendarSyncExecutor
- **åŠŸèƒ½**: æ—¥å†åŒæ­¥ä»»åŠ¡æ‰§è¡Œå™¨
- **é…ç½®**: æ”¯æŒå¤šç§åŒæ­¥æ¨¡å¼å’Œè¿‡æ»¤é€‰é¡¹
- **ç‰¹æ€§**: æ‰¹é‡å¤„ç†ã€äº‹ä»¶éªŒè¯ã€å†²çªè§£å†³

### 4. å·¥ä½œæµ (Workflows)

#### å®Œæ•´æ•°æ®åŒæ­¥å·¥ä½œæµ
- **åç§°**: `hltnlink-full-data-sync`
- **åŠŸèƒ½**: å®Œæ•´çš„æ•°æ®åŒæ­¥æµç¨‹
- **æ­¥éª¤**: éªŒè¯ â†’ å¹¶è¡ŒåŒæ­¥ â†’ æ•°æ®éªŒè¯ â†’ æ—¥å†åŒæ­¥ â†’ æ¸…ç†é€šçŸ¥

#### å¢é‡æ•°æ®åŒæ­¥å·¥ä½œæµ
- **åç§°**: `hltnlink-incremental-data-sync`
- **åŠŸèƒ½**: å¢é‡æ•°æ®åŒæ­¥
- **ç‰¹æ€§**: åŸºäºæ—¶é—´æˆ³çš„å¢é‡æ›´æ–°

## ğŸ”§ é…ç½®è¯´æ˜

### ç¯å¢ƒé…ç½® (dev.env.json)
```json
{
  "hltnlink": {
    "api": {
      "baseUrl": "https://api.example.com",
      "appId": "your-app-id",
      "appSecret": "your-app-secret",
      "timeout": 30000
    },
    "sync": {
      "batchSize": 1000,
      "enableAutoSync": true,
      "autoSyncCron": "0 */2 * * *"
    },
    "calendar": {
      "defaultCalendarId": "your-calendar-id",
      "syncMode": "MERGE"
    }
  }
}
```

### æ’ä»¶é…ç½®
æ’ä»¶ä¼šè‡ªåŠ¨æ³¨å†Œä»¥ä¸‹ç»„ä»¶ï¼š
- æ•°æ®åŒæ­¥æ‰§è¡Œå™¨
- æ—¥å†åŒæ­¥æ‰§è¡Œå™¨
- å·¥ä½œæµå®šä¹‰
- å¥åº·æ£€æŸ¥ç«¯ç‚¹
- APIè·¯ç”±

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. å®‰è£…ä¾èµ–
```bash
pnpm install
```

### 2. é…ç½®ç¯å¢ƒ
ç¼–è¾‘ `dev.env.json` æ–‡ä»¶ï¼Œé…ç½®APIå’Œæ—¥å†ç›¸å…³å‚æ•°ã€‚

### 3. æ„å»ºé¡¹ç›®
```bash
pnpm run build
```

### 4. è¿è¡Œæµ‹è¯•
```bash
pnpm test
```

### 5. å¯åŠ¨åº”ç”¨
```bash
pnpm run dev
```

## ğŸ“¡ APIç«¯ç‚¹

### å¥åº·æ£€æŸ¥
- `GET /health/hltnlink` - ç³»ç»Ÿå¥åº·çŠ¶æ€

### åŒæ­¥ç®¡ç†
- `GET /api/hltnlink/sync/status/:syncId` - æŸ¥è¯¢åŒæ­¥çŠ¶æ€
- `POST /api/hltnlink/sync/trigger` - æ‰‹åŠ¨è§¦å‘åŒæ­¥

### è¯·æ±‚ç¤ºä¾‹
```bash
# è§¦å‘å®Œæ•´åŒæ­¥
curl -X POST http://localhost:3001/api/hltnlink/sync/trigger \
  -H "Content-Type: application/json" \
  -d '{
    "syncType": "FULL",
    "dataTypes": ["courses", "students", "teachers", "schedules"],
    "options": {
      "batchSize": 1000,
      "enableCalendarSync": true
    }
  }'
```

## ğŸ§ª æµ‹è¯•

é¡¹ç›®åŒ…å«å®Œæ•´çš„æµ‹è¯•å¥—ä»¶ï¼š

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pnpm test

# è¿è¡Œç‰¹å®šæµ‹è¯•
pnpm test basic.test.ts

# ç”Ÿæˆæµ‹è¯•è¦†ç›–ç‡æŠ¥å‘Š
pnpm test --coverage
```

## ğŸ“ å¼€å‘æŒ‡å—

### æ·»åŠ æ–°çš„æ•°æ®ç±»å‹
1. åœ¨ `types/api.ts` ä¸­æ·»åŠ å¤–éƒ¨æ•°æ®ç±»å‹å®šä¹‰
2. åœ¨ `types/database.ts` ä¸­æ·»åŠ å†…éƒ¨æ•°æ®åº“å®ä½“
3. åœ¨ `DataTransformService` ä¸­æ·»åŠ è½¬æ¢é€»è¾‘
4. æ›´æ–°å·¥ä½œæµå®šä¹‰ä»¥åŒ…å«æ–°çš„æ•°æ®ç±»å‹

### è‡ªå®šä¹‰æ‰§è¡Œå™¨
1. å®ç° `TaskExecutor` æ¥å£
2. æ·»åŠ  `@Executor()` è£…é¥°å™¨
3. åœ¨æ’ä»¶ä¸­æ³¨å†Œæ‰§è¡Œå™¨
4. æ›´æ–°å·¥ä½œæµå®šä¹‰ä»¥ä½¿ç”¨æ–°æ‰§è¡Œå™¨

## ğŸ” ç›‘æ§å’Œæ—¥å¿—

åº”ç”¨æä¾›å®Œæ•´çš„ç›‘æ§å’Œæ—¥å¿—åŠŸèƒ½ï¼š
- ç»“æ„åŒ–æ—¥å¿—è®°å½•
- æ€§èƒ½æŒ‡æ ‡æ”¶é›†
- é”™è¯¯è¿½è¸ªå’ŒæŠ¥å‘Š
- å¥åº·çŠ¶æ€ç›‘æ§

## ğŸ¤ è´¡çŒ®æŒ‡å—

1. Fork é¡¹ç›®
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯
3. æäº¤æ›´æ”¹
4. æ¨é€åˆ°åˆ†æ”¯
5. åˆ›å»º Pull Request

## ğŸ“„ è®¸å¯è¯

æœ¬é¡¹ç›®é‡‡ç”¨ MIT è®¸å¯è¯ã€‚è¯¦è§ LICENSE æ–‡ä»¶ã€‚
