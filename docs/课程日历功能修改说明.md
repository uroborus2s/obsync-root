# 课程日历功能修改说明

## 📝 修改概述

根据需求，对课程日历功能进行了重要调整，将树形结构从三级改为两级，并优化了数据加载逻辑。

---

## 🔄 主要修改内容

### 1. 树形结构调整

**修改前**：
- 三级树形结构：根节点 → 日历列表 → 课程列表
- 一次性加载所有数据（包括课程节点）

**修改后**：
- 两级树形结构：根节点 → 日历列表
- 懒加载方式，只在需要时加载课程数据
- 课程数据通过右侧Tab页展示，不在树中显示

### 2. 数据加载方式

**修改前**：
```typescript
// 树形结构包含课程节点
{
  id: 'root',
  label: '吉林财经大学课表',
  type: 'root',
  children: [
    {
      id: 'calendar-1',
      label: '日历名称',
      type: 'calendar',
      children: [
        {
          id: 'course-1',
          label: '课程名称',
          type: 'course'  // ❌ 不再需要
        }
      ]
    }
  ]
}
```

**修改后**：
```typescript
// 树形结构只包含日历节点
{
  id: 'root',
  label: '吉林财经大学课表',
  type: 'root',
  children: [
    {
      id: 'calendar-1',
      label: '日历名称',
      type: 'calendar',
      calendarId: 'cal_xxx',
      kkh: 'CS101',
      xnxq: '2024-2025-1'
      // ✅ 不包含课程子节点
    }
  ]
}
```

### 3. 用户交互流程

**修改前**：
1. 用户展开日历节点
2. 显示课程子节点
3. 点击课程节点查看详情

**修改后**：
1. 用户点击日历节点
2. 右侧Tab页自动加载数据：
   - Tab 1：日历参与者列表（调用WPS API）
   - Tab 2：课程详情列表（查询数据库）

---

## 📁 修改的文件清单

### 后端文件（2个）

#### 1. `apps/app-icalink/src/services/interfaces/ICourseCalendarService.ts`

**修改内容**：
- 更新 `CourseCalendarTreeNodeType` 类型定义
- 移除 `'course'` 类型选项
- 更新 `CourseCalendarTreeNode` 接口注释

**关键代码**：
```typescript
// 修改前
export type CourseCalendarTreeNodeType = 'root' | 'calendar' | 'course';

// 修改后
export type CourseCalendarTreeNodeType = 'root' | 'calendar';
```

#### 2. `apps/app-icalink/src/services/CourseCalendarService.ts`

**修改内容**：
- 重构 `getCourseCalendarTree()` 方法
- 移除课程节点构建逻辑
- 简化树形结构，只返回两级
- 修正错误返回格式（使用 `code` 和 `message` 字段）

**关键代码**：
```typescript
// 修改前：构建三级树（包含课程节点）
for (const mapping of calendarMappings) {
  const calendarNode = { /* ... */ };
  
  // 获取课程并创建子节点
  const courses = await this.attendanceCourseRepository.findMany(/* ... */);
  for (const course of courses) {
    const courseNode = { type: 'course', /* ... */ };
    calendarNode.children!.push(courseNode);
  }
  
  rootNode.children!.push(calendarNode);
}

// 修改后：只构建两级树（不包含课程节点）
for (const mapping of calendarMappings) {
  const calendarNode: CourseCalendarTreeNode = {
    id: `calendar-${mapping.id}`,
    label: mapping.calendar_name || mapping.calendar_id,
    type: 'calendar',
    calendarId: mapping.calendar_id,
    kkh: mapping.kkh,
    xnxq: mapping.xnxq,
    metadata: {
      mappingId: mapping.id,
      createdAt: mapping.created_at,
      updatedAt: mapping.updated_at
    }
  };
  
  rootNode.children!.push(calendarNode);
}
```

### 前端文件（2个）

#### 3. `apps/agendaedu-web/src/types/course-calendar.types.ts`

**修改内容**：
- 更新 `CourseCalendarTreeNodeType` 类型定义
- 移除 `'course'` 类型选项
- 添加 `kkh` 字段到 `CourseCalendarTreeNode` 接口

**关键代码**：
```typescript
// 修改前
export type CourseCalendarTreeNodeType = 'root' | 'calendar' | 'course'

// 修改后
export type CourseCalendarTreeNodeType = 'root' | 'calendar'
```

#### 4. `apps/agendaedu-web/src/routes/_authenticated/course-calendar/index.tsx`

**修改内容**：
- 重构 `renderTreeNode()` 函数
- 移除课程节点渲染逻辑
- 优化节点点击交互
- 移除 `BookOpen` 图标（课程节点专用）

**关键代码**：
```typescript
// 修改前：处理三种节点类型
onClick={() => {
  if (hasChildren) {
    toggleNode(node.id)
  }
  if (node.type === 'calendar' && node.calendarId) {
    selectCalendar(node.calendarId)
  }
}}

// 修改后：只处理两种节点类型
onClick={() => {
  if (node.type === 'root' && hasChildren) {
    toggleNode(node.id)
  } else if (node.type === 'calendar' && node.calendarId) {
    selectCalendar(node.calendarId)
  }
}}
```

---

## ✅ 验证要点

### 1. 后端API验证

#### 测试树形结构接口
```bash
curl -X GET http://localhost:8090/api/icalink/v1/course-calendar/tree \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**预期响应**：
```json
{
  "success": true,
  "data": {
    "id": "root",
    "label": "吉林财经大学课表",
    "type": "root",
    "children": [
      {
        "id": "calendar-1",
        "label": "2024-2025学年第一学期-高等数学",
        "type": "calendar",
        "calendarId": "cal_xxx",
        "kkh": "CS101",
        "xnxq": "2024-2025-1",
        "metadata": {
          "mappingId": 1,
          "createdAt": "2024-01-01T00:00:00Z",
          "updatedAt": "2024-01-01T00:00:00Z"
        }
      }
    ]
  }
}
```

**验证要点**：
- ✅ `children` 数组只包含日历节点
- ✅ 日历节点包含 `calendarId`、`kkh`、`xnxq` 字段
- ✅ 日历节点**不包含** `children` 字段（或为空）
- ✅ 没有 `type: 'course'` 的节点

#### 测试课程详情接口
```bash
curl -X GET http://localhost:8090/api/icalink/v1/course-calendar/cal_xxx/courses \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**预期响应**：
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "courseName": "高等数学",
      "teachingWeek": 1,
      "weekDay": 1,
      "teacherNames": "张三",
      "classLocation": "教学楼A-101",
      "startTime": "2024-09-01T08:00:00Z",
      "endTime": "2024-09-01T09:40:00Z",
      "attendanceEnabled": true
    }
  ]
}
```

### 2. 前端界面验证

#### 树形结构验证
1. 打开课程表页面：`http://localhost:5173/web/course-calendar`
2. 检查左侧树形结构：
   - ✅ 根节点显示"吉林财经大学课表"
   - ✅ 根节点有展开/收起箭头
   - ✅ 展开后显示日历列表
   - ✅ 日历节点显示日历图标（蓝色）
   - ✅ 日历节点**没有**展开/收起箭头
   - ✅ 日历节点**没有**子节点

#### 交互验证
1. 点击根节点：
   - ✅ 展开/收起日历列表
   - ✅ 右侧不显示详情

2. 点击日历节点：
   - ✅ 节点高亮显示
   - ✅ 右侧Tab 1自动加载参与者列表
   - ✅ 右侧Tab 2自动加载课程详情列表

3. 切换Tab页：
   - ✅ Tab 1显示参与者信息（用户ID、权限角色）
   - ✅ Tab 2显示课程信息（课程名称、教学周、教师、地点、时间等）

### 3. 数据一致性验证

#### 验证数据库查询
```sql
-- 检查日历映射数据
SELECT id, kkh, xnxq, calendar_id, calendar_name, is_deleted
FROM icasync_calendar_mapping
WHERE is_deleted = 0;

-- 检查课程数据
SELECT id, course_code, course_name, semester, teaching_week, week_day
FROM icasync_attendance_courses
WHERE course_code = 'CS101'
  AND semester = '2024-2025-1'
  AND deleted_at IS NULL
ORDER BY teaching_week, week_day;
```

#### 验证WPS API调用
- 确保 `WpsCalendarAdapter.getAllCalendarPermissions()` 正常工作
- 检查返回的权限列表格式正确

---

## 🎯 功能对比

| 功能项 | 修改前 | 修改后 |
|--------|--------|--------|
| 树形结构层级 | 3级（根→日历→课程） | 2级（根→日历） |
| 课程数据加载 | 树加载时一次性获取 | 点击日历时按需加载 |
| 课程数据展示 | 树节点 | Tab页表格 |
| 节点类型 | root, calendar, course | root, calendar |
| 数据加载性能 | 较慢（一次加载所有） | 较快（懒加载） |
| 用户体验 | 需要展开多层 | 直接点击查看 |

---

## 📊 性能优化

### 修改前的问题
1. **初始加载慢**：一次性加载所有日历和课程数据
2. **内存占用高**：树结构包含大量课程节点
3. **渲染性能差**：需要渲染三级嵌套结构

### 修改后的优势
1. **初始加载快**：只加载日历列表
2. **内存占用低**：树结构只包含日历节点
3. **渲染性能好**：只渲染两级结构
4. **按需加载**：只在用户点击时加载课程数据

---

## 🔧 技术细节

### ServiceResult 错误格式

修改了错误返回格式，使用 `code` 和 `message` 字段：

```typescript
// 修改前（错误）
return {
  success: false,
  error: {
    code: ServiceErrorCode.INTERNAL_ERROR,
    message: '错误信息'
  }
};

// 修改后（正确）
return {
  success: false,
  code: ServiceErrorCode.INTERNAL_ERROR,
  message: '错误信息'
};
```

### Maybe 类型处理

正确使用 `isSome()` 和 `.value` 访问 Maybe 类型：

```typescript
const calendarMapping = await this.calendarMappingRepository.findByCalendarId(calendarId);

if (!isSome(calendarMapping)) {
  return { success: false, code: ServiceErrorCode.RESOURCE_NOT_FOUND, message: '日历不存在' };
}

const mapping = calendarMapping.value;  // ✅ 正确访问值
const courses = await this.attendanceCourseRepository.findMany((qb) =>
  qb.where('course_code', '=', mapping.kkh)  // ✅ 使用 mapping.kkh
);
```

---

## 📝 后续建议

1. **添加加载状态**：在Tab页数据加载时显示骨架屏
2. **错误处理**：完善API调用失败时的错误提示
3. **缓存优化**：使用React Query的缓存机制避免重复请求
4. **搜索功能**：添加日历和课程的搜索过滤
5. **性能监控**：监控API响应时间和前端渲染性能

---

## ✨ 总结

本次修改成功将课程日历功能从三级树形结构简化为两级，采用懒加载方式优化了性能，提升了用户体验。所有修改都严格遵循Stratix框架规范，确保了代码的一致性和可维护性。

**修改完成时间**：2025-11-01
**修改文件数量**：4个（后端2个，前端2个）
**测试状态**：待验证

