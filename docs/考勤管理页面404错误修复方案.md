# è€ƒå‹¤ç®¡ç†é¡µé¢ 404 é”™è¯¯ä¿®å¤æ–¹æ¡ˆ

## ğŸ› é—®é¢˜æè¿°

**é”™è¯¯ç°è±¡**ï¼š
- å‰ç«¯é¡µé¢æ˜¾ç¤ºï¼š`APIè¯·æ±‚å¤±è´¥: 404 {"error":"Route not found","message":"Route not found","path":"/api/icalink/v1/attendance/overall-stats","timestamp":"2025-10-27T02:18:48.7932"}`
- é¡µé¢æ— æ³•æ˜¾ç¤ºè€ƒå‹¤ç»Ÿè®¡æ•°æ®

**é”™è¯¯æˆªå›¾åˆ†æ**ï¼š
- é¡µé¢è·¯å¾„ï¼š`/attendance/students`ï¼ˆè€ƒå‹¤ç®¡ç† â†’ å­¦ç”Ÿè€ƒå‹¤ï¼‰
- é”™è¯¯æ¥å£ï¼š`/api/icalink/v1/attendance/overall-stats`
- HTTP çŠ¶æ€ç ï¼š404

---

## ğŸ” æ ¹æœ¬åŸå› åˆ†æ

### 1. æ¥å£å·²åºŸå¼ƒ

æ ¹æ® `apps/app-icalink/docs/æ¥å£æ¸…ç†åˆ†ææŠ¥å‘Š.md`ï¼š

```markdown
12. âŒ **GET** `/api/icalink/v1/attendance/overall-stats` - ç³»ç»Ÿçº§åˆ«å…¨å±€ç»Ÿè®¡
    - ä½ç½®ï¼š`AttendanceController.ts:816`
    - åŸå› ï¼šå‰ç«¯ä»æœªè°ƒç”¨ï¼ŒåŠŸèƒ½æœªå®ç°
    - å»ºè®®ï¼šåˆ é™¤
```

**è¯¥æ¥å£å·²åœ¨åç«¯è¢«åˆ é™¤ï¼Œä½†å‰ç«¯ä»£ç ä»åœ¨è°ƒç”¨ã€‚**

### 2. å‰ç«¯è°ƒç”¨ä½ç½®

**æ–‡ä»¶**ï¼š`apps/agendaedu-web/src/lib/attendance-api.ts`

```typescript
// ç¬¬ 781-797 è¡Œ
async getOverallStats(
  params?: Partial<AttendanceQueryParams>
): Promise<ApiResponse<AttendanceStats>> {
  const queryString = new URLSearchParams()

  if (params) {
    if (params.xnxq) queryString.append('xnxq', params.xnxq)
    if (params.start_date) queryString.append('start_date', params.start_date)
    if (params.end_date) queryString.append('end_date', params.end_date)
  }

  const endpoint = `/api/icalink/v1/attendance/overall-stats${queryString.toString() ? `?${queryString.toString()}` : ''}`
  return this.makeRequest<ApiResponse<AttendanceStats>>(endpoint)
}
```

**è°ƒç”¨è¯¥æ–¹æ³•çš„ç»„ä»¶**ï¼š
1. `apps/agendaedu-web/src/features/attendance/components/attendance-overview.tsx` (ç¬¬ 34 è¡Œ)
2. `apps/agendaedu-web/src/features/attendance/components/stats-attendance-tab.tsx` (ç¬¬ 50 è¡Œ)

### 3. æ­£ç¡®çš„æ¥å£

åç«¯ç°åœ¨æä¾›çš„ç»Ÿè®¡æ¥å£åœ¨ `StatsController` ä¸­ï¼š

| æ¥å£è·¯å¾„ | åŠŸèƒ½ | æ•°æ®æ¥æº |
|---------|------|---------|
| `/api/icalink/v1/stats/absent-history` | ç¼ºå‹¤å†å²æ˜ç»† | `icalink_absent_student_relations` è¡¨ |
| `/api/icalink/v1/stats/course-stats` | è¯¾ç¨‹å†å²ç»Ÿè®¡ | `icalink_course_checkin_stats` è¡¨ |
| `/api/icalink/v1/stats/teaching-class` | æ•™å­¦ç­æ•°æ® | `v_teaching_class` è§†å›¾ |
| `/api/icalink/v1/stats/student-stats` | å­¦ç”Ÿå†å²ç»Ÿè®¡ | `view_student_overall_attendance_stats` è§†å›¾ |
| `/api/icalink/v1/stats/student-stats-details` | å­¦ç”Ÿç»Ÿè®¡è¯¦æƒ… | `view_student_overall_attendance_stats_details` è§†å›¾ |

---

## âœ… ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨ç°æœ‰çš„å­¦ç”Ÿç»Ÿè®¡æ¥å£ï¼ˆæ¨èï¼‰

ä¿®æ”¹ `attendance-api.ts` ä¸­çš„ `getOverallStats()` æ–¹æ³•ï¼Œæ”¹ä¸ºè°ƒç”¨ `/api/icalink/v1/stats/student-stats` æ¥å£ã€‚

**ä¼˜ç‚¹**ï¼š
- åˆ©ç”¨ç°æœ‰æ¥å£ï¼Œæ— éœ€åç«¯å¼€å‘
- æ•°æ®æ¥è‡ªæ•°æ®åº“è§†å›¾ï¼Œæ€§èƒ½å¥½
- æ”¯æŒåˆ†é¡µå’Œæœç´¢

**ç¼ºç‚¹**ï¼š
- è¿”å›çš„æ˜¯å­¦ç”Ÿç»´åº¦çš„ç»Ÿè®¡æ•°æ®ï¼Œä¸æ˜¯æ•´ä½“æ¦‚è§ˆ
- éœ€è¦å‰ç«¯è°ƒæ•´æ•°æ®å±•ç¤ºé€»è¾‘

### æ–¹æ¡ˆ 2ï¼šåœ¨åç«¯æ–°å¢æ•´ä½“ç»Ÿè®¡æ¥å£

åœ¨ `StatsController` ä¸­æ–°å¢ä¸€ä¸ª `/api/icalink/v1/stats/overall-summary` æ¥å£ï¼Œæä¾›æ•´ä½“ç»Ÿè®¡æ¦‚è§ˆæ•°æ®ã€‚

**ä¼˜ç‚¹**ï¼š
- æä¾›çœŸæ­£çš„æ•´ä½“ç»Ÿè®¡æ•°æ®
- å‰ç«¯æ”¹åŠ¨æœ€å°

**ç¼ºç‚¹**ï¼š
- éœ€è¦åç«¯å¼€å‘
- éœ€è¦è®¾è®¡æ–°çš„æ•°æ®èšåˆé€»è¾‘

### æ–¹æ¡ˆ 3ï¼šå‰ç«¯ç›´æ¥è°ƒç”¨å¤šä¸ªæ¥å£å¹¶èšåˆ

å‰ç«¯åŒæ—¶è°ƒç”¨å¤šä¸ªç»Ÿè®¡æ¥å£ï¼Œåœ¨å®¢æˆ·ç«¯è¿›è¡Œæ•°æ®èšåˆã€‚

**ä¼˜ç‚¹**ï¼š
- çµæ´»æ€§é«˜
- å¯ä»¥å±•ç¤ºæ›´ä¸°å¯Œçš„æ•°æ®

**ç¼ºç‚¹**ï¼š
- å‰ç«¯é€»è¾‘å¤æ‚
- å¤šæ¬¡ API è°ƒç”¨ï¼Œæ€§èƒ½è¾ƒå·®

---

## ğŸ› ï¸ æ¨èå®æ–½æ­¥éª¤ï¼ˆæ–¹æ¡ˆ 1ï¼‰

### æ­¥éª¤ 1ï¼šä¿®æ”¹ `attendance-api.ts`

```typescript
// apps/agendaedu-web/src/lib/attendance-api.ts

/**
 * è·å–æ•´ä½“è€ƒå‹¤ç»Ÿè®¡ï¼ˆä½¿ç”¨å­¦ç”Ÿç»Ÿè®¡æ¥å£ï¼‰
 */
async getOverallStats(
  params?: Partial<AttendanceQueryParams>
): Promise<ApiResponse<AttendanceStats>> {
  const queryString = new URLSearchParams()

  // ä½¿ç”¨æ–°çš„ç»Ÿè®¡æ¥å£
  if (params) {
    if (params.xnxq) queryString.append('semester', params.xnxq)
    if (params.start_date) queryString.append('start_date', params.start_date)
    if (params.end_date) queryString.append('end_date', params.end_date)
  }

  // æ·»åŠ åˆ†é¡µå‚æ•°
  queryString.append('page', '1')
  queryString.append('pageSize', '100')

  const endpoint = `/api/icalink/v1/stats/student-stats${queryString.toString() ? `?${queryString.toString()}` : ''}`
  
  try {
    const response = await this.makeRequest<any>(endpoint)
    
    if (response.success && response.data) {
      // å°†å­¦ç”Ÿç»Ÿè®¡æ•°æ®è½¬æ¢ä¸ºæ•´ä½“ç»Ÿè®¡æ ¼å¼
      const studentStats = response.data.data || []
      const totalStudents = response.data.total || 0
      
      // è®¡ç®—æ•´ä½“ç»Ÿè®¡
      const totalSessions = studentStats.reduce((sum: number, s: any) => sum + (s.total_sessions || 0), 0)
      const totalAbsent = studentStats.reduce((sum: number, s: any) => sum + (s.absent_count || 0), 0)
      const totalLeave = studentStats.reduce((sum: number, s: any) => sum + (s.leave_count || 0), 0)
      const totalTruant = studentStats.reduce((sum: number, s: any) => sum + (s.truant_count || 0), 0)
      const totalCompleted = studentStats.reduce((sum: number, s: any) => sum + (s.completed_sessions || 0), 0)
      
      const overallAttendanceRate = totalCompleted > 0 
        ? ((totalCompleted - totalAbsent) / totalCompleted * 100).toFixed(2)
        : '0.00'
      
      return {
        success: true,
        message: 'è·å–æ•´ä½“ç»Ÿè®¡æˆåŠŸ',
        data: {
          total_students: totalStudents,
          total_sessions: totalSessions,
          total_completed: totalCompleted,
          total_absent: totalAbsent,
          total_leave: totalLeave,
          total_truant: totalTruant,
          overall_attendance_rate: parseFloat(overallAttendanceRate),
          // ä¿æŒä¸åŸæ¥å£å…¼å®¹
          total_courses: 0, // å¦‚éœ€è¦ï¼Œå¯ä»¥è°ƒç”¨ course-stats æ¥å£è·å–
          total_classes: 0,
        } as AttendanceStats
      }
    }
    
    return {
      success: false,
      message: response.message || 'è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥',
      data: null
    }
  } catch (error) {
    return {
      success: false,
      message: `è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥: ${error}`,
      data: null
    }
  }
}
```

### æ­¥éª¤ 2ï¼šæ›´æ–°ç±»å‹å®šä¹‰ï¼ˆå¦‚éœ€è¦ï¼‰

æ£€æŸ¥ `AttendanceStats` ç±»å‹å®šä¹‰æ˜¯å¦éœ€è¦è°ƒæ•´ï¼š

```typescript
// apps/agendaedu-web/src/types/attendance.types.ts

export interface AttendanceStats {
  total_students: number
  total_courses: number
  total_classes: number
  total_sessions: number
  total_completed: number
  total_absent: number
  total_leave: number
  total_truant: number
  overall_attendance_rate: number
}
```

### æ­¥éª¤ 3ï¼šæµ‹è¯•ä¿®æ”¹

1. é‡å¯å‰ç«¯å¼€å‘æœåŠ¡å™¨
2. è®¿é—®è€ƒå‹¤ç®¡ç†é¡µé¢
3. æ£€æŸ¥æ•°æ®æ˜¯å¦æ­£å¸¸æ˜¾ç¤º
4. éªŒè¯ç»Ÿè®¡æ•°å­—æ˜¯å¦æ­£ç¡®

---

## ğŸ§ª æµ‹è¯•æ¥å£

### æµ‹è¯•å­¦ç”Ÿç»Ÿè®¡æ¥å£

```bash
# ä½¿ç”¨æµè§ˆå™¨è®¿é—®ï¼ˆéœ€è¦å…ˆç™»å½•ï¼‰
http://localhost:5175/web/

# æˆ–ä½¿ç”¨ curlï¼ˆéœ€è¦æ·»åŠ è®¤è¯ Cookieï¼‰
curl -H "Cookie: wps_jwt_token=YOUR_TOKEN" \
  "http://localhost:3000/api/icalink/v1/stats/student-stats?page=1&pageSize=10"
```

### é¢„æœŸå“åº”æ ¼å¼

```json
{
  "success": true,
  "data": {
    "data": [
      {
        "student_id": "105063",
        "name": "ç‹æ•",
        "school_name": "ç»æµå­¦é™¢",
        "major_name": "ç»æµå­¦",
        "class_name": "ç»æµ1ç­",
        "total_sessions": 100,
        "completed_sessions": 95,
        "absent_count": 5,
        "leave_count": 2,
        "truant_count": 3,
        "absence_rate": 5.26
      }
    ],
    "total": 1,
    "page": 1,
    "pageSize": 10,
    "totalPages": 1
  }
}
```

---

## ğŸ“‹ ç›¸å…³æ–‡ä»¶æ¸…å•

### éœ€è¦ä¿®æ”¹çš„æ–‡ä»¶
1. `apps/agendaedu-web/src/lib/attendance-api.ts` - ä¿®æ”¹ `getOverallStats()` æ–¹æ³•
2. `apps/agendaedu-web/src/features/attendance/components/attendance-overview.tsx` - å¯èƒ½éœ€è¦è°ƒæ•´æ•°æ®å±•ç¤ºé€»è¾‘
3. `apps/agendaedu-web/src/features/attendance/components/stats-attendance-tab.tsx` - å¯èƒ½éœ€è¦è°ƒæ•´æ•°æ®å±•ç¤ºé€»è¾‘

### å‚è€ƒæ–‡ä»¶
1. `apps/app-icalink/src/controllers/StatsController.ts` - åç«¯ç»Ÿè®¡æ¥å£å®ç°
2. `apps/app-icalink/src/config/wps-dbsheet-fields.ts` - æ•°æ®è¡¨é…ç½®
3. `apps/app-icalink/docs/æ¥å£æ¸…ç†åˆ†ææŠ¥å‘Š.md` - æ¥å£å˜æ›´æ–‡æ¡£

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³ä¿®å¤**ï¼šæŒ‰ç…§æ–¹æ¡ˆ 1 ä¿®æ”¹ `attendance-api.ts`
2. **æµ‹è¯•éªŒè¯**ï¼šç¡®ä¿é¡µé¢èƒ½æ­£å¸¸æ˜¾ç¤ºæ•°æ®
3. **ä¼˜åŒ–æ”¹è¿›**ï¼šæ ¹æ®å®é™…éœ€æ±‚è€ƒè™‘æ˜¯å¦éœ€è¦å®æ–½æ–¹æ¡ˆ 2
4. **æ–‡æ¡£æ›´æ–°**ï¼šæ›´æ–° API æ–‡æ¡£ï¼Œè®°å½•æ¥å£å˜æ›´

---

## ğŸ’¡ é¢å¤–å»ºè®®

### 1. ç»Ÿä¸€æ¥å£è°ƒç”¨

å»ºè®®å‰ç«¯ç»Ÿä¸€ä½¿ç”¨ `StatsController` æä¾›çš„æ¥å£ï¼Œè€Œä¸æ˜¯æ··ç”¨å¤šä¸ªæ§åˆ¶å™¨çš„æ¥å£ã€‚

### 2. é”™è¯¯å¤„ç†

åœ¨å‰ç«¯æ·»åŠ æ›´å‹å¥½çš„é”™è¯¯æç¤ºï¼Œå½“æ¥å£è¿”å› 404 æ—¶ï¼Œæç¤ºç”¨æˆ·"æ•°æ®æ¥å£å·²æ›´æ–°ï¼Œè¯·åˆ·æ–°é¡µé¢"ã€‚

### 3. æ•°æ®ç¼“å­˜

è€ƒè™‘åœ¨å‰ç«¯æ·»åŠ æ•°æ®ç¼“å­˜æœºåˆ¶ï¼Œå‡å°‘ä¸å¿…è¦çš„ API è°ƒç”¨ã€‚

### 4. æ¥å£ç‰ˆæœ¬ç®¡ç†

å»ºè®®åœ¨ API è·¯å¾„ä¸­æ·»åŠ ç‰ˆæœ¬å·ï¼ˆå¦‚ `/api/v2/`ï¼‰ï¼Œæ–¹ä¾¿æœªæ¥çš„æ¥å£å‡çº§å’Œå…¼å®¹æ€§ç®¡ç†ã€‚


