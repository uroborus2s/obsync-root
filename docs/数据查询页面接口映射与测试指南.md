# æ•°æ®æŸ¥è¯¢é¡µé¢æ¥å£æ˜ å°„ä¸æµ‹è¯•æŒ‡å—

## ğŸ“‹ SHEET_LIST é…ç½®ä¸æ¥å£æ˜ å°„è¡¨

æ ¹æ® `apps/app-icalink/src/config/wps-dbsheet-fields.ts` ä¸­çš„ `SHEET_LIST` é…ç½®ï¼Œä»¥ä¸‹æ˜¯å„ä¸ªæ•°æ®é¡µé¢ä¸åç«¯æ¥å£çš„å¯¹åº”å…³ç³»ï¼š

| åºå· | é¡µé¢åç§° | Sheet ID | æ•°æ®åº“è¡¨/è§†å›¾ | åç«¯æ¥å£ | å‰ç«¯è·¯ç”± |
|------|---------|----------|--------------|---------|---------|
| 1 | ç¼ºå‹¤å†å²æ˜ç»†è¡¨ | 2 | `absentStudentRelationRepository` | `/api/icalink/v1/stats/absent-history` | `/data-query/absent-history` |
| 2 | è¯¾ç¨‹å†å²ç»Ÿè®¡è¡¨ | 3 | `courseCheckinStatsRepository` | `/api/icalink/v1/stats/course-stats` | `/data-query/course-stats` |
| 3 | æ•™å­¦ç­è¡¨ | 4 | `vTeachingClassRepository` | `/api/icalink/v1/stats/teaching-class` | `/data-query/teaching-class` |
| 4 | å­¦ç”Ÿå†å²ç»Ÿè®¡è¡¨ | 5 | `courseCheckinStatsRepository` | `/api/icalink/v1/stats/student-stats` | `/data-query/student-stats` |
| 5 | å­¦ç”Ÿå†å²ç»Ÿè®¡è¯¦æƒ…è¡¨ | 6 (å·²æ³¨é‡Š) | `courseCheckinStatsRepository` | `/api/icalink/v1/stats/student-stats-details` | `/data-query/student-stats-details` |

---

## ğŸ” æ¥å£è¯¦ç»†è¯´æ˜

### 1. ç¼ºå‹¤å†å²æ˜ç»†è¡¨

**æ¥å£åœ°å€**ï¼š`GET /api/icalink/v1/stats/absent-history`

**åŠŸèƒ½**ï¼šæŸ¥è¯¢å­¦ç”Ÿç¼ºå‹¤å†å²æ˜ç»†æ•°æ®

**æŸ¥è¯¢å‚æ•°**ï¼š
```typescript
{
  page?: number;          // é¡µç ï¼ˆé»˜è®¤1ï¼‰
  pageSize?: number;      // æ¯é¡µæ•°é‡ï¼ˆé»˜è®¤20ï¼Œæœ€å¤§100ï¼‰
  searchKeyword?: string; // æœç´¢å…³é”®è¯ï¼ˆå­¦ç”Ÿå§“åã€å­¦ç”ŸIDã€è¯¾ç¨‹åç§°ã€è¯¾ç¨‹ä»£ç ã€ç¼ºå‹¤ç±»å‹ï¼‰
  teachingWeek?: number;  // æ•™å­¦å‘¨ç­›é€‰
  sortField?: string;     // æ’åºå­—æ®µ
  sortOrder?: 'asc' | 'desc'; // æ’åºæ–¹å‘
}
```

**å“åº”æ ¼å¼**ï¼š
```typescript
{
  success: boolean;
  data: {
    data: Array<{
      id: number;
      course_stats_id: number;
      course_id: string;
      course_code: string;
      course_name: string;
      student_id: string;
      student_name: string;
      school_name: string;
      class_name: string;
      major_name: string;
      absence_type: 'ç¼ºå‹¤' | 'æ—·è¯¾' | 'è¯·å‡' | 'è¯·å‡å¾…å®¡æ‰¹';
      semester: string;
      teaching_week: number;
      week_day: number;
      periods: string;
      time_period: 'ä¸Šåˆ' | 'ä¸‹åˆ';
      leave_reason?: string;
      created_at: string;
      updated_at: string;
    }>;
    total: number;
    page: number;
    pageSize: number;
    totalPages: number;
  };
  error?: string;
}
```

**æµ‹è¯•å‘½ä»¤**ï¼š
```bash
# åŸºç¡€æŸ¥è¯¢
curl "http://localhost:3000/api/icalink/v1/stats/absent-history?page=1&pageSize=10"

# å¸¦æœç´¢å…³é”®è¯
curl "http://localhost:3000/api/icalink/v1/stats/absent-history?searchKeyword=å¼ ä¸‰&page=1&pageSize=10"

# æŒ‰æ•™å­¦å‘¨ç­›é€‰
curl "http://localhost:3000/api/icalink/v1/stats/absent-history?teachingWeek=5&page=1&pageSize=10"
```

---

### 2. è¯¾ç¨‹å†å²ç»Ÿè®¡è¡¨

**æ¥å£åœ°å€**ï¼š`GET /api/icalink/v1/stats/course-stats`

**åŠŸèƒ½**ï¼šæŸ¥è¯¢è¯¾ç¨‹ç­¾åˆ°å†å²ç»Ÿè®¡æ•°æ®

**æŸ¥è¯¢å‚æ•°**ï¼š
```typescript
{
  page?: number;
  pageSize?: number;
  searchKeyword?: string; // è¯¾ç¨‹åç§°ã€è¯¾ç¨‹ä»£ç ã€æ•™å¸ˆå§“å
  teachingWeek?: number;
  sortField?: string;
  sortOrder?: 'asc' | 'desc';
}
```

**å“åº”æ•°æ®å­—æ®µ**ï¼š
```typescript
{
  id: number;
  stat_date: string;
  course_id: number;
  external_id: string;
  course_code: string;
  course_name: string;
  class_location: string;
  teacher_name: string;
  teacher_codes: string;
  semester: string;
  teaching_week: number;
  week_day: number;
  time_period: 'ä¸Šåˆ' | 'ä¸‹åˆ';
  periods: string;
  start_time: string;
  end_time: string;
  total_should_attend: number;
  present_count: number;
  absent_count: number;
  truant_count: number;
  leave_count: number;
}
```

**æµ‹è¯•å‘½ä»¤**ï¼š
```bash
# åŸºç¡€æŸ¥è¯¢
curl "http://localhost:3000/api/icalink/v1/stats/course-stats?page=1&pageSize=10"

# æœç´¢ç‰¹å®šè¯¾ç¨‹
curl "http://localhost:3000/api/icalink/v1/stats/course-stats?searchKeyword=é«˜ç­‰æ•°å­¦&page=1&pageSize=10"
```

---

### 3. æ•™å­¦ç­è¡¨

**æ¥å£åœ°å€**ï¼š`GET /api/icalink/v1/stats/teaching-class`

**åŠŸèƒ½**ï¼šæŸ¥è¯¢æ•™å­¦ç­å­¦ç”Ÿåå•æ•°æ®

**æŸ¥è¯¢å‚æ•°**ï¼š
```typescript
{
  page?: number;
  pageSize?: number;
  searchKeyword?: string; // å­¦ç”Ÿå§“åã€å­¦å·ã€è¯¾ç¨‹åç§°
  sortField?: string;
  sortOrder?: 'asc' | 'desc';
}
```

**å“åº”æ•°æ®å­—æ®µ**ï¼š
```typescript
{
  student_id: string;
  course_code: string;
  course_name: string;
  name: string;
  school_name: string;
  major_name: string;
  class_name: string;
}
```

**æµ‹è¯•å‘½ä»¤**ï¼š
```bash
# åŸºç¡€æŸ¥è¯¢
curl "http://localhost:3000/api/icalink/v1/stats/teaching-class?page=1&pageSize=10"

# æœç´¢ç‰¹å®šå­¦ç”Ÿ
curl "http://localhost:3000/api/icalink/v1/stats/teaching-class?searchKeyword=ç‹æ•&page=1&pageSize=10"
```

---

### 4. å­¦ç”Ÿå†å²ç»Ÿè®¡è¡¨

**æ¥å£åœ°å€**ï¼š`GET /api/icalink/v1/stats/student-stats`

**åŠŸèƒ½**ï¼šæŸ¥è¯¢å­¦ç”Ÿæ•´ä½“ç­¾åˆ°ç»Ÿè®¡æ•°æ®

**æŸ¥è¯¢å‚æ•°**ï¼š
```typescript
{
  page?: number;
  pageSize?: number;
  searchKeyword?: string; // å­¦ç”Ÿå§“åã€å­¦å·
  sortField?: string;
  sortOrder?: 'asc' | 'desc';
}
```

**å“åº”æ•°æ®å­—æ®µ**ï¼š
```typescript
{
  student_id: string;
  name: string;
  school_name: string;
  major_name: string;
  class_name: string;
  total_sessions: number;      // è¯¾èŠ‚æ€»æ•°
  completed_sessions: number;  // å·²ç»ä¸Šè¯¾èŠ‚æ•°
  absent_count: number;        // ç¼ºå‹¤èŠ‚æ•°
  leave_count: number;         // è¯·å‡èŠ‚æ•°
  truant_count: number;        // æ—·è¯¾æ¬¡æ•°
  absence_rate: number;        // ç¼ºå‹¤ç‡%
}
```

**æµ‹è¯•å‘½ä»¤**ï¼š
```bash
# åŸºç¡€æŸ¥è¯¢
curl "http://localhost:3000/api/icalink/v1/stats/student-stats?page=1&pageSize=10"

# æŒ‰ç¼ºå‹¤ç‡æ’åº
curl "http://localhost:3000/api/icalink/v1/stats/student-stats?sortField=absence_rate&sortOrder=desc&page=1&pageSize=10"
```

---

### 5. å­¦ç”Ÿå†å²ç»Ÿè®¡è¯¦æƒ…è¡¨

**æ¥å£åœ°å€**ï¼š`GET /api/icalink/v1/stats/student-stats-details`

**åŠŸèƒ½**ï¼šæŸ¥è¯¢å­¦ç”Ÿç­¾åˆ°ç»Ÿè®¡è¯¦ç»†æ•°æ®ï¼ˆåŒ…å«è¯¾ç¨‹ä¿¡æ¯ï¼‰

**æŸ¥è¯¢å‚æ•°**ï¼š
```typescript
{
  page?: number;
  pageSize?: number;
  searchKeyword?: string; // å­¦ç”Ÿå§“åã€å­¦å·ã€è¯¾ç¨‹åç§°
  teachingWeek?: number;
  sortField?: string;
  sortOrder?: 'asc' | 'desc';
}
```

**å“åº”æ•°æ®å­—æ®µ**ï¼šåŒ…å«å­¦ç”Ÿç»Ÿè®¡è¡¨çš„æ‰€æœ‰å­—æ®µï¼Œå¤–åŠ è¯¾ç¨‹è¯¦ç»†ä¿¡æ¯ï¼ˆè¯¾ç¨‹ä»£ç ã€è¯¾ç¨‹åç§°ã€æ•™å¸ˆä¿¡æ¯ã€ä¸Šè¯¾æ—¶é—´ç­‰ï¼‰

**æµ‹è¯•å‘½ä»¤**ï¼š
```bash
# åŸºç¡€æŸ¥è¯¢
curl "http://localhost:3000/api/icalink/v1/stats/student-stats-details?page=1&pageSize=10"

# æŸ¥è¯¢ç‰¹å®šå­¦ç”Ÿçš„è¯¦æƒ…
curl "http://localhost:3000/api/icalink/v1/stats/student-stats-details?searchKeyword=105063&page=1&pageSize=10"
```

---

## ğŸ› å½“å‰é—®é¢˜è¯Šæ–­

### é—®é¢˜ç°è±¡
å‰ç«¯é¡µé¢æ˜¾ç¤º 404 é”™è¯¯ï¼š`Route not found: /api/icalink/v1/attendance/overall-stats`

### æ ¹æœ¬åŸå› 
1. **å‰ç«¯è°ƒç”¨äº†å·²åºŸå¼ƒçš„æ¥å£**ï¼š`/api/icalink/v1/attendance/overall-stats`
2. **è¯¥æ¥å£åœ¨åç«¯å·²è¢«åˆ é™¤**ï¼šåœ¨æ¥å£æ¸…ç†è¿‡ç¨‹ä¸­è¢«æ ‡è®°ä¸ºåºŸå¼ƒå¹¶ç§»é™¤
3. **å‰ç«¯ä»£ç æœªæ›´æ–°**ï¼šä»åœ¨ä½¿ç”¨æ—§çš„ API è·¯å¾„

### å—å½±å“çš„å‰ç«¯æ–‡ä»¶
- `apps/agendaedu-web/src/lib/attendance-api.ts` (ç¬¬ 795 è¡Œ)
- `apps/agendaedu-web/src/features/attendance/components/attendance-overview.tsx`
- `apps/agendaedu-web/src/features/attendance/components/stats-attendance-tab.tsx`

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1ï¼šä½¿ç”¨æ–°çš„ç»Ÿè®¡æ¥å£ï¼ˆæ¨èï¼‰

å‰ç«¯åº”è¯¥ä½¿ç”¨ `StatsController` æä¾›çš„æ–°æ¥å£ï¼Œè€Œä¸æ˜¯å·²åºŸå¼ƒçš„ `overall-stats` æ¥å£ã€‚

**ä¿®æ”¹å»ºè®®**ï¼š
1. å°† `getOverallStats()` æ–¹æ³•æ”¹ä¸ºè°ƒç”¨ `/api/icalink/v1/stats/student-stats` æˆ–å…¶ä»–åˆé€‚çš„ç»Ÿè®¡æ¥å£
2. æ ¹æ®é¡µé¢éœ€æ±‚é€‰æ‹©åˆé€‚çš„æ¥å£ï¼ˆç¼ºå‹¤æ˜ç»†ã€è¯¾ç¨‹ç»Ÿè®¡ã€å­¦ç”Ÿç»Ÿè®¡ç­‰ï¼‰

### æ–¹æ¡ˆ 2ï¼šåœ¨åç«¯é‡æ–°å®ç° overall-stats æ¥å£

å¦‚æœå‰ç«¯ç¡®å®éœ€è¦ä¸€ä¸ªæ•´ä½“ç»Ÿè®¡æ¦‚è§ˆæ¥å£ï¼Œå¯ä»¥åœ¨ `StatsController` ä¸­æ·»åŠ ä¸€ä¸ªæ–°çš„æ¥å£æ¥æä¾›æ±‡æ€»æ•°æ®ã€‚

---

## ğŸ§ª å®Œæ•´æµ‹è¯•æµç¨‹

### 1. ç¡®è®¤åç«¯æœåŠ¡è¿è¡Œ
```bash
# æ£€æŸ¥ app-icalink æœåŠ¡æ˜¯å¦è¿è¡Œåœ¨ 3000 ç«¯å£
curl http://localhost:3000/api/icalink/v1/auth/status
```

### 2. æµ‹è¯•å„ä¸ªç»Ÿè®¡æ¥å£
```bash
# æµ‹è¯•ç¼ºå‹¤å†å²
curl "http://localhost:3000/api/icalink/v1/stats/absent-history?page=1&pageSize=5"

# æµ‹è¯•è¯¾ç¨‹ç»Ÿè®¡
curl "http://localhost:3000/api/icalink/v1/stats/course-stats?page=1&pageSize=5"

# æµ‹è¯•æ•™å­¦ç­
curl "http://localhost:3000/api/icalink/v1/stats/teaching-class?page=1&pageSize=5"

# æµ‹è¯•å­¦ç”Ÿç»Ÿè®¡
curl "http://localhost:3000/api/icalink/v1/stats/student-stats?page=1&pageSize=5"

# æµ‹è¯•å­¦ç”Ÿç»Ÿè®¡è¯¦æƒ…
curl "http://localhost:3000/api/icalink/v1/stats/student-stats-details?page=1&pageSize=5"
```

### 3. æ£€æŸ¥æ•°æ®åº“è§†å›¾
```sql
-- æ£€æŸ¥è§†å›¾æ˜¯å¦å­˜åœ¨
SHOW FULL TABLES WHERE Table_type = 'VIEW';

-- æŸ¥è¯¢å­¦ç”Ÿç»Ÿè®¡è§†å›¾
SELECT * FROM view_student_overall_attendance_stats LIMIT 10;

-- æŸ¥è¯¢å­¦ç”Ÿç»Ÿè®¡è¯¦æƒ…è§†å›¾
SELECT * FROM view_student_overall_attendance_stats_details LIMIT 10;

-- æŸ¥è¯¢æ•™å­¦ç­è§†å›¾
SELECT * FROM v_teaching_class LIMIT 10;
```

---

## ğŸ“ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ä¿®å¤å‰ç«¯ API è°ƒç”¨**ï¼šå°† `getOverallStats()` æ”¹ä¸ºè°ƒç”¨æ­£ç¡®çš„æ¥å£
2. **æ›´æ–°å‰ç«¯é¡µé¢**ï¼šæ ¹æ®æ–°æ¥å£çš„æ•°æ®æ ¼å¼è°ƒæ•´é¡µé¢å±•ç¤ºé€»è¾‘
3. **æµ‹è¯•æ•°æ®æµ**ï¼šç¡®ä¿ä»æ•°æ®åº“ â†’ åç«¯æ¥å£ â†’ å‰ç«¯é¡µé¢çš„å®Œæ•´æ•°æ®æµæ­£å¸¸å·¥ä½œ
4. **æ›´æ–°æ–‡æ¡£**ï¼šè®°å½•æ¥å£å˜æ›´å’Œä½¿ç”¨æ–¹æ³•


