# 课表同步应用详细设计方案

## 1. 系统架构设计

### 1.1 整体架构
![系统架构图](系统架构图.png)

系统分为四层结构：
- 数据源层：对接教育机构课表数据
- 核心处理层：数据处理、转换和同步逻辑
- 接口层：与WPS协作空间交互的API接口
- 应用层：最终展现给用户的WPS应用功能

### 1.2 核心模块组成
- **数据采集模块**：负责从源系统获取课表数据
- **数据处理模块**：负责数据清洗、转换和标准化
- **同步引擎**：处理数据同步逻辑，包括增量同步判断
- **WPS API适配器**：封装与WPS API的交互
- **任务调度器**：管理同步任务的调度
- **监控与日志**：记录系统运行状态和错误信息

## 2. 数据模型设计

### 2.1 核心数据表

#### 2.1.1 内部数据表

**同步任务表(sync_task)**
```sql
CREATE TABLE sync_task (
  id INT PRIMARY KEY AUTO_INCREMENT,
  task_name VARCHAR(100) NOT NULL COMMENT '任务名称',
  task_type ENUM('calendar', 'punch', 'approval') NOT NULL COMMENT '任务类型',
  source_type VARCHAR(50) NOT NULL COMMENT '数据源类型',
  config JSON NOT NULL COMMENT '同步配置',
  schedule VARCHAR(100) COMMENT '调度表达式',
  last_sync_time DATETIME COMMENT '上次同步时间',
  status ENUM('active', 'paused', 'error') DEFAULT 'active' COMMENT '任务状态',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP
);
```

**同步记录表(sync_log)**
```sql
CREATE TABLE sync_log (
  id INT PRIMARY KEY AUTO_INCREMENT,
  task_id INT NOT NULL COMMENT '关联的任务ID',
  start_time DATETIME NOT NULL COMMENT '开始时间',
  end_time DATETIME COMMENT '结束时间',
  status ENUM('success', 'failed', 'partial') COMMENT '同步状态',
  processed_items INT DEFAULT 0 COMMENT '处理条目数',
  error_items INT DEFAULT 0 COMMENT '错误条目数',
  error_msg TEXT COMMENT '错误信息',
  FOREIGN KEY (task_id) REFERENCES sync_task(id)
);
```

**映射关系表(sync_mapping)**
```sql
CREATE TABLE sync_mapping (
  id INT PRIMARY KEY AUTO_INCREMENT,
  source_id VARCHAR(100) NOT NULL COMMENT '源系统ID',
  target_id VARCHAR(100) NOT NULL COMMENT 'WPS系统ID',
  entity_type ENUM('calendar', 'event', 'punch', 'approval') NOT NULL COMMENT '实体类型',
  task_id INT NOT NULL COMMENT '关联的任务ID',
  data_hash VARCHAR(64) COMMENT '数据哈希值',
  created_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP,
  updated_at DATETIME NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
  FOREIGN KEY (task_id) REFERENCES sync_task(id),
  UNIQUE KEY (source_id, entity_type, task_id)
);
```

#### 2.1.2 外部数据表

**课程安排表结构**
| 字段 | 类型 | 长度 | 说明 |
| --- | --- | --- | --- |
| kkh | varchar | 60 | 开课号 |
| xnxq | varchar | 20 | 学年学期 |
| jxz | int | 11 | 教学周 1-18 |
| zc | int | 11 | 周几 1-7 |
| jc | int | 11 | 节次 1-10 |
| lq | varchar | 200 | 楼群 |
| room | varchar | 200 | 房间 |
| xq | varchar | 100 | 校区 |
| ghs | varchar | 255 | 教师工号组 |
| Xms | Varchar | 500 | 教师姓名组 |
| lc | varchar | 255 | 楼层 |
| rq | varchar | 255 | 日期 |
| st | varchar | 255 | 开始时间 |
| ed | varchar | 255 | 结束时间 |
| sj | varchar | 255 | 状态展示标识 |
| zt | varchar | 30 | 状态标识: add、update、delete |
| kcmc | varchar | 200 | 课程名称 |
| sfdk | Smallint |  | 是否打卡 0-1 |

**学生课表结构**
| 字段 | 类型 | 长度 | 说明 |
| --- | --- | --- | --- |
| kkh | varchar | 60 | 开课号 |
| xh | varchar | 40 | 学生编号 |
| xnxq | varchar | 20 | 学年学期 |
| kcbh | varchar | 40 | 课程编号 |

### 2.2 数据转换映射规则

#### 2.2.1 课表到日历的转换
```json
{
  "mapping": {
    "title": "kcmc",
    "location": "room",
    "start_time": "根据jc转换的具体时间",
    "end_time": "根据jc转换的具体时间",
    "repeat_rule": "根据zc和jxz生成",
    "description": "教师: ${xms}\\n教室: ${room}\\n周次: ${jxz}"
  }
}
```

#### 2.2.2 课表到打卡的转换
```json
{
  "mapping": {
    "punch_name": "${kcmc}上课打卡",
    "start_time": "课前10分钟",
    "end_time": "课后10分钟",
    "location_required": true,
    "members": "根据学生课表转换"
  }
}
```

#### 2.2.3 课表到审批的转换
```json
{
  "mapping": {
    "template_name": "${kcmc}请假审批",
    "form_fields": [
      {
        "field_name": "请假原因",
        "field_type": "text",
        "required": true
      },
      {
        "field_name": "请假时间",
        "field_type": "datetime_range",
        "required": true,
        "default_value": "当前课程时间"
      }
    ],
    "approvers": "根据ghs转换的教师ID"
  }
}
```

## 3. 接口设计

### 3.1 日历接口

#### 3.1.1 创建日历
- **接口**: `https://open-xz.wps.cn/pages/server/calendar/create-calendar/`
- **方法**: POST
- **请求参数**:
```json
{
  "calendar_name": "2024春季课表",
  "color": "#4285F4",
  "description": "自动同步的课表日历",
  "is_public": true
}
```
- **响应参数**:
```json
{
  "calendar_id": "cal_123456",
  "result": "success"
}
```

#### 3.1.2 更新日历
- **接口**: `https://open-xz.wps.cn/pages/server/calendar/update-calendar/`
- **方法**: POST
- **请求参数**:
```json
{
  "calendar_id": "cal_123456",
  "calendar_name": "2024春季课表(更新版)",
  "color": "#4285F4",
  "description": "更新后的课表日历"
}
```

#### 3.1.3 删除日历
- **接口**: `https://open-xz.wps.cn/pages/server/calendar/delete-calendar/`
- **方法**: POST
- **请求参数**:
```json
{
  "calendar_id": "cal_123456"
}
```

#### 3.1.4 添加日历成员
- **接口**: `https://open-xz.wps.cn/pages/server/calendar/add-members/`
- **方法**: POST
- **请求参数**:
```json
{
  "calendar_id": "cal_123456",
  "member_ids": ["user_001", "user_002"],
  "role": "reader"
}
```

### 3.2 审批接口

#### 3.2.1 创建审批模板
- **接口**: `https://open-xz.wps.cn/pages/server/workflow/create-template/`
- **方法**: POST
- **请求参数**:
```json
{
  "template_name": "课程请假审批",
  "form_config": {
    "fields": [
      {
        "field_id": "reason",
        "field_name": "请假原因",
        "field_type": "text",
        "required": true
      },
      {
        "field_id": "time_range",
        "field_name": "请假时间",
        "field_type": "datetime_range",
        "required": true
      }
    ]
  },
  "approval_config": {
    "approvers": [
      {
        "approver_id": "teacher_001",
        "approver_type": "user"
      }
    ],
    "approval_type": "sequential"
  }
}
```

#### 3.2.2 模板设置
- **接口**: `https://open-xz.wps.cn/pages/server/workflow/template-setting/`
- **方法**: POST
- **请求参数**:
```json
{
  "template_id": "template_123",
  "settings": {
    "visible_to_all": true,
    "notify_approvers": true
  }
}
```

#### 3.2.3 创建审批
- **接口**: `https://open-xz.wps.cn/pages/server/workflow/approve-create/`
- **方法**: POST
- **请求参数**:
```json
{
  "template_id": "template_123",
  "title": "数据结构课请假申请",
  "form_data": {
    "reason": "生病",
    "time_range": {
      "start": "2023-04-10 08:00:00",
      "end": "2023-04-10 09:30:00"
    }
  },
  "initiator": "student_001"
}
```

#### 3.2.4 审批列表查询
- **接口**: `https://open-xz.wps.cn/pages/server/workflow/approve-list/`
- **方法**: GET
- **请求参数**:
```json
{
  "template_id": "template_123",
  "status": "pending",
  "page": 1,
  "page_size": 20
}
```

### 3.3 打卡接口

#### 3.3.1 打卡记录查询
- **接口**: `https://open-xz.wps.cn/pages/server/attendance/punch/query/`
- **方法**: GET
- **请求参数**:
```json
{
  "punch_id": "punch_123",
  "start_date": "2023-04-10",
  "end_date": "2023-04-10",
  "user_ids": ["student_001", "student_002"],
  "page": 1,
  "page_size": 50
}
```

## 4. 业务流程设计

### 4.1 日程同步流程
1. 读取课表数据源
2. 根据配置确定同步范围（教师、学生、课程等）
3. 对比上次同步时间，筛选增量数据
4. 将课表数据转换为日历格式
5. 调用WPS API创建或更新日历
6. 更新同步状态和映射关系
7. 记录同步日志

### 4.2 打卡同步流程
1. 读取课表数据，筛选需要打卡的课程（sfdk=1）
2. 根据推送条件确定打卡规则
   - 推送对象设置（教师、学生）
   - 推送消息通知设置
   - 打卡时间设置（课前几分钟到课后几分钟）
3. 将课表数据转换为打卡任务
4. 调用WPS API创建打卡任务
5. 更新同步状态和映射关系
6. 记录同步日志

### 4.3 审批同步流程
1. 读取课表数据
2. 确定审批模板类型（请假、调课等）
3. 创建审批模板，设置表单字段和审批流程
4. 配置审批权限和通知规则
5. 审批操作记录和同步
6. 更新同步状态和映射关系
7. 记录同步日志

## 5. 推送策略设计

### 5.1 推送顺序
1. 教师优先级最高：根据ghs列进行拆分推送课程日历
2. 学生课表优先级次之：可考虑部分推送（数据量大）

### 5.2 推送条件配置
1. 推送对象设置
   - 教师、学生、研究生等
2. 推送消息通知设置
   - 全量消息通知：每一节都通知，简单实现
   - 确定性上下推送：只通知第一节的开始
3. 推送时间配置
   - 提前多少分钟推送（如提前1小时）
   - 课程时间确定方式（根据开始时间）
4. 打卡时间配置
   - 允许打卡时间范围（如7:55-8:10）
5. 请假配置
   - 请假次数限制（如每课程4次）
   - 请假提前时间

## 6. 异常处理设计

### 6.1 同步异常处理
1. 网络连接中断：实现重试机制，最多重试3次
2. API限流：实现退避算法，延迟重试
3. 数据格式错误：记录错误日志，跳过错误数据继续处理
4. 同步冲突：采用乐观锁机制，记录数据哈希值

### 6.2 数据一致性保障
1. 事务管理：关键操作使用事务保证原子性
2. 状态追踪：记录每条数据的同步状态
3. 校验机制：定期全量校验数据一致性
4. 修复机制：提供数据不一致修复功能

## 7. 性能优化设计

### 7.1 大批量数据处理
1. 分批处理：将大量数据分批次处理
2. 并发处理：多线程并发处理不同批次
3. 队列机制：使用消息队列削峰填谷

### 7.2 缓存策略
1. 课表数据缓存：减少重复读取
2. API结果缓存：减少重复调用
3. 映射关系缓存：提高查询效率

### 7.3 增量同步设计
1. 基于时间戳：记录上次同步时间，只同步新增或变更数据
2. 基于状态标志：利用zt字段（add、update、delete）
3. 基于数据哈希：计算数据哈希值，判断是否变更

## 8. 安全设计

### 8.1 数据安全
1. 敏感信息加密：学生ID等敏感信息加密存储
2. 数据访问控制：根据用户角色控制数据访问权限
3. 数据脱敏：展示数据时进行必要脱敏

### 8.2 接口安全
1. 认证机制：基于OAuth的API认证
2. 参数验证：所有接口参数严格验证
3. 请求限流：防止接口滥用

## 9. 部署方案

### 9.1 系统环境
- Node.js 16+
- MySQL 8.0+
- Redis 6.0+

### 9.2 部署架构
- Web服务：PM2管理Node.js进程
- 定时任务：使用node-cron处理定时同步
- 队列服务：使用Bull队列处理异步任务

### 9.3 监控告警
- 系统监控：CPU、内存、磁盘使用率
- 业务监控：同步成功率、API调用成功率
- 告警机制：异常时通过邮件/企业微信通知

## 10. 开发计划

### 10.1 阶段划分
1. 第一阶段：基础框架搭建（2周）
2. 第二阶段：核心功能开发（4周）
3. 第三阶段：测试与优化（2周）
4. 第四阶段：上线与运维（持续）

### 10.2 优先级排序
1. 最高优先级：日历同步功能
2. 中等优先级：打卡功能
3. 较低优先级：审批功能

## 11. 测试方案

### 11.1 单元测试
- 针对核心转换逻辑的单元测试
- 针对API适配器的单元测试

### 11.2 集成测试
- 完整同步流程的集成测试
- 异常情况下的处理测试

### 11.3 性能测试
- 大数据量下的性能测试
- 并发同步的性能测试 