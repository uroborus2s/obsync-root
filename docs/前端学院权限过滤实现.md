# 前端学院权限过滤实现文档

## 概述

本文档记录了在前端 `student-absence-stats.tsx` 组件中添加 `parent_ex_dept_id` 参数支持，以配合后端的学院权限过滤功能。

**实现时间：** 2025-11-03  
**实现人：** Augment Agent  
**影响范围：** 学生缺勤统计页面的部门树组件

---

## 需求说明

### 背景
后端已经实现了基于登录用户学院的权限过滤逻辑：
- 当 `parent_ex_dept_id` 为 `'02'` 或 `'03'` 时，只返回与登录用户所属学院ID匹配的部门
- 前端需要在调用部门子列表接口时传递父部门的 `ex_dept_id` 参数

### 目标
1. 在调用 `/api/icalink/v1/depts/:deptId/children` 接口时添加 `parent_ex_dept_id` 查询参数
2. 该参数应该传递父部门的 `ex_dept_id` 值
3. 确保在展开部门树节点时能够正确传递此参数

---

## 实现方案

### 架构设计

```
用户点击部门节点
  ↓
toggleNode(nodeId)
  ↓
从 nodeMap 获取当前节点的 ex_dept_id
  ↓
fetchChildren(nodeId, parentExDeptId)
  ↓
构建 URL，添加 parent_ex_dept_id 查询参数
  ↓
调用后端 API
  ↓
后端应用权限过滤
  ↓
返回过滤后的子部门列表
```

---

## 代码修改详情

### 1. 添加节点映射表

**文件位置：** `apps/agendaedu-web/src/features/attendance/components/student-absence-stats.tsx`

**修改内容：**
```typescript
export function StudentAbsenceStats() {
  // ... 其他状态
  
  // 新增：存储所有节点信息，用于获取父节点的 ex_dept_id
  const [nodeMap, setNodeMap] = useState<Map<string, DepartmentNode>>(new Map())
  
  // ... 其他代码
}
```

**说明：**
- `nodeMap` 用于存储所有已加载的部门节点信息
- 在展开节点时，可以从 `nodeMap` 中获取当前节点的 `ex_dept_id`

---

### 2. 修改 fetchChildren 函数签名

**修改前：**
```typescript
const fetchChildren = async (deptId: string): Promise<DepartmentNode[]> => {
  // ...
}
```

**修改后：**
```typescript
const fetchChildren = async (
  deptId: string,
  parentExDeptId?: string
): Promise<DepartmentNode[]> => {
  console.log('📡 fetchChildren 被调用:', {
    deptId,
    parentExDeptId,  // 新增日志
    hasCache: treeData.has(deptId),
    cacheSize: treeData.size,
  })
  // ...
}
```

**说明：**
- 新增 `parentExDeptId` 可选参数
- 用于接收父部门的 `ex_dept_id` 值

---

### 3. 在 URL 中添加 parent_ex_dept_id 参数

**修改位置：** `fetchChildren` 函数中的 URL 构建部分

**修改前：**
```typescript
const url = new URL(
  `/api/icalink/v1/depts/${deptId}/children`,
  window.location.origin
)
url.searchParams.set('page_size', '50')
if (pageToken) {
  url.searchParams.set('page_token', pageToken)
}
// 性能优化：传递根部门ID，避免后端额外的API调用
if (rootDept?.id) {
  url.searchParams.set('root_dept_id', rootDept.id)
}
```

**修改后：**
```typescript
const url = new URL(
  `/api/icalink/v1/depts/${deptId}/children`,
  window.location.origin
)
url.searchParams.set('page_size', '50')
if (pageToken) {
  url.searchParams.set('page_token', pageToken)
}
// 性能优化：传递根部门ID，避免后端额外的API调用
if (rootDept?.id) {
  url.searchParams.set('root_dept_id', rootDept.id)
}
// 权限过滤：传递父部门的 ex_dept_id，用于学院级别权限过滤
if (parentExDeptId) {
  url.searchParams.set('parent_ex_dept_id', parentExDeptId)
}
```

**说明：**
- 当 `parentExDeptId` 存在时，将其添加到 URL 查询参数中
- 后端会根据此参数应用学院级别的权限过滤

---

### 4. 更新 nodeMap

**修改位置：** `fetchChildren` 函数的缓存结果部分

**修改前：**
```typescript
// 缓存结果
setTreeData((prev) => new Map(prev).set(deptId, allChildren))

return allChildren
```

**修改后：**
```typescript
// 缓存结果
setTreeData((prev) => new Map(prev).set(deptId, allChildren))

// 更新节点映射表，存储所有子节点信息
setNodeMap((prev) => {
  const newMap = new Map(prev)
  allChildren.forEach((child) => {
    newMap.set(child.id, child)
  })
  return newMap
})

return allChildren
```

**说明：**
- 在缓存子部门数据时，同时将所有子节点添加到 `nodeMap` 中
- 这样在后续展开子节点时，可以从 `nodeMap` 中获取其 `ex_dept_id`

---

### 5. 修改 toggleNode 函数

**修改位置：** `toggleNode` 函数中调用 `fetchChildren` 的部分

**修改前：**
```typescript
// 如果节点还没有加载子节点，则加载
if (!treeData.has(nodeId)) {
  console.log('Fetching children for nodeId:', nodeId)
  // 设置加载状态
  setLoadingNodes((prev) => new Set(prev).add(nodeId))

  try {
    await fetchChildren(nodeId)
    // 清除之前的错误
    setTreeError(null)
  } catch (error) {
    // ...
  }
}
```

**修改后：**
```typescript
// 如果节点还没有加载子节点，则加载
if (!treeData.has(nodeId)) {
  console.log('Fetching children for nodeId:', nodeId)
  
  // 从 nodeMap 中获取当前节点的 ex_dept_id
  const currentNode = nodeMap.get(nodeId) || rootDept
  const parentExDeptId = currentNode?.ex_dept_id
  
  console.log('Parent ex_dept_id:', parentExDeptId)
  
  // 设置加载状态
  setLoadingNodes((prev) => new Set(prev).add(nodeId))

  try {
    await fetchChildren(nodeId, parentExDeptId)
    // 清除之前的错误
    setTreeError(null)
  } catch (error) {
    // ...
  }
}
```

**说明：**
- 在调用 `fetchChildren` 之前，从 `nodeMap` 中获取当前节点的信息
- 如果 `nodeMap` 中没有找到（例如根节点），则使用 `rootDept`
- 提取 `ex_dept_id` 并传递给 `fetchChildren` 函数

---

## 数据流示例

### 场景：展开学院级别部门

1. **用户操作**：点击学院节点（ex_dept_id = '02'）
2. **toggleNode 执行**：
   ```typescript
   const currentNode = nodeMap.get('college-dept-id')
   // currentNode.ex_dept_id = '02'
   const parentExDeptId = '02'
   ```
3. **fetchChildren 调用**：
   ```typescript
   await fetchChildren('college-dept-id', '02')
   ```
4. **URL 构建**：
   ```
   /api/icalink/v1/depts/college-dept-id/children?page_size=50&parent_ex_dept_id=02
   ```
5. **后端处理**：
   - 识别 `parent_ex_dept_id = '02'`
   - 查询登录用户的学院ID
   - 只返回与用户学院ID匹配的子部门
6. **前端接收**：
   - 接收过滤后的子部门列表
   - 更新 `treeData` 和 `nodeMap`
   - 渲染部门树

---

## 测试建议

### 1. 功能测试

**测试场景 1：展开学院级别部门（ex_dept_id = '02'）**
- 预期：只显示当前登录用户所属学院的子部门
- 验证：检查返回的子部门是否都属于同一个学院

**测试场景 2：展开其他级别部门（ex_dept_id ≠ '02' 且 ≠ '03'）**
- 预期：显示所有子部门，不应用权限过滤
- 验证：检查返回的子部门数量是否正常

**测试场景 3：根部门展开**
- 预期：正常显示所有一级子部门
- 验证：检查 `parent_ex_dept_id` 参数是否正确传递

### 2. 边界测试

**测试场景 1：nodeMap 为空时展开根节点**
- 预期：使用 `rootDept` 的 `ex_dept_id`
- 验证：检查日志中的 `Parent ex_dept_id` 值

**测试场景 2：快速连续点击多个节点**
- 预期：每个节点都能正确传递其 `ex_dept_id`
- 验证：检查网络请求中的 `parent_ex_dept_id` 参数

### 3. 性能测试

**测试场景：展开包含大量子部门的节点**
- 预期：nodeMap 更新不影响性能
- 验证：检查页面响应时间

---

## 相关文档

- [学院权限过滤实现 - ContactRepository 重构](./学院权限过滤实现-ContactRepository重构.md)
- [部门子列表过滤逻辑实现](./部门子列表过滤逻辑实现.md)

---

## 总结

本次前端修改完成了以下功能：

✅ **添加 nodeMap 状态**
- 存储所有已加载的部门节点信息
- 用于在展开节点时获取父节点的 `ex_dept_id`

✅ **修改 fetchChildren 函数**
- 新增 `parentExDeptId` 参数
- 在 URL 中添加 `parent_ex_dept_id` 查询参数
- 更新 `nodeMap` 以存储子节点信息

✅ **修改 toggleNode 函数**
- 从 `nodeMap` 中获取当前节点的 `ex_dept_id`
- 将 `ex_dept_id` 传递给 `fetchChildren` 函数

✅ **向后兼容**
- `parentExDeptId` 是可选参数，不影响现有功能
- 当参数不存在时，后端不应用权限过滤

所有修改都保持了代码的简洁性和可维护性，与后端的权限过滤逻辑完美配合！

