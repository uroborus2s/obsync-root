# ObSync 优化部署指南

## 📋 概述

本指南介绍如何将ObSync系统从当前的9实例配置优化到7实例配置,同时保持高可用性和性能。

### 优化目标

- ✅ 减少资源消耗 22% (9实例 -> 7实例)
- ✅ 保持核心服务高可用性
- ✅ 优化资源分配和限制
- ✅ 改进健康检查和更新策略
- ✅ 启用优化后的熔断器配置

---

## 🔄 变更对比

### 服务副本数变更

| 服务 | 当前副本数 | 优化后副本数 | 变更原因 |
|------|-----------|-------------|---------|
| api-gateway | 3 | 2 | 无状态网关,2个副本足够 |
| app-icalink | 3 | 3 | 核心业务服务,保持高可用 |
| app-icasync | 3 | 2 | 后台同步,可容忍短暂延迟 |
| **总计** | **9** | **7** | **节省22%资源** |

### 资源限制新增

所有业务服务都添加了资源限制:

```yaml
resources:
  limits:
    cpus: '1.0-1.5'
    memory: 1G-2G
  reservations:
    cpus: '0.5-0.75'
    memory: 512M-1G
```

### 健康检查优化

新增 `start_period` 参数,避免启动时误判:

```yaml
healthcheck:
  start_period: 40s-60s  # 根据服务启动时间调整
```

---

## 📝 部署步骤

### 前置准备

#### 1. 备份当前配置

```bash
# 备份当前stack配置
cp /opt/obsync/swarm/stack.yml /opt/obsync/swarm/stack.yml.backup.$(date +%Y%m%d_%H%M%S)

# 导出当前服务状态
docker service ls > /tmp/services-before.txt
docker service ps obsync_api-gateway obsync_app-icalink obsync_app-icasync > /tmp/tasks-before.txt
```

#### 2. 检查当前资源使用

```bash
# 查看当前资源使用情况
docker stats --no-stream

# 查看服务状态
docker service ls
```

#### 3. 更新代码

```bash
# 进入项目目录
cd /path/to/obsync-root

# 拉取最新代码
git pull origin main

# 检查熔断器配置是否已更新
grep -A 10 "熔断器配置" apps/api-gateway/src/hooks.ts
```

### 主要部署流程

#### 步骤1: 构建新镜像

```bash
# 构建api-gateway (包含优化后的熔断器配置)
cd /path/to/obsync-root
pnpm run build @stratix/gateway

# 构建Docker镜像
docker build -t g-rrng9518-docker.pkg.coding.net/obsync/sync/stratix-gateway:v1.0.2 \
  -f apps/api-gateway/Dockerfile .

# 推送镜像
docker push g-rrng9518-docker.pkg.coding.net/obsync/sync/stratix-gateway:v1.0.2
```

#### 步骤2: 更新Stack配置

```bash
# 复制优化后的配置文件
cp scripts/deploy/swarm/stack-optimized.yml /opt/obsync/swarm/stack.yml

# 或者手动编辑现有配置
vi /opt/obsync/swarm/stack.yml
```

**关键修改点**:

1. **api-gateway服务**:
   ```yaml
   api-gateway:
     image: g-rrng9518-docker.pkg.coding.net/obsync/sync/stratix-gateway:v1.0.2  # 更新版本
     deploy:
       replicas: 2  # 从3改为2
       resources:
         limits: {cpus: '1.0', memory: 1G}
         reservations: {cpus: '0.5', memory: 512M}
     healthcheck:
       start_period: 40s  # 新增
   ```

2. **app-icalink服务**:
   ```yaml
   app-icalink:
     deploy:
       replicas: 3  # 保持不变
       resources:
         limits: {cpus: '1.5', memory: 2G}  # 新增
         reservations: {cpus: '0.75', memory: 1G}  # 新增
     healthcheck:
       start_period: 60s  # 新增
   ```

3. **app-icasync服务**:
   ```yaml
   app-icasync:
     deploy:
       replicas: 2  # 从3改为2
       resources:
         limits: {cpus: '1.0', memory: 1.5G}  # 新增
         reservations: {cpus: '0.5', memory: 768M}  # 新增
     healthcheck:
       start_period: 60s  # 新增
   ```

#### 步骤3: 验证配置

```bash
# 验证stack配置语法
docker stack config -c /opt/obsync/swarm/stack.yml

# 检查是否有错误
echo $?  # 应该返回0
```

#### 步骤4: 滚动更新部署

```bash
# 更新stack (会自动进行滚动更新)
docker stack deploy -c /opt/obsync/swarm/stack.yml obsync

# 实时监控更新进度
watch -n 2 'docker service ls'
```

#### 步骤5: 监控部署过程

```bash
# 监控服务状态
docker service ps obsync_api-gateway --no-trunc
docker service ps obsync_app-icalink --no-trunc
docker service ps obsync_app-icasync --no-trunc

# 查看服务日志
docker service logs obsync_api-gateway --tail 50 --follow
docker service logs obsync_app-icalink --tail 50 --follow
docker service logs obsync_app-icasync --tail 50 --follow
```

### 验证部署

#### 1. 检查服务状态

```bash
# 所有服务应该是Running状态
docker service ls

# 检查副本数
# api-gateway: 2/2
# app-icalink: 3/3
# app-icasync: 2/2
```

#### 2. 健康检查

```bash
# 检查api-gateway健康状态
curl http://localhost:8090/health

# 检查app-icalink健康状态 (需要进入容器)
docker exec $(docker ps -q -f name=obsync_app-icalink) wget -qO- http://localhost:3000/health

# 检查app-icasync健康状态
docker exec $(docker ps -q -f name=obsync_app-icasync) wget -qO- http://localhost:3000/health
```

#### 3. 功能测试

```bash
# 测试签到接口 (替换为实际的token和course_id)
curl -X POST http://localhost:8090/api/icalink/v1/attendance/19644/checkin \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json" \
  -d '{
    "latitude": 43.8171,
    "longitude": 125.3235
  }'

# 应该返回成功响应,而不是503错误
```

#### 4. 资源使用检查

```bash
# 查看资源使用情况
docker stats --no-stream

# 对比优化前后的资源使用
# 应该看到总体CPU和内存使用率下降
```

---

## 🔍 故障排查

### 问题1: 服务更新失败

**症状**: 服务状态显示为 `Update paused`

**解决方案**:

```bash
# 查看失败原因
docker service ps obsync_api-gateway --no-trunc

# 如果是镜像拉取失败
docker pull g-rrng9518-docker.pkg.coding.net/obsync/sync/stratix-gateway:v1.0.2

# 如果是健康检查失败,检查日志
docker service logs obsync_api-gateway --tail 100

# 回滚到上一个版本
docker service rollback obsync_api-gateway
```

### 问题2: 503错误仍然出现

**症状**: 部署后仍然出现熔断器503错误

**诊断步骤**:

```bash
# 1. 检查熔断器配置是否生效
docker service logs obsync_api-gateway | grep "circuit"

# 2. 检查下游服务健康状态
docker service ps obsync_app-icalink

# 3. 检查网络连接
docker exec $(docker ps -q -f name=obsync_api-gateway) ping app-icalink

# 4. 检查DNS解析
docker exec $(docker ps -q -f name=obsync_api-gateway) nslookup app-icalink
```

**解决方案**:

```bash
# 如果是熔断器参数问题,调整配置
# 编辑 apps/api-gateway/src/hooks.ts
# 增加 threshold 或 timeout 值

# 如果是下游服务问题,检查app-icalink日志
docker service logs obsync_app-icalink --tail 100

# 如果是资源问题,增加资源限制
# 编辑 stack.yml,增加 memory 或 cpus 限制
```

### 问题3: 资源不足

**症状**: 服务频繁重启,OOM错误

**解决方案**:

```bash
# 检查内存使用
docker stats --no-stream

# 增加内存限制
# 编辑 stack.yml
resources:
  limits:
    memory: 2G  # 从1G增加到2G

# 重新部署
docker stack deploy -c /opt/obsync/swarm/stack.yml obsync
```

---

## 📊 监控指标

### 关键指标

部署后需要持续监控以下指标:

1. **服务可用性**
   - 健康检查成功率 > 99%
   - 服务重启次数 < 1次/天

2. **响应时间**
   - P50 < 100ms
   - P95 < 500ms
   - P99 < 1000ms

3. **错误率**
   - 4xx错误率 < 1%
   - 5xx错误率 < 0.1%

4. **资源使用**
   - CPU使用率 < 70%
   - 内存使用率 < 80%
   - 网络IO < 100MB/s

5. **熔断器状态**
   - 熔断器打开次数 < 5次/天
   - 熔断器打开持续时间 < 1分钟

### 监控命令

```bash
# 实时监控服务状态
watch -n 5 'docker service ls'

# 监控资源使用
watch -n 5 'docker stats --no-stream'

# 监控日志
docker service logs obsync_api-gateway --tail 100 --follow | grep -E "error|circuit|503"
```

---

## 🔄 回滚计划

如果部署出现问题,可以快速回滚:

### 快速回滚

```bash
# 方法1: 使用备份的配置文件
docker stack deploy -c /opt/obsync/swarm/stack.yml.backup.YYYYMMDD_HHMMSS obsync

# 方法2: 回滚单个服务
docker service rollback obsync_api-gateway
docker service rollback obsync_app-icalink
docker service rollback obsync_app-icasync

# 方法3: 完全重新部署
docker stack rm obsync
sleep 30
docker stack deploy -c /opt/obsync/swarm/stack.yml.backup.YYYYMMDD_HHMMSS obsync
```

---

## ✅ 部署检查清单

- [ ] 备份当前配置和数据
- [ ] 更新代码到最新版本
- [ ] 构建新的Docker镜像
- [ ] 推送镜像到仓库
- [ ] 更新stack.yml配置
- [ ] 验证配置语法
- [ ] 执行滚动更新
- [ ] 监控部署进度
- [ ] 验证服务健康状态
- [ ] 执行功能测试
- [ ] 检查资源使用情况
- [ ] 设置监控告警
- [ ] 记录部署日志

---

## 📞 支持

如有问题,请联系:
- 技术支持: tech-support@example.com
- 紧急联系: +86-xxx-xxxx-xxxx

---

**文档版本**: v1.0  
**最后更新**: 2025-10-24  
**作者**: Stratix Team

