# ObSync 生产环境部署方案

## 📋 部署架构概览

本文档描述了 ObSync 系统在生产环境中的完整部署方案，采用双服务器高可用架构，确保系统的稳定性和可扩展性。

### 🏗️ 系统架构

```
                    Internet
                       |
                kwps.jlufe.edu.cn
                       |
              ┌─────────────────┐
              │   主服务器      │
              │ 120.131.12.6   │
              │                │
              │ ┌─────────────┐ │
              │ │    Nginx    │ │ ← 静态文件服务 + 负载均衡
              │ │   (HTTPS)   │ │
              │ └─────────────┘ │
              │        │        │
              │ ┌─────────────┐ │
              │ │   Docker    │ │
              │ │ api-gateway │ │ ← API网关实例
              │ │ app-icasync │ │ ← 后端服务实例
              │ └─────────────┘ │
              └─────────────────┘
                       │
                   内网通信
                       │
              ┌─────────────────┐
              │   备用服务器    │
              │ (10.0.0.102)120.131.10.128 │
              │                │
              │ ┌─────────────┐ │
              │ │    Nginx    │ │ ← MySQL代理 + API代理
              │ │   (HTTP)    │ │
              │ └─────────────┘ │
              │        │        │
              │ ┌─────────────┐ │
              │ │   Docker    │ │
              │ │ api-gateway │ │ ← API网关实例
              │ │ app-icasync │ │ ← 后端服务实例
              │ └─────────────┘ │
              └─────────────────┘
```

## 🎯 核心设计原则

### 1. 高可用性
- **双服务器部署**：主备服务器确保服务连续性
- **负载均衡**：Nginx upstream 实现智能流量分发
- **健康检查**：自动故障检测和流量切换
- **容器化部署**：Docker 确保环境一致性和快速恢复

### 2. 安全性
- **HTTPS 强制**：所有外部访问强制使用 HTTPS
- **内网隔离**：后端服务仅绑定 localhost，通过 API 网关访问
- **防火墙配置**：最小化端口暴露，严格访问控制
- **SSL 证书**：使用通配符证书，支持自动续期

### 3. 性能优化
- **静态资源缓存**：Nginx 提供高效的静态文件服务
- **Gzip 压缩**：减少传输数据量
- **连接复用**：keepalive 优化连接管理
- **限流保护**：防止恶意请求和系统过载

## 📦 应用组件

### 前端应用
- **agendaedu-web** (Web管理端)
  - 部署路径：`/web`
  - 静态文件目录：`/var/www/agendaedu-web/`
  - 访问地址：`https://kwps.jlufe.edu.cn/web/`

- **agendaedu-app** (移动端应用)
  - 部署路径：`/app`
  - 静态文件目录：`/var/www/agendaedu-app/`
  - 访问地址：`https://kwps.jlufe.edu.cn/app/`

### 后端服务
- **api-gateway** (API网关)
  - 端口：8090
  - 功能：认证、授权、路由转发、限流
  - 部署：两台服务器都运行实例

- **app-icasync** (课程同步服务)
  - 端口：3001 (内部)
  - 功能：课程数据同步到 WPS 日历
  - 访问：仅通过 API 网关

- **app-icalink** (签到服务)
  - 端口：3002 (内部)
  - 功能：课程签到功能
  - 访问：仅通过 API 网关
  - 状态：当前已注释，待启用

## 🔄 流量路由

### API 请求流程
```
用户请求 → Nginx (主服务器) → API Gateway (负载均衡) → 后端服务
```

1. **外部请求**：所有 `/api/*` 请求到达主服务器 Nginx
2. **负载均衡**：Nginx 根据权重分发到两台服务器的 API Gateway
3. **服务路由**：API Gateway 根据路径路由到对应的后端服务
4. **内部通信**：后端服务间通过 Docker 网络通信

### 静态资源流程
```
用户请求 → Nginx (主服务器) → 静态文件
```

- 直接由主服务器 Nginx 提供，无需转发
- 支持缓存策略和压缩优化

## 📊 当前配置分析

### ✅ 符合要求的配置
1. **双服务器架构**：已配置主备服务器
2. **Docker 容器化**：所有服务都使用 Docker 部署
3. **Nginx 负载均衡**：已配置 upstream 和权重分配
4. **HTTPS 配置**：完整的 SSL 证书和安全头配置
5. **健康检查**：容器级和应用级健康检查机制

### ⚠️ 需要调整的配置
1. **app-icalink 服务**：当前被注释，需要启用
2. **端口绑定**：需要确保后端服务仅绑定 localhost
3. **备用服务器配置**：需要完善 Server-2 的 Docker 配置
4. **监控和日志**：需要增强监控和日志收集机制

## 📚 文档结构

本部署方案包含以下详细文档：

- **[服务器环境配置](./server-setup.md)** - 两台服务器的基础环境搭建
- **[Nginx 配置说明](./nginx-config.md)** - 负载均衡和静态文件服务配置
- **[Docker 部署指南](./docker-deployment.md)** - 容器配置和部署脚本
- **[安全配置指南](./security-config.md)** - 网络安全和访问控制
- **[监控配置](./monitoring.md)** - 服务监控和日志管理
- **[故障恢复机制](./disaster-recovery.md)** - 故障转移和恢复流程
- **[部署验证](./verification.md)** - 部署验证和测试步骤

## 🚀 快速开始

1. **环境准备**：按照 [服务器环境配置](./server-setup.md) 搭建基础环境
2. **配置部署**：参考 [Docker 部署指南](./docker-deployment.md) 部署服务
3. **验证测试**：使用 [部署验证](./verification.md) 确认部署成功
4. **监控配置**：按照 [监控配置](./monitoring.md) 设置监控系统

## 📞 支持与维护

- **技术支持**：参考各组件的 README 文档
- **故障排查**：查看 [故障恢复机制](./disaster-recovery.md)
- **性能优化**：参考 [监控配置](./monitoring.md) 中的性能指标
- **安全更新**：定期检查 [安全配置指南](./security-config.md)
