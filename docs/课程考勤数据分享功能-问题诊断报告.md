# è¯¾ç¨‹è€ƒå‹¤æ•°æ®åˆ†äº«åŠŸèƒ½ - é—®é¢˜è¯Šæ–­æŠ¥å‘Š

## ğŸ“‹ é—®é¢˜æè¿°

**é”™è¯¯ç°è±¡**: ç‚¹å‡»"åˆ†äº«"æŒ‰é’®é€‰æ‹©"å®æ—¶æ•°æ®"æˆ–"å†å²ç»Ÿè®¡æ•°æ®"æ—¶ï¼Œæç¤º"ç”Ÿæˆå¤±è´¥"

**é”™è¯¯ä¿¡æ¯**: `icaLinkApiClient.post is not a function`

**å‘ç”Ÿæ—¶é—´**: 2025-11-10

---

## âœ… å·²ä¿®å¤çš„é—®é¢˜

### 1. APIå®¢æˆ·ç«¯å¯¼å…¥é”™è¯¯ âœ…

**é—®é¢˜**: å‰ç«¯ä»£ç ä¸­ä½¿ç”¨äº†é”™è¯¯çš„APIå®¢æˆ·ç«¯

**åŸå› **:
- å¯¼å…¥çš„æ˜¯ `IcaLinkApiClient`ï¼ˆç±»ï¼‰ï¼Œè€Œä¸æ˜¯ `icaLinkApiClient`ï¼ˆå®ä¾‹ï¼‰
- ç±»æ²¡æœ‰ `post` æ–¹æ³•ï¼Œåªæœ‰å®ä¾‹æ‰æœ‰

**ä¿®å¤**:
```typescript
// ä¿®å¤å‰
import { IcaLinkApiClient } from './icalink-api-client';
const response = await IcaLinkApiClient.post(...);  // âŒ

// ä¿®å¤å
import { icaLinkApiClient } from './icalink-api-client';
const response = await icaLinkApiClient.post(...);  // âœ…
```

**æ–‡ä»¶**: `apps/agendaedu-app/src/lib/attendance-api.ts`

---

### 2. æ¥å£è·¯å¾„ä¸ä¸€è‡´ âœ…

**é—®é¢˜**: `exportRealtimeData` æ–¹æ³•çš„è·¯å¾„ç¼ºå°‘ `/api` å‰ç¼€

**åŸå› **:
- åç«¯Controllerå®šä¹‰çš„è·¯å¾„: `/api/icalink/v1/attendance/export/realtime`
- å‰ç«¯è°ƒç”¨çš„è·¯å¾„: `/icalink/v1/attendance/export/realtime`ï¼ˆç¼ºå°‘ `/api`ï¼‰

**ä¿®å¤**:
```typescript
// ä¿®å¤å‰
'>('/icalink/v1/attendance/export/realtime', {  // âŒ

// ä¿®å¤å
'>('/api/icalink/v1/attendance/export/realtime', {  // âœ…
```

**æ–‡ä»¶**: `apps/agendaedu-app/src/lib/attendance-api.ts`

---

## âœ… å·²éªŒè¯çš„é…ç½®

### 1. Controllerè‡ªåŠ¨æ³¨å†Œ âœ…

**é…ç½®æ–‡ä»¶**: `apps/app-icalink/src/stratix.config.ts`

**é…ç½®å†…å®¹**:
```typescript
applicationAutoDI: {
  options: {}
}
```

**é»˜è®¤æ‰«ææ¨¡å¼**:
```typescript
patterns: [
  'services/*.{ts,js}',
  'repositories/*.{ts,js}',
  'controllers/*.{ts,js}'
]
```

**éªŒè¯ç»“æœ**: âœ… `AttendanceExportController.ts` ä½äº `controllers/` ç›®å½•ï¼Œä¼šè¢«è‡ªåŠ¨å‘ç°å’Œæ³¨å†Œ

---

### 2. Serviceä¾èµ–æ³¨å…¥ âœ…

**æ–‡ä»¶**: `apps/app-icalink/src/services/AttendanceExportService.ts`

**ä¾èµ–æ³¨å…¥**:
```typescript
constructor(
  private readonly exportRecordRepository: IAttendanceExportRecordRepository,
  private readonly attendanceTodayViewRepository: AttendanceTodayViewRepository,
  private readonly studentAbsenceRateDetailRepository: StudentAbsenceRateDetailRepository,
  private readonly osspClient: IOSSAdapter,
  private readonly logger: Logger
) {
  this.logger.info('âœ… AttendanceExportService initialized');
}
```

**éªŒè¯ç»“æœ**: âœ… ä¾èµ–æ³¨å…¥é…ç½®æ­£ç¡®ï¼Œæ‰€æœ‰ä¾èµ–éƒ½å·²å£°æ˜

---

### 3. Repositoryæ³¨å†Œ âœ…

**å·²éªŒè¯çš„Repository**:
- âœ… `AttendanceExportRecordRepository.ts` - å¯¼å‡ºè®°å½•Repository
- âœ… `AttendanceTodayViewRepository.ts` - å®æ—¶è€ƒå‹¤è§†å›¾Repository
- âœ… `StudentAbsenceRateDetailRepository.ts` - å­¦ç”Ÿç¼ºå‹¤ç‡è¯¦æƒ…Repository

**éªŒè¯ç»“æœ**: âœ… æ‰€æœ‰ä¾èµ–çš„Repositoryéƒ½å­˜åœ¨äº `repositories/` ç›®å½•ï¼Œä¼šè¢«è‡ªåŠ¨æ³¨å†Œ

---

### 4. OSSé€‚é…å™¨é…ç½® âœ…

**é…ç½®æ–‡ä»¶**: `apps/app-icalink/src/stratix.config.ts`

**é…ç½®å†…å®¹**:
```typescript
{
  name: '@stratix/ossp',
  plugin: osspPlugin,
  options: {
    ...osspConfig  // ä»æ•æ„Ÿé…ç½®ä¸­è¯»å–
  }
}
```

**é€‚é…å™¨æ³¨å†Œ**: `@stratix/ossp` æ’ä»¶ä¼šè‡ªåŠ¨æ³¨å†Œ `IOSSAdapter` åˆ°å®¹å™¨

**éªŒè¯ç»“æœ**: âœ… OSSé€‚é…å™¨å·²é…ç½®ï¼Œå¯ä»¥é€šè¿‡ä¾èµ–æ³¨å…¥ä½¿ç”¨

---

## â³ å¾…éªŒè¯çš„é—®é¢˜

### 1. æ•°æ®åº“è¡¨æ˜¯å¦å­˜åœ¨ â³

**è¡¨å**: `icalink_attendance_export_records`

**å»ºè¡¨SQL**: å·²åœ¨æŠ€æœ¯æ–¹æ¡ˆæ–‡æ¡£ä¸­æä¾›

**éªŒè¯æ–¹æ³•**:
```sql
SHOW TABLES LIKE 'icalink_attendance_export_records';
```

**å¦‚æœè¡¨ä¸å­˜åœ¨ï¼Œéœ€è¦æ‰§è¡Œ**:
```sql
CREATE TABLE `icalink_attendance_export_records` (
  `id` INT UNSIGNED NOT NULL AUTO_INCREMENT COMMENT 'ä¸»é”®ID',
  `task_id` VARCHAR(64) NOT NULL COMMENT 'ä»»åŠ¡IDï¼ˆUUIDï¼‰',
  `export_type` ENUM('realtime', 'history') NOT NULL COMMENT 'å¯¼å‡ºç±»å‹',
  `status` ENUM('pending', 'processing', 'completed', 'failed') NOT NULL DEFAULT 'pending' COMMENT 'ä»»åŠ¡çŠ¶æ€',
  `progress` TINYINT UNSIGNED NOT NULL DEFAULT 0 COMMENT 'è¿›åº¦ï¼ˆ0-100ï¼‰',
  `file_name` VARCHAR(255) NULL COMMENT 'æ–‡ä»¶å',
  `file_path` VARCHAR(512) NULL COMMENT 'OSSæ–‡ä»¶è·¯å¾„',
  `file_size` BIGINT UNSIGNED NULL COMMENT 'æ–‡ä»¶å¤§å°ï¼ˆå­—èŠ‚ï¼‰',
  `download_url` VARCHAR(1024) NULL COMMENT 'ä¸‹è½½URL',
  `query_hash` VARCHAR(64) NULL COMMENT 'æŸ¥è¯¢å‚æ•°å“ˆå¸Œï¼ˆç”¨äºç¼“å­˜åˆ¤æ–­ï¼‰',
  `request_params` JSON NULL COMMENT 'è¯·æ±‚å‚æ•°ï¼ˆJSONæ ¼å¼ï¼‰',
  `error_message` TEXT NULL COMMENT 'é”™è¯¯ä¿¡æ¯',
  `created_by` VARCHAR(64) NULL COMMENT 'åˆ›å»ºäººID',
  `created_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `updated_at` TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  `expires_at` TIMESTAMP NULL COMMENT 'è¿‡æœŸæ—¶é—´',
  PRIMARY KEY (`id`),
  UNIQUE KEY `uk_task_id` (`task_id`),
  KEY `idx_query_hash` (`query_hash`),
  KEY `idx_status` (`status`),
  KEY `idx_created_by` (`created_by`),
  KEY `idx_expires_at` (`expires_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_unicode_ci COMMENT='è€ƒå‹¤æ•°æ®å¯¼å‡ºè®°å½•è¡¨';
```

---

### 2. OSSæœåŠ¡é…ç½® â³

**éœ€è¦éªŒè¯çš„é…ç½®é¡¹**:
- MinIOæœåŠ¡åœ°å€ï¼ˆendPointï¼‰
- è®¿é—®å¯†é’¥ï¼ˆaccessKeyï¼‰
- å¯†é’¥ï¼ˆsecretKeyï¼‰
- ç«¯å£ï¼ˆportï¼‰
- æ˜¯å¦ä½¿ç”¨SSLï¼ˆuseSSLï¼‰

**é…ç½®ä½ç½®**: ç¯å¢ƒå˜é‡ `STRATIX_SENSITIVE_CONFIG` ä¸­çš„ `ossp` é…ç½®

**ç¤ºä¾‹é…ç½®**:
```json
{
  "ossp": {
    "endPoint": "minio.example.com",
    "port": 9000,
    "useSSL": false,
    "accessKey": "your-access-key",
    "secretKey": "your-secret-key"
  }
}
```

---

## ğŸ” åç»­è¯Šæ–­æ­¥éª¤

### æ­¥éª¤1: æ£€æŸ¥æ•°æ®åº“è¡¨

```bash
# è¿æ¥åˆ°æ•°æ®åº“
mysql -h <host> -u <user> -p <database>

# æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
SHOW TABLES LIKE 'icalink_attendance_export_records';

# å¦‚æœä¸å­˜åœ¨ï¼Œæ‰§è¡Œå»ºè¡¨SQL
```

### æ­¥éª¤2: æ£€æŸ¥OSSé…ç½®

```bash
# æŸ¥çœ‹ç¯å¢ƒå˜é‡
echo $STRATIX_SENSITIVE_CONFIG

# æˆ–è€…æŸ¥çœ‹é…ç½®æ–‡ä»¶
cat /path/to/config/file
```

### æ­¥éª¤3: æµ‹è¯•åç«¯æ¥å£

```bash
# æµ‹è¯•å¯¼å‡ºå®æ—¶æ•°æ®æ¥å£
curl -X POST http://localhost:8090/api/icalink/v1/attendance/export/realtime \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer <token>" \
  -d '{"courseId": 123}'

# æŸ¥çœ‹å“åº”
```

### æ­¥éª¤4: æŸ¥çœ‹åç«¯æ—¥å¿—

```bash
# æŸ¥çœ‹åº”ç”¨æ—¥å¿—
tail -f /path/to/logs/app.log

# æŸ¥æ‰¾é”™è¯¯ä¿¡æ¯
grep -i "error" /path/to/logs/app.log
grep -i "AttendanceExportController" /path/to/logs/app.log
```

---

## ğŸ“Š é—®é¢˜æ€»ç»“

### å·²ä¿®å¤ âœ…
1. âœ… APIå®¢æˆ·ç«¯å¯¼å…¥é”™è¯¯ï¼ˆ`IcaLinkApiClient` â†’ `icaLinkApiClient`ï¼‰
2. âœ… æ¥å£è·¯å¾„ä¸ä¸€è‡´ï¼ˆç¼ºå°‘ `/api` å‰ç¼€ï¼‰

### å·²éªŒè¯ âœ…
1. âœ… Controllerè‡ªåŠ¨æ³¨å†Œé…ç½®æ­£ç¡®
2. âœ… Serviceä¾èµ–æ³¨å…¥é…ç½®æ­£ç¡®
3. âœ… Repositoryæ³¨å†Œé…ç½®æ­£ç¡®
4. âœ… OSSé€‚é…å™¨é…ç½®æ­£ç¡®

### å¾…éªŒè¯ â³
1. â³ æ•°æ®åº“è¡¨ `icalink_attendance_export_records` æ˜¯å¦å­˜åœ¨
2. â³ OSSæœåŠ¡é…ç½®æ˜¯å¦æ­£ç¡®ï¼ˆMinIOè¿æ¥ä¿¡æ¯ï¼‰

---

## ğŸ¯ ä¸‹ä¸€æ­¥è¡ŒåŠ¨

1. **ç«‹å³æ‰§è¡Œ**: åˆ·æ–°å‰ç«¯é¡µé¢ï¼Œæµ‹è¯•ä¿®å¤åçš„APIè°ƒç”¨
2. **å¦‚æœä»ç„¶å¤±è´¥**: 
   - æ£€æŸ¥æµè§ˆå™¨æ§åˆ¶å°çš„é”™è¯¯ä¿¡æ¯
   - æ£€æŸ¥åç«¯æ—¥å¿—çš„é”™è¯¯ä¿¡æ¯
   - éªŒè¯æ•°æ®åº“è¡¨æ˜¯å¦å­˜åœ¨
   - éªŒè¯OSSæœåŠ¡é…ç½®æ˜¯å¦æ­£ç¡®

---

**æŠ¥å‘Šç”Ÿæˆæ—¶é—´**: 2025-11-10  
**æŠ¥å‘ŠçŠ¶æ€**: éƒ¨åˆ†é—®é¢˜å·²ä¿®å¤ï¼Œå¾…éªŒè¯æ•°æ®åº“å’ŒOSSé…ç½®

