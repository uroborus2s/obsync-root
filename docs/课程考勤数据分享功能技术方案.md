# 课程考勤数据分享功能技术方案

## 1. 需求概述

在教师端增加**课程考勤数据分享功能**，支持导出Excel文档并通过OSS下载。

### 1.1 核心功能

- **实时数据导出**: 当前最新的考勤数据（每次重新生成）
- **历史统计数据导出**: 缺勤统计数据（支持缓存，避免重复生成）

### 1.2 技术栈

- **后端**: Stratix框架 (Fastify 5 + Awilix 12)
- **Excel生成**: exceljs
- **存储**: OSS (MinIO)
- **异步任务**: Executor层

---

## 2. 前端交互设计

### 2.1 页面位置

在 `agendaedu-app/src/pages/AttendanceSheet.tsx` 教师端页面中增加分享功能。

**位置**: 在"签到情况"和"缺勤统计"Tab项的右侧增加一个"分享"按钮（与Tab项同一行）

**布局结构**:

```
┌─────────────────────────────────────────────────────┐
│  Tab导航栏                                           │
│  ┌──────────┬──────────┬──────────────────┬────────┐│
│  │ 签到情况 │ 缺勤统计 │        (空白)     │ 分享 📤││
│  └──────────┴──────────┴──────────────────┴────────┘│
└─────────────────────────────────────────────────────┘
```

**实现方式**:

- Tab导航栏使用 `flex` 布局
- Tab按钮使用 `flex-1` 占据左侧空间
- 分享按钮固定在右侧，不参与Tab切换

### 2.2 UI交互流程

```
教师端课程详情页
  ├─ Tab导航栏
  │   ├─ 签到情况 Tab
  │   ├─ 缺勤统计 Tab
  │   └─ [新增] 分享按钮 ⬅️ 新增按钮（右侧固定位置）
  │
  └─ 点击"分享"按钮
      ├─ 弹出分享对话框（Modal）
      │   ├─ 标题: "分享考勤数据"
      │   ├─ 选项1: 实时数据（当前最新考勤）
      │   │   └─ 说明: 导出当前课程的实时签到数据
      │   └─ 选项2: 历史统计数据（缺勤统计）
      │       └─ 说明: 导出学生缺勤统计报表
      │
      ├─ 选择数据类型后
      │   ├─ 对话框内容切换为进度面板
      │   ├─ 显示进度条和状态文字
      │   └─ 后台轮询任务状态（每2秒）
      │
      └─ 任务完成
          ├─ 进度条变为100%
          ├─ 显示"下载"按钮（替换进度条）
          └─ 点击下载Excel文件
```

### 2.3 交互细节设计

#### 2.3.1 进度显示方案

**显示位置**: 在分享对话框（Modal）内部

**进度面板内容**:

```
┌─────────────────────────────────────┐
│  分享考勤数据                        │
├─────────────────────────────────────┤
│                                     │
│  正在生成Excel文件...                │
│                                     │
│  ████████████░░░░░░░░  60%          │
│                                     │
│  状态: 正在查询数据...               │
│                                     │
└─────────────────────────────────────┘
```

**进度信息**:

- **进度条**: 显示百分比（0-100%）
- **状态文字**: 显示当前步骤
  - "正在查询数据..." (0-30%)
  - "正在生成Excel..." (30-70%)
  - "正在上传文件..." (70-90%)
  - "即将完成..." (90-100%)
- **不显示预计剩余时间**（因为任务通常很快完成）

#### 2.3.2 下载按钮位置

**方案**: 在进度面板上（进度条变为下载按钮）

**完成后的面板**:

```
┌─────────────────────────────────────┐
│  分享考勤数据                        │
├─────────────────────────────────────┤
│                                     │
│  ✅ Excel文件生成成功！              │
│                                     │
│  ┌─────────────────────────────┐   │
│  │  📥 下载Excel文件            │   │
│  └─────────────────────────────┘   │
│                                     │
│  文件名: 实时考勤数据_xxx.xlsx       │
│  大小: 125 KB                       │
│                                     │
└─────────────────────────────────────┘
```

**交互逻辑**:

1. 任务完成后，进度条淡出
2. 下载按钮淡入（带动画效果）
3. 点击下载按钮后，触发文件下载
4. 下载完成后，对话框自动关闭（或显示"关闭"按钮）

#### 2.3.3 历史文档缓存交互

**采用方案A**: 先调用API检查缓存，根据结果决定UI展示

**交互流程**:

1. **点击"分享"按钮** → 显示数据类型选择对话框
2. **选择"历史统计数据"** → 立即调用后端API
3. **后端检查缓存**:
   - **命中缓存** (cacheHit: true):
     - 对话框内容切换为"文件已准备好"
     - 直接显示下载按钮（跳过进度条）
     - 显示缓存提示: "使用已生成的文件（生成于 2小时前）"
   - **未命中缓存** (cacheHit: false):
     - 对话框内容切换为进度面板
     - 显示进度条（从0%开始）
     - 开始轮询任务状态

**命中缓存时的面板**:

```
┌─────────────────────────────────────┐
│  分享考勤数据                        │
├─────────────────────────────────────┤
│                                     │
│  ✅ 文件已准备好！                   │
│                                     │
│  ┌─────────────────────────────┐   │
│  │  📥 下载Excel文件            │   │
│  └─────────────────────────────┘   │
│                                     │
│  💡 使用已生成的文件                 │
│     (生成于 2小时前)                │
│                                     │
└─────────────────────────────────────┘
```

**优点**:

- 用户体验更好（命中缓存时无需等待）
- 明确告知用户使用的是缓存文件
- 减少不必要的进度条显示

### 2.4 用户操作步骤

#### 2.4.1 实时数据导出流程

1. **进入教师端课程详情页**
2. **点击Tab导航栏右侧的"分享"按钮**
3. **在弹出的对话框中选择"实时数据"**
4. **对话框切换为进度面板**，显示:
   - 进度条（0% → 100%）
   - 状态文字（正在查询数据 → 正在生成Excel → 正在上传文件）
5. **任务完成后**，进度条变为下载按钮
6. **点击"下载Excel文件"按钮**
7. **浏览器自动下载文件**，对话框关闭

#### 2.4.2 历史统计数据导出流程（命中缓存）

1. **进入教师端课程详情页**
2. **点击Tab导航栏右侧的"分享"按钮**
3. **在弹出的对话框中选择"历史统计数据"**
4. **后端检查缓存，命中缓存**
5. **对话框直接显示下载按钮**（跳过进度条）
6. **显示缓存提示**: "使用已生成的文件（生成于 2小时前）"
7. **点击"下载Excel文件"按钮**
8. **浏览器自动下载文件**，对话框关闭

#### 2.4.3 历史统计数据导出流程（未命中缓存）

1. **进入教师端课程详情页**
2. **点击Tab导航栏右侧的"分享"按钮**
3. **在弹出的对话框中选择"历史统计数据"**
4. **后端检查缓存，未命中缓存**
5. **对话框切换为进度面板**，显示进度条
6. **轮询任务状态**（每2秒），更新进度
7. **任务完成后**，进度条变为下载按钮
8. **点击"下载Excel文件"按钮**
9. **浏览器自动下载文件**，对话框关闭

---

## 3. 后端API设计

### 3.1 接口路由定义

#### 3.1.1 生成实时数据Excel

```
POST /api/icalink/v1/attendance/export/realtime
```

**请求参数**:

```typescript
{
  courseId: number;        // 课程ID (attendance_course_id)
  externalId?: string;     // 课程外部ID（可选）
}
```

**响应格式**:

```typescript
{
  success: boolean;
  data: {
    taskId: string;        // 任务ID（用于轮询状态）
    status: 'pending' | 'processing' | 'completed' | 'failed';
    downloadUrl?: string;  // 下载URL（完成后返回）
  };
  message?: string;
}
```

#### 3.1.2 生成历史统计数据Excel

```
POST /api/icalink/v1/attendance/export/history
```

**请求参数**:

```typescript
{
  courseCode: string;      // 课程代码
  sortField?: string;      // 排序字段（默认：absence_rate）
  sortOrder?: 'asc' | 'desc'; // 排序方向（默认：desc）
}
```

**响应格式**:

```typescript
{
  success: boolean;
  data: {
    taskId?: string;       // 任务ID（如果是新生成）
    status: 'cached' | 'pending' | 'processing' | 'completed' | 'failed';
    downloadUrl?: string;  // 下载URL（缓存或完成后返回）
    cacheHit: boolean;     // 是否命中缓存
  };
  message?: string;
}
```

#### 3.1.3 查询任务状态

```
GET /api/icalink/v1/attendance/export/status/:taskId
```

**响应格式**:

```typescript
{
  success: boolean;
  data: {
    taskId: string;
    status: 'pending' | 'processing' | 'completed' | 'failed';
    progress?: number;     // 进度百分比（0-100）
    downloadUrl?: string;  // 下载URL（完成后返回）
    error?: string;        // 错误信息（失败时返回）
  };
}
```

#### 3.1.4 下载Excel文件

```
GET /api/icalink/v1/attendance/export/download/:fileId
```

**响应**: Excel文件流（application/vnd.openxmlformats-officedocument.spreadsheetml.sheet）

### 3.2 异步任务处理流程

```
客户端请求
  ↓
Controller层（接收请求）
  ↓
Service层（业务逻辑）
  ├─ 检查缓存（仅历史数据）
  │   ├─ 命中缓存 → 直接返回下载链接
  │   └─ 未命中 → 创建异步任务
  │
  └─ 创建异步任务
      ↓
Executor层（异步执行）
  ├─ 查询数据
  ├─ 生成Excel
  ├─ 上传到OSS
  └─ 更新任务状态
      ↓
客户端轮询任务状态
  ↓
任务完成 → 返回下载链接
  ↓
客户端下载文件
```

---

## 4. 数据库设计

### 4.1 历史文档记录表

```sql
CREATE TABLE icalink_attendance_export_records (
  id INT AUTO_INCREMENT PRIMARY KEY,

  -- 任务标识
  task_id VARCHAR(64) NOT NULL UNIQUE COMMENT '任务ID（UUID）',

  -- 导出类型
  export_type ENUM('realtime', 'history') NOT NULL COMMENT '导出类型',

  -- 课程信息
  course_id INT COMMENT '课程ID（实时数据）',
  course_code VARCHAR(50) COMMENT '课程代码（历史数据）',
  course_name VARCHAR(200) COMMENT '课程名称',

  -- 查询参数（用于缓存判断）
  query_params JSON COMMENT '查询参数（JSON格式）',
  query_hash VARCHAR(64) NOT NULL COMMENT '查询参数哈希（用于去重）',

  -- 文件信息
  file_name VARCHAR(255) NOT NULL COMMENT '文件名',
  file_path VARCHAR(500) NOT NULL COMMENT 'OSS文件路径',
  file_size BIGINT COMMENT '文件大小（字节）',

  -- 任务状态
  status ENUM('pending', 'processing', 'completed', 'failed') NOT NULL DEFAULT 'pending' COMMENT '任务状态',
  progress INT DEFAULT 0 COMMENT '进度百分比（0-100）',
  error_message TEXT COMMENT '错误信息',

  -- 统计信息
  record_count INT COMMENT '记录数量',

  -- 时间戳
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  completed_at TIMESTAMP NULL COMMENT '完成时间',
  expires_at TIMESTAMP NULL COMMENT '过期时间（文件有效期）',

  -- 创建者
  created_by VARCHAR(50) COMMENT '创建者ID',

  -- 索引
  INDEX idx_task_id (task_id),
  INDEX idx_query_hash (query_hash),
  INDEX idx_export_type (export_type),
  INDEX idx_course_code (course_code),
  INDEX idx_status (status),
  INDEX idx_created_at (created_at),
  INDEX idx_expires_at (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='考勤数据导出记录表';
```

### 4.2 索引和查询优化

**主要查询场景**:

1. 根据 `task_id` 查询任务状态（高频）
2. 根据 `query_hash` 查询是否已生成（缓存判断）
3. 根据 `expires_at` 清理过期文件（定时任务）

**优化策略**:

- `task_id` 使用 UNIQUE 索引，支持快速查询
- `query_hash` 索引用于缓存命中判断
- `expires_at` 索引用于定时清理过期文件

---

## 5. Excel生成方案

### 5.1 使用的库

**exceljs** - Node.js Excel生成库

- 官方文档: https://github.com/exceljs/exceljs
- 功能强大，支持样式、公式、图表等
- 性能优秀，支持流式写入

### 5.2 数据格式和模板设计

#### 5.2.1 实时数据Excel模板

**数据来源**: `v_attendance_today_details` 视图

**表头设计**:

```
| 序号 | 学号 | 姓名 | 班级 | 专业 | 签到状态 | 签到时间 | 备注 |
```

**字段映射**:

- 学号: `student_id`
- 姓名: `student_name`
- 班级: `class_name`
- 专业: `major_name`
- 签到状态: `final_status` (转换为中文)
- 签到时间: 格式化显示

**样式设置**:

- 表头: 加粗、背景色、居中
- 数据行: 根据签到状态设置不同颜色
  - 已签到: 绿色
  - 缺勤: 红色
  - 请假: 黄色

#### 5.2.2 历史统计数据Excel模板

**数据来源**: `getCourseAbsenceStats` 接口返回的数据

**表头设计**:

```
| 序号 | 学号 | 姓名 | 班级 | 总课次 | 已上课次 | 缺勤次数 | 请假次数 | 旷课次数 | 缺课率 | 旷课率 | 请假率 |
```

**字段映射**:

- 学号: `student_id`
- 姓名: `student_name`
- 班级: `class_name`
- 总课次: `total_sessions`
- 已上课次: `completed_sessions`
- 缺勤次数: `absent_count`
- 请假次数: `leave_count`
- 旷课次数: `truant_count`
- 缺课率: `absence_rate` (百分比格式)
- 旷课率: `truant_rate` (百分比格式)
- 请假率: `leave_rate` (百分比格式)

**样式设置**:

- 表头: 加粗、背景色、居中
- 数据行: 根据缺课率设置不同颜色
  - 缺课率 < 10%: 绿色
  - 10% ≤ 缺课率 < 30%: 黄色
  - 缺课率 ≥ 30%: 红色

### 5.3 性能优化考虑

1. **流式写入**: 使用 exceljs 的流式API，避免内存溢出
2. **批量处理**: 分批查询数据，避免一次性加载大量数据
3. **异步执行**: 使用 Executor 层异步生成，避免阻塞请求
4. **缓存策略**: 历史数据使用缓存，避免重复生成

---

## 6. 缓存策略

### 6.1 历史数据去重逻辑

**缓存Key设计**:

```typescript
const queryHash = crypto
  .createHash('sha256')
  .update(
    JSON.stringify({
      courseCode,
      sortField,
      sortOrder
    })
  )
  .digest('hex');
```

**缓存判断流程**:

```
1. 计算查询参数的哈希值
2. 查询数据库是否存在相同哈希值的记录
3. 如果存在且状态为 'completed' 且未过期
   ├─ 命中缓存
   └─ 直接返回下载链接
4. 否则
   └─ 创建新的导出任务
```

### 6.2 文件过期清理策略

**过期时间**: 7天（可配置）

**清理策略**:

1. **定时任务**: 每天凌晨执行清理任务
2. **清理逻辑**:
   - 查询 `expires_at < NOW()` 的记录
   - 删除OSS文件
   - 删除数据库记录

**实现方式**: 使用数据库事件或Executor定时任务

```sql
-- 定时清理过期文件
CREATE EVENT IF NOT EXISTS clean_expired_export_files
ON SCHEDULE EVERY 1 DAY
STARTS '2024-01-01 02:00:00'
DO
  DELETE FROM icalink_attendance_export_records
  WHERE expires_at < NOW();
```

### 6.3 实时数据处理

**不使用缓存**: 每次请求都重新生成Excel文件

**原因**: 实时数据会频繁变化，缓存意义不大

---

## 7. OSS集成方案

### 7.1 文件命名规则

**实时数据**:

```
attendance/realtime/{courseId}/{timestamp}.xlsx
```

**历史统计数据**:

```
attendance/history/{courseCode}/{queryHash}.xlsx
```

### 7.2 存储路径设计

**Bucket**: `icalink-attachments`

**路径结构**:

```
icalink-attachments/
  └─ attendance/
      ├─ realtime/
      │   └─ {courseId}/
      │       └─ {timestamp}.xlsx
      └─ history/
          └─ {courseCode}/
              └─ {queryHash}.xlsx
```

### 7.3 下载链接有效期

**内网OSS**: 文件的生成和下载通过后端接口完成

**下载流程**:

1. 客户端请求下载接口: `GET /api/icalink/v1/attendance/export/download/:fileId`
2. 后端验证权限和文件有效性
3. 从OSS下载文件
4. 返回文件流给客户端

**优点**:

- 统一权限控制
- 避免暴露OSS内网地址
- 支持下载统计和审计

---

## 8. 实现步骤

### 8.1 后端实现

#### 步骤1: 创建数据库表

```bash
# 执行SQL脚本
mysql -u root -p < apps/app-icalink/database/tables/icalink_attendance_export_records.sql
```

#### 步骤2: 创建类型定义

```typescript
// apps/app-icalink/src/types/attendance-export.types.ts
```

#### 步骤3: 创建Repository层

```typescript
// apps/app-icalink/src/repositories/AttendanceExportRecordRepository.ts
```

#### 步骤4: 创建Service层

```typescript
// apps/app-icalink/src/services/AttendanceExportService.ts
```

#### 步骤5: 创建Executor层

```typescript
// apps/app-icalink/src/executors/AttendanceExportExecutor.ts
```

#### 步骤6: 创建Controller层

```typescript
// apps/app-icalink/src/controllers/AttendanceExportController.ts
```

### 8.2 前端实现

#### 步骤1: 创建分享对话框组件

```typescript
// apps/agendaedu-app/src/components/ShareAttendanceDialog.tsx
```

#### 步骤2: 在AttendanceSheet中集成

```typescript
// apps/agendaedu-app/src/pages/AttendanceSheet.tsx
// 添加"分享考勤数据"按钮
```

#### 步骤3: 创建API客户端方法

```typescript
// apps/agendaedu-app/src/lib/attendance-api.ts
// 添加导出相关API方法
```

---

## 9. 注意事项

1. **权限控制**: 仅教师可以导出课程考勤数据
2. **并发控制**: 同一课程同时只能有一个导出任务
3. **错误处理**: 完善的错误提示和重试机制
4. **性能监控**: 记录导出任务的执行时间和资源消耗
5. **文件大小限制**: 单个Excel文件不超过10MB
6. **数据安全**: 敏感数据脱敏处理

---

## 10. 后续优化

1. **支持更多导出格式**: PDF、CSV等
2. **支持自定义字段**: 用户可选择导出哪些字段
3. **支持批量导出**: 一次导出多个课程的数据
4. **支持邮件发送**: 导出完成后发送邮件通知
5. **支持数据分析**: 在Excel中添加图表和统计分析
