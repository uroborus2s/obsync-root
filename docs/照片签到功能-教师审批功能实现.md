# ç…§ç‰‡ç­¾åˆ°åŠŸèƒ½ - æ•™å¸ˆå®¡æ‰¹åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ“‹ å®ç°æ¦‚è¿°

æœ¬æ¬¡ä¿®æ”¹å®ç°äº†æ•™å¸ˆæŸ¥çœ‹å’Œå®¡æ‰¹å­¦ç”Ÿç…§ç‰‡ç­¾åˆ°çš„å®Œæ•´åŠŸèƒ½ï¼ŒåŒ…æ‹¬ï¼š
1. ä¼˜åŒ–æ•™å¸ˆè§†å›¾çš„æ•°æ®è·å–é€»è¾‘
2. å®ç°å­¦ç”Ÿåˆ—è¡¨æŒ‰å®¡æ‰¹çŠ¶æ€æ’åº
3. æ·»åŠ ç…§ç‰‡ç­¾åˆ°å®¡æ‰¹æ¥å£

---

## ğŸ”§ ä¿®æ”¹å†…å®¹

### 1. Repository å±‚ä¼˜åŒ–

**æ–‡ä»¶**: `apps/app-icalink/src/repositories/CourseStudentRepository.ts`

#### 1.1 æ•°æ®è·å–é€»è¾‘ä¼˜åŒ–

**ä¿®æ”¹å‰**ï¼š
- ä½¿ç”¨ `v_attendance_realtime_details` è§†å›¾
- åªèƒ½è·å–åŸºæœ¬çš„è€ƒå‹¤çŠ¶æ€ä¿¡æ¯
- ç¼ºå°‘ç…§ç‰‡ç­¾åˆ°çš„è¯¦ç»†ä¿¡æ¯ï¼ˆ`metadata`ã€`checkin_location` ç­‰ï¼‰

**ä¿®æ”¹å**ï¼š
```typescript
// ä¸»æŸ¥è¯¢ï¼šä½¿ç”¨ v_attendance_today_details + LEFT JOIN icalink_attendance_records
let query: any = db.selectFrom('out_jw_kcb_xs as cs');
query = query.leftJoin('out_xsxx as s', 's.xh', 'cs.xh');

// LEFT JOIN v_attendance_today_details è§†å›¾è·å–è€ƒå‹¤çŠ¶æ€
query = query.leftJoin(
  'icasync.v_attendance_today_details as vatd',
  (join: any) =>
    join
      .onRef('vatd.student_id', '=', 'cs.xh')
      .on('vatd.external_id', '=', externalId)
);

// LEFT JOIN icalink_attendance_records è¡¨è·å–è¯¦ç»†ä¿¡æ¯ï¼ˆåŒ…æ‹¬ metadataï¼‰
query = query.leftJoin(
  'icasync.icalink_attendance_records as ar',
  (join: any) => join.onRef('ar.id', '=', 'vatd.attendance_record_id')
);

query = query.select([
  'cs.xh as student_id',
  's.xm as student_name',
  's.bjmc as class_name',
  's.zymc as major_name',
  sql<string>`COALESCE(vatd.final_status, 'absent')`.as('absence_type'),
  'ar.id as attendance_record_id',
  'ar.checkin_time',
  'ar.checkin_location',
  'ar.checkin_latitude',
  'ar.checkin_longitude',
  'ar.checkin_accuracy',
  'ar.metadata'  // âœ… åŒ…å«ç…§ç‰‡ URL å’Œä½ç½®åç§»è·ç¦»
]);
```

**ä¼˜åŠ¿**ï¼š
- âœ… è·å–æ‰€æœ‰æ•™å­¦ç­å­¦ç”Ÿï¼ˆå³ä½¿æœªç­¾åˆ°ä¹Ÿæ˜¾ç¤ºï¼‰
- âœ… è·å–è¯¦ç»†çš„ç­¾åˆ°ä¿¡æ¯ï¼ˆç…§ç‰‡ URLã€ä½ç½®åç§»è·ç¦»ç­‰ï¼‰
- âœ… æ•°æ®ç»“æ„å®Œæ•´ï¼Œæ”¯æŒç…§ç‰‡ç­¾åˆ°å®¡æ‰¹åŠŸèƒ½

#### 1.2 å­¦ç”Ÿåˆ—è¡¨æ’åºè§„åˆ™

**æ–°æ’åºè§„åˆ™**ï¼ˆæŒ‰ä¼˜å…ˆçº§ä»é«˜åˆ°ä½ï¼‰ï¼š
```typescript
query = query.orderBy(
  sql`CASE
    WHEN COALESCE(vatd.final_status, 'absent') = 'pending_approval' THEN 1  // å¾…å®¡æ‰¹ï¼ˆç…§ç‰‡ç­¾åˆ°ï¼‰
    WHEN COALESCE(vatd.final_status, 'absent') = 'leave_pending' THEN 2     // è¯·å‡å¾…å®¡æ‰¹
    WHEN COALESCE(vatd.final_status, 'absent') = 'truant' THEN 3            // æ—·è¯¾
    WHEN COALESCE(vatd.final_status, 'absent') = 'absent' THEN 4            // ç¼ºå‹¤
    WHEN COALESCE(vatd.final_status, 'absent') = 'leave' THEN 5             // å·²æ‰¹å‡†è¯·å‡
    WHEN COALESCE(vatd.final_status, 'absent') = 'present' THEN 6           // å·²ç­¾åˆ°
    ELSE 7
  END`,
  'asc'
);
query = query.orderBy('cs.xh', 'asc');  // æ¬¡è¦æ’åºï¼šå­¦å·
```

**æ•ˆæœ**ï¼š
- âœ… å¾…å®¡æ‰¹çš„ç…§ç‰‡ç­¾åˆ°æ’åœ¨åˆ—è¡¨æœ€å‰é¢
- âœ… æ•™å¸ˆä¼˜å…ˆå¤„ç†éœ€è¦å®¡æ‰¹çš„ç­¾åˆ°
- âœ… ç¬¦åˆä¸šåŠ¡ä¼˜å…ˆçº§

#### 1.3 ç»Ÿè®¡æŸ¥è¯¢ä¼˜åŒ–

**ä¿®æ”¹å‰**ï¼š
```typescript
statsQuery = statsQuery.leftJoin(
  'icasync.v_attendance_realtime_details as vard',  // âŒ æ—§è§†å›¾
  ...
);
```

**ä¿®æ”¹å**ï¼š
```typescript
statsQuery = statsQuery.leftJoin(
  'icasync.v_attendance_today_details as vatd',  // âœ… æ–°è§†å›¾
  (join: any) =>
    join
      .onRef('vatd.student_id', '=', 'cs.xh')
      .on('vatd.external_id', '=', externalId)
);
```

**æ•ˆæœ**ï¼š
- âœ… ç»Ÿè®¡æ•°æ®ä¸ä¸»æŸ¥è¯¢ä¿æŒä¸€è‡´
- âœ… ä½¿ç”¨ç›¸åŒçš„æ•°æ®æºï¼ˆ`v_attendance_today_details`ï¼‰

---

### 2. API ç±»å‹å®šä¹‰

**æ–‡ä»¶**: `apps/app-icalink/src/types/api.ts`

#### 2.1 æ‰©å±• `StudentAttendanceDetail` æ¥å£

**æ–°å¢å­—æ®µ**ï¼š
```typescript
export interface StudentAttendanceDetail {
  student_id: string;
  student_name: string | null;
  class_name: string | null;
  major_name: string | null;
  absence_type: AttendanceStatus;
  checkin_time?: string | Date | null;
  
  // âœ… æ–°å¢å­—æ®µ
  attendance_record_id?: number | null;
  checkin_location?: string | null;
  checkin_latitude?: number | null;
  checkin_longitude?: number | null;
  checkin_accuracy?: number | null;
  metadata?: {
    photo_url?: string;                    // ç…§ç‰‡ URL
    location_offset_distance?: number;     // ä½ç½®åç§»è·ç¦»ï¼ˆç±³ï¼‰
    reason?: string;                       // å¤‡æ³¨
  } | null;
}
```

**ç”¨é€”**ï¼š
- `attendance_record_id`: ç”¨äºå®¡æ‰¹æ“ä½œ
- `metadata.photo_url`: æ˜¾ç¤ºå­¦ç”Ÿä¸Šä¼ çš„ç…§ç‰‡
- `metadata.location_offset_distance`: æ˜¾ç¤ºä½ç½®åç§»è·ç¦»

#### 2.2 ç…§ç‰‡ç­¾åˆ°å®¡æ‰¹æ¥å£ç±»å‹

**æ–°å¢ç±»å‹å®šä¹‰**ï¼š
```typescript
// ==================== API_12: ç…§ç‰‡ç­¾åˆ°å®¡æ‰¹æ¥å£ ====================

/**
 * å®¡æ‰¹ç…§ç‰‡ç­¾åˆ° DTO
 */
export interface ApprovePhotoCheckinDTO {
  attendanceRecordId: number;
  userInfo: UserInfo;
}

/**
 * å®¡æ‰¹ç…§ç‰‡ç­¾åˆ°å“åº”
 */
export interface ApprovePhotoCheckinResponse {
  success: boolean;
  message: string;
  data: {
    attendance_record_id: number;
    status: AttendanceStatus;
    updated_at: string;
  };
}
```

---

### 3. Service å±‚å®ç°

**æ–‡ä»¶**: `apps/app-icalink/src/services/AttendanceService.ts`

#### 3.1 å®¡æ‰¹æ–¹æ³•å®ç°

**æ–¹æ³•ç­¾å**ï¼š
```typescript
async approvePhotoCheckin(
  dto: ApprovePhotoCheckinDTO
): Promise<Either<ServiceError, ApprovePhotoCheckinResponse>>
```

**å®ç°é€»è¾‘**ï¼š
```typescript
public async approvePhotoCheckin(
  dto: ApprovePhotoCheckinDTO
): Promise<Either<ServiceError, ApprovePhotoCheckinResponse>> {
  const { attendanceRecordId, userInfo } = dto;

  try {
    // 1. æŸ¥è¯¢ç­¾åˆ°è®°å½•
    const recordMaybe = await this.attendanceRecordRepository.findById(attendanceRecordId);
    
    if (isNone(recordMaybe)) {
      return left({
        code: String(ServiceErrorCode.RESOURCE_NOT_FOUND),
        message: 'ç­¾åˆ°è®°å½•ä¸å­˜åœ¨'
      });
    }

    const record = recordMaybe.value;

    // 2. éªŒè¯è®°å½•çŠ¶æ€ï¼ˆåªèƒ½å®¡æ‰¹ pending_approval çŠ¶æ€çš„è®°å½•ï¼‰
    if (record.status !== 'pending_approval') {
      return left({
        code: String(ServiceErrorCode.VALIDATION_FAILED),
        message: `ç­¾åˆ°è®°å½•çŠ¶æ€ä¸æ˜¯å¾…å®¡æ‰¹çŠ¶æ€ï¼Œå½“å‰çŠ¶æ€ï¼š${record.status}`
      });
    }

    // 3. éªŒè¯æ˜¯å¦ä¸ºç…§ç‰‡ç­¾åˆ°ï¼ˆæ£€æŸ¥ metadata ä¸­æ˜¯å¦æœ‰ photo_urlï¼‰
    const metadata = record.metadata as any;
    if (!metadata || !metadata.photo_url) {
      return left({
        code: String(ServiceErrorCode.VALIDATION_FAILED),
        message: 'è¯¥ç­¾åˆ°è®°å½•ä¸æ˜¯ç…§ç‰‡ç­¾åˆ°'
      });
    }

    // 4. æ›´æ–°ç­¾åˆ°è®°å½•çŠ¶æ€ä¸º present
    const updateData: Partial<IcalinkAttendanceRecord> = {
      status: 'present',
      remark: 'ç…§ç‰‡ç­¾åˆ°å®¡æ‰¹é€šè¿‡',
      updated_by: userInfo.userId,
      manual_override_by: userInfo.userId,
      manual_override_time: new Date(),
      manual_override_reason: 'ç…§ç‰‡ç­¾åˆ°å®¡æ‰¹é€šè¿‡'
    };

    const updateResult = await this.attendanceRecordRepository.update(
      attendanceRecordId,
      updateData
    );

    if (isLeft(updateResult)) {
      return left({
        code: String(ServiceErrorCode.DATABASE_ERROR),
        message: 'æ›´æ–°ç­¾åˆ°è®°å½•å¤±è´¥'
      });
    }

    // 5. è¿”å›æˆåŠŸç»“æœ
    return right({
      success: true,
      message: 'ç…§ç‰‡ç­¾åˆ°å®¡æ‰¹é€šè¿‡',
      data: {
        attendance_record_id: attendanceRecordId,
        status: 'present',
        updated_at: new Date().toISOString()
      }
    });
  } catch (error) {
    this.logger.error({ error, attendanceRecordId }, 'Failed to approve photo checkin');
    return left({
      code: String(ServiceErrorCode.UNKNOWN_ERROR),
      message: 'å®¡æ‰¹ç…§ç‰‡ç­¾åˆ°å¤±è´¥'
    });
  }
}
```

**éªŒè¯é€»è¾‘**ï¼š
1. âœ… éªŒè¯ç­¾åˆ°è®°å½•å­˜åœ¨
2. âœ… éªŒè¯çŠ¶æ€ä¸º `pending_approval`
3. âœ… éªŒè¯æ˜¯ç…§ç‰‡ç­¾åˆ°ï¼ˆ`metadata.photo_url` å­˜åœ¨ï¼‰
4. âœ… æ›´æ–°çŠ¶æ€ä¸º `present`
5. âœ… è®°å½•å®¡æ‰¹äººå’Œå®¡æ‰¹æ—¶é—´

---

## ğŸ“Š æ•°æ®æµç¨‹

### æ•™å¸ˆæŸ¥çœ‹å­¦ç”Ÿç­¾åˆ°åˆ—è¡¨

```
1. å‰ç«¯è¯·æ±‚ â†’ GET /api/attendance/course/complete
   â†“
2. AttendanceService.getCourseCompleteData()
   â†“
3. AttendanceService.buildCurrentTeacherView()
   â†“
4. CourseStudentRepository.findStudentsWithRealtimeStatus()
   â†“
5. SQL æŸ¥è¯¢ï¼š
   - FROM out_jw_kcb_xs (æ•™å­¦ç­å­¦ç”Ÿ)
   - LEFT JOIN v_attendance_today_details (è€ƒå‹¤çŠ¶æ€)
   - LEFT JOIN icalink_attendance_records (è¯¦ç»†ä¿¡æ¯)
   â†“
6. è¿”å›å­¦ç”Ÿåˆ—è¡¨ï¼ˆåŒ…å« metadataï¼‰
   â†“
7. å‰ç«¯æ˜¾ç¤ºï¼š
   - å¾…å®¡æ‰¹çš„ç…§ç‰‡ç­¾åˆ°æ’åœ¨æœ€å‰é¢
   - æ˜¾ç¤ºç…§ç‰‡ç¼©ç•¥å›¾
   - æ˜¾ç¤ºä½ç½®åç§»è·ç¦»
   - æ˜¾ç¤º"æ‰¹å‡†"æŒ‰é’®
```

### æ•™å¸ˆå®¡æ‰¹ç…§ç‰‡ç­¾åˆ°

```
1. å‰ç«¯è¯·æ±‚ â†’ POST /api/attendance/records/:id/approve
   â†“
2. AttendanceService.approvePhotoCheckin()
   â†“
3. éªŒè¯ï¼š
   - è®°å½•å­˜åœ¨
   - çŠ¶æ€ä¸º pending_approval
   - æ˜¯ç…§ç‰‡ç­¾åˆ°
   â†“
4. æ›´æ–°æ•°æ®åº“ï¼š
   UPDATE icalink_attendance_records
   SET status = 'present',
       remark = 'ç…§ç‰‡ç­¾åˆ°å®¡æ‰¹é€šè¿‡',
       updated_by = teacherId,
       manual_override_by = teacherId,
       manual_override_time = NOW()
   WHERE id = attendanceRecordId
   â†“
5. è¿”å›æˆåŠŸå“åº”
   â†“
6. å‰ç«¯æ›´æ–°ï¼š
   - å­¦ç”ŸçŠ¶æ€å˜ä¸º"å·²ç­¾åˆ°"
   - ä»å¾…å®¡æ‰¹åˆ—è¡¨ç§»é™¤
```

---

## âœ… é¢„æœŸæ•ˆæœ

### 1. æ•™å¸ˆè§†å›¾æ•°æ®å®Œæ•´æ€§
- âœ… æ˜¾ç¤ºæ‰€æœ‰æ•™å­¦ç­å­¦ç”Ÿï¼ˆåŒ…æ‹¬æœªç­¾åˆ°çš„å­¦ç”Ÿï¼‰
- âœ… å¾…å®¡æ‰¹çš„ç…§ç‰‡ç­¾åˆ°æ’åœ¨åˆ—è¡¨æœ€å‰é¢
- âœ… æ˜¾ç¤ºå­¦ç”Ÿä¸Šä¼ çš„ç…§ç‰‡ï¼ˆ`metadata.photo_url`ï¼‰
- âœ… æ˜¾ç¤ºä½ç½®åç§»è·ç¦»ï¼ˆ`metadata.location_offset_distance`ï¼‰

### 2. å®¡æ‰¹åŠŸèƒ½
- âœ… æ•™å¸ˆç‚¹å‡»"æ‰¹å‡†"æŒ‰é’®
- âœ… åç«¯éªŒè¯è®°å½•çŠ¶æ€å’Œç…§ç‰‡å­˜åœ¨æ€§
- âœ… æ›´æ–°çŠ¶æ€ä¸º `present`
- âœ… è®°å½•å®¡æ‰¹äººå’Œå®¡æ‰¹æ—¶é—´
- âœ… å‰ç«¯ç«‹å³æ›´æ–°å­¦ç”ŸçŠ¶æ€

### 3. æ•°æ®ä¸€è‡´æ€§
- âœ… `v_attendance_today_details` è§†å›¾åæ˜ æœ€æ–°çŠ¶æ€
- âœ… ç»Ÿè®¡æ•°æ®ä¸å­¦ç”Ÿåˆ—è¡¨ä¿æŒä¸€è‡´
- âœ… æ’åºè§„åˆ™ç¬¦åˆä¸šåŠ¡ä¼˜å…ˆçº§

---

## ğŸ§ª æµ‹è¯•éªŒè¯

### æµ‹è¯•åœºæ™¯ 1: æ•™å¸ˆæŸ¥çœ‹å­¦ç”Ÿåˆ—è¡¨

**æ“ä½œæ­¥éª¤**ï¼š
1. æ•™å¸ˆç™»å½•ç³»ç»Ÿ
2. è¿›å…¥å½“å¤©è¯¾ç¨‹çš„è€ƒå‹¤ç®¡ç†é¡µé¢
3. æŸ¥çœ‹å­¦ç”Ÿç­¾åˆ°åˆ—è¡¨

**é¢„æœŸç»“æœ**ï¼š
- âœ… æ˜¾ç¤ºæ‰€æœ‰æ•™å­¦ç­å­¦ç”Ÿ
- âœ… å¾…å®¡æ‰¹çš„ç…§ç‰‡ç­¾åˆ°æ’åœ¨æœ€å‰é¢
- âœ… æ¯ä¸ªå¾…å®¡æ‰¹å­¦ç”Ÿæ˜¾ç¤ºï¼š
  - ç…§ç‰‡ç¼©ç•¥å›¾
  - ä½ç½®åç§»è·ç¦»
  - "æ‰¹å‡†"æŒ‰é’®

### æµ‹è¯•åœºæ™¯ 2: æ•™å¸ˆå®¡æ‰¹ç…§ç‰‡ç­¾åˆ°

**æ“ä½œæ­¥éª¤**ï¼š
1. æ•™å¸ˆç‚¹å‡»æŸä¸ªå¾…å®¡æ‰¹å­¦ç”Ÿçš„"æ‰¹å‡†"æŒ‰é’®
2. ç³»ç»Ÿå¤„ç†å®¡æ‰¹è¯·æ±‚

**é¢„æœŸç»“æœ**ï¼š
- âœ… åç«¯éªŒè¯é€šè¿‡
- âœ… æ•°æ®åº“çŠ¶æ€æ›´æ–°ä¸º `present`
- âœ… å‰ç«¯æ˜¾ç¤º"å®¡æ‰¹æˆåŠŸ"æç¤º
- âœ… å­¦ç”ŸçŠ¶æ€ç«‹å³å˜ä¸º"å·²ç­¾åˆ°"
- âœ… å­¦ç”Ÿä»å¾…å®¡æ‰¹åˆ—è¡¨ç§»é™¤

### æµ‹è¯•åœºæ™¯ 3: æ•°æ®åº“éªŒè¯

**SQL æŸ¥è¯¢**ï¼š
```sql
-- æŸ¥è¯¢å®¡æ‰¹åçš„ç­¾åˆ°è®°å½•
SELECT 
  id,
  student_id,
  status,
  metadata,
  updated_by,
  manual_override_by,
  manual_override_time,
  manual_override_reason
FROM icalink_attendance_records
WHERE id = <attendance_record_id>;
```

**é¢„æœŸç»“æœ**ï¼š
- âœ… `status = 'present'`
- âœ… `updated_by` ä¸ºæ•™å¸ˆ ID
- âœ… `manual_override_by` ä¸ºæ•™å¸ˆ ID
- âœ… `manual_override_time` ä¸ºå®¡æ‰¹æ—¶é—´
- âœ… `manual_override_reason = 'ç…§ç‰‡ç­¾åˆ°å®¡æ‰¹é€šè¿‡'`

---

## ğŸ“ åç»­å·¥ä½œ

### 1. Controller å±‚å®ç°ï¼ˆå¾…å®Œæˆï¼‰
- æ·»åŠ å®¡æ‰¹æ¥å£ï¼š`POST /api/attendance/records/:id/approve`
- è°ƒç”¨ `AttendanceService.approvePhotoCheckin()`
- è¿”å›æ ‡å‡† HTTP å“åº”

### 2. å‰ç«¯å®ç°ï¼ˆå¾…å®Œæˆï¼‰
- æ•™å¸ˆç•Œé¢æ˜¾ç¤ºå¾…å®¡æ‰¹ç…§ç‰‡ç­¾åˆ°åˆ—è¡¨
- æ˜¾ç¤ºç…§ç‰‡ç¼©ç•¥å›¾å’Œä½ç½®åç§»è·ç¦»
- æ·»åŠ "æ‰¹å‡†"æŒ‰é’®
- è°ƒç”¨å®¡æ‰¹æ¥å£
- æ›´æ–°æœ¬åœ°çŠ¶æ€

### 3. æƒé™æ§åˆ¶ï¼ˆå¯é€‰ï¼‰
- éªŒè¯æ•™å¸ˆæ˜¯å¦æœ‰æƒé™å®¡æ‰¹è¯¥è¯¾ç¨‹çš„ç­¾åˆ°
- æ·»åŠ å®¡æ‰¹æ“ä½œæ—¥å¿—

---

## ğŸ‰ æ€»ç»“

æœ¬æ¬¡ä¿®æ”¹å®Œæˆäº†ç…§ç‰‡ç­¾åˆ°å®¡æ‰¹åŠŸèƒ½çš„æ ¸å¿ƒé€»è¾‘ï¼š

1. âœ… **Repository å±‚**ï¼šä¼˜åŒ–æ•°æ®è·å–é€»è¾‘ï¼Œä½¿ç”¨ `v_attendance_today_details` + `icalink_attendance_records` è·å–å®Œæ•´æ•°æ®
2. âœ… **API ç±»å‹**ï¼šæ‰©å±• `StudentAttendanceDetail` æ¥å£ï¼Œæ·»åŠ  `metadata` å­—æ®µ
3. âœ… **Service å±‚**ï¼šå®ç° `approvePhotoCheckin` æ–¹æ³•ï¼ŒåŒ…å«å®Œæ•´çš„éªŒè¯å’Œæ›´æ–°é€»è¾‘
4. âœ… **æ’åºè§„åˆ™**ï¼šå¾…å®¡æ‰¹çš„ç…§ç‰‡ç­¾åˆ°æ’åœ¨åˆ—è¡¨æœ€å‰é¢

ä»£ç å·²å‡†å¤‡å°±ç»ªï¼Œå¯ä»¥è¿›è¡Œ Controller å±‚å’Œå‰ç«¯çš„å¼€å‘ï¼ğŸš€

