# 课程日历功能验证清单

## 📋 验证步骤

### 第一步：启动服务

#### 1. 启动后端服务
```bash
cd apps/app-icalink
pnpm run dev
```

**验证点**：
- [ ] 后端服务成功启动在 `http://localhost:8090`
- [ ] 控制台显示 `✅ CourseCalendarService initialized`
- [ ] 控制台显示 `✅ CalendarMappingRepository initialized`
- [ ] 没有错误日志

#### 2. 启动前端服务
```bash
cd apps/agendaedu-web
pnpm run dev
```

**验证点**：
- [ ] 前端服务成功启动在 `http://localhost:5173`
- [ ] 没有编译错误
- [ ] 浏览器控制台没有错误

---

### 第二步：后端API验证

#### 1. 测试树形结构接口

**请求**：
```bash
curl -X GET http://localhost:8090/api/icalink/v1/course-calendar/tree \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json"
```

**验证点**：
- [ ] HTTP状态码为 200
- [ ] 响应包含 `success: true`
- [ ] `data.type` 为 `'root'`
- [ ] `data.label` 为 `'吉林财经大学课表'`
- [ ] `data.children` 是数组
- [ ] 每个子节点的 `type` 为 `'calendar'`
- [ ] 每个子节点包含 `calendarId`、`kkh`、`xnxq` 字段
- [ ] **子节点不包含 `children` 字段或为空数组**
- [ ] **没有 `type: 'course'` 的节点**

**示例响应**：
```json
{
  "success": true,
  "data": {
    "id": "root",
    "label": "吉林财经大学课表",
    "type": "root",
    "children": [
      {
        "id": "calendar-1",
        "label": "2024-2025学年第一学期-高等数学",
        "type": "calendar",
        "calendarId": "cal_xxx",
        "kkh": "CS101",
        "xnxq": "2024-2025-1",
        "metadata": { ... }
      }
    ]
  }
}
```

#### 2. 测试日历参与者接口

**请求**：
```bash
curl -X GET http://localhost:8090/api/icalink/v1/course-calendar/{calendar_id}/participants \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json"
```

**验证点**：
- [ ] HTTP状态码为 200
- [ ] 响应包含 `success: true`
- [ ] `data` 是数组
- [ ] 每个参与者包含 `id`、`calendarId`、`userId`、`role` 字段
- [ ] `role` 值为 `'owner'`、`'writer'`、`'reader'` 或 `'free_busy_reader'` 之一

**示例响应**：
```json
{
  "success": true,
  "data": [
    {
      "id": "perm_xxx",
      "calendarId": "cal_xxx",
      "userId": "user_123",
      "role": "owner"
    }
  ]
}
```

#### 3. 测试课程详情接口

**请求**：
```bash
curl -X GET http://localhost:8090/api/icalink/v1/course-calendar/{calendar_id}/courses \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -H "Content-Type: application/json"
```

**验证点**：
- [ ] HTTP状态码为 200
- [ ] 响应包含 `success: true`
- [ ] `data` 是数组
- [ ] 每个课程包含完整字段（id、courseName、teachingWeek等）
- [ ] 课程按 `teachingWeek`、`weekDay`、`startTime` 排序

**示例响应**：
```json
{
  "success": true,
  "data": [
    {
      "id": 1,
      "courseName": "高等数学",
      "teachingWeek": 1,
      "weekDay": 1,
      "teacherNames": "张三",
      "classLocation": "教学楼A-101",
      "startTime": "2024-09-01T08:00:00Z",
      "endTime": "2024-09-01T09:40:00Z",
      "attendanceEnabled": true,
      ...
    }
  ]
}
```

---

### 第三步：前端界面验证

#### 1. 访问课程表页面

**操作**：
1. 打开浏览器访问 `http://localhost:5173/web/course-calendar`
2. 登录系统（如需要）

**验证点**：
- [ ] 页面成功加载
- [ ] 左侧显示树形结构
- [ ] 右侧显示详情面板
- [ ] 没有JavaScript错误

#### 2. 验证树形结构

**操作**：
1. 查看左侧树形结构

**验证点**：
- [ ] 根节点显示"吉林财经大学课表"
- [ ] 根节点有展开/收起箭头图标
- [ ] 根节点默认展开状态
- [ ] 展开后显示日历列表
- [ ] 每个日历节点显示蓝色日历图标
- [ ] 日历节点显示日历名称
- [ ] **日历节点没有展开/收起箭头**
- [ ] **日历节点没有子节点**
- [ ] **没有课程节点显示**

#### 3. 验证根节点交互

**操作**：
1. 点击根节点的箭头图标

**验证点**：
- [ ] 日历列表展开/收起
- [ ] 箭头图标在向下和向右之间切换
- [ ] 右侧详情面板不变化

#### 4. 验证日历节点交互

**操作**：
1. 点击任意日历节点

**验证点**：
- [ ] 日历节点高亮显示（背景色变化）
- [ ] 右侧Tab页自动切换到"日历参与者"
- [ ] Tab 1开始加载数据（显示骨架屏）
- [ ] Tab 2开始加载数据（显示骨架屏）
- [ ] 加载完成后显示实际数据

#### 5. 验证Tab 1：日历参与者

**操作**：
1. 选中一个日历节点
2. 查看右侧Tab 1

**验证点**：
- [ ] Tab标题显示"日历参与者"
- [ ] 显示表格结构
- [ ] 表头包含：用户ID、权限角色、权限ID
- [ ] 每行显示一个参与者
- [ ] 权限角色显示为彩色标签
  - [ ] 所有者：红色标签
  - [ ] 编辑者：蓝色标签
  - [ ] 查看者：绿色标签
  - [ ] 忙闲查看：灰色标签
- [ ] 如果没有数据，显示"暂无参与者数据"

#### 6. 验证Tab 2：课节详情

**操作**：
1. 选中一个日历节点
2. 切换到Tab 2

**验证点**：
- [ ] Tab标题显示"课节详情"
- [ ] 显示表格结构
- [ ] 表头包含：课程名称、教学周、周次、教师、上课地点、时间、签到状态
- [ ] 每行显示一个课程
- [ ] 教学周显示格式：第X周
- [ ] 周次显示格式：周X
- [ ] 时间显示格式：HH:MM - HH:MM
- [ ] 签到状态显示：
  - [ ] 已启用：绿色文字
  - [ ] 未启用：灰色文字
- [ ] 如果没有数据，显示"暂无课程数据"

#### 7. 验证加载状态

**操作**：
1. 点击不同的日历节点
2. 观察加载过程

**验证点**：
- [ ] 切换日历时显示加载骨架屏
- [ ] 骨架屏样式正确（灰色矩形）
- [ ] 加载完成后骨架屏消失
- [ ] 数据平滑过渡显示

#### 8. 验证空数据状态

**操作**：
1. 选择一个没有参与者或课程的日历

**验证点**：
- [ ] Tab 1显示"暂无参与者数据"
- [ ] Tab 2显示"暂无课程数据"
- [ ] 提示文字居中显示
- [ ] 提示文字颜色为灰色

---

### 第四步：数据一致性验证

#### 1. 验证数据库数据

**SQL查询**：
```sql
-- 检查日历映射数据
SELECT id, kkh, xnxq, calendar_id, calendar_name, is_deleted
FROM icasync_calendar_mapping
WHERE is_deleted = 0
ORDER BY created_at DESC;

-- 检查课程数据
SELECT id, course_code, course_name, semester, teaching_week, week_day
FROM icasync_attendance_courses
WHERE deleted_at IS NULL
ORDER BY semester DESC, teaching_week ASC, week_day ASC
LIMIT 10;
```

**验证点**：
- [ ] 数据库中有未删除的日历映射记录
- [ ] 日历映射的 `kkh` 和 `xnxq` 字段有值
- [ ] 课程表中有对应的课程记录
- [ ] 课程的 `course_code` 和 `semester` 与日历映射匹配

#### 2. 验证WPS API

**操作**：
1. 检查WPS V7配置
2. 查看后端日志

**验证点**：
- [ ] `stratix.config.ts` 中配置了正确的 appId 和 appSecret
- [ ] WPS API调用成功（后端日志无错误）
- [ ] 返回的权限列表格式正确

---

### 第五步：错误处理验证

#### 1. 测试不存在的日历ID

**请求**：
```bash
curl -X GET http://localhost:8090/api/icalink/v1/course-calendar/invalid_id/participants \
  -H "Authorization: Bearer YOUR_TOKEN"
```

**验证点**：
- [ ] HTTP状态码为 200（业务错误）
- [ ] 响应包含 `success: false`
- [ ] 响应包含 `code: 'RESOURCE_NOT_FOUND'`
- [ ] 响应包含 `message: '日历不存在'`

#### 2. 测试未授权访问

**请求**：
```bash
curl -X GET http://localhost:8090/api/icalink/v1/course-calendar/tree
# 不带 Authorization header
```

**验证点**：
- [ ] HTTP状态码为 401
- [ ] 返回未授权错误

#### 3. 测试前端错误处理

**操作**：
1. 断开网络连接
2. 点击日历节点

**验证点**：
- [ ] 显示错误提示
- [ ] 不会导致页面崩溃
- [ ] 可以重试操作

---

### 第六步：性能验证

#### 1. 测试初始加载性能

**操作**：
1. 打开浏览器开发者工具 → Network标签
2. 刷新课程表页面
3. 查看网络请求

**验证点**：
- [ ] 只发起1个树形结构API请求
- [ ] **不发起课程详情API请求**（未选择日历时）
- [ ] 树形结构API响应时间 < 1秒
- [ ] 页面首次渲染时间 < 2秒

#### 2. 测试懒加载性能

**操作**：
1. 点击第一个日历节点
2. 查看Network标签

**验证点**：
- [ ] 发起2个API请求（参与者 + 课程详情）
- [ ] 两个请求并行发起
- [ ] 响应时间都 < 1秒

#### 3. 测试缓存机制

**操作**：
1. 点击日历A
2. 点击日历B
3. 再次点击日历A

**验证点**：
- [ ] 第三次点击时使用缓存数据
- [ ] 不发起新的API请求
- [ ] 数据立即显示

---

## ✅ 验证结果汇总

### 后端验证
- [ ] 树形结构API正确返回两级结构
- [ ] 日历参与者API正常工作
- [ ] 课程详情API正常工作
- [ ] 错误处理正确

### 前端验证
- [ ] 树形结构只显示两级
- [ ] 日历节点点击交互正确
- [ ] Tab页数据加载正常
- [ ] 加载状态显示正确
- [ ] 空数据提示正确
- [ ] 错误处理正确

### 性能验证
- [ ] 初始加载快速
- [ ] 懒加载工作正常
- [ ] 缓存机制有效

### 数据一致性
- [ ] 前后端数据结构匹配
- [ ] 数据库查询正确
- [ ] WPS API集成正常

---

## 🐛 常见问题排查

### 问题1：树形结构为空

**可能原因**：
- 数据库中没有未删除的日历映射

**排查步骤**：
```sql
SELECT COUNT(*) FROM icasync_calendar_mapping WHERE is_deleted = 0;
```

**解决方案**：
- 插入测试数据或检查 `is_deleted` 字段

### 问题2：参与者列表为空

**可能原因**：
- WPS API配置错误
- Access Token过期
- 日历没有设置参与者

**排查步骤**：
1. 检查后端日志中的WPS API调用
2. 验证 `stratix.config.ts` 配置
3. 在WPS日历中添加参与者

### 问题3：课程详情为空

**可能原因**：
- 数据库中没有对应的课程数据
- `course_code` 或 `semester` 不匹配

**排查步骤**：
```sql
SELECT * FROM icasync_attendance_courses
WHERE course_code = '对应的kkh'
  AND semester = '对应的xnxq'
  AND deleted_at IS NULL;
```

### 问题4：前端显示错误

**可能原因**：
- API返回格式不匹配
- 类型定义错误

**排查步骤**：
1. 打开浏览器控制台查看错误
2. 检查Network标签中的API响应
3. 对比前后端类型定义

---

## 📝 验证完成确认

完成所有验证后，请在此签名确认：

- **验证人**：__________________
- **验证日期**：__________________
- **验证结果**：[ ] 通过  [ ] 未通过
- **备注**：__________________

---

**祝验证顺利！** ✨

