# Stratixæ¡†æ¶æ¶æ„é‡æ„è®¾è®¡æ–‡æ¡£

## ğŸ¯ è®¾è®¡ç›®æ ‡

åŸºäºFastify 5å’ŒAwilix 12ï¼Œè®¾è®¡ä¸€ä¸ªç°ä»£åŒ–ã€å‡½æ•°å¼ã€é«˜æ€§èƒ½çš„Node.jsåº”ç”¨æ¡†æ¶ï¼Œå®ç°ï¼š
- **é›¶é…ç½®å¯åŠ¨**: `StratixApp.run()`ä¸€è¡Œä»£ç å¯åŠ¨åº”ç”¨
- **æ’ä»¶åŒ–æ¶æ„**: æ¯ä¸ªæ’ä»¶ä½œä¸ºç‹¬ç«‹npmåŒ…å‘å¸ƒ
- **æ˜¾å¼é…ç½®**: åœ¨`stratix.config.ts`ä¸­æ˜¾å¼åŠ è½½å’Œé…ç½®æ’ä»¶
- **å‡½æ•°å¼ç¼–ç¨‹**: å®Œå…¨é‡‡ç”¨å‡½æ•°å¼ç¼–ç¨‹èŒƒå¼
- **ç±»å‹å®‰å…¨**: ç«¯åˆ°ç«¯TypeScriptç±»å‹å®‰å…¨
- **å¼€å‘ä½“éªŒ**: æç®€é…ç½®ï¼Œå¼ºå¤§åŠŸèƒ½

## ğŸ—ï¸ æ’ä»¶åŒ–æ¶æ„è®¾è®¡

### æ¶æ„åˆ†å±‚

```mermaid
graph TB
    A[Application Layer] --> B[Plugin Layer]
    B --> C[Core Layer]
    C --> D[Utils Layer]
    
    subgraph "Application Layer"
        A1[StratixApp]
        A2[stratix.config.ts]
        A3[é¡¹ç›®ç‰¹å®šæ’ä»¶]
    end
    
    subgraph "Plugin Layer - ç‹¬ç«‹npmåŒ…"
        B1[@stratix/database]
        B2[@stratix/web]
        B3[@stratix/queue]
        B4[@stratix/was-v7]
        B5[é¡¹ç›®è‡ªå®šä¹‰æ’ä»¶]
    end
    
    subgraph "Core Layer"
        C1[@stratix/core]
        C2[Fastify Wrapper]
        C3[DI Container]
        C4[Plugin Registry]
    end
    
    subgraph "Utils Layer"
        D1[@stratix/utils]
        D2[å‡½æ•°å¼å·¥å…·]
        D3[ç±»å‹ç³»ç»Ÿ]
        D4[é”™è¯¯å¤„ç†]
    end
```

### ç‹¬ç«‹npmåŒ…æ¶æ„

```typescript
// æ¯ä¸ªæ’ä»¶éƒ½æ˜¯ç‹¬ç«‹çš„npmåŒ…
@stratix/core                # æ ¸å¿ƒæ¡†æ¶
@stratix/utils               # å‡½æ•°å¼å·¥å…·åº“
@stratix/database            # æ•°æ®åº“æ’ä»¶åŒ…
@stratix/web                 # WebåŠŸèƒ½æ’ä»¶åŒ…
@stratix/queue               # é˜Ÿåˆ—æ’ä»¶åŒ…  
@stratix/was-v7              # WAS V7é›†æˆæ’ä»¶åŒ…
@stratix/tasks               # ä»»åŠ¡ç³»ç»Ÿæ’ä»¶åŒ…

// é¡¹ç›®çº§åˆ«
my-stratix-app/
â”œâ”€â”€ package.json             # å£°æ˜æ’ä»¶ä¾èµ–
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ stratix.config.ts    # æ˜¾å¼é…ç½®æ’ä»¶
â”‚   â””â”€â”€ plugin/
â”‚       â””â”€â”€ api/             # é¡¹ç›®ç‰¹å®šæ’ä»¶
â””â”€â”€ ...
```

## ğŸ”§ æ ¸å¿ƒè®¾è®¡

### 1. StratixApp æ ¸å¿ƒå…¥å£

```typescript
// @stratix/core/src/app.ts
export interface StratixConfig {
  readonly name?: string
  readonly version?: string
  readonly description?: string
  readonly logger?: LoggingConfig
  readonly server?: ServerConfig
  readonly registers: PluginRegistration[]  // æ˜¾å¼æ’ä»¶æ³¨å†Œ
}

export interface PluginRegistration {
  readonly 0: PluginFactory           // æ’ä»¶å·¥å‚å‡½æ•°
  readonly 1: PluginConfig            // æ’ä»¶é…ç½®
}

// ä¸€è¡Œä»£ç å¯åŠ¨
export const StratixApp = {
  run: async (options?: { config?: string }): Promise<void> => {
    const configPath = options?.config || './stratix.config.js'
    const config = await loadConfig(configPath)
    const app = await createApp(config)
    await startServer(app)
  }
}
```

### 2. æ˜¾å¼æ’ä»¶é…ç½®ç³»ç»Ÿ

```typescript
// é¡¹ç›®çš„ stratix.config.ts
import { type StratixConfig } from '@stratix/core'
import databasePlugin from '@stratix/database'
import webPlugin from '@stratix/web'
import queuePlugin from '@stratix/queue'
import wasV7Plugin from '@stratix/was-v7'
import apiPlugin from './src/plugin/api/index.js'

export default (sensitiveInfo: any): StratixConfig => {
  return {
    name: 'my-stratix-app',
    version: '1.0.0',
    description: 'Stratixåº”ç”¨ç¤ºä¾‹',
    
    logger: {
      level: 'info'
    },
    
    server: {
      bodyLimit: 20 * 1024 * 1024
    },
    
    // æ˜¾å¼æ³¨å†Œæ’ä»¶ - å¼€å‘è€…å®Œå…¨æ§åˆ¶
    registers: [
      // Webæ’ä»¶ - åŸºç¡€HTTPæœåŠ¡
      [webPlugin, {
        port: 8090,
        projectRootDir: process.cwd(),
        formbody: { bodyLimit: 20 * 1024 * 1024 }
      }],
      
      // æ•°æ®åº“æ’ä»¶ - å¯é€‰ï¼Œéœ€è¦æ—¶æ·»åŠ 
      [databasePlugin, {
        databases: {
          default: {
            connection: {
              client: 'mysql',
              host: sensitiveInfo.databases.default.host,
              port: sensitiveInfo.databases.default.port,
              user: sensitiveInfo.databases.default.user,
              password: sensitiveInfo.databases.default.password,
              database: sensitiveInfo.databases.default.database
            }
          }
        }
      }],
      
      // WAS V7æ’ä»¶ - å¯é€‰ï¼Œéœ€è¦æ—¶æ·»åŠ 
      [wasV7Plugin, {
        appId: sensitiveInfo.wasV7.appId,
        appSecret: sensitiveInfo.wasV7.appSecret
      }],
      
      // é˜Ÿåˆ—æ’ä»¶ - å¯é€‰ï¼Œéœ€è¦æ—¶æ·»åŠ   
      [queuePlugin, {
        redis: {
          host: sensitiveInfo.redis.host,
          port: sensitiveInfo.redis.port
        }
      }],
      
      // é¡¹ç›®ç‰¹å®šæ’ä»¶
      [apiPlugin, sensitiveInfo.icalink_api]
    ]
  }
}
```

### 3. æ¸è¿›å¼é…ç½®ä½“éªŒ

```typescript
// é›¶é…ç½®å¯åŠ¨ - æœ€ç®€å•çš„æ–¹å¼
export const createZeroConfig = (): StratixConfig => ({
  name: process.env.APP_NAME || 'stratix-app',
  logger: { level: 'info' },
  registers: [
    // åªæ³¨å†ŒåŸºç¡€Webæ’ä»¶
    [webPlugin, { 
      port: parseInt(process.env.PORT || '8090')
    }]
  ]
})

// æ¸è¿›å¼æ·»åŠ æ’ä»¶
export const createCustomConfig = (options: ConfigOptions): StratixConfig => {
  const baseConfig = createZeroConfig()
  
  // éœ€è¦æ•°æ®åº“æ—¶æ·»åŠ 
  if (options.database) {
    baseConfig.registers.push([databasePlugin, options.database])
  }
  
  // éœ€è¦é˜Ÿåˆ—æ—¶æ·»åŠ 
  if (options.queue) {
    baseConfig.registers.push([queuePlugin, options.queue])
  }
  
  return baseConfig
}
```

## ğŸ”Œ æ’ä»¶å¼€å‘è§„èŒƒ

### 1. æ’ä»¶åŒ…ç»“æ„

```typescript
// @stratix/database/package.json
{
  "name": "@stratix/database",
  "version": "1.0.0",
  "main": "dist/index.js",
  "types": "dist/index.d.ts",
  "peerDependencies": {
    "@stratix/core": "^1.0.0"
  }
}

// @stratix/database/src/index.ts
export interface DatabaseConfig {
  readonly databases: Record<string, DatabaseConnection>
}

export interface DatabaseConnection {
  readonly connection: {
    readonly client: string
    readonly host: string
    readonly port: number
    readonly user: string
    readonly password: string
    readonly database: string
    readonly pool?: PoolConfig
  }
}

// æ’ä»¶å·¥å‚å‡½æ•°
export default (config: DatabaseConfig): StratixPlugin => ({
  name: 'database',
  version: '1.0.0',
  
  register: async (app: StratixApp) => {
    // æ³¨å†Œæ•°æ®åº“æœåŠ¡åˆ°DIå®¹å™¨
    const databases = await createDatabases(config)
    
    app.container.register({
      database: asValue(databases.default),
      originDatabase: asValue(databases.origin),
      queryBuilder: asFunction(createQueryBuilder),
      migrator: asFunction(createMigrator)
    })
    
    console.log('âœ… Database plugin registered')
  }
})
```

### 2. å‡½æ•°å¼æ’ä»¶å¼€å‘

```typescript
// @stratix/web/src/index.ts  
import { pipe, curry, chain, fold } from '@stratix/utils'

export interface WebConfig {
  readonly port: number
  readonly host?: string
  readonly projectRootDir: string
  readonly cors?: CorsConfig
  readonly formbody?: FormbodyConfig
}

// å‡½æ•°å¼æ’ä»¶å·¥å‚
export const createWebPlugin = curry((config: WebConfig) => ({
  name: 'web',
  version: '1.0.0',
  
  register: pipe(
    validateConfig,
    chain(setupFastify),
    chain(registerMiddleware),
    chain(setupRoutes),
    fold(
      (error) => Promise.reject(error),
      (server) => Promise.resolve(server)
    )
  )
}))

// å‡½æ•°å¼ä¸­é—´ä»¶æ³¨å†Œ
const registerMiddleware = curry((config: WebConfig, app: FastifyInstance) =>
  pipe(
    [corsMiddleware, formbodyMiddleware, staticMiddleware],
    map(middleware => middleware(config)),
    reduce(registerSingle(app), Promise.resolve(app))
  )
)

export default createWebPlugin
```

### 3. ç±»å‹å®‰å…¨çš„æ’ä»¶ç³»ç»Ÿ

```typescript
// @stratix/core/src/plugin.ts
export interface StratixPlugin {
  readonly name: string
  readonly version: string
  readonly dependencies?: string[]
  readonly register: (app: StratixApp) => Promise<void>
}

export type PluginFactory<T = any> = (config: T) => StratixPlugin

// ç±»å‹å®‰å…¨çš„æ’ä»¶æ³¨å†Œ
export const registerPlugin = <T>(
  plugin: PluginFactory<T>,
  config: T
) => (app: StratixApp): Promise<StratixApp> =>
  plugin(config)
    .register(app)
    .then(() => app)

// å‡½æ•°å¼æ’ä»¶åŠ è½½ç®¡é“
export const loadPlugins = (registrations: PluginRegistration[]) =>
  pipe(
    registrations,
    map(([factory, config]) => registerPlugin(factory, config)),
    sequence(Promise),
    chain(validateDependencies),
    chain(sortByDependencies)
  )
```

## ğŸ“¦ åŒ…ä¾èµ–ç®¡ç†

### 1. é¡¹ç›®package.jsoné…ç½®

```json
{
  "name": "my-stratix-app",
  "dependencies": {
    "@stratix/core": "^1.0.0",
    "@stratix/web": "^1.0.0",
    "@stratix/database": "^1.0.0",
    "@stratix/queue": "^1.0.0",
    "@stratix/was-v7": "^1.0.0"
  },
  "scripts": {
    "dev": "stratix dev",
    "start": "stratix start",
    "build": "stratix build"
  }
}
```

### 2. æŒ‰éœ€å®‰è£…æ’ä»¶

```bash
# åŸºç¡€å®‰è£… - åªå®‰è£…æ ¸å¿ƒ
npm install @stratix/core @stratix/web

# éœ€è¦æ•°æ®åº“åŠŸèƒ½æ—¶
npm install @stratix/database

# éœ€è¦é˜Ÿåˆ—åŠŸèƒ½æ—¶  
npm install @stratix/queue

# éœ€è¦WASé›†æˆæ—¶
npm install @stratix/was-v7
```

## ğŸ¨ å‡½æ•°å¼ç¼–ç¨‹èŒƒå¼

### 1. é”™è¯¯å¤„ç†æ¨¡å¼

```typescript
// @stratix/utils/src/either.ts
export type Either<E, A> = Left<E> | Right<A>

export interface Left<E> {
  readonly _tag: 'Left'
  readonly left: E
}

export interface Right<A> {
  readonly _tag: 'Right' 
  readonly right: A
}

// å‡½æ•°å¼é”™è¯¯å¤„ç†
export const handleRequest = (request: FastifyRequest) =>
  pipe(
    parseRequest(request),
    chain(validateInput),
    chain(processBusinessLogic),
    chain(formatResponse),
    fold(
      (error) => createErrorResponse(error),
      (result) => createSuccessResponse(result)
    )
  )
```

### 2. ä¸å˜æ€§å’Œçº¯å‡½æ•°

```typescript
// æ‰€æœ‰é…ç½®éƒ½æ˜¯åªè¯»çš„
export interface ReadonlyConfig {
  readonly name: string
  readonly version: string
  readonly plugins: readonly PluginRegistration[]
}

// çº¯å‡½æ•°æ•°æ®è½¬æ¢
export const transformConfig = (config: RawConfig): ReadonlyConfig => ({
  ...config,
  plugins: Object.freeze(config.plugins.map(Object.freeze))
})

// å‡½æ•°å¼æ•°æ®æµ
export const configPipeline = pipe(
  loadConfigFile,
  parseConfig,
  validateConfig,
  transformConfig,
  applyDefaults
)
```

### 3. å‡½æ•°ç»„åˆå’Œç®¡é“

```typescript
// å‡½æ•°ç»„åˆæ„å»ºå¤æ‚é€»è¾‘
export const startupPipeline = pipe(
  loadConfiguration,
  chain(validateConfiguration),
  chain(createApplication),
  chain(loadPlugins),
  chain(registerRoutes),
  chain(startServer),
  fold(
    (error) => {
      console.error('âŒ Startup failed:', error)
      process.exit(1)
    },
    (app) => {
      console.log('ğŸš€ Application started successfully')
      return app
    }
  )
)
```

## ğŸš€ é›¶é…ç½®åˆ°å®Œæ•´é…ç½®çš„æ¼”è¿›

### é˜¶æ®µ1: é›¶é…ç½®å¿«é€Ÿå¯åŠ¨

```typescript
// æœ€ç®€å•çš„ä½¿ç”¨æ–¹å¼
import { StratixApp } from '@stratix/core'

await StratixApp.run() // ä½¿ç”¨é»˜è®¤é…ç½®
```

### é˜¶æ®µ2: åŸºç¡€é…ç½®

```typescript
// stratix.config.ts
import { createZeroConfig } from '@stratix/core'

export default createZeroConfig()
```

### é˜¶æ®µ3: æ·»åŠ æ•°æ®åº“

```typescript
// stratix.config.ts  
import databasePlugin from '@stratix/database'
import { createCustomConfig } from '@stratix/core'

export default createCustomConfig({
  plugins: [
    [databasePlugin, { /* æ•°æ®åº“é…ç½® */ }]
  ]
})
```

### é˜¶æ®µ4: å®Œæ•´ä¼ä¸šçº§é…ç½®

```typescript
// stratix.config.ts
import databasePlugin from '@stratix/database'
import webPlugin from '@stratix/web'
import queuePlugin from '@stratix/queue'
import wasV7Plugin from '@stratix/was-v7'

export default (sensitiveInfo: any): StratixConfig => ({
  name: 'enterprise-app',
  version: '1.0.0',
  
  logger: { level: 'info' },
  server: { bodyLimit: 50 * 1024 * 1024 },
  
  registers: [
    [webPlugin, { port: 8090 }],
    [databasePlugin, { databases: sensitiveInfo.databases }],
    [queuePlugin, { redis: sensitiveInfo.redis }],
    [wasV7Plugin, { appId: '...', appSecret: '...' }]
  ]
})
```

## ğŸ“‹ æœ€ä½³å®è·µ

### 1. æ’ä»¶å¼€å‘æŒ‡å—

```typescript
// âœ… æ¨èï¼šçº¯å‡½æ•°æ’ä»¶å·¥å‚
export const createMyPlugin = (config: MyConfig): StratixPlugin => ({
  name: 'my-plugin',
  version: '1.0.0',
  register: async (app) => {
    // æ’ä»¶é€»è¾‘
  }
})

// âŒ é¿å…ï¼šæœ‰å‰¯ä½œç”¨çš„æ’ä»¶
export const badPlugin = (config: MyConfig) => {
  // é¿å…åœ¨å·¥å‚å‡½æ•°ä¸­äº§ç”Ÿå‰¯ä½œç”¨
  setupGlobalState() // âŒ
  
  return {
    name: 'bad-plugin',
    register: async (app) => {
      // åœ¨registerä¸­å¤„ç†å‰¯ä½œç”¨ âœ…
      setupPluginState()
    }
  }
}
```

### 2. é…ç½®ç®¡ç†æŒ‡å—

```typescript
// âœ… æ¨èï¼šç¯å¢ƒç‰¹å®šé…ç½®
export const createProductionConfig = (secrets: Secrets): StratixConfig => ({
  logger: { level: 'warn' },
  server: { 
    bodyLimit: 10 * 1024 * 1024,
    trustProxy: true
  },
  registers: [
    [webPlugin, { port: 80, host: '0.0.0.0' }],
    [databasePlugin, { 
      databases: {
        default: {
          connection: { ...secrets.database, pool: { min: 5, max: 20 } }
        }
      }
    }]
  ]
})

// âœ… æ¨èï¼šå¼€å‘ç¯å¢ƒé…ç½®
export const createDevelopmentConfig = (): StratixConfig => ({
  logger: { level: 'debug' },
  server: { bodyLimit: 50 * 1024 * 1024 },
  registers: [
    [webPlugin, { port: 3000, host: 'localhost' }]
    // å¼€å‘ç¯å¢ƒå¯èƒ½ä¸éœ€è¦æ•°æ®åº“
  ]
})
```

### 3. ç±»å‹å®‰å…¨æŒ‡å—

```typescript
// âœ… æ¨èï¼šå¼ºç±»å‹æ’ä»¶é…ç½®
export interface DatabaseConfig {
  readonly databases: {
    readonly [key: string]: {
      readonly connection: {
        readonly client: 'mysql' | 'postgresql' | 'sqlite'
        readonly host: string
        readonly port: number
        readonly user: string
        readonly password: string
        readonly database: string
        readonly pool?: {
          readonly min: number
          readonly max: number
        }
      }
    }
  }
}

// âœ… æ¨èï¼šé…ç½®éªŒè¯
export const validateDatabaseConfig = (config: unknown): Either<ValidationError, DatabaseConfig> =>
  pipe(
    config,
    parseConfig(DatabaseConfigSchema),
    validateConnections,
    validatePoolSettings
  )
```

## ğŸ¯ æ¶æ„ä¼˜åŠ¿æ€»ç»“

### 1. **æ˜ç¡®çš„æ’ä»¶è¾¹ç•Œ**
- âœ… æ¯ä¸ªæ’ä»¶éƒ½æ˜¯ç‹¬ç«‹çš„npmåŒ…
- âœ… ç‰ˆæœ¬ç®¡ç†æ¸…æ™°ï¼Œå¯ç‹¬ç«‹æ›´æ–°
- âœ… æŒ‰éœ€å®‰è£…ï¼Œå‡å°‘ä¾èµ–ä½“ç§¯

### 2. **å¯æ§çš„é…ç½®ä½“éªŒ**  
- âœ… æ˜¾å¼é…ç½®ï¼Œå¼€å‘è€…å®Œå…¨æŒæ§
- âœ… é›¶é…ç½®åˆ°å®Œæ•´é…ç½®çš„å¹³æ»‘è¿‡æ¸¡
- âœ… ç±»å‹å®‰å…¨çš„é…ç½®éªŒè¯

### 3. **å‡½æ•°å¼ç¼–ç¨‹ä¼˜åŠ¿**
- âœ… ä¸å˜æ€§ç¡®ä¿é…ç½®å¯é æ€§
- âœ… çº¯å‡½æ•°ä¾¿äºæµ‹è¯•å’Œè°ƒè¯•
- âœ… ç®¡é“æ“ä½œæå‡ä»£ç å¯è¯»æ€§

### 4. **å¼€å‘ä½“éªŒä¼˜åŒ–**
- âœ… ä¸€è¡Œä»£ç å¯åŠ¨åº”ç”¨
- âœ… æ¸è¿›å¼åŠŸèƒ½æ·»åŠ 
- âœ… å®Œæ•´çš„TypeScriptæ”¯æŒ

è¿™ä¸ªé‡æ–°è®¾è®¡çš„æ¶æ„æ–‡æ¡£å®Œå…¨ç¬¦åˆæ‚¨çš„è¦æ±‚ï¼šç‹¬ç«‹npmåŒ…æ’ä»¶ã€æ˜¾å¼é…ç½®åŠ è½½ã€å‡½æ•°å¼ç¼–ç¨‹èŒƒå¼ï¼Œå¹¶ä¸”ä¸å®é™…å®ç°ä¿æŒä¸€è‡´ã€‚