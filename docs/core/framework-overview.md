# Stratix 框架架构概览

## 1. 框架设计理念

Stratix 是一个基于 Node.js 和 Fastify 构建的纯配置驱动的函数式框架，旨在提供简洁、透明和高度组合性的开发体验。框架遵循函数式编程原则，通过配置文件驱动应用程序的构建和运行，最大限度地减少样板代码，提高开发效率。

### 1.1 核心设计原则

- **配置驱动**：应用的所有功能和行为都通过配置文件定义，避免编写大量的样板代码
- **函数式编程**：遵循函数式编程范式，强调不可变性和组合性
- **插件化架构**：所有能力都通过插件方式扩展，保持框架的简洁性
- **依赖注入**：基于 Awilix 提供强大的依赖注入能力，支持Service层、Repository层的自动注入
- **零注解设计**：追求尽量简单，不支持注解模式，通过配置和约定实现功能
- **Fastify 生态兼容**：直接使用 Fastify 插件系统，无需重新开发插件体系

### 1.2 框架特性

- 🚀 **高性能**：基于 Fastify 构建，享受其高性能特性
- 📦 **插件化**：支持声明式和函数式两种插件加载方式
- 🔧 **依赖注入**：集成 Awilix 容器，提供完善的 DI 支持
- 📝 **配置驱动**：通过 `stratix.config.ts` 配置文件驱动应用构建
- 🔌 **生态兼容**：完全兼容 Fastify 生态系统
- ⚡ **一键启动**：使用 `StratixApp.run()` 一行代码启动应用

## 2. 框架核心架构

### 2.1 架构层次图

```
┌─────────────────────────────────────────────────────┐
│                  Stratix 应用层                      │
│              stratix.config.ts                     │
├─────────────────────────────────────────────────────┤
│                  Stratix Core                       │
│   ┌───────────────┐  ┌───────────────┐              │
│   │   插件管理器   │  │   依赖注入容器  │              │
│   │ PluginManager │  │ AwilixContainer│              │
│   └───────────────┘  └───────────────┘              │
├─────────────────────────────────────────────────────┤
│                 Fastify 框架                        │
│  ┌──────────────┐ ┌──────────────┐ ┌──────────────┐ │
│  │  路由系统     │ │   插件系统    │ │   中间件      │ │
│  │   Routing    │ │   Plugins    │ │  Middleware  │ │
│  └──────────────┘ └──────────────┘ └──────────────┘ │
├─────────────────────────────────────────────────────┤
│                   Node.js 运行时                     │
└─────────────────────────────────────────────────────┘
```

### 2.2 核心组件

#### 2.2.1 StratixApp (应用入口)
- **职责**：应用的主入口类，提供静态方法 `run()` 启动应用
- **功能**：
  - 加载和解析配置文件
  - 创建 StratixApplication 实例
  - 处理应用生命周期

#### 2.2.2 StratixApplication (应用核心)
- **职责**：应用的核心实现类，围绕 Fastify 实例构建
- **主要属性**：
  - `config`：完整的应用配置
  - `server`：Fastify 实例
  - `container`：Awilix DI 容器
  - `logger`：日志记录器
  - `context`：上下文存储
  - `pluginManager`：增强插件管理器
  - `serviceRegistrar`：服务注册器

#### 2.2.3 插件管理器 (PluginManager)
- **职责**：管理插件的注册、加载和生命周期
- **支持的插件类型**：
  - **函数式插件**：标准的 Fastify 插件函数
  - **声明式插件**：通过声明对象自动生成的插件

#### 2.2.4 依赖注入容器 (AwilixContainer)
- **职责**：管理应用中的所有依赖关系
- **支持的注入类型**：
  - Service 层对象
  - Repository 层对象
  - 各种 Hooks
  - 自定义组件

#### 2.2.5 服务注册器 (ServiceRegistrar)
- **职责**：简化服务和仓储的注册过程
- **功能**：
  - 自动命名和生命周期管理
  - 支持批量注册
  - 类型安全的服务解析

### 2.3 插件系统架构

```
┌─────────────────────────────────────────────────────┐
│                插件配置 (stratix.config.ts)          │
│  plugins: [                                        │
│    [webPlugin, 'global', {}],                     │
│    [adminPlugin, 'scoped', {}],                   │
│    [declarativePlugin, 'scoped', options]         │
│  ]                                                 │
└─────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────┐
│              Stratix 插件管理器                      │
│  ┌───────────────┐         ┌───────────────┐        │
│  │   函数式插件   │         │   声明式插件   │        │
│  │ FunctionPlugin│  ──────▶│DeclarativePlugin│       │
│  │              │         │               │        │
│  └───────────────┘         └───────────────┘        │
└─────────────────────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────┐
│                 Fastify 插件系统                     │
│              fastify.register()                    │
└─────────────────────────────────────────────────────┘
```

## 3. 配置系统

### 3.1 配置文件结构

```typescript
// stratix.config.ts
export default (sensitiveInfo: any) => ({
  // 应用基础信息
  app: {
    name: 'stratix-example-app',
    version: '1.0.0',
    description: 'Stratix框架示例应用'
  },
  
  // 日志配置
  logger: {
    appType: 'web'
  },
  
  // 插件配置 - 键值对方式
  '@stratix/web': [webPlugin, 'global', {}],
  adminPlugin: [adminPlugin, 'scoped', {}],
  apiPlugin: [apiPlugin, 'scoped', {}]
});
```

### 3.2 插件配置格式

每个插件配置遵循统一格式：`[plugin, scope, options]`

- **plugin**：插件函数或声明式对象
- **scope**：插件作用域 (`'global'` | `'scoped'`)
- **options**：插件参数对象

## 4. 依赖注入系统

### 4.1 容器配置

```typescript
// 创建 Awilix 容器
this.container = createContainer({
  injectionMode: 'PROXY',  // 使用代理模式注入
  strict: true             // 启用严格模式
});
```

### 4.2 服务注册流程

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   Service 类     │───▶│  ServiceRegistrar│───▶│ Awilix Container│
└─────────────────┘    └─────────────────┘    └─────────────────┘
                              │
                              ▼
                    ┌─────────────────┐
                    │   自动命名       │
                    │   生命周期管理    │
                    │   类型推断       │
                    └─────────────────┘
```

## 5. 生命周期管理

### 5.1 应用启动流程

```
StratixApp.run()
    │
    ▼
加载环境变量
    │
    ▼
解析配置文件
    │
    ▼
创建 StratixApplication
    │
    ▼
初始化 DI 容器
    │
    ▼
注册 Fastify Awilix 插件
    │
    ▼
从配置注册插件
    │
    ▼
初始化应用
    │
    ▼
启动 Fastify 服务器
```

### 5.2 生命周期钩子

框架提供丰富的生命周期钩子：

- `beforeConfig`：配置加载前
- `afterConfig`：配置加载后
- `afterCreate`：应用创建后
- `beforeInit`：应用初始化前
- `afterInit`：应用初始化后
- `beforeStart`：应用启动前
- `afterStart`：应用启动后

## 6. 扩展点设计

### 6.1 插件扩展

所有功能通过插件方式扩展：

- **Web 插件** (`@stratix/web`)：提供 HTTP 服务器功能
- **数据库插件** (`@stratix/database`)：数据库连接和 ORM 支持
- **认证插件** (`@stratix/auth`)：身份验证和授权
- **缓存插件** (`@stratix/cache`)：缓存功能
- **验证插件** (`@stratix/validation`)：数据验证
- **队列插件** (`@stratix/queue`)：任务队列
- **部署插件** (`@stratix/deploy`)：部署和运维

### 6.2 自定义插件开发

开发者可以轻松开发自定义插件：

1. **函数式插件**：直接使用 Fastify 插件开发模式
2. **声明式插件**：通过配置对象定义插件行为

## 7. 项目结构规范

```
stratix-app/
├── src/
│   ├── stratix.config.ts       # 主配置文件
│   ├── index.ts               # 应用入口
│   ├── services/              # 服务层
│   ├── repositories/          # 数据访问层
│   ├── plugins/               # 自定义插件
│   └── types/                 # 类型定义
├── package.json
└── tsconfig.json
```

## 8. 设计优势

### 8.1 开发效率

- **零样板代码**：通过配置驱动减少重复代码
- **一键启动**：`StratixApp.run()` 即可启动完整应用
- **自动注入**：无需手动管理依赖关系

### 8.2 可维护性

- **清晰分层**：Service、Repository、Plugin 层次分明
- **配置集中**：所有配置集中在一个文件中管理
- **类型安全**：完整的 TypeScript 支持

### 8.3 可扩展性

- **插件化架构**：通过插件扩展任意功能
- **兼容生态**：完全兼容 Fastify 生态系统
- **灵活配置**：支持运行时配置和环境特定配置

## 9. 下一步开发计划

本文档为 Stratix 框架的整体架构概览。接下来将编写以下详细设计文档：

1. **核心模块设计**：详细设计各个核心模块的接口和实现
2. **插件系统设计**：深入设计插件系统的架构和实现
3. **依赖注入系统设计**：详细设计 DI 容器的使用和扩展
4. **配置系统设计**：配置解析、验证和管理的详细设计
5. **生命周期管理设计**：应用生命周期和钩子系统的设计
6. **类型系统设计**：完整的 TypeScript 类型定义
7. **测试策略设计**：框架和应用的测试策略和工具
8. **性能优化设计**：性能监控和优化策略
9. **部署运维设计**：生产环境部署和运维方案
10. **生态系统设计**：官方插件和社区生态的规划

每个文档都将提供足够详细的设计信息，使开发者能够直接按照文档进行实现。 