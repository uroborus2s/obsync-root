# éœ€è¦ä¿®å¤çš„æ¥å£æ¸…å• - ERR_HTTP_HEADERS_SENT é£é™©

## ğŸ“‹ é—®é¢˜æ¦‚è¿°

é€šè¿‡ä»£ç æ‰«æå‘ç°ï¼Œé¡¹ç›®ä¸­æœ‰**å¤šä¸ªæ¥å£**å­˜åœ¨ä¸ `ERR_HTTP_HEADERS_SENT` ç›¸åŒçš„é£é™©æ¨¡å¼ï¼š

**é£é™©æ¨¡å¼**:
```typescript
// âŒ é£é™©ä»£ç æ¨¡å¼
async handler(request, reply): Promise<ApiResponse<any>> {
  if (error) {
    reply.status(400);  // åªè®¾ç½®çŠ¶æ€ç 
    return { success: false, ... };  // è¿”å›å¯¹è±¡
  }
  return { success: true, data: ... };
}
```

**é—®é¢˜**: è¿”å›å¯¹è±¡è®©Fastifyè‡ªåŠ¨åºåˆ—åŒ–ï¼Œå¦‚æœåºåˆ—åŒ–è¿‡ç¨‹ä¸­å‡ºé”™ï¼Œä¼šå¯¼è‡´ `ERR_HTTP_HEADERS_SENT`ã€‚

---

## ğŸ” æ‰«æç»“æœ

### AttendanceController.ts

| è¡Œå· | æ–¹æ³• | è¿”å›ç±»å‹ | é£é™©ç­‰çº§ | çŠ¶æ€ |
|------|------|----------|----------|------|
| 29 | `checkAuthStatus` | `Promise<ApiResponse<any>>` | ğŸŸ¡ ä½ | â³ å¾…ä¿®å¤ |
| 70 | `getCourseCompleteData` | `Promise<void>` | âœ… æ—  | âœ… **å·²ä¿®å¤** |
| 182 | `checkin` | `Promise<ApiResponse<CheckinResponse>>` | ğŸ”´ é«˜ | â³ å¾…ä¿®å¤ |
| 330 | `getStudentLeaveApplications` | `Promise<ApiResponse<any>>` | ğŸ”´ é«˜ | â³ å¾…ä¿®å¤ |
| 539 | `createVerificationWindow` | `Promise<ApiResponse<CreateVerificationWindowResponse>>` | ğŸ”´ é«˜ | â³ å¾…ä¿®å¤ |
| 648 | `getLeaveApplicationDetail` | `Promise<ApiResponse<any>>` | ğŸ”´ é«˜ | â³ å¾…ä¿®å¤ |

**é£é™©ä»£ç ç¤ºä¾‹** (ç¬¬182-238è¡Œ):
```typescript
async checkin(...): Promise<ApiResponse<CheckinResponse>> {
  if (!userIdentity) {
    reply.status(401);  // âŒ åªè®¾ç½®çŠ¶æ€ç 
    return { success: false, ... };  // âŒ è¿”å›å¯¹è±¡
  }
  
  if (isLeft(result)) {
    reply.status(statusCode);  // âŒ åªè®¾ç½®çŠ¶æ€ç 
    return { success: false, ... };  // âŒ è¿”å›å¯¹è±¡
  }
  
  reply.status(200);  // âŒ åªè®¾ç½®çŠ¶æ€ç 
  return { success: true, data: result.right };  // âŒ è¿”å›å¯¹è±¡
}
```

### LeaveController.ts

| è¡Œå· | æ–¹æ³• | è¿”å›ç±»å‹ | é£é™©ç­‰çº§ | çŠ¶æ€ |
|------|------|----------|----------|------|
| 52 | `getStudentLeaveApplications` | `Promise<ApiResponse<any>>` | ğŸ”´ é«˜ | â³ å¾…ä¿®å¤ |
| 111 | `submitLeaveApplication` | `Promise<ApiResponse<any>>` | ğŸ”´ é«˜ | â³ å¾…ä¿®å¤ |
| 168 | `getLeaveApplicationDetail` | `Promise<ApiResponse<any>>` | ğŸ”´ é«˜ | â³ å¾…ä¿®å¤ |
| 273 | `getTeacherLeaveApplications` | `Promise<ApiResponse<any>>` | ğŸ”´ é«˜ | â³ å¾…ä¿®å¤ |
| 367 | `approveLeaveApplication` | `Promise<ApiResponse<any>>` | ğŸ”´ é«˜ | â³ å¾…ä¿®å¤ |

**é£é™©ä»£ç ç¤ºä¾‹** (ç¬¬52-95è¡Œ):
```typescript
async getStudentLeaveApplications(...): Promise<ApiResponse<any>> {
  if (!userIdentity || userIdentity.userType !== 'student') {
    reply.status(403);  // âŒ åªè®¾ç½®çŠ¶æ€ç 
    return { success: false, ... };  // âŒ è¿”å›å¯¹è±¡
  }
  
  if (isLeft(result)) {
    reply.status(statusCode);  // âŒ åªè®¾ç½®çŠ¶æ€ç 
    return { success: false, ... };  // âŒ è¿”å›å¯¹è±¡
  }
  
  return { success: true, data: result.right };  // âŒ è¿”å›å¯¹è±¡
}
```

---

## ğŸ“Š ç»Ÿè®¡ä¿¡æ¯

- **æ€»è®¡**: 11ä¸ªæ¥å£å­˜åœ¨é£é™©
- **å·²ä¿®å¤**: 1ä¸ª (`getCourseCompleteData`)
- **å¾…ä¿®å¤**: 10ä¸ª
- **é«˜é£é™©**: 9ä¸ª (æœ‰å¤šä¸ª `reply.status()` è°ƒç”¨)
- **ä½é£é™©**: 1ä¸ª (ç®€å•è¿”å›ï¼Œæ— é”™è¯¯å¤„ç†)

---

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: æ‰¹é‡ä¿®å¤æ‰€æœ‰æ¥å£ (æ¨è)

**ä¼˜ç‚¹**:
- âœ… ä¸€æ¬¡æ€§è§£å†³æ‰€æœ‰æ½œåœ¨é—®é¢˜
- âœ… ç»Ÿä¸€ä»£ç é£æ ¼
- âœ… é¿å…æœªæ¥å‡ºç°ç›¸åŒé”™è¯¯

**ç¼ºç‚¹**:
- âš ï¸ æ”¹åŠ¨è¾ƒå¤§ï¼Œéœ€è¦å……åˆ†æµ‹è¯•
- âš ï¸ éœ€è¦æ›´æ–°æ‰€æœ‰ç›¸å…³çš„å•å…ƒæµ‹è¯•

**å·¥ä½œé‡**: çº¦2-3å°æ—¶

### æ–¹æ¡ˆ2: æ¸è¿›å¼ä¿®å¤ (ä¿å®ˆ)

**ä¼˜ç‚¹**:
- âœ… é£é™©å¯æ§ï¼Œé€æ­¥éªŒè¯
- âœ… å¯ä»¥ä¼˜å…ˆä¿®å¤é«˜é£é™©æ¥å£

**ç¼ºç‚¹**:
- âš ï¸ è€—æ—¶è¾ƒé•¿
- âš ï¸ å¯èƒ½é—æ¼éƒ¨åˆ†æ¥å£

**å·¥ä½œé‡**: çº¦4-5å°æ—¶

---

## ğŸš€ ä¿®å¤æ­¥éª¤ (æ–¹æ¡ˆ1)

### æ­¥éª¤1: ä¿®å¤ AttendanceController.ts

éœ€è¦ä¿®å¤çš„æ–¹æ³•:
1. `checkin` (ç¬¬182-238è¡Œ)
2. `getStudentLeaveApplications` (ç¬¬330-364è¡Œ)
3. `createVerificationWindow` (ç¬¬539-609è¡Œ)
4. `getLeaveApplicationDetail` (ç¬¬648-725è¡Œ)

**ä¿®å¤æ¨¡æ¿**:
```typescript
// âœ… ä¿®å¤åçš„ä»£ç 
async methodName(...): Promise<void> {  // æ”¹ä¸º void
  try {  // æ·»åŠ  try-catch
    // ä¸šåŠ¡é€»è¾‘
    
    if (error) {
      // ç«‹å³å‘é€å“åº”
      return reply.status(400).send({
        success: false,
        message: '...',
        code: '...'
      });
    }
    
    // æˆåŠŸå“åº”
    return reply.status(200).send({
      success: true,
      message: '...',
      data: result
    });
  } catch (error: any) {
    // é”™è¯¯å¤„ç†
    if (!reply.sent) {
      return reply.status(500).send({
        success: false,
        message: 'æœåŠ¡å™¨å†…éƒ¨é”™è¯¯',
        code: 'INTERNAL_SERVER_ERROR'
      });
    }
  }
}
```

### æ­¥éª¤2: ä¿®å¤ LeaveController.ts

éœ€è¦ä¿®å¤çš„æ–¹æ³•:
1. `getStudentLeaveApplications` (ç¬¬52-95è¡Œ)
2. `submitLeaveApplication` (ç¬¬111-131è¡Œ)
3. `getLeaveApplicationDetail` (ç¬¬168-230è¡Œ)
4. `getTeacherLeaveApplications` (ç¬¬273-316è¡Œ)
5. `approveLeaveApplication` (ç¬¬367-425è¡Œ)

ä½¿ç”¨ç›¸åŒçš„ä¿®å¤æ¨¡æ¿ã€‚

### æ­¥éª¤3: æ„å»ºå’Œæµ‹è¯•

```bash
# æ„å»º
pnpm run build @stratix/app-icalink

# è¿è¡Œå•å…ƒæµ‹è¯•
pnpm test apps/app-icalink

# æ„å»ºDockeré•œåƒ
docker build -t app-icalink:v1.0.4 -f apps/app-icalink/Dockerfile .
```

### æ­¥éª¤4: éƒ¨ç½²éªŒè¯

```bash
# æ¨é€é•œåƒ
docker push g-rrng9518-docker.pkg.coding.net/obsync/sync/app-icalink:v1.0.4

# æ›´æ–°æœåŠ¡
docker service update \
  --image g-rrng9518-docker.pkg.coding.net/obsync/sync/app-icalink:v1.0.4 \
  obsync_app-icalink

# éªŒè¯
docker service logs obsync_app-icalink --tail 100 | grep "ERR_HTTP_HEADERS_SENT"
```

---

## ğŸ¯ ä¼˜å…ˆçº§å»ºè®®

### ğŸ”´ é«˜ä¼˜å…ˆçº§ (ç«‹å³ä¿®å¤)

è¿™äº›æ¥å£ä½¿ç”¨é¢‘ç¹ï¼Œä¸”æœ‰å¤šä¸ªé”™è¯¯å¤„ç†åˆ†æ”¯:

1. **`checkin`** - ç­¾åˆ°æ¥å£ï¼Œä½¿ç”¨é¢‘ç‡æœ€é«˜
2. **`submitLeaveApplication`** - æäº¤è¯·å‡ç”³è¯·
3. **`approveLeaveApplication`** - å®¡æ‰¹è¯·å‡ç”³è¯·
4. **`getStudentLeaveApplications`** - æŸ¥è¯¢è¯·å‡åˆ—è¡¨

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ (æœ¬å‘¨å†…ä¿®å¤)

5. **`createVerificationWindow`** - åˆ›å»ºéªŒè¯çª—å£
6. **`getLeaveApplicationDetail`** - æŸ¥è¯¢è¯·å‡è¯¦æƒ…
7. **`getTeacherLeaveApplications`** - æ•™å¸ˆæŸ¥è¯¢è¯·å‡åˆ—è¡¨

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ (ä¸‹å‘¨ä¿®å¤)

8. **`checkAuthStatus`** - ç®€å•çš„è®¤è¯çŠ¶æ€æ£€æŸ¥

---

## ğŸ“ ä¿®å¤æ£€æŸ¥æ¸…å•

### AttendanceController.ts
- [ ] `checkin` (ç¬¬182-238è¡Œ)
- [ ] `getStudentLeaveApplications` (ç¬¬330-364è¡Œ)
- [ ] `createVerificationWindow` (ç¬¬539-609è¡Œ)
- [ ] `getLeaveApplicationDetail` (ç¬¬648-725è¡Œ)

### LeaveController.ts
- [ ] `getStudentLeaveApplications` (ç¬¬52-95è¡Œ)
- [ ] `submitLeaveApplication` (ç¬¬111-131è¡Œ)
- [ ] `getLeaveApplicationDetail` (ç¬¬168-230è¡Œ)
- [ ] `getTeacherLeaveApplications` (ç¬¬273-316è¡Œ)
- [ ] `approveLeaveApplication` (ç¬¬367-425è¡Œ)

### æµ‹è¯•éªŒè¯
- [ ] å•å…ƒæµ‹è¯•é€šè¿‡
- [ ] é›†æˆæµ‹è¯•é€šè¿‡
- [ ] æ‰‹åŠ¨æµ‹è¯•æ‰€æœ‰ä¿®å¤çš„æ¥å£
- [ ] å‹åŠ›æµ‹è¯•éªŒè¯ç¨³å®šæ€§
- [ ] ç”Ÿäº§ç¯å¢ƒç›‘æ§24å°æ—¶

---

## ğŸ”§ è‡ªåŠ¨åŒ–ä¿®å¤è„šæœ¬

ä¸ºäº†æé«˜æ•ˆç‡ï¼Œå¯ä»¥åˆ›å»ºä¸€ä¸ªè‡ªåŠ¨åŒ–ä¿®å¤è„šæœ¬:

```bash
#!/bin/bash
# scripts/fix-response-pattern.sh

# æŸ¥æ‰¾æ‰€æœ‰é£é™©ä»£ç æ¨¡å¼
echo "æ‰«æé£é™©ä»£ç æ¨¡å¼..."
grep -rn "Promise<ApiResponse" apps/app-icalink/src/controllers/ \
  | grep -v "Promise<void>"

# æç¤ºéœ€è¦æ‰‹åŠ¨ä¿®å¤
echo ""
echo "âš ï¸  å‘ç°ä»¥ä¸Šæ¥å£éœ€è¦ä¿®å¤"
echo "è¯·æŒ‰ç…§ä¿®å¤æ¨¡æ¿è¿›è¡Œä¿®å¤"
```

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [ERR_HTTP_HEADERS_SENTé”™è¯¯åˆ†æ](./ERR_HTTP_HEADERS_SENTé”™è¯¯åˆ†æ.md)
- [é—®é¢˜ä¿®å¤æ€»ç»“-ERR_HTTP_HEADERS_SENT](./é—®é¢˜ä¿®å¤æ€»ç»“-ERR_HTTP_HEADERS_SENT.md)
- [Fastify Replyæ–‡æ¡£](https://fastify.dev/docs/latest/Reference/Reply/)

---

## â“ å¸¸è§é—®é¢˜

### Q1: ä¸ºä»€ä¹ˆè¦æ”¹ä¸º `Promise<void>`?

**A**: å› ä¸ºä½¿ç”¨ `reply.send()` æ˜¾å¼å‘é€å“åº”åï¼Œä¸éœ€è¦å†è¿”å›å¯¹è±¡ã€‚è¿”å› `void` è¡¨ç¤ºæ–¹æ³•ä¸è¿”å›å€¼ï¼Œåªé€šè¿‡ `reply` å¯¹è±¡å‘é€å“åº”ã€‚

### Q2: æ˜¯å¦æ‰€æœ‰æ¥å£éƒ½éœ€è¦ä¿®å¤?

**A**: æ˜¯çš„ã€‚è™½ç„¶ç›®å‰åªæœ‰ä¸€ä¸ªæ¥å£æŠ¥é”™ï¼Œä½†æ‰€æœ‰ä½¿ç”¨ç›¸åŒæ¨¡å¼çš„æ¥å£éƒ½å­˜åœ¨æ½œåœ¨é£é™©ã€‚å»ºè®®ä¸€æ¬¡æ€§ä¿®å¤ï¼Œé¿å…æœªæ¥å‡ºç°ç›¸åŒé—®é¢˜ã€‚

### Q3: ä¿®å¤åæ˜¯å¦éœ€è¦æ›´æ–°APIæ–‡æ¡£?

**A**: ä¸éœ€è¦ã€‚ä¿®å¤åªæ”¹å˜äº†å†…éƒ¨å®ç°ï¼ŒAPIçš„è¾“å…¥è¾“å‡ºæ ¼å¼ã€HTTPçŠ¶æ€ç ç­‰éƒ½ä¿æŒä¸å˜ï¼Œå¯¹å¤–éƒ¨è°ƒç”¨è€…é€æ˜ã€‚

### Q4: å¦‚ä½•éªŒè¯ä¿®å¤æ˜¯å¦æˆåŠŸ?

**A**: 
1. æ£€æŸ¥æ—¥å¿—ä¸­æ˜¯å¦è¿˜æœ‰ `ERR_HTTP_HEADERS_SENT` é”™è¯¯
2. è¿è¡Œå•å…ƒæµ‹è¯•å’Œé›†æˆæµ‹è¯•
3. æ‰‹åŠ¨æµ‹è¯•æ‰€æœ‰ä¿®å¤çš„æ¥å£
4. ç›‘æ§ç”Ÿäº§ç¯å¢ƒ24å°æ—¶

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0  
**æœ€åæ›´æ–°**: 2025-10-25  
**ä½œè€…**: Stratix Team

