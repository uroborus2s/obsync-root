# é›ªå´©æ•ˆåº”ä¸è´Ÿè½½å‡è¡¡è¯¦è§£

## ğŸ“š ç›®å½•

1. [ä»€ä¹ˆæ˜¯é›ªå´©æ•ˆåº”](#1-ä»€ä¹ˆæ˜¯é›ªå´©æ•ˆåº”)
2. [Docker Swarmè´Ÿè½½å‡è¡¡æœºåˆ¶](#2-docker-swarmè´Ÿè½½å‡è¡¡æœºåˆ¶)
3. [API Gateway 503é”™è¯¯è§¦å‘æ¡ä»¶](#3-api-gateway-503é”™è¯¯è§¦å‘æ¡ä»¶)
4. [é˜²æŠ¤æªæ–½](#4-é˜²æŠ¤æªæ–½)

---

## 1. ä»€ä¹ˆæ˜¯é›ªå´©æ•ˆåº”ï¼Ÿ

### 1.1 å®šä¹‰

**é›ªå´©æ•ˆåº” (Cascading Failure)** æ˜¯æŒ‡åœ¨å¾®æœåŠ¡æ¶æ„ä¸­,ä¸€ä¸ªæœåŠ¡çš„æ•…éšœå¯¼è‡´å…¶ä»–ä¾èµ–æœåŠ¡è¿é”å¤±è´¥,æœ€ç»ˆé€ æˆæ•´ä¸ªç³»ç»Ÿå´©æºƒçš„ç°è±¡ã€‚

### 1.2 é›ªå´©æ•ˆåº”çš„å‘ç”Ÿè¿‡ç¨‹

```mermaid
graph TD
    A[ç”¨æˆ·è¯·æ±‚] --> B[API Gateway]
    B --> C[Service A]
    C --> D[Service B]
    D --> E[Database]

    style D fill:#ff6b6b
    style C fill:#ffa07a
    style B fill:#ffcccb

    F[Service B æ•…éšœ] --> G[è¯·æ±‚å †ç§¯]
    G --> H[Service A è¶…æ—¶]
    H --> I[API Gateway è¶…æ—¶]
    I --> J[æ•´ä¸ªç³»ç»Ÿä¸å¯ç”¨]
```

### 1.3 å…¸å‹åœºæ™¯ç¤ºä¾‹

#### åœºæ™¯1: æ•°æ®åº“è¿æ¥æ± è€—å°½

```
æ—¶é—´çº¿:
T0: æ•°æ®åº“å“åº”å˜æ…¢ (ä»10ms -> 2000ms)
T1: app-icalink è¯·æ±‚å †ç§¯,è¿æ¥æ± è€—å°½
T2: app-icalink å¼€å§‹è¿”å›è¶…æ—¶é”™è¯¯
T3: api-gateway è¯·æ±‚å¤±è´¥ç´¯ç§¯,è§¦å‘ç†”æ–­å™¨
T4: æ‰€æœ‰ç”¨æˆ·è¯·æ±‚è¿”å›503é”™è¯¯
T5: ç³»ç»Ÿå®Œå…¨ä¸å¯ç”¨ âŒ
```

**ä»£ç ç¤ºä¾‹**:

```typescript
// app-icalink: æ•°æ®åº“æŸ¥è¯¢å˜æ…¢
async checkin(courseId: number, studentId: number) {
  // æ•°æ®åº“æŸ¥è¯¢ä»10mså˜æˆ2000ms
  const course = await this.courseRepo.findById(courseId); // 2000ms â±ï¸
  const student = await this.studentRepo.findById(studentId); // 2000ms â±ï¸

  // æ€»è€—æ—¶4000ms,è¶…è¿‡api-gatewayçš„3000msè¶…æ—¶
  // api-gatewayè§¦å‘è¶…æ—¶,è®¡å…¥å¤±è´¥æ¬¡æ•°
}
```

#### åœºæ™¯2: å†…å­˜æ³„æ¼å¯¼è‡´çš„é›ªå´©

```
æ—¶é—´çº¿:
T0: app-icalink æŸä¸ªå®ä¾‹å†…å­˜æ³„æ¼
T1: è¯¥å®ä¾‹OOM,è¢«Docker Swarmé‡å¯
T2: æµé‡è½¬ç§»åˆ°å…¶ä»–2ä¸ªå®ä¾‹
T3: å…¶ä»–å®ä¾‹è´Ÿè½½ç¿»å€,ä¹Ÿå¼€å§‹å†…å­˜æ³„æ¼
T4: æ‰€æœ‰å®ä¾‹é™†ç»­å´©æºƒ
T5: api-gateway æ— æ³•è¿æ¥åˆ°ä»»ä½•å®ä¾‹
T6: ç†”æ–­å™¨æ‰“å¼€,è¿”å›503 âŒ
```

#### åœºæ™¯3: çªå‘æµé‡å¯¼è‡´çš„é›ªå´©

```
æ—¶é—´çº¿:
T0: æ­£å¸¸æµé‡ 100 QPS
T1: çªå‘æµé‡ 1000 QPS (ä¸Šè¯¾ç­¾åˆ°é«˜å³°)
T2: app-icalink CPU 100%,å“åº”å˜æ…¢
T3: è¯·æ±‚å †ç§¯,å†…å­˜å ç”¨ä¸Šå‡
T4: under-pressure è§¦å‘,è¿”å›503
T5: api-gateway æ”¶åˆ°å¤§é‡503,è§¦å‘ç†”æ–­å™¨
T6: å³ä½¿æµé‡æ¢å¤æ­£å¸¸,ç†”æ–­å™¨ä»ç„¶æ‰“å¼€
T7: éœ€è¦ç­‰å¾…45ç§’æ‰èƒ½æ¢å¤ â±ï¸
```

### 1.4 é›ªå´©æ•ˆåº”çš„å±å®³

| å½±å“å±‚é¢       | å…·ä½“å±å®³                         |
| -------------- | -------------------------------- |
| **ç”¨æˆ·ä½“éªŒ**   | æ‰€æœ‰ç”¨æˆ·æ— æ³•ä½¿ç”¨ç³»ç»Ÿ,å¤§é‡503é”™è¯¯ |
| **ä¸šåŠ¡å½±å“**   | ç­¾åˆ°å¤±è´¥,æ•°æ®ä¸¢å¤±,ä¸šåŠ¡ä¸­æ–­       |
| **ç³»ç»Ÿç¨³å®šæ€§** | æœåŠ¡é¢‘ç¹é‡å¯,èµ„æºè€—å°½            |
| **æ¢å¤æ—¶é—´**   | éœ€è¦æ‰‹åŠ¨å¹²é¢„,æ¢å¤æ—¶é—´é•¿          |
| **è¿é”ååº”**   | å½±å“å…¶ä»–ä¸ç›¸å…³çš„æœåŠ¡             |

### 1.5 ç†”æ–­å™¨å¦‚ä½•é˜²æ­¢é›ªå´©

**ç†”æ–­å™¨çš„ä¸‰ç§çŠ¶æ€**:

```mermaid
stateDiagram-v2
    [*] --> Closed: åˆå§‹çŠ¶æ€
    Closed --> Open: å¤±è´¥æ¬¡æ•° >= threshold (20æ¬¡)
    Open --> HalfOpen: ç­‰å¾… resetTimeout (45ç§’)
    HalfOpen --> Closed: è¯·æ±‚æˆåŠŸ
    HalfOpen --> Open: è¯·æ±‚å¤±è´¥

    note right of Closed
        æ­£å¸¸çŠ¶æ€
        æ‰€æœ‰è¯·æ±‚æ­£å¸¸è½¬å‘
    end note

    note right of Open
        ç†”æ–­çŠ¶æ€
        ç›´æ¥è¿”å›503
        ä¸å†è½¬å‘è¯·æ±‚
    end note

    note right of HalfOpen
        åŠå¼€çŠ¶æ€
        å°è¯•è½¬å‘å°‘é‡è¯·æ±‚
        æµ‹è¯•æœåŠ¡æ˜¯å¦æ¢å¤
    end note
```

**ç†”æ–­å™¨å·¥ä½œæµç¨‹**:

```typescript
// 1. Closed çŠ¶æ€ (æ­£å¸¸)
è¯·æ±‚ -> api-gateway -> app-icalink -> æˆåŠŸ âœ…
è¯·æ±‚ -> api-gateway -> app-icalink -> æˆåŠŸ âœ…
è¯·æ±‚ -> api-gateway -> app-icalink -> å¤±è´¥ âŒ (å¤±è´¥è®¡æ•°: 1)
è¯·æ±‚ -> api-gateway -> app-icalink -> å¤±è´¥ âŒ (å¤±è´¥è®¡æ•°: 2)
...
è¯·æ±‚ -> api-gateway -> app-icalink -> å¤±è´¥ âŒ (å¤±è´¥è®¡æ•°: 20)

// 2. Open çŠ¶æ€ (ç†”æ–­)
ç†”æ–­å™¨æ‰“å¼€! ğŸ”´
è¯·æ±‚ -> api-gateway -> ç›´æ¥è¿”å›503 (ä¸å†è½¬å‘åˆ°app-icalink)
è¯·æ±‚ -> api-gateway -> ç›´æ¥è¿”å›503
// è¿™æ ·å¯ä»¥:
// - å‡è½»app-icalinkçš„å‹åŠ›,è®©å®ƒæœ‰æ—¶é—´æ¢å¤
// - é¿å…è¯·æ±‚å †ç§¯
// - å¿«é€Ÿå¤±è´¥,ä¸æµªè´¹èµ„æº

// 3. ç­‰å¾… resetTimeout (45ç§’)
ç­‰å¾…ä¸­... â±ï¸

// 4. HalfOpen çŠ¶æ€ (åŠå¼€)
è¯·æ±‚ -> api-gateway -> app-icalink -> æˆåŠŸ âœ…
// å¦‚æœæˆåŠŸ,ç†”æ–­å™¨å…³é—­,æ¢å¤æ­£å¸¸
// å¦‚æœå¤±è´¥,ç†”æ–­å™¨é‡æ–°æ‰“å¼€,ç»§ç»­ç­‰å¾…
```

**é˜²æ­¢é›ªå´©çš„å…³é”®**:

1. **å¿«é€Ÿå¤±è´¥** - ä¸ç­‰å¾…è¶…æ—¶,ç«‹å³è¿”å›é”™è¯¯
2. **éš”ç¦»æ•…éšœ** - é˜»æ­¢æ•…éšœä¼ æ’­åˆ°ä¸Šæ¸¸æœåŠ¡
3. **è‡ªåŠ¨æ¢å¤** - å®šæœŸå°è¯•æ¢å¤,æ— éœ€äººå·¥å¹²é¢„
4. **ä¿æŠ¤ä¸‹æ¸¸** - å‡è½»æ•…éšœæœåŠ¡çš„å‹åŠ›

---

## 2. Docker Swarmè´Ÿè½½å‡è¡¡æœºåˆ¶

### 2.1 Docker Swarmç½‘ç»œæ¶æ„

```mermaid
graph TB
    subgraph "å¤–éƒ¨æµé‡"
        CDN[CDN]
    end

    subgraph "ç‰©ç†æœºA"
        LB1[Ingress Load Balancer]
        GW1[api-gateway-1]
        GW2[api-gateway-2]
        ICA1[app-icalink-1]
        ICA2[app-icalink-2]
    end

    subgraph "ç‰©ç†æœºB"
        LB2[Ingress Load Balancer]
        ICA3[app-icalink-3]
    end

    subgraph "Overlay Network"
        DNS[Internal DNS]
        VIP[Virtual IP: app-icalink]
    end

    CDN --> LB1
    CDN --> LB2
    LB1 --> GW1
    LB1 --> GW2
    LB2 --> GW1
    LB2 --> GW2

    GW1 --> VIP
    GW2 --> VIP

    VIP --> ICA1
    VIP --> ICA2
    VIP --> ICA3

    DNS -.-> VIP
```

### 2.2 è¯·æ±‚è½¬å‘æµç¨‹è¯¦è§£

#### æ­¥éª¤1: CDNåˆ°API Gateway

```bash
# CDNé…ç½® (ç¤ºä¾‹)
upstream backend {
    server 47.116.161.190:8090;   # ç‰©ç†æœºA
    server 120.131.12.6:8090;     # ç‰©ç†æœºB

    # è´Ÿè½½å‡è¡¡ç®—æ³•: round-robin (è½®è¯¢)
}

# è¯·æ±‚åˆ†å‘:
è¯·æ±‚1 -> ç‰©ç†æœºA:8090
è¯·æ±‚2 -> ç‰©ç†æœºB:8090
è¯·æ±‚3 -> ç‰©ç†æœºA:8090
è¯·æ±‚4 -> ç‰©ç†æœºB:8090
```

#### æ­¥éª¤2: Ingress Load Balanceråˆ°API Gatewayå®ä¾‹

```yaml
# Docker Swarm Ingressç½‘ç»œ
# å½“è¯·æ±‚åˆ°è¾¾ç‰©ç†æœºçš„8090ç«¯å£æ—¶:

ç‰©ç†æœºA:8090 -> Ingress LB -> é€‰æ‹©ä¸€ä¸ªapi-gatewayå®ä¾‹
-> api-gateway-1 (åœ¨ç‰©ç†æœºA)
-> api-gateway-2 (åœ¨ç‰©ç†æœºA)
-> api-gateway-1 (åœ¨ç‰©ç†æœºB) âŒ ä¸å­˜åœ¨
# æ³¨æ„: å¦‚æœåªæœ‰2ä¸ªapi-gatewayå‰¯æœ¬,å¯èƒ½éƒ½åœ¨åŒä¸€å°æœºå™¨ä¸Š!
# Docker Swarmä¼šå°½é‡åˆ†æ•£,ä½†ä¸ä¿è¯
```

#### æ­¥éª¤3: API Gatewayåˆ°app-icalink

**å…³é”®é…ç½®**:

```json
// apps/api-gateway/prod.env.json
{
  "proxyServices": [
    {
      "name": "icalink",
      "upstream": "http://app-icalink:3000", // ğŸ”‘ å…³é”®: ä½¿ç”¨æœåŠ¡å,ä¸æ˜¯IP
      "prefix": "/api/icalink",
      "rewritePrefix": "/api/icalink"
    }
  ]
}
```

**DNSè§£æè¿‡ç¨‹**:

```bash
# 1. api-gatewayå‘èµ·è¯·æ±‚
GET http://app-icalink:3000/api/icalink/v1/attendance/19644/checkin

# 2. Docker Swarmå†…éƒ¨DNSè§£æ
app-icalink -> 10.0.1.100 (Virtual IP)

# 3. Virtual IPèƒŒåçš„è´Ÿè½½å‡è¡¡
10.0.1.100 -> 10.0.1.101 (app-icalink-1, ç‰©ç†æœºA)
           -> 10.0.1.102 (app-icalink-2, ç‰©ç†æœºA)
           -> 10.0.1.103 (app-icalink-3, ç‰©ç†æœºB)

# 4. è´Ÿè½½å‡è¡¡ç®—æ³•: IPVS (IP Virtual Server)
# é»˜è®¤ç®—æ³•: round-robin (è½®è¯¢)
è¯·æ±‚1 -> app-icalink-1
è¯·æ±‚2 -> app-icalink-2
è¯·æ±‚3 -> app-icalink-3
è¯·æ±‚4 -> app-icalink-1
...
```

### 2.3 è´Ÿè½½å‡è¡¡ç®—æ³•è¯¦è§£

#### Docker Swarmä½¿ç”¨çš„IPVSè´Ÿè½½å‡è¡¡

```bash
# æŸ¥çœ‹IPVSè§„åˆ™ (åœ¨Docker SwarmèŠ‚ç‚¹ä¸Šæ‰§è¡Œ)
ipvsadm -Ln

# è¾“å‡ºç¤ºä¾‹:
IP Virtual Server version 1.2.1 (size=4096)
Prot LocalAddress:Port Scheduler Flags
  -> RemoteAddress:Port           Forward Weight ActiveConn InActConn
TCP  10.0.1.100:3000 rr
  -> 10.0.1.101:3000              Masq    1      5          0
  -> 10.0.1.102:3000              Masq    1      3          0
  -> 10.0.1.103:3000              Masq    1      4          0
```

**è´Ÿè½½å‡è¡¡ç‰¹æ€§**:

| ç‰¹æ€§         | è¯´æ˜                  |
| ------------ | --------------------- |
| **ç®—æ³•**     | Round-Robin (è½®è¯¢)    |
| **ä¼šè¯ä¿æŒ** | æ—  (æ¯ä¸ªè¯·æ±‚ç‹¬ç«‹è·¯ç”±) |
| **å¥åº·æ£€æŸ¥** | åŸºäºDockerå¥åº·æ£€æŸ¥    |
| **æ•…éšœè½¬ç§»** | è‡ªåŠ¨å‰”é™¤ä¸å¥åº·çš„å®ä¾‹  |
| **æƒé‡**     | é»˜è®¤ç›¸åŒæƒé‡          |

#### è´Ÿè½½å‡è¡¡ç¤ºä¾‹

**åœºæ™¯: 3ä¸ªapp-icalinkå®ä¾‹**

```typescript
// è¯·æ±‚åºåˆ—:
è¯·æ±‚1: POST /api/icalink/v1/attendance/19644/checkin
  -> api-gateway-1 -> app-icalink-1 âœ…

è¯·æ±‚2: POST /api/icalink/v1/attendance/19644/checkin
  -> api-gateway-2 -> app-icalink-2 âœ…

è¯·æ±‚3: POST /api/icalink/v1/attendance/19644/checkin
  -> api-gateway-1 -> app-icalink-3 âœ…

è¯·æ±‚4: POST /api/icalink/v1/attendance/19644/checkin
  -> api-gateway-2 -> app-icalink-1 âœ…

// å¦‚æœapp-icalink-2å¥åº·æ£€æŸ¥å¤±è´¥:
è¯·æ±‚5: POST /api/icalink/v1/attendance/19644/checkin
  -> api-gateway-1 -> app-icalink-3 âœ… (è·³è¿‡app-icalink-2)

è¯·æ±‚6: POST /api/icalink/v1/attendance/19644/checkin
  -> api-gateway-2 -> app-icalink-1 âœ…
```

### 2.4 è·¨èŠ‚ç‚¹é€šä¿¡

**Overlayç½‘ç»œç‰¹æ€§**:

```mermaid
graph LR
    subgraph "ç‰©ç†æœºA"
        GW1[api-gateway-1<br/>10.0.1.10]
        ICA1[app-icalink-1<br/>10.0.1.101]
    end

    subgraph "ç‰©ç†æœºB"
        GW2[api-gateway-2<br/>10.0.1.11]
        ICA2[app-icalink-3<br/>10.0.1.103]
    end

    subgraph "Overlay Network"
        VIP[VIP: app-icalink<br/>10.0.1.100]
    end

    GW1 -.->|VXLANéš§é“| VIP
    GW2 -.->|VXLANéš§é“| VIP
    VIP --> ICA1
    VIP --> ICA2

    style VIP fill:#ffd700
```

**é€šä¿¡è¿‡ç¨‹**:

1. **åŒèŠ‚ç‚¹é€šä¿¡** (api-gateway-1 -> app-icalink-1)
   - å»¶è¿Ÿ: ~0.1ms
   - ä¸ç»è¿‡ç‰©ç†ç½‘ç»œ
   - ä½¿ç”¨Linux bridge

2. **è·¨èŠ‚ç‚¹é€šä¿¡** (api-gateway-1 -> app-icalink-3)
   - å»¶è¿Ÿ: ~1-5ms
   - ç»è¿‡VXLANéš§é“
   - éœ€è¦ç‰©ç†ç½‘ç»œä¼ è¾“

---

## 3. API Gateway 503é”™è¯¯è§¦å‘æ¡ä»¶

### 3.1 è§¦å‘æ¡ä»¶æ±‡æ€»

API Gatewayè¿”å›503é”™è¯¯æœ‰**3ä¸ªä¸»è¦æ¥æº**:

```mermaid
graph TD
    A[ç”¨æˆ·è¯·æ±‚] --> B{API Gateway}

    B --> C{1. ç†”æ–­å™¨æ£€æŸ¥}
    C -->|ç†”æ–­å™¨æ‰“å¼€| D[è¿”å›503<br/>FST_ERR_CIRCUIT_BREAKER_OPEN]

    C -->|ç†”æ–­å™¨å…³é—­| E{2. under-pressureæ£€æŸ¥}
    E -->|èµ„æºè¶…é™| F[è¿”å›503<br/>Service under pressure]

    E -->|èµ„æºæ­£å¸¸| G{3. è½¬å‘åˆ°app-icalink}
    G -->|è¶…æ—¶| H[å¤±è´¥è®¡æ•°+1]
    G -->|è¿æ¥å¤±è´¥| I[å¤±è´¥è®¡æ•°+1]
    G -->|è¿”å›503| J[å¤±è´¥è®¡æ•°+1]

    H --> K{å¤±è´¥æ¬¡æ•° >= 20?}
    I --> K
    J --> K

    K -->|æ˜¯| L[æ‰“å¼€ç†”æ–­å™¨]
    K -->|å¦| M[ç»§ç»­å¤„ç†]

    L --> D
```

### 3.2 æ¡ä»¶1: ç†”æ–­å™¨æ‰“å¼€

**è§¦å‘æ¡ä»¶**:

```typescript
// apps/api-gateway/src/hooks.ts
await instance.register(circuitBreaker, {
  threshold: 20, // ğŸ”‘ å¤±è´¥æ¬¡æ•°é˜ˆå€¼
  timeout: 60000, // ğŸ”‘ å•ä¸ªè¯·æ±‚è¶…æ—¶æ—¶é—´
  resetTimeout: 45000 // ğŸ”‘ ç†”æ–­å™¨é‡ç½®æ—¶é—´
});

// è§¦å‘é€»è¾‘:
if (å¤±è´¥æ¬¡æ•° >= 20) {
  ç†”æ–­å™¨çŠ¶æ€ = 'OPEN';
  return 503; // "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•"
}
```

**ä»€ä¹ˆç®—"å¤±è´¥"?**

1. **è¯·æ±‚è¶…æ—¶** (> 60ç§’)

   ```typescript
   // åœºæ™¯: app-icalinkå“åº”æ…¢
   api-gateway -> app-icalink (ç­‰å¾…60ç§’)
   -> è¶…æ—¶! âŒ
   -> å¤±è´¥è®¡æ•° +1
   ```

2. **è¿æ¥å¤±è´¥**

   ```typescript
   // åœºæ™¯: app-icalinkæ‰€æœ‰å®ä¾‹éƒ½æŒ‚äº†
   api-gateway -> app-icalink
   -> ECONNREFUSED âŒ
   -> å¤±è´¥è®¡æ•° +1
   ```

3. **ä¸‹æ¸¸è¿”å›5xxé”™è¯¯**
   ```typescript
   // åœºæ™¯: app-icalinkè¿”å›500/503
   api-gateway -> app-icalink
   -> 500 Internal Server Error âŒ
   -> å¤±è´¥è®¡æ•° +1
   ```

**å®é™…æ¡ˆä¾‹**:

```
æ—¶é—´çº¿:
05:59:00 - è¯·æ±‚1 -> app-icalink -> è¶…æ—¶ (å¤±è´¥: 1)
05:59:02 - è¯·æ±‚2 -> app-icalink -> è¶…æ—¶ (å¤±è´¥: 2)
05:59:04 - è¯·æ±‚3 -> app-icalink -> è¶…æ—¶ (å¤±è´¥: 3)
...
05:59:38 - è¯·æ±‚20 -> app-icalink -> è¶…æ—¶ (å¤±è´¥: 20)
05:59:39 - ç†”æ–­å™¨æ‰“å¼€! ğŸ”´
05:59:39 - è¯·æ±‚21 -> ç›´æ¥è¿”å›503 (ä¸å†è½¬å‘)
05:59:40 - è¯·æ±‚22 -> ç›´æ¥è¿”å›503
...
06:00:24 - ç­‰å¾…45ç§’å,ç†”æ–­å™¨è¿›å…¥åŠå¼€çŠ¶æ€
06:00:24 - è¯·æ±‚N -> å°è¯•è½¬å‘ -> æˆåŠŸ âœ…
06:00:24 - ç†”æ–­å™¨å…³é—­,æ¢å¤æ­£å¸¸ ğŸŸ¢
```

### 3.3 æ¡ä»¶2: under-pressureè§¦å‘

**API Gatewayçš„under-pressureé…ç½®**:

```typescript
// apps/api-gateway/src/stratix.config.ts
{
  name: 'under-pressure',
  plugin: underPressure,
  options: {
    maxEventLoopDelay: 2000,              // ğŸ”‘ äº‹ä»¶å¾ªç¯å»¶è¿Ÿ > 2ç§’
    maxHeapUsedBytes: 650 * 1024 * 1024,  // ğŸ”‘ å †å†…å­˜ä½¿ç”¨ > 650MB
    maxRssBytes: 850 * 1024 * 1024,       // ğŸ”‘ å¸¸é©»å†…å­˜ > 850MB
    maxEventLoopUtilization: 0.98,        // ğŸ”‘ äº‹ä»¶å¾ªç¯åˆ©ç”¨ç‡ > 98%
    message: 'Service under pressure',
    retryAfter: 30000                     // å»ºè®®30ç§’åé‡è¯•
  }
}
```

**è§¦å‘æ¡ä»¶ (æ»¡è¶³ä»»ä¸€å³è§¦å‘)**:

```typescript
if (
  eventLoopDelay > 2000 ||           // äº‹ä»¶å¾ªç¯é˜»å¡è¶…è¿‡2ç§’
  heapUsed > 650MB ||                // å †å†…å­˜è¶…è¿‡650MB
  rss > 850MB ||                     // å¸¸é©»å†…å­˜è¶…è¿‡850MB
  eventLoopUtilization > 0.98        // CPUåˆ©ç”¨ç‡è¶…è¿‡98%
) {
  return 503; // "Service under pressure"
}
```

**å®é™…åœºæ™¯**:

```
åœºæ™¯1: å†…å­˜æ³„æ¼
T0: æ­£å¸¸è¿è¡Œ,å†…å­˜ä½¿ç”¨ 400MB
T1: å¤„ç†å¤§é‡è¯·æ±‚,å†…å­˜ä¸Šå‡åˆ° 600MB
T2: å†…å­˜ç»§ç»­ä¸Šå‡åˆ° 650MB
T3: è§¦å‘under-pressure! ğŸ”´
T4: è¿”å›503,æ‹’ç»æ–°è¯·æ±‚
T5: ç­‰å¾…GCå›æ”¶å†…å­˜

åœºæ™¯2: CPUå¯†é›†å‹æ“ä½œ
T0: æ­£å¸¸è¿è¡Œ,CPU 30%
T1: å¤§é‡ç­¾åˆ°è¯·æ±‚,CPU 80%
T2: CPUç»§ç»­ä¸Šå‡åˆ° 98%
T3: äº‹ä»¶å¾ªç¯é˜»å¡,å»¶è¿Ÿ > 2ç§’
T4: è§¦å‘under-pressure! ğŸ”´
T5: è¿”å›503,ä¿æŠ¤æœåŠ¡
```

### 3.4 æ¡ä»¶3: ä¸‹æ¸¸æœåŠ¡è¿”å›503

**app-icalinkçš„under-pressureé…ç½®**:

```typescript
// apps/app-icalink/src/stratix.config.ts
{
  name: 'under-pressure',
  plugin: underPressure,
  options: {
    maxEventLoopDelay: 1000,              // ğŸ”‘ 1ç§’ (æ›´ä¸¥æ ¼)
    maxHeapUsedBytes: 1200 * 1024 * 1024, // ğŸ”‘ 1.2GB
    maxRssBytes: 1400 * 1024 * 1024,      // ğŸ”‘ 1.4GB
    maxEventLoopUtilization: 0.98,
    message: 'Service under pressure - please retry later',
    retryAfter: 10000,
    pressureHandler: (req, rep, type, value) => {
      rep.code(503).send({
        error: 'Service Unavailable',
        message: `Service under pressure: ${type}`,
        value: value,
        retryAfter: 1000
      });
    }
  }
}
```

**ä¼ æ’­é“¾**:

```typescript
// 1. app-icalinkè§¦å‘under-pressure
app-icalink: å†…å­˜ä½¿ç”¨ > 1.2GB
-> è¿”å›503 "Service under pressure"

// 2. api-gatewayæ”¶åˆ°503
api-gateway -> app-icalink
<- 503 Service Unavailable
-> å¤±è´¥è®¡æ•° +1

// 3. å¦‚æœè¿ç»­20æ¬¡503
å¤±è´¥è®¡æ•°è¾¾åˆ°20
-> ç†”æ–­å™¨æ‰“å¼€
-> api-gatewayç›´æ¥è¿”å›503 "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•"
```

### 3.5 å®Œæ•´çš„503é”™è¯¯æµç¨‹å›¾

```mermaid
sequenceDiagram
    participant User as ç”¨æˆ·
    participant CDN as CDN
    participant GW as API Gateway
    participant CB as ç†”æ–­å™¨
    participant UP as under-pressure
    participant ICA as app-icalink

    User->>CDN: POST /api/icalink/v1/attendance/19644/checkin
    CDN->>GW: è½¬å‘è¯·æ±‚

    GW->>CB: æ£€æŸ¥ç†”æ–­å™¨çŠ¶æ€
    alt ç†”æ–­å™¨æ‰“å¼€
        CB-->>GW: OPEN
        GW-->>User: 503 "æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•"
    else ç†”æ–­å™¨å…³é—­
        CB-->>GW: CLOSED
        GW->>UP: æ£€æŸ¥ç³»ç»Ÿå‹åŠ›

        alt èµ„æºè¶…é™
            UP-->>GW: PRESSURE
            GW-->>User: 503 "Service under pressure"
        else èµ„æºæ­£å¸¸
            UP-->>GW: OK
            GW->>ICA: è½¬å‘è¯·æ±‚

            alt app-icalinkæ­£å¸¸
                ICA-->>GW: 200 OK
                GW-->>User: 200 OK
            else app-icalinkè¶…æ—¶
                ICA--xGW: è¶…æ—¶ (60ç§’)
                GW->>CB: å¤±è´¥è®¡æ•° +1
                GW-->>User: 504 Gateway Timeout
            else app-icalinkè¿”å›503
                ICA-->>GW: 503 Service Unavailable
                GW->>CB: å¤±è´¥è®¡æ•° +1
                GW-->>User: 503 Service Unavailable
            end

            alt å¤±è´¥æ¬¡æ•° >= 20
                CB->>CB: æ‰“å¼€ç†”æ–­å™¨
                Note over CB: åç»­è¯·æ±‚ç›´æ¥è¿”å›503
            end
        end
    end
```

---

## 4. é˜²æŠ¤æªæ–½

### 4.1 å¤šå±‚é˜²æŠ¤ä½“ç³»

```mermaid
graph TB
    subgraph "ç¬¬1å±‚: CDN"
        CDN[CDNé™æµ<br/>DDoSé˜²æŠ¤]
    end

    subgraph "ç¬¬2å±‚: API Gateway"
        CB[ç†”æ–­å™¨<br/>threshold: 20<br/>timeout: 60s]
        UP1[under-pressure<br/>å†…å­˜: 650MB<br/>CPU: 98%]
        RL[é€Ÿç‡é™åˆ¶<br/>å¯é€‰]
    end

    subgraph "ç¬¬3å±‚: app-icalink"
        UP2[under-pressure<br/>å†…å­˜: 1.2GB<br/>CPU: 98%]
        Queue[é˜Ÿåˆ—é™æµ<br/>BullMQ]
        DB[æ•°æ®åº“è¿æ¥æ± <br/>é™åˆ¶å¹¶å‘]
    end

    CDN --> CB
    CB --> UP1
    UP1 --> RL
    RL --> UP2
    UP2 --> Queue
    Queue --> DB

    style CB fill:#90EE90
    style UP1 fill:#87CEEB
    style UP2 fill:#87CEEB
    style Queue fill:#FFD700
```

### 4.2 æœ€ä½³å®è·µå»ºè®®

#### 1. ç†”æ–­å™¨å‚æ•°è°ƒä¼˜

**æ ¹æ®æœåŠ¡ç‰¹æ€§è°ƒæ•´**:

```typescript
// å¿«é€Ÿå“åº”æœåŠ¡ (æŸ¥è¯¢æ¥å£)
{
  threshold: 10,      // æ›´ä½çš„é˜ˆå€¼
  timeout: 5000,      // 5ç§’è¶…æ—¶
  resetTimeout: 10000 // 10ç§’æ¢å¤
}

// è€—æ—¶æ“ä½œæœåŠ¡ (ç­¾åˆ°ã€æ–‡ä»¶ä¸Šä¼ )
{
  threshold: 20,      // æ›´é«˜çš„é˜ˆå€¼
  timeout: 60000,     // 60ç§’è¶…æ—¶
  resetTimeout: 45000 // 45ç§’æ¢å¤
}
```

#### 2. ç›‘æ§å’Œå‘Šè­¦

**å…³é”®æŒ‡æ ‡**:

```typescript
// 1. ç†”æ–­å™¨çŠ¶æ€
metrics.circuitBreaker = {
  state: 'OPEN' | 'CLOSED' | 'HALF_OPEN',
  failureCount: 15,
  lastFailureTime: '2025-10-24T05:59:39.714Z'
};

// 2. èµ„æºä½¿ç”¨
metrics.resources = {
  heapUsed: 580 * 1024 * 1024, // 580MB
  rss: 720 * 1024 * 1024, // 720MB
  eventLoopDelay: 1200, // 1.2ç§’
  cpu: 0.85 // 85%
};

// 3. è¯·æ±‚ç»Ÿè®¡
metrics.requests = {
  total: 1000,
  success: 950,
  failed: 50,
  errorRate: 0.05 // 5%
};
```

**å‘Šè­¦è§„åˆ™**:

```yaml
alerts:
  - name: CircuitBreakerOpen
    condition: circuitBreaker.state == 'OPEN'
    severity: critical
    action: ç«‹å³é€šçŸ¥è¿ç»´å›¢é˜Ÿ

  - name: HighFailureRate
    condition: errorRate > 0.1 # 10%
    duration: 5m
    severity: warning
    action: å‘é€å‘Šè­¦é‚®ä»¶

  - name: HighMemoryUsage
    condition: heapUsed > 600MB
    duration: 10m
    severity: warning
    action: å‡†å¤‡æ‰©å®¹
```

#### 3. ä¼˜é›…é™çº§

**é™çº§ç­–ç•¥**:

```typescript
// åœ¨api-gatewayä¸­å®ç°é™çº§é€»è¾‘
fastify.setErrorHandler(async (error, request, reply) => {
  if (error.code === 'FST_ERR_CIRCUIT_BREAKER_OPEN') {
    // ç†”æ–­å™¨æ‰“å¼€æ—¶çš„é™çº§å¤„ç†

    // ç­–ç•¥1: è¿”å›ç¼“å­˜æ•°æ®
    const cached = await redis.get(`cache:${request.url}`);
    if (cached) {
      return reply.code(200).send({
        data: JSON.parse(cached),
        fromCache: true,
        message: 'æœåŠ¡ç¹å¿™,è¿”å›ç¼“å­˜æ•°æ®'
      });
    }

    // ç­–ç•¥2: è¿”å›é»˜è®¤å€¼
    return reply.code(503).send({
      error: 'Service Unavailable',
      message: 'æœåŠ¡æš‚æ—¶ä¸å¯ç”¨ï¼Œè¯·ç¨åå†è¯•',
      retryAfter: 45 // ç§’
    });
  }
});
```

#### 4. è‡ªåŠ¨æ‰©å®¹

**åŸºäºæŒ‡æ ‡çš„è‡ªåŠ¨æ‰©å®¹**:

```yaml
# Docker Swarmä¸æ”¯æŒè‡ªåŠ¨æ‰©å®¹,éœ€è¦æ‰‹åŠ¨æˆ–è„šæœ¬å®ç°
# ç›‘æ§è„šæœ¬ç¤ºä¾‹:

#!/bin/bash
# auto-scale.sh

# è·å–å½“å‰å‰¯æœ¬æ•°
CURRENT=$(docker service ls --filter name=obsync_app-icalink --format "{{.Replicas}}" | cut -d'/' -f1)

# è·å–CPUä½¿ç”¨ç‡
CPU=$(docker stats --no-stream --format "{{.CPUPerc}}" | grep app-icalink | awk '{sum+=$1; count++} END {print sum/count}')

# å¦‚æœCPU > 80%,æ‰©å®¹
if [ $(echo "$CPU > 80" | bc) -eq 1 ]; then
  NEW=$((CURRENT + 1))
  docker service scale obsync_app-icalink=$NEW
  echo "æ‰©å®¹: $CURRENT -> $NEW"
fi

# å¦‚æœCPU < 30%,ç¼©å®¹
if [ $(echo "$CPU < 30" | bc) -eq 1 ] && [ $CURRENT -gt 2 ]; then
  NEW=$((CURRENT - 1))
  docker service scale obsync_app-icalink=$NEW
  echo "ç¼©å®¹: $CURRENT -> $NEW"
fi
```

#### 5. å¥åº·æ£€æŸ¥ä¼˜åŒ–

**æ”¹è¿›å¥åº·æ£€æŸ¥**:

```typescript
// apps/app-icalink/src/routes/health.ts
export const healthCheck = async (
  request: FastifyRequest,
  reply: FastifyReply
) => {
  const health = {
    status: 'healthy',
    timestamp: new Date().toISOString(),
    checks: {}
  };

  try {
    // 1. æ£€æŸ¥æ•°æ®åº“è¿æ¥
    await db.raw('SELECT 1');
    health.checks.database = 'ok';
  } catch (error) {
    health.status = 'unhealthy';
    health.checks.database = 'failed';
  }

  try {
    // 2. æ£€æŸ¥Redisè¿æ¥
    await redis.ping();
    health.checks.redis = 'ok';
  } catch (error) {
    health.status = 'unhealthy';
    health.checks.redis = 'failed';
  }

  // 3. æ£€æŸ¥å†…å­˜ä½¿ç”¨
  const memUsage = process.memoryUsage();
  health.checks.memory = {
    heapUsed: memUsage.heapUsed,
    heapTotal: memUsage.heapTotal,
    rss: memUsage.rss,
    status: memUsage.heapUsed < 1200 * 1024 * 1024 ? 'ok' : 'warning'
  };

  const statusCode = health.status === 'healthy' ? 200 : 503;
  return reply.code(statusCode).send(health);
};
```

---

## 5. æ€»ç»“

### 5.1 å…³é”®è¦ç‚¹

1. **é›ªå´©æ•ˆåº”** æ˜¯å¾®æœåŠ¡æ¶æ„ä¸­æœ€å±é™©çš„æ•…éšœæ¨¡å¼,éœ€è¦å¤šå±‚é˜²æŠ¤
2. **Docker Swarm** ä½¿ç”¨IPVSè¿›è¡Œè´Ÿè½½å‡è¡¡,é»˜è®¤round-robinç®—æ³•
3. **API Gateway 503é”™è¯¯** æœ‰3ä¸ªæ¥æº:
   - ç†”æ–­å™¨æ‰“å¼€ (å¤±è´¥æ¬¡æ•° >= 20)
   - under-pressureè§¦å‘ (èµ„æºè¶…é™)
   - ä¸‹æ¸¸æœåŠ¡è¿”å›503

### 5.2 é˜²æŠ¤å»ºè®®

| å±‚çº§            | é˜²æŠ¤æªæ–½       | é…ç½®                        |
| --------------- | -------------- | --------------------------- |
| **CDN**         | DDoSé˜²æŠ¤ã€é™æµ | æ ¹æ®CDNæä¾›å•†é…ç½®           |
| **API Gateway** | ç†”æ–­å™¨         | threshold: 20, timeout: 60s |
| **API Gateway** | under-pressure | å†…å­˜: 650MB, CPU: 98%       |
| **app-icalink** | under-pressure | å†…å­˜: 1.2GB, CPU: 98%       |
| **app-icalink** | é˜Ÿåˆ—é™æµ       | BullMQå¹¶å‘æ§åˆ¶              |
| **Database**    | è¿æ¥æ±          | é™åˆ¶æœ€å¤§è¿æ¥æ•°              |

### 5.3 ç›‘æ§æ¸…å•

- [ ] ç†”æ–­å™¨çŠ¶æ€ (OPEN/CLOSED)
- [ ] å¤±è´¥æ¬¡æ•°å’Œå¤±è´¥ç‡
- [ ] èµ„æºä½¿ç”¨ (CPU/å†…å­˜)
- [ ] å“åº”æ—¶é—´ (P50/P95/P99)
- [ ] è¯·æ±‚é‡ (QPS)
- [ ] å¥åº·æ£€æŸ¥çŠ¶æ€
- [ ] æœåŠ¡å‰¯æœ¬æ•°å’Œåˆ†å¸ƒ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-10-24
**ä½œè€…**: Stratix Team
