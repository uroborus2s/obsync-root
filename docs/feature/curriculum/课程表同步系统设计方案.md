# 课程表同步系统设计方案

## 1. 系统架构设计

### 1.1 架构概述

课程表同步系统采用微服务架构，主要由以下几个部分组成：

- **数据同步服务**：负责从原始数据库获取课程数据，处理后同步至WPS协作平台
- **用户服务**：管理用户信息、认证和授权
- **打卡服务**：处理打卡和出勤相关逻辑
- **请假审批服务**：管理请假申请和审批流程
- **统计分析服务**：处理出勤数据统计和报表生成
- **前端应用**：为各类用户提供交互界面
- **API网关**：统一管理API访问和权限控制

### 1.2 系统组件详解

#### 1.2.1 数据同步服务
- **职责**：课程数据同步、日历和日程管理
- **工作流程**：
  1. 定时从原始数据库拉取最新课程数据
  2. 对课程数据进行处理和转换
  3. 调用WPS协作平台API创建/更新日历和日程
  4. 记录同步日志和状态
- **技术选型**：Node.js、MySQL、Redis

#### 1.2.2 用户服务
- **职责**：用户账号管理、身份认证、权限控制
- **工作流程**：
  1. 维护系统内用户与WPS账号的映射关系
  2. 提供用户认证和会话管理
  3. 基于角色的权限控制
- **技术选型**：Node.js、JWT、Redis

#### 1.2.3 打卡服务
- **职责**：课程打卡、位置验证、出勤记录
- **工作流程**：
  1. 验证打卡时间和位置是否有效
  2. 记录打卡信息
  3. 更新出勤状态
- **技术选型**：Node.js、GeoDB、WebSocket

#### 1.2.4 请假审批服务
- **职责**：请假申请处理、审批流程管理
- **工作流程**：
  1. 接收学生请假申请
  2. 创建WPS审批流程
  3. 跟踪审批状态
  4. 更新出勤记录
- **技术选型**：Node.js、状态机、消息队列

#### 1.2.5 统计分析服务
- **职责**：出勤数据统计、报表生成
- **工作流程**：
  1. 汇总各维度出勤数据
  2. 生成统计报表
  3. 提供数据查询接口
- **技术选型**：Node.js、数据仓库、OLAP

#### 1.2.6 前端应用
- **职责**：提供用户界面
- **模块组成**：
  1. 学生端：课程表、打卡、请假、出勤查询
  2. 教师端：课程表、请假审批、出勤管理
  3. 管理员端：系统配置、同步管理、出勤统计
- **技术选型**：React、Next.js、Tailwind CSS、Shadcn UI

#### 1.2.7 API网关
- **职责**：API路由、认证授权、限流
- **功能特点**：
  1. 统一API入口
  2. 请求转发和负载均衡
  3. 访问控制和安全保护
- **技术选型**：Express Gateway、Kong

### 1.3 系统交互流程

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  原始数据库  │────▶│ 数据同步服务 │────▶│ WPS协作平台 │
└─────────────┘     └──────┬──────┘     └─────────────┘
                           │
                           ▼
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│   API网关   │◀───▶│  系统数据库  │◀───▶│ 统计分析服务 │
└──────┬──────┘     └─────────────┘     └─────────────┘
       │
       ▼
┌─────────────┬─────────────┬─────────────┬─────────────┐
│  用户服务   │   打卡服务   │ 请假审批服务 │   前端应用   │
└─────────────┴─────────────┴─────────────┴─────────────┘
```

## 2. 数据流程设计

### 2.1 课程数据同步流程

```
┌───────────┐     ┌───────────┐     ┌───────────┐     ┌───────────┐
│ 定时触发  │────▶│ 获取数据  │────▶│ 数据处理  │────▶│ 同步日历  │
└───────────┘     └───────────┘     └───────────┘     └───────────┘
                                                             │
┌───────────┐     ┌───────────┐     ┌───────────┐           │
│ 更新状态  │◀───┤ 记录日志  │◀───┤ 同步日程  │◀──────────┘
└───────────┘     └───────────┘     └───────────┘
```

### 2.2 打卡流程

```
┌───────────┐     ┌───────────┐     ┌───────────┐     ┌───────────┐
│ 用户打卡  │────▶│ 位置验证  │────▶│ 时间验证  │────▶│ 记录打卡  │
└───────────┘     └───────────┘     └───────────┘     └───────────┘
                                                             │
                  ┌───────────┐                              │
                  │ 返回结果  │◀─────────────────────────────┘
                  └───────────┘
```

### 2.3 请假流程

```
┌───────────┐     ┌───────────┐     ┌───────────┐     ┌───────────┐
│ 提交申请  │────▶│ 创建审批  │────▶│ 教师审批  │────▶│ 更新状态  │
└───────────┘     └───────────┘     └───────────┘     └───────────┘
                                                             │
                  ┌───────────┐                              │
                  │ 通知学生  │◀─────────────────────────────┘
                  └───────────┘
```

## 3. 接口设计

### 3.1 内部服务接口

#### 3.1.1 数据同步服务接口
- `POST /api/sync/start`：手动触发同步
- `GET /api/sync/status`：获取同步状态
- `GET /api/sync/logs`：获取同步日志
- `POST /api/sync/config`：更新同步配置

#### 3.1.2 用户服务接口
- `POST /api/users/login`：用户登录
- `GET /api/users/profile`：获取用户信息
- `GET /api/users/calendar`：获取用户日历
- `GET /api/users/schedules`：获取用户日程

#### 3.1.3 打卡服务接口
- `POST /api/checkin`：提交打卡
- `GET /api/checkin/status/:scheduleId`：获取打卡状态
- `GET /api/checkin/records`：获取打卡记录

#### 3.1.4 请假审批服务接口
- `POST /api/leaves`：提交请假申请
- `GET /api/leaves`：获取请假记录
- `POST /api/leaves/:id/approve`：审批请假申请
- `POST /api/leaves/:id/reject`：拒绝请假申请

#### 3.1.5 统计分析服务接口
- `GET /api/stats/attendance/course/:courseId`：获取课程出勤率
- `GET /api/stats/attendance/student/:studentId`：获取学生出勤率
- `GET /api/stats/attendance/teacher/:teacherId`：获取教师课程出勤率
- `GET /api/stats/ranking/course`：获取课程出勤率排名
- `GET /api/stats/ranking/student`：获取学生出勤率排名

### 3.2 外部API接口

#### 3.2.1 WPS协作平台API
- 日历API：创建/更新/删除日历
- 日程API：创建/更新/删除日程
- 审批流API：创建/查询审批流
- 账号API：账号验证和授权

#### 3.2.2 定位服务API
- 地理位置API：位置验证和距离计算

## 4. 数据库设计

### 4.1 数据库架构

系统采用关系型数据库MySQL作为主数据库，Redis作为缓存和会话存储。

```
┌─────────────────────┐     ┌─────────────────────┐
│       MySQL         │     │        Redis        │
│  (主数据存储)        │     │  (缓存和会话存储)    │
└─────────────────────┘     └─────────────────────┘
```

### 4.2 数据存储分层

- **运营数据**：用户、课程、打卡、请假等业务数据
- **配置数据**：系统参数、同步配置等
- **日志数据**：同步日志、审计日志等
- **统计数据**：统计结果、报表数据等

### 4.3 数据库索引策略

- **主键索引**：所有表的主键
- **外键索引**：表之间的关联字段
- **复合索引**：常用查询条件组合
- **全文索引**：需要全文搜索的字段

### 4.4 关键表设计优化

- **用户表分片**：按用户类型分片存储
- **打卡记录分区**：按时间范围分区
- **统计数据预聚合**：针对常用统计维度预先聚合
- **日志表滚动**：按时间周期滚动日志表

## 5. 安全设计

### 5.1 认证授权机制

- **多因素认证**：账号密码 + 验证码
- **基于JWT的无状态认证**：生成安全令牌
- **细粒度权限控制**：基于RBAC模型
- **API访问控制**：基于OAuth 2.0

### 5.2 数据安全

- **传输加密**：全站HTTPS
- **数据存储加密**：敏感数据字段加密
- **访问审计**：记录关键操作日志
- **数据备份**：定期备份和灾备恢复

### 5.3 隐私保护

- **最小授权原则**：只收集必要的位置信息
- **数据脱敏**：展示数据时进行脱敏处理
- **数据生命周期管理**：定期清理过期数据
- **用户授权确认**：明确数据使用范围和目的

## 6. 性能优化

### 6.1 前端优化

- **按需加载**：组件和资源延迟加载
- **资源压缩**：JS/CSS压缩和代码分割
- **浏览器缓存**：合理设置缓存策略
- **预加载**：关键资源预加载

### 6.2 后端优化

- **接口缓存**：热点数据Redis缓存
- **数据库优化**：索引优化和查询优化
- **并发处理**：异步处理和任务队列
- **水平扩展**：服务实例动态扩缩容

### 6.3 同步性能优化

- **批量处理**：批量创建/更新数据
- **增量同步**：只同步变更数据
- **并行处理**：多线程并行处理
- **任务分片**：大任务分片处理

## 7. 监控与运维

### 7.1 系统监控

- **性能监控**：服务器资源使用情况
- **接口监控**：API响应时间和成功率
- **业务监控**：核心业务指标监控
- **日志监控**：异常日志实时告警

### 7.2 运维自动化

- **自动部署**：CI/CD自动化部署
- **配置管理**：集中式配置管理
- **容器化**：Docker容器化部署
- **服务编排**：Kubernetes服务编排

### 7.3 故障恢复

- **故障检测**：自动检测系统异常
- **故障隔离**：故障节点自动隔离
- **服务降级**：核心服务保障策略
- **数据恢复**：备份数据自动恢复

## 8. 扩展性设计

### 8.1 水平扩展

- **无状态服务**：支持多实例部署
- **数据分片**：支持数据水平分片
- **负载均衡**：请求自动分发
- **分布式缓存**：缓存集群共享

### 8.2 垂直扩展

- **服务拆分**：按业务领域拆分服务
- **异步通信**：服务间消息队列通信
- **事件驱动**：基于事件的服务协作
- **微服务治理**：服务发现和配置中心

### 8.3 接口扩展

- **API版本控制**：支持多版本API共存
- **扩展字段**：预留扩展字段
- **插件机制**：核心功能插件化扩展
- **钩子系统**：关键节点自定义处理 