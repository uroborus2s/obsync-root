# 课程表同步系统需求方案

## 1. 项目概述

### 1.1 项目背景
本项目旨在开发一个大学课程表同步应用程序，将原始课程数据库中的课程信息同步到WPS协作平台的日历和日程应用中，并提供打卡、请假等功能，以及出勤率统计和管理功能。通过此系统，可以实现教师和学生课程信息的统一管理和查看，提高教学管理效率。

### 1.2 项目目标
1. 实现课程数据从原始数据库到WPS协作平台的自动同步
2. 为教师和学生提供个性化的课程日历和日程
3. 开发课程打卡和请假功能
4. 提供课程出勤率统计和管理功能
5. 建立同步管理后台，便于运维人员监控和管理同步过程

### 1.3 用户角色定义
- **管理员**：负责系统配置、监控同步过程、查看统计数据
- **教师**：查看个人课程表、审批学生请假申请、查看课程出勤率
- **学生**：查看个人课程表、进行课程打卡、提交请假申请、查看个人出勤情况

## 2. 系统架构

### 2.1 总体架构
系统采用前后端分离架构，包括以下几个主要部分：
- 数据同步服务：定期从原始数据库获取数据并同步到WPS协作平台
- Web应用服务：提供用户界面和业务逻辑处理
- 数据存储服务：存储系统配置、同步记录、打卡记录等信息
- WPS协作平台API：第三方服务，用于创建和管理日历、日程和审批流

### 2.2 技术架构
- 前端：基于React框架开发的Web应用
- 后端：基于Node.js的API服务
- 数据库：MySQL关系型数据库
- 服务器：云服务器部署
- 第三方API：WPS协作平台开放API

### 2.3 数据流程
1. 数据同步服务定期从原始数据库获取课程安排表和学生课表数据
2. 系统处理数据，根据设定的规则生成日历和日程数据
3. 系统通过WPS协作平台API创建或更新用户的日历和日程
4. 用户通过Web应用进行打卡或请假操作，数据记录在系统数据库中
5. 系统根据打卡和请假记录生成出勤统计数据

## 3. 功能需求

### 3.1 数据同步功能

#### 3.1.1 用户账号同步
- **功能描述**：创建WPS协作平台用户账号，对应每个教师和学生
- **优先级**：高
- **实现细节**：
  - 从原始数据库获取教师工号和学生学号信息
  - 根据工号/学号生成WPS协作平台账号
  - 存储账号映射关系

#### 3.1.2 课程日历同步
- **功能描述**：为每个用户创建"课程表"日历
- **优先级**：高
- **实现细节**：
  - 调用WPS协作平台API创建日历
  - 设置日历名称为"课程表"
  - 设置日历权限和可见性

#### 3.1.3 课程日程同步
- **功能描述**：根据课程安排表和学生课表，创建对应的日程
- **优先级**：高
- **实现细节**：
  - 教师日程：根据课程安排表中的ghs字段，为每个教师创建对应的课程日程
  - 学生日程：根据学生课表和课程安排表，为每个学生创建对应的课程日程
  - 日程信息包括：课程名称、上课时间、下课时间、上课地点、授课教师等
  - 根据sfdk字段判断是否需要设置打卡提醒
  - 对同一天同一门课程进行分组处理，只在当天第一节课设置打卡和提醒

#### 3.1.4 课程变更同步
- **功能描述**：当原始数据中的课程信息发生变化时，同步更新相关日程
- **优先级**：高
- **实现细节**：
  - 定期检查原始数据库中的课程变更信息（通过zt字段识别add、update、delete操作）
  - 对于新增课程，创建新的日程
  - 对于更新课程，修改现有日程
  - 对于删除课程，取消现有日程

### 3.2 打卡功能

#### 3.2.1 课程打卡
- **功能描述**：学生通过Web应用进行课程打卡
- **优先级**：高
- **实现细节**：
  - 打卡入口：从日程详情页进入打卡页面
  - 打卡时间限制：课程开始前后15分钟内（可配置）
  - 位置验证：打卡时获取用户位置，验证是否在上课地点范围内
  - 打卡结果记录：记录打卡时间、位置等信息

#### 3.2.2 请假申请
- **功能描述**：学生通过Web应用提交请假申请
- **优先级**：高
- **实现细节**：
  - 请假条件：必须在课程开始前提交
  - 请假审批：创建WPS协作平台审批流，指定授课教师为审批人
  - 请假状态：待审批、已批准、已拒绝
  - 请假记录：记录请假原因、提交时间、审批时间、审批结果等

### 3.3 出勤管理功能

#### 3.3.1 出勤率统计
- **功能描述**：统计各维度的出勤率数据
- **优先级**：中
- **实现细节**：
  - 课程出勤率：每门课程的总体出勤率、每节课的出勤率
  - 学生出勤率：每个学生的总体出勤率、每门课程的出勤率
  - 学期出勤率：每个学期的总体出勤率

#### 3.3.2 出勤率排名
- **功能描述**：根据出勤率生成排名数据
- **优先级**：低
- **实现细节**：
  - 课程出勤率排名：各课程按出勤率排名
  - 学生出勤率排名：各学生按出勤率排名
  - 支持按学期、课程等多维度筛选排名

#### 3.3.3 出勤数据查询
- **功能描述**：提供多条件查询出勤数据的功能
- **优先级**：中
- **实现细节**：
  - 实时查询：支持按课程、学生、日期等条件实时查询出勤数据
  - 数据导出：支持将查询结果导出为Excel等格式

### 3.4 系统管理功能

#### 3.4.1 同步参数配置
- **功能描述**：配置数据同步的相关参数
- **优先级**：中
- **实现细节**：
  - 同步频次：设置数据同步的时间间隔
  - 提醒时间范围：设置课程提醒的提前时间
  - 打卡时间范围：设置允许打卡的时间范围

#### 3.4.2 同步过程管理
- **功能描述**：监控和管理数据同步过程
- **优先级**：中
- **实现细节**：
  - 查看同步状态：显示当前同步状态和进度
  - 查看同步日志：记录每次同步的详细信息
  - 手动触发同步：允许管理员手动启动同步过程

#### 3.4.3 系统用户管理
- **功能描述**：管理系统用户的账号和权限
- **优先级**：低
- **实现细节**：
  - 用户管理：创建、修改、禁用系统用户
  - 角色管理：设置用户角色和权限
  - 登录认证：用户登录和身份验证

## 4. 数据模型

### 4.1 原始数据表结构
系统将从以下两张原始数据表中获取数据：

#### 课程安排表
| 字段名称 | 字段类型 | 字段长度 | 字段说明 |
| -------- | -------- | -------- | -------- |
| kkh | varchar | 60 | 开课号 |
| xnxq | varchar | 20 | 学年学期 |
| jxz | int | 11 | 教学周1-18 |
| zc | int | 11 | 周几1-7 |
| jc | int | 11 | 节次1-10 |
| lq | varchar | 200 | 楼群 |
| room | varchar | 200 | 房间 |
| xq | varchar | 100 | 校区 |
| ghs | varchar | 255 | 教师工号组，逗号分割 |
| Xms | Varchar | 500 | 教师姓名组，逗号分割 |
| lx | varchar | 10 | 类型 |
| bz | varchar | 255 | 备注 |
| lc | varchar | 255 | 楼层 |
| rq | varchar | 255 | 日期 |
| st | varchar | 255 | 开始时间 |
| ed | varchar | 255 | 结束时间 |
| sj | varchar | 255 | 状态库时间标识 |
| zt | varchar | 30 | 状态标识：add、update、delete |
| kcmc | varchar | 200 | 课程名称 |
| sfdk | Smallint | | 是否打卡0-1，有些课程仅给老师占位用，给老师提供日历，没有打卡需求 |

#### 学生课表
| 字段名称 | 字段类型 | 字段长度 | 字段说明 |
| -------- | -------- | -------- | -------- |
| kkh | varchar | 60 | 开课号 |
| xh | varchar | 40 | 学生编号 |
| xnxq | varchar | 20 | 学年学期 |
| kcbh | varchar | 40 | 课程编号 |

### 4.2 系统数据表设计

系统需要设计以下数据表：

#### 用户表（users）
| 字段名 | 类型 | 说明 |
| ------ | ---- | ---- |
| id | int | 主键 |
| user_type | varchar | 用户类型（教师/学生） |
| user_code | varchar | 用户编号（工号/学号） |
| user_name | varchar | 用户姓名 |
| wps_account | varchar | WPS协作平台账号 |
| wps_calendar_id | varchar | WPS日历ID |
| create_time | datetime | 创建时间 |
| update_time | datetime | 更新时间 |

#### 课程表（courses）
| 字段名 | 类型 | 说明 |
| ------ | ---- | ---- |
| id | int | 主键 |
| kkh | varchar | 开课号 |
| kcbh | varchar | 课程编号 |
| kcmc | varchar | 课程名称 |
| xnxq | varchar | 学年学期 |
| need_check | tinyint | 是否需要打卡 |
| create_time | datetime | 创建时间 |
| update_time | datetime | 更新时间 |

#### 课程安排表（course_arrangements）
| 字段名 | 类型 | 说明 |
| ------ | ---- | ---- |
| id | int | 主键 |
| course_id | int | 课程ID |
| jxz | int | 教学周 |
| zc | int | 周几 |
| jc | int | 节次 |
| location | varchar | 上课地点 |
| start_time | datetime | 开始时间 |
| end_time | datetime | 结束时间 |
| teacher_ids | varchar | 教师ID，逗号分隔 |
| status | varchar | 状态 |
| create_time | datetime | 创建时间 |
| update_time | datetime | 更新时间 |

#### 日程表（schedules）
| 字段名 | 类型 | 说明 |
| ------ | ---- | ---- |
| id | int | 主键 |
| user_id | int | 用户ID |
| course_arrangement_id | int | 课程安排ID |
| wps_event_id | varchar | WPS日程ID |
| is_first_class | tinyint | 是否当天第一节课 |
| create_time | datetime | 创建时间 |
| update_time | datetime | 更新时间 |

#### 打卡记录表（check_records）
| 字段名 | 类型 | 说明 |
| ------ | ---- | ---- |
| id | int | 主键 |
| user_id | int | 用户ID |
| schedule_id | int | 日程ID |
| check_time | datetime | 打卡时间 |
| location | varchar | 打卡位置 |
| status | varchar | 状态（正常/迟到/早退） |
| create_time | datetime | 创建时间 |

#### 请假记录表（leave_records）
| 字段名 | 类型 | 说明 |
| ------ | ---- | ---- |
| id | int | 主键 |
| user_id | int | 用户ID |
| schedule_id | int | 日程ID |
| reason | varchar | 请假原因 |
| apply_time | datetime | 申请时间 |
| wps_approval_id | varchar | WPS审批流ID |
| status | varchar | 状态（待审批/已批准/已拒绝） |
| approval_time | datetime | 审批时间 |
| approver_id | int | 审批人ID |
| create_time | datetime | 创建时间 |
| update_time | datetime | 更新时间 |

#### 系统配置表（system_configs）
| 字段名 | 类型 | 说明 |
| ------ | ---- | ---- |
| id | int | 主键 |
| config_key | varchar | 配置键 |
| config_value | varchar | 配置值 |
| description | varchar | 描述 |
| create_time | datetime | 创建时间 |
| update_time | datetime | 更新时间 |

#### 同步记录表（sync_logs）
| 字段名 | 类型 | 说明 |
| ------ | ---- | ---- |
| id | int | 主键 |
| sync_type | varchar | 同步类型 |
| start_time | datetime | 开始时间 |
| end_time | datetime | 结束时间 |
| status | varchar | 状态 |
| total_count | int | 总记录数 |
| success_count | int | 成功数 |
| fail_count | int | 失败数 |
| error_message | text | 错误信息 |
| create_time | datetime | 创建时间 |

## 5. 界面设计

### 5.1 学生端

#### 5.1.1 课程表页面
- 日历视图：显示课程安排，支持周视图、月视图切换
- 日程详情：点击日程查看详情，包括课程名称、时间、地点、教师等信息
- 操作按钮：进入打卡、请假界面的入口

#### 5.1.2 打卡页面
- 课程信息：显示当前课程的基本信息
- 位置信息：显示当前位置和上课地点
- 打卡按钮：用于提交打卡
- 打卡状态：显示打卡结果（成功/失败）和原因

#### 5.1.3 请假页面
- 课程信息：显示请假课程的基本信息
- 请假表单：填写请假原因等信息
- 提交按钮：提交请假申请
- 请假记录：显示历史请假记录和状态

#### 5.1.4 个人出勤统计页面
- 总体出勤统计：显示总体出勤率、缺勤次数等
- 课程出勤统计：按课程显示出勤情况
- 出勤明细：显示每次课程的出勤记录
- 筛选功能：支持按时间、课程等条件筛选数据

### 5.2 教师端

#### 5.2.1 课程表页面
- 与学生端类似，显示教师的课程安排
- 增加课程学生列表功能，可查看每门课的学生名单

#### 5.2.2 请假审批页面
- 待审批列表：显示学生提交的请假申请
- 审批操作：同意/拒绝请假申请
- 历史审批：查看历史审批记录

#### 5.2.3 课程出勤管理页面
- 课程选择：选择要查看的课程
- 出勤统计：显示课程总体出勤率
- 学生列表：显示每个学生的出勤情况
- 出勤明细：显示每次课程的出勤记录
- 导出功能：支持导出出勤数据

### 5.3 管理员端

#### 5.3.1 系统配置页面
- 同步配置：设置同步频次、提醒时间范围、打卡时间范围等参数
- 位置配置：设置各教学楼的地理位置范围
- 其他配置：其他系统参数设置

#### 5.3.2 同步管理页面
- 同步状态：显示当前同步状态和进度
- 同步日志：显示历史同步记录
- 手动同步：手动触发数据同步
- 同步统计：显示同步成功率、失败原因等统计数据

#### 5.3.3 出勤统计页面
- 多维度统计：支持按学期、学院、专业、班级、课程等多维度统计出勤数据
- 数据可视化：使用图表展示统计结果
- 导出功能：支持导出统计数据
- 排名功能：显示出勤率排名

## 6. 技术实现

### 6.1 数据同步实现

#### 6.1.1 同步策略
- 定时同步：系统定期（如每小时）从原始数据库获取数据并进行同步
- 增量同步：根据zt字段，只处理变更的数据
- 错误重试：同步失败的数据会进行重试
- 日志记录：记录同步过程的详细信息

#### 6.1.2 WPS协作平台API调用
- 创建日历：为每个用户创建课程表日历
- 创建日程：根据课程安排创建日程
- 更新日程：根据课程变更更新日程
- 取消日程：根据课程取消情况取消日程
- 创建审批流：为请假申请创建审批流

### 6.2 打卡功能实现

#### 6.2.1 位置验证
- 使用浏览器定位API获取用户当前位置
- 将用户位置与配置的教学楼位置范围进行比对
- 只有在有效范围内才允许打卡

#### 6.2.2 时间验证
- 根据课程开始时间和结束时间，计算有效打卡时间范围
- 只有在有效时间范围内才允许打卡

### 6.3 出勤统计实现

#### 6.3.1 统计算法
- 正常出勤：成功打卡或请假获批
- 缺勤：未打卡且未请假或请假未获批
- 出勤率计算：正常出勤次数 / 总课程次数

#### 6.3.2 实时查询
- 使用缓存技术提高查询效率
- 设计合理的索引加速查询
- 使用异步加载减少页面加载时间

## 7. 安全措施

### 7.1 账号安全
- 用户认证：登录时进行身份验证
- 权限控制：基于角色的权限控制，限制用户只能访问和操作其权限范围内的数据
- 密码保护：使用加密算法存储密码

### 7.2 数据安全
- 数据加密：敏感数据进行加密存储
- 数据备份：定期备份数据，防止数据丢失
- 访问控制：严格控制数据库访问权限

### 7.3 接口安全
- API认证：使用Token或其他方式进行API调用认证
- 参数验证：验证API参数，防止非法请求
- 日志记录：记录API调用日志，便于追溯

## 8. 系统部署

### 8.1 部署架构
- Web服务器：Nginx
- 应用服务器：Node.js
- 数据库服务器：MySQL
- 缓存服务器：Redis
- 文件服务器：用于存储日志等文件

### 8.2 性能优化
- 服务器集群：使用多台服务器构建集群，提高并发处理能力
- 负载均衡：使用负载均衡器分配请求，平衡服务器负载
- 数据缓存：使用缓存减少数据库访问，提高响应速度
- 代码优化：优化代码，减少资源消耗

### 8.3 监控告警
- 系统监控：监控服务器资源使用情况
- 应用监控：监控应用运行状态和性能
- 异常告警：出现异常情况时及时告警
- 日志分析：分析系统日志，发现潜在问题

## 9. 实施计划

### 9.1 开发阶段
1. 需求分析与设计/数据库设计与开发：1周
2. 后端API开发：2周
3. 前端界面开发：2周
4. 系统集成与联调：2周
5. 测试与修复：1周

### 9.2 测试阶段
1. 单元测试：验证各模块功能
2. 集成测试：验证模块间交互
3. 系统测试：验证整体系统功能
4. 性能测试：测试系统在高负载下的表现
5. 用户验收测试：用户参与测试，验证系统是否满足需求

### 9.3 上线阶段
1. 环境准备：准备生产环境
2. 数据准备：准备初始数据
3. 系统部署：部署系统到生产环境
4. 切换上线：正式上线系统
5. 运行监控：监控系统运行情况，及时处理问题

## 10. 风险与应对措施

### 10.1 可能的风险
1. 数据同步延迟：原始数据变更未及时同步到WPS协作平台
2. 系统负载过高：高峰期用户并发访问导致系统负载过高
3. 打卡定位不准：GPS定位误差导致正常打卡失败
4. WPS协作平台API不稳定：API调用失败影响系统功能
5. 数据安全风险：用户数据泄露风险

### 10.2 应对措施
1. 优化同步机制，减少同步延迟；增加同步状态监控，出现异常及时处理
2. 采用集群部署，增强系统并发处理能力；实施合理的资源扩展策略
3. 扩大打卡有效范围，考虑位置误差因素；提供打卡问题反馈渠道
4. 增加API调用重试机制；建立API调用日志，便于问题定位
5. 加强数据加密和权限控制；定期进行安全审计和漏洞修复

## 11. 附录

### 11.1 术语表
- WPS协作平台：金山办公提供的协同办公平台
- 开课号（kkh）：唯一标识一门课程的编号
- 日历：WPS协作平台中用于组织日程的容器
- 日程：WPS协作平台中表示具体活动的基本单位
- 打卡：学生通过系统记录课程出勤的行为
- 请假：学生因故无法上课，提前申请并获得批准的行为

### 11.2 参考文档
- WPS协作平台API文档
- 原始数据库说明文档
- 相关法规和教学管理规定 