# 课程考勤数据分享功能实现指南

本文档提供详细的代码实现示例和步骤说明。

---

## 1. 数据库表创建

### 1.1 创建导出记录表

**文件路径**: `apps/app-icalink/database/tables/icalink_attendance_export_records.sql`

```sql
-- 考勤数据导出记录表
CREATE TABLE IF NOT EXISTS icalink_attendance_export_records (
  id INT AUTO_INCREMENT PRIMARY KEY,
  
  -- 任务标识
  task_id VARCHAR(64) NOT NULL UNIQUE COMMENT '任务ID（UUID）',
  
  -- 导出类型
  export_type ENUM('realtime', 'history') NOT NULL COMMENT '导出类型',
  
  -- 课程信息
  course_id INT COMMENT '课程ID（实时数据）',
  course_code VARCHAR(50) COMMENT '课程代码（历史数据）',
  course_name VARCHAR(200) COMMENT '课程名称',
  
  -- 查询参数（用于缓存判断）
  query_params JSON COMMENT '查询参数（JSON格式）',
  query_hash VARCHAR(64) NOT NULL COMMENT '查询参数哈希（用于去重）',
  
  -- 文件信息
  file_name VARCHAR(255) NOT NULL COMMENT '文件名',
  file_path VARCHAR(500) NOT NULL COMMENT 'OSS文件路径',
  file_size BIGINT COMMENT '文件大小（字节）',
  
  -- 任务状态
  status ENUM('pending', 'processing', 'completed', 'failed') NOT NULL DEFAULT 'pending' COMMENT '任务状态',
  progress INT DEFAULT 0 COMMENT '进度百分比（0-100）',
  error_message TEXT COMMENT '错误信息',
  
  -- 统计信息
  record_count INT COMMENT '记录数量',
  
  -- 时间戳
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP COMMENT '创建时间',
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT '更新时间',
  completed_at TIMESTAMP NULL COMMENT '完成时间',
  expires_at TIMESTAMP NULL COMMENT '过期时间（文件有效期）',
  
  -- 创建者
  created_by VARCHAR(50) COMMENT '创建者ID',
  
  -- 索引
  INDEX idx_task_id (task_id),
  INDEX idx_query_hash (query_hash),
  INDEX idx_export_type (export_type),
  INDEX idx_course_code (course_code),
  INDEX idx_status (status),
  INDEX idx_created_at (created_at),
  INDEX idx_expires_at (expires_at)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='考勤数据导出记录表';
```

---

## 2. 类型定义

### 2.1 导出记录类型

**文件路径**: `apps/app-icalink/src/types/attendance-export.types.ts`

```typescript
import type { ColumnType } from 'kysely';

/**
 * 导出类型枚举
 */
export enum AttendanceExportType {
  REALTIME = 'realtime',
  HISTORY = 'history'
}

/**
 * 导出任务状态枚举
 */
export enum AttendanceExportStatus {
  PENDING = 'pending',
  PROCESSING = 'processing',
  COMPLETED = 'completed',
  FAILED = 'failed'
}

/**
 * 考勤数据导出记录表实体
 */
export interface IcalinkAttendanceExportRecord {
  id: ColumnType<number, number | undefined, number>;
  task_id: string;
  export_type: AttendanceExportType;
  course_id?: number;
  course_code?: string;
  course_name?: string;
  query_params?: any;
  query_hash: string;
  file_name: string;
  file_path: string;
  file_size?: number;
  status: AttendanceExportStatus;
  progress: number;
  error_message?: string;
  record_count?: number;
  created_at: ColumnType<Date, string, string>;
  updated_at: ColumnType<Date, string, string>;
  completed_at?: Date;
  expires_at?: Date;
  created_by?: string;
}

/**
 * 实时数据导出请求参数
 */
export interface RealtimeExportRequest {
  courseId: number;
  externalId?: string;
}

/**
 * 历史统计数据导出请求参数
 */
export interface HistoryExportRequest {
  courseCode: string;
  sortField?: string;
  sortOrder?: 'asc' | 'desc';
}

/**
 * 导出任务响应
 */
export interface ExportTaskResponse {
  taskId: string;
  status: AttendanceExportStatus;
  downloadUrl?: string;
  cacheHit?: boolean;
  progress?: number;
  error?: string;
}
```

### 2.2 更新数据库类型定义

**文件路径**: `apps/app-icalink/src/types/database.ts`

在 `IcalinkDatabase` 接口中添加新表:

```typescript
export interface IcalinkDatabase {
  // ... 现有表定义
  icalink_attendance_export_records: IcalinkAttendanceExportRecord;
}
```

---

## 3. Repository层实现

### 3.1 AttendanceExportRecordRepository

**文件路径**: `apps/app-icalink/src/repositories/AttendanceExportRecordRepository.ts`

```typescript
import { BaseRepository } from '@stratix/core';
import type { Logger } from '@stratix/core';
import type { Database } from '@stratix/kysely';
import type {
  IcalinkAttendanceExportRecord,
  AttendanceExportStatus
} from '../types/attendance-export.types.js';
import type { IcalinkDatabase } from '../types/database.js';

/**
 * 考勤数据导出记录仓储
 */
export default class AttendanceExportRecordRepository extends BaseRepository<
  IcalinkDatabase,
  'icalink_attendance_export_records',
  IcalinkAttendanceExportRecord
> {
  constructor(db: Database<IcalinkDatabase>, logger: Logger) {
    super(db, 'icalink_attendance_export_records', logger);
    this.logger.info('✅ AttendanceExportRecordRepository initialized');
  }

  /**
   * 根据任务ID查询记录
   */
  async findByTaskId(
    taskId: string
  ): Promise<IcalinkAttendanceExportRecord | null> {
    const result = await this.findOne((qb) =>
      qb.where('task_id', '=', taskId)
    );

    if (result && (result as any).isSome && (result as any).isSome()) {
      return (result as any).value as IcalinkAttendanceExportRecord;
    }

    return null;
  }

  /**
   * 根据查询哈希查找已完成的记录（用于缓存判断）
   */
  async findCompletedByQueryHash(
    queryHash: string
  ): Promise<IcalinkAttendanceExportRecord | null> {
    const result = await this.findOne((qb) =>
      qb
        .where('query_hash', '=', queryHash)
        .where('status', '=', 'completed')
        .where('expires_at', '>', new Date())
        .orderBy('created_at', 'desc')
    );

    if (result && (result as any).isSome && (result as any).isSome()) {
      return (result as any).value as IcalinkAttendanceExportRecord;
    }

    return null;
  }

  /**
   * 更新任务状态
   */
  async updateTaskStatus(
    taskId: string,
    status: AttendanceExportStatus,
    updates?: {
      progress?: number;
      error_message?: string;
      file_path?: string;
      file_size?: number;
      record_count?: number;
      completed_at?: Date;
    }
  ): Promise<void> {
    const updateData: any = { status };

    if (updates) {
      if (updates.progress !== undefined) updateData.progress = updates.progress;
      if (updates.error_message) updateData.error_message = updates.error_message;
      if (updates.file_path) updateData.file_path = updates.file_path;
      if (updates.file_size) updateData.file_size = updates.file_size;
      if (updates.record_count) updateData.record_count = updates.record_count;
      if (updates.completed_at) updateData.completed_at = updates.completed_at;
    }

    await this.update((qb) => qb.where('task_id', '=', taskId), updateData);
  }

  /**
   * 查询过期的记录
   */
  async findExpiredRecords(): Promise<IcalinkAttendanceExportRecord[]> {
    return await this.findMany((qb) =>
      qb.where('expires_at', '<', new Date())
    );
  }

  /**
   * 删除过期记录
   */
  async deleteExpiredRecords(): Promise<number> {
    const result = await this.delete((qb) =>
      qb.where('expires_at', '<', new Date())
    );

    return Number(result);
  }
}
```

---

## 4. Service层实现

### 4.1 AttendanceExportService接口

**文件路径**: `apps/app-icalink/src/services/AttendanceExportService.ts`

```typescript
import type { Logger } from '@stratix/core';
import type { Either } from '@stratix/fp';
import type { ServiceError, ServiceResult } from '@stratix/core';
import type AttendanceExportRecordRepository from '../repositories/AttendanceExportRecordRepository.js';
import type AttendanceTodayViewRepository from '../repositories/AttendanceTodayViewRepository.js';
import type StudentAbsenceRateDetailService from './StudentAbsenceRateDetailService.js';
import type OsspStorageService from './OsspStorageService.js';
import type {
  RealtimeExportRequest,
  HistoryExportRequest,
  ExportTaskResponse,
  AttendanceExportStatus
} from '../types/attendance-export.types.js';
import { v4 as uuidv4 } from 'uuid';
import crypto from 'crypto';
import ExcelJS from 'exceljs';

/**
 * 考勤数据导出服务接口
 */
export interface IAttendanceExportService {
  /**
   * 导出实时数据
   */
  exportRealtimeData(
    request: RealtimeExportRequest,
    userId?: string
  ): Promise<ServiceResult<ExportTaskResponse>>;

  /**
   * 导出历史统计数据
   */
  exportHistoryData(
    request: HistoryExportRequest,
    userId?: string
  ): Promise<ServiceResult<ExportTaskResponse>>;

  /**
   * 查询任务状态
   */
  getTaskStatus(taskId: string): Promise<ServiceResult<ExportTaskResponse>>;

  /**
   * 下载文件
   */
  downloadFile(
    taskId: string
  ): Promise<Either<ServiceError, { fileName: string; fileContent: Buffer }>>;
}

/**
 * 考勤数据导出服务实现
 */
export default class AttendanceExportService
  implements IAttendanceExportService
{
  constructor(
    private readonly logger: Logger,
    private readonly exportRecordRepository: AttendanceExportRecordRepository,
    private readonly attendanceTodayViewRepository: AttendanceTodayViewRepository,
    private readonly studentAbsenceRateDetailService: StudentAbsenceRateDetailService,
    private readonly osspStorageService: OsspStorageService
  ) {
    this.logger.info('✅ AttendanceExportService initialized');
  }

  /**
   * 导出实时数据
   */
  async exportRealtimeData(
    request: RealtimeExportRequest,
    userId?: string
  ): Promise<ServiceResult<ExportTaskResponse>> {
    try {
      const { courseId } = request;

      // 1. 创建任务记录
      const taskId = uuidv4();
      const queryHash = this.generateQueryHash({ courseId });
      const fileName = `实时考勤数据_${courseId}_${Date.now()}.xlsx`;

      await this.exportRecordRepository.create({
        task_id: taskId,
        export_type: 'realtime',
        course_id: courseId,
        query_hash: queryHash,
        file_name: fileName,
        file_path: '', // 稍后更新
        status: 'pending',
        progress: 0,
        created_by: userId,
        expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7天后过期
      } as any);

      // 2. 异步执行导出任务（这里简化为同步执行，实际应使用Executor）
      this.executeRealtimeExport(taskId, courseId).catch((error) => {
        this.logger.error('实时数据导出失败', { taskId, error });
      });

      return {
        success: true,
        data: {
          taskId,
          status: 'pending' as AttendanceExportStatus
        }
      };
    } catch (error) {
      this.logger.error('创建实时数据导出任务失败', { error });
      return {
        success: false,
        error: '创建导出任务失败'
      };
    }
  }

  /**
   * 导出历史统计数据
   */
  async exportHistoryData(
    request: HistoryExportRequest,
    userId?: string
  ): Promise<ServiceResult<ExportTaskResponse>> {
    try {
      const { courseCode, sortField = 'absence_rate', sortOrder = 'desc' } = request;

      // 1. 计算查询哈希
      const queryHash = this.generateQueryHash({ courseCode, sortField, sortOrder });

      // 2. 检查缓存
      const cachedRecord = await this.exportRecordRepository.findCompletedByQueryHash(
        queryHash
      );

      if (cachedRecord) {
        this.logger.info('命中缓存', { queryHash, taskId: cachedRecord.task_id });
        return {
          success: true,
          data: {
            taskId: cachedRecord.task_id,
            status: 'completed' as AttendanceExportStatus,
            downloadUrl: `/api/icalink/v1/attendance/export/download/${cachedRecord.task_id}`,
            cacheHit: true
          }
        };
      }

      // 3. 创建新任务
      const taskId = uuidv4();
      const fileName = `课程缺勤统计_${courseCode}_${Date.now()}.xlsx`;

      await this.exportRecordRepository.create({
        task_id: taskId,
        export_type: 'history',
        course_code: courseCode,
        query_params: { courseCode, sortField, sortOrder },
        query_hash: queryHash,
        file_name: fileName,
        file_path: '', // 稍后更新
        status: 'pending',
        progress: 0,
        created_by: userId,
        expires_at: new Date(Date.now() + 7 * 24 * 60 * 60 * 1000) // 7天后过期
      } as any);

      // 4. 异步执行导出任务
      this.executeHistoryExport(taskId, courseCode, sortField, sortOrder).catch(
        (error) => {
          this.logger.error('历史数据导出失败', { taskId, error });
        }
      );

      return {
        success: true,
        data: {
          taskId,
          status: 'pending' as AttendanceExportStatus,
          cacheHit: false
        }
      };
    } catch (error) {
      this.logger.error('创建历史数据导出任务失败', { error });
      return {
        success: false,
        error: '创建导出任务失败'
      };
    }
  }

  // ... 其他方法实现见下一部分
}
```

---

## 5. 下一步实现

由于文档长度限制，以下内容将在后续文档中继续：

1. **Service层完整实现**（Excel生成逻辑）
2. **Executor层实现**（异步任务执行）
3. **Controller层实现**（HTTP接口）
4. **前端组件实现**（分享对话框）
5. **集成测试**

请参考：
- `docs/课程考勤数据分享功能实现指南-Part2.md`（Service层完整实现）
- `docs/课程考勤数据分享功能实现指南-Part3.md`（Executor和Controller层）
- `docs/课程考勤数据分享功能实现指南-Part4.md`（前端实现）

