# éƒ¨é—¨å­åˆ—è¡¨æ€§èƒ½ä¼˜åŒ– - æ ¹éƒ¨é—¨åˆ¤æ–­ä¼˜åŒ–

## ğŸ“‹ ä¼˜åŒ–æ¦‚è¿°

ä¼˜åŒ– `getDepartmentChildren` æ–¹æ³•çš„æ ¹éƒ¨é—¨åˆ¤æ–­é€»è¾‘ï¼Œé€šè¿‡å‰ç«¯ä¼ é€’æ ¹éƒ¨é—¨ ID æ¥é¿å…åç«¯é¢å¤–çš„ API è°ƒç”¨ï¼Œæå‡ç»„ç»‡æ¶æ„æ ‘çš„åŠ è½½æ€§èƒ½ã€‚

---

## âš ï¸ ä¼˜åŒ–å‰çš„é—®é¢˜

### æ€§èƒ½ç“¶é¢ˆ

**é—®é¢˜æè¿°ï¼š**
- æ¯æ¬¡è°ƒç”¨ `getDepartmentChildren` éƒ½ä¼šé¢å¤–è°ƒç”¨ `batchGetDeptInfo` API æ¥åˆ¤æ–­å½“å‰éƒ¨é—¨æ˜¯å¦ä¸ºæ ¹éƒ¨é—¨
- è¿™å¢åŠ äº†ä¸å¿…è¦çš„ HTTP è¯·æ±‚å¼€é”€ï¼ˆçº¦ 50-100msï¼‰
- åœ¨ç»„ç»‡æ¶æ„æ ‘å±•å¼€å¤šä¸ªèŠ‚ç‚¹æ—¶ï¼Œç´¯ç§¯çš„å»¶è¿Ÿä¼šå½±å“ç”¨æˆ·ä½“éªŒ

**åŸå§‹å®ç°ï¼š**
```typescript
// Service å±‚ - æ¯æ¬¡éƒ½è°ƒç”¨ API
const parentDeptResult = await this.wasV7ApiDepartment.batchGetDeptInfo({
  dept_ids: [deptId]
});

const parentDept = parentDeptResult.items[0];
const isRootDept = parentDept && parentDept.parent_id === parentDept.id;
```

**æ€§èƒ½å½±å“ï¼š**
- æ¯æ¬¡å±•å¼€èŠ‚ç‚¹ï¼š2 æ¬¡ HTTP è¯·æ±‚ï¼ˆ1 æ¬¡ `batchGetDeptInfo` + 1 æ¬¡ `getDeptChildren`ï¼‰
- å±•å¼€ 10 ä¸ªèŠ‚ç‚¹ï¼š20 æ¬¡ HTTP è¯·æ±‚
- æ€»å»¶è¿Ÿï¼š500-1000msï¼ˆå‡è®¾æ¯æ¬¡è¯·æ±‚ 50-100msï¼‰

---

## âœ… ä¼˜åŒ–æ–¹æ¡ˆ

### æ ¸å¿ƒæ€è·¯

**ä¼˜åŒ–ç­–ç•¥ï¼š**
1. å‰ç«¯åœ¨è·å–æ ¹éƒ¨é—¨ä¿¡æ¯åï¼Œç¼“å­˜æ ¹éƒ¨é—¨çš„ `id`
2. å‰ç«¯è°ƒç”¨ `getDepartmentChildren` æ¥å£æ—¶ï¼Œé€šè¿‡ URL å‚æ•°ä¼ é€’æ ¹éƒ¨é—¨ ID
3. åç«¯é€šè¿‡æ¯”è¾ƒ `deptId === rootDeptId` æ¥åˆ¤æ–­æ˜¯å¦ä¸ºæ ¹éƒ¨é—¨ï¼Œé¿å…é¢å¤–çš„ API è°ƒç”¨
4. ä¿æŒå‘åå…¼å®¹æ€§ï¼šå¦‚æœå‰ç«¯æœªä¼ é€’ `rootDeptId`ï¼Œåç«¯ä»ä½¿ç”¨åŸæœ‰çš„ API è°ƒç”¨æ–¹å¼

### ä¼˜åŒ–æ•ˆæœ

**æ€§èƒ½æå‡ï¼š**
- æ¯æ¬¡å±•å¼€èŠ‚ç‚¹ï¼š1 æ¬¡ HTTP è¯·æ±‚ï¼ˆä»… `getDeptChildren`ï¼‰
- å±•å¼€ 10 ä¸ªèŠ‚ç‚¹ï¼š10 æ¬¡ HTTP è¯·æ±‚
- æ€»å»¶è¿Ÿï¼š250-500msï¼ˆå‡å°‘ 50%ï¼‰

**å‘åå…¼å®¹ï¼š**
- æ—§ç‰ˆæœ¬å‰ç«¯ä»å¯æ­£å¸¸å·¥ä½œ
- æ–°ç‰ˆæœ¬å‰ç«¯äº«å—æ€§èƒ½æå‡

---

## ğŸ”§ å®ç°ç»†èŠ‚

### 1. Service å±‚æ¥å£å®šä¹‰

**æ–‡ä»¶ï¼š** `apps/app-icalink/src/services/interfaces/IDepartmentService.ts`

**ä¿®æ”¹å†…å®¹ï¼š**
```typescript
/**
 * è·å–å­éƒ¨é—¨åˆ—è¡¨
 * @param deptId éƒ¨é—¨ID
 * @param pageSize åˆ†é¡µå¤§å°ï¼ˆå¯é€‰ï¼Œé»˜è®¤10ï¼Œæœ€å¤§50ï¼‰
 * @param pageToken åˆ†é¡µæ ‡è®°ï¼ˆå¯é€‰ï¼‰
 * @param withTotal æ˜¯å¦è¿”å›æ€»æ•°ï¼ˆå¯é€‰ï¼‰
 * @param rootDeptId æ ¹éƒ¨é—¨IDï¼ˆå¯é€‰ï¼Œç”¨äºä¼˜åŒ–æ€§èƒ½ï¼Œé¿å…é¢å¤–çš„APIè°ƒç”¨ï¼‰
 * @returns å­éƒ¨é—¨åˆ—è¡¨å“åº”
 */
getDepartmentChildren(
  deptId: string,
  pageSize?: number,
  pageToken?: string,
  withTotal?: boolean,
  rootDeptId?: string  // æ–°å¢å‚æ•°
): Promise<{
  success: boolean;
  data?: GetDeptChildrenResponse;
  error?: string;
}>;
```

### 2. Service å±‚å®ç°

**æ–‡ä»¶ï¼š** `apps/app-icalink/src/services/DepartmentService.ts`

**æ ¸å¿ƒé€»è¾‘ï¼š**
```typescript
// åˆ¤æ–­æ˜¯å¦ä¸ºæ ¹éƒ¨é—¨
let isRootDept = false;

if (rootDeptId) {
  // æ€§èƒ½ä¼˜åŒ–ï¼šå¦‚æœä¼ å…¥äº†æ ¹éƒ¨é—¨IDï¼Œç›´æ¥æ¯”è¾ƒ
  isRootDept = deptId === rootDeptId;
  this.logger.debug('Using provided rootDeptId for comparison', {
    deptId,
    rootDeptId,
    isRootDept
  });
} else {
  // å‘åå…¼å®¹ï¼šå¦‚æœæœªä¼ å…¥æ ¹éƒ¨é—¨IDï¼Œè°ƒç”¨APIæŸ¥è¯¢
  this.logger.debug('rootDeptId not provided, fetching parent department info');

  const parentDeptResult = await this.wasV7ApiDepartment.batchGetDeptInfo({
    dept_ids: [deptId]
  });

  const parentDept = parentDeptResult.items[0];
  isRootDept = parentDept && parentDept.parent_id === parentDept.id;

  this.logger.debug('Parent department info', {
    deptId,
    deptName: parentDept?.name,
    parentId: parentDept?.parent_id,
    isRootDept
  });
}
```

**æ—¥å¿—è¾“å‡ºï¼š**
```typescript
this.logger.debug('Getting department children', {
  deptId,
  pageSize,
  pageToken,
  withTotal,
  rootDeptId  // æ–°å¢æ—¥å¿—å­—æ®µ
});
```

### 3. Controller å±‚

**æ–‡ä»¶ï¼š** `apps/app-icalink/src/controllers/StatsController.ts`

**Schema å®šä¹‰ï¼š**
```typescript
querystring: {
  type: 'object',
  properties: {
    page_size: { type: 'integer', minimum: 1, maximum: 50 },
    page_token: { type: 'string' },
    with_total: { type: 'boolean' },
    root_dept_id: { type: 'string' }  // æ–°å¢æŸ¥è¯¢å‚æ•°
  }
}
```

**TypeScript ç±»å‹ï¼š**
```typescript
async getDepartmentChildren(
  request: FastifyRequest<{
    Params: { deptId: string };
    Querystring: {
      page_size?: number;
      page_token?: string;
      with_total?: boolean;
      root_dept_id?: string;  // æ–°å¢ç±»å‹å®šä¹‰
    };
  }>,
  reply: FastifyReply
): Promise<void>
```

**å‚æ•°ä¼ é€’ï¼š**
```typescript
const { deptId } = request.params;
const { page_size, page_token, with_total, root_dept_id } = request.query;

const result = await this.departmentService.getDepartmentChildren(
  deptId,
  page_size,
  page_token,
  with_total,
  root_dept_id  // ä¼ é€’æ ¹éƒ¨é—¨ID
);
```

### 4. å‰ç«¯å®ç°

**æ–‡ä»¶ï¼š** `apps/agendaedu-web/src/features/attendance/components/student-absence-stats.tsx`

**ä¿®æ”¹å†…å®¹ï¼š**
```typescript
// å¾ªç¯è·å–æ‰€æœ‰é¡µçš„æ•°æ®
do {
  const url = new URL(
    `/api/icalink/v1/depts/${deptId}/children`,
    window.location.origin
  )
  url.searchParams.set('page_size', '50')
  if (pageToken) {
    url.searchParams.set('page_token', pageToken)
  }
  // æ€§èƒ½ä¼˜åŒ–ï¼šä¼ é€’æ ¹éƒ¨é—¨IDï¼Œé¿å…åç«¯é¢å¤–çš„APIè°ƒç”¨
  if (rootDept?.id) {
    url.searchParams.set('root_dept_id', rootDept.id)
  }

  const response = await fetch(url.toString())
  // ...
} while (pageToken)
```

**å…³é”®ç‚¹ï¼š**
- ä½¿ç”¨ `rootDept?.id` å®‰å…¨è®¿é—®æ ¹éƒ¨é—¨ ID
- åªæœ‰åœ¨æ ¹éƒ¨é—¨æ•°æ®åŠ è½½å®Œæˆåæ‰ä¼šä¼ é€’å‚æ•°
- ä¸å½±å“ç°æœ‰çš„åˆ†é¡µé€»è¾‘

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### ä¼˜åŒ–å‰

| æ“ä½œ | HTTP è¯·æ±‚æ¬¡æ•° | é¢„ä¼°å»¶è¿Ÿ |
|------|--------------|---------|
| å±•å¼€æ ¹èŠ‚ç‚¹ | 2 æ¬¡ï¼ˆbatchGetDeptInfo + getDeptChildrenï¼‰ | 100-200ms |
| å±•å¼€å­èŠ‚ç‚¹ | 2 æ¬¡ï¼ˆbatchGetDeptInfo + getDeptChildrenï¼‰ | 100-200ms |
| å±•å¼€ 10 ä¸ªèŠ‚ç‚¹ | 20 æ¬¡ | 1000-2000ms |

### ä¼˜åŒ–å

| æ“ä½œ | HTTP è¯·æ±‚æ¬¡æ•° | é¢„ä¼°å»¶è¿Ÿ | æ€§èƒ½æå‡ |
|------|--------------|---------|---------|
| å±•å¼€æ ¹èŠ‚ç‚¹ | 1 æ¬¡ï¼ˆgetDeptChildrenï¼‰ | 50-100ms | **50%** |
| å±•å¼€å­èŠ‚ç‚¹ | 1 æ¬¡ï¼ˆgetDeptChildrenï¼‰ | 50-100ms | **50%** |
| å±•å¼€ 10 ä¸ªèŠ‚ç‚¹ | 10 æ¬¡ | 500-1000ms | **50%** |

---

## ğŸ” æ—¥å¿—è¾“å‡ºç¤ºä¾‹

### ä¼˜åŒ–åï¼ˆä¼ é€’äº† rootDeptIdï¼‰

```
[DEBUG] Getting department children {
  deptId: 'root-dept-id',
  pageSize: 50,
  pageToken: undefined,
  withTotal: undefined,
  rootDeptId: 'root-dept-id'
}
[DEBUG] Using provided rootDeptId for comparison {
  deptId: 'root-dept-id',
  rootDeptId: 'root-dept-id',
  isRootDept: true
}
[DEBUG] Successfully retrieved and filtered department children {
  deptId: 'root-dept-id',
  originalCount: 10,
  filteredCount: 5,
  hasNextPage: false
}
```

### å‘åå…¼å®¹ï¼ˆæœªä¼ é€’ rootDeptIdï¼‰

```
[DEBUG] Getting department children {
  deptId: 'root-dept-id',
  pageSize: 50,
  pageToken: undefined,
  withTotal: undefined,
  rootDeptId: undefined
}
[DEBUG] rootDeptId not provided, fetching parent department info
[DEBUG] Parent department info {
  deptId: 'root-dept-id',
  deptName: 'å‰æ—è´¢ç»å¤§å­¦',
  parentId: 'root-dept-id',
  isRootDept: true
}
[DEBUG] Successfully retrieved and filtered department children {
  deptId: 'root-dept-id',
  originalCount: 10,
  filteredCount: 5,
  hasNextPage: false
}
```

---

## ğŸ“ ä¿®æ”¹çš„æ–‡ä»¶

### åç«¯æ–‡ä»¶

1. **`apps/app-icalink/src/services/interfaces/IDepartmentService.ts`**
   - âœ… æ·»åŠ  `rootDeptId?: string` å‚æ•°åˆ°æ¥å£å®šä¹‰

2. **`apps/app-icalink/src/services/DepartmentService.ts`**
   - âœ… æ·»åŠ  `rootDeptId?: string` å‚æ•°åˆ°æ–¹æ³•ç­¾å
   - âœ… å®ç°æ¡ä»¶åˆ¤æ–­é€»è¾‘ï¼ˆä¼˜å…ˆä½¿ç”¨ rootDeptIdï¼Œå¦åˆ™è°ƒç”¨ APIï¼‰
   - âœ… æ›´æ–°æ—¥å¿—è¾“å‡ºï¼ŒåŒ…å« rootDeptId ä¿¡æ¯
   - âœ… æ›´æ–°æ–¹æ³•æ–‡æ¡£æ³¨é‡Šï¼Œè¯´æ˜æ€§èƒ½ä¼˜åŒ–å’Œå‘åå…¼å®¹æ€§

3. **`apps/app-icalink/src/controllers/StatsController.ts`**
   - âœ… æ·»åŠ  `root_dept_id` åˆ° querystring schema
   - âœ… æ·»åŠ  `root_dept_id?: string` åˆ° TypeScript ç±»å‹å®šä¹‰
   - âœ… ä» query ä¸­æå– `root_dept_id` å¹¶ä¼ é€’ç»™ Service å±‚
   - âœ… æ›´æ–°æ¥å£æ–‡æ¡£æ³¨é‡Š

### å‰ç«¯æ–‡ä»¶

4. **`apps/agendaedu-web/src/features/attendance/components/student-absence-stats.tsx`**
   - âœ… åœ¨æ„å»º URL æ—¶æ·»åŠ  `root_dept_id` æŸ¥è¯¢å‚æ•°
   - âœ… ä½¿ç”¨ `rootDept?.id` å®‰å…¨è®¿é—®æ ¹éƒ¨é—¨ ID

---

## âœ… å‘åå…¼å®¹æ€§

### å…¼å®¹æ€§ä¿è¯

**æ—§ç‰ˆæœ¬å‰ç«¯ï¼ˆæœªä¼ é€’ rootDeptIdï¼‰ï¼š**
- âœ… åç«¯æ£€æµ‹åˆ° `rootDeptId` ä¸º `undefined`
- âœ… è‡ªåŠ¨è°ƒç”¨ `batchGetDeptInfo` API è¿›è¡Œåˆ¤æ–­
- âœ… åŠŸèƒ½å®Œå…¨æ­£å¸¸ï¼Œæ— ä»»ä½•å½±å“

**æ–°ç‰ˆæœ¬å‰ç«¯ï¼ˆä¼ é€’ rootDeptIdï¼‰ï¼š**
- âœ… åç«¯ä½¿ç”¨ä¼ å…¥çš„ `rootDeptId` è¿›è¡Œæ¯”è¾ƒ
- âœ… é¿å…é¢å¤–çš„ API è°ƒç”¨
- âœ… æ€§èƒ½æå‡ 50%

### æ¸è¿›å¼å‡çº§

**å‡çº§è·¯å¾„ï¼š**
1. å…ˆéƒ¨ç½²åç«¯ä»£ç ï¼ˆæ”¯æŒå¯é€‰çš„ `rootDeptId` å‚æ•°ï¼‰
2. åç«¯éƒ¨ç½²å®Œæˆåï¼Œéƒ¨ç½²å‰ç«¯ä»£ç ï¼ˆå¼€å§‹ä¼ é€’ `rootDeptId`ï¼‰
3. å‰ç«¯éƒ¨ç½²å®Œæˆåï¼Œç«‹å³äº«å—æ€§èƒ½æå‡

**å›æ»šå®‰å…¨ï¼š**
- å¦‚æœéœ€è¦å›æ»šå‰ç«¯ï¼Œåç«¯ä»èƒ½æ­£å¸¸å·¥ä½œï¼ˆä½¿ç”¨ API è°ƒç”¨æ–¹å¼ï¼‰
- å¦‚æœéœ€è¦å›æ»šåç«¯ï¼Œå‰ç«¯ä¼ é€’çš„ `rootDeptId` å‚æ•°ä¼šè¢«å¿½ç•¥ï¼ˆä¸å½±å“åŠŸèƒ½ï¼‰

---

## ğŸ¯ æµ‹è¯•å»ºè®®

### åŠŸèƒ½æµ‹è¯•

1. **æµ‹è¯•æ–°ç‰ˆæœ¬å‰ç«¯ + æ–°ç‰ˆæœ¬åç«¯**
   - [ ] å±•å¼€æ ¹èŠ‚ç‚¹ï¼ŒéªŒè¯åªæœ‰ 1 æ¬¡ HTTP è¯·æ±‚
   - [ ] å±•å¼€å­èŠ‚ç‚¹ï¼ŒéªŒè¯åªæœ‰ 1 æ¬¡ HTTP è¯·æ±‚
   - [ ] æ£€æŸ¥åç«¯æ—¥å¿—ï¼Œç¡®è®¤ä½¿ç”¨äº† `rootDeptId` è¿›è¡Œæ¯”è¾ƒ
   - [ ] éªŒè¯è¿‡æ»¤é€»è¾‘ä»ç„¶æ­£å¸¸å·¥ä½œ

2. **æµ‹è¯•æ—§ç‰ˆæœ¬å‰ç«¯ + æ–°ç‰ˆæœ¬åç«¯**
   - [ ] å±•å¼€æ ¹èŠ‚ç‚¹ï¼ŒéªŒè¯æœ‰ 2 æ¬¡ HTTP è¯·æ±‚ï¼ˆå‘åå…¼å®¹ï¼‰
   - [ ] æ£€æŸ¥åç«¯æ—¥å¿—ï¼Œç¡®è®¤è°ƒç”¨äº† `batchGetDeptInfo` API
   - [ ] éªŒè¯åŠŸèƒ½å®Œå…¨æ­£å¸¸

### æ€§èƒ½æµ‹è¯•

1. **æµ‹é‡å“åº”æ—¶é—´**
   ```bash
   # ä¼˜åŒ–å‰
   curl -w "@curl-format.txt" "http://localhost:3000/api/icalink/v1/depts/{deptId}/children?page_size=50"

   # ä¼˜åŒ–å
   curl -w "@curl-format.txt" "http://localhost:3000/api/icalink/v1/depts/{deptId}/children?page_size=50&root_dept_id={rootDeptId}"
   ```

2. **å¯¹æ¯”æ—¥å¿—æ—¶é—´æˆ³**
   - æŸ¥çœ‹ `batchGetDeptInfo` è°ƒç”¨çš„è€—æ—¶
   - å¯¹æ¯”ä¼˜åŒ–å‰åçš„æ€»å“åº”æ—¶é—´

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

- [éƒ¨é—¨å­åˆ—è¡¨è¿‡æ»¤é€»è¾‘å®ç°](./éƒ¨é—¨å­åˆ—è¡¨è¿‡æ»¤é€»è¾‘å®ç°.md)
- [ç»„ç»‡æ¶æ„æ ‘äº¤äº’ä¼˜åŒ–æ€»ç»“](./ç»„ç»‡æ¶æ„æ ‘äº¤äº’ä¼˜åŒ–æ€»ç»“.md)
- [WPS V7 éƒ¨é—¨é€‚é…å™¨æ–‡æ¡£](../packages/was_v7/docs/department-adapter-refactoring.md)

---

**å®ç°å®Œæˆæ—¶é—´ï¼š** 2025-11-03  
**å®ç°äººï¼š** Augment Agent  
**æ€§èƒ½æå‡ï¼š** å‡å°‘ 50% çš„ HTTP è¯·æ±‚ï¼Œå“åº”æ—¶é—´ç¼©çŸ­ 50%  
**å½±å“èŒƒå›´ï¼š** æ‰€æœ‰ä½¿ç”¨ç»„ç»‡æ¶æ„æ ‘çš„åŠŸèƒ½

