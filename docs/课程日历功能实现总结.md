# è¯¾ç¨‹æ—¥å†åŠŸèƒ½å®ç°æ€»ç»“

## ğŸ“‹ åŠŸèƒ½æ¦‚è¿°

æœ¬æ¬¡å¼€å‘å®ç°äº†ç­¾åˆ°åº”ç”¨ä¸­çš„è¯¾ç¨‹æ—¥å†åŠŸèƒ½æ¨¡å—ï¼ŒåŒ…æ‹¬è¯¾ç¨‹è¡¨å’Œå­¦ç”Ÿè¯¾ç¨‹è¡¨ä¸¤ä¸ªå­åŠŸèƒ½ã€‚

## ğŸ—ï¸ æ¶æ„è®¾è®¡

### åç«¯æ¶æ„ï¼ˆapp-icalinkï¼‰

é‡‡ç”¨ Stratix æ¡†æ¶çš„æ ‡å‡†åˆ†å±‚æ¶æ„ï¼š

```
Repository å±‚ â†’ Service å±‚ â†’ Controller å±‚
```

#### 1. Repository å±‚

**æ–‡ä»¶ä½ç½®**ï¼š
- `apps/app-icalink/src/repositories/CalendarMappingRepository.ts`
- `apps/app-icalink/src/repositories/interfaces/ICalendarMappingRepository.ts`

**ä¸»è¦åŠŸèƒ½**ï¼š
- `findAllActive()`: æŸ¥è¯¢æ‰€æœ‰æœªåˆ é™¤çš„æ—¥å†æ˜ å°„
- `findByCalendarId()`: æ ¹æ®æ—¥å†IDæŸ¥è¯¢
- `findByKkhAndXnxq()`: æ ¹æ®å¼€è¯¾å·å’Œå­¦å¹´å­¦æœŸæŸ¥è¯¢
- `findByXnxq()`: æ ¹æ®å­¦å¹´å­¦æœŸæŸ¥è¯¢

**æ•°æ®è¡¨**ï¼š
- `icasync_calendar_mapping`: è¯¾ç¨‹æ—¥å†æ˜ å°„è¡¨
- `icasync_attendance_courses`: ç­¾åˆ°è¯¾ç¨‹è¡¨

#### 2. Service å±‚

**æ–‡ä»¶ä½ç½®**ï¼š
- `apps/app-icalink/src/services/CourseCalendarService.ts`
- `apps/app-icalink/src/services/interfaces/ICourseCalendarService.ts`

**ä¸»è¦åŠŸèƒ½**ï¼š
- `getCourseCalendarTree()`: è·å–è¯¾ç¨‹æ—¥å†æ ‘å½¢ç»“æ„
  - æ ¹èŠ‚ç‚¹ï¼šå‰æ—è´¢ç»å¤§å­¦è¯¾è¡¨
  - ä¸€çº§èŠ‚ç‚¹ï¼šæ‰€æœ‰æ—¥å†æ˜ å°„
  - äºŒçº§èŠ‚ç‚¹ï¼šæ¯ä¸ªæ—¥å†ä¸‹çš„è¯¾ç¨‹
- `getCalendarParticipants()`: è·å–æ—¥å†å‚ä¸è€…åˆ—è¡¨
  - è°ƒç”¨ `WpsCalendarAdapter.getAllCalendarPermissions()`
- `getCourseDetailsByCalendarId()`: è·å–è¯¾ç¨‹è¯¦æƒ…åˆ—è¡¨

#### 3. Controller å±‚

**æ–‡ä»¶ä½ç½®**ï¼š
- `apps/app-icalink/src/controllers/CourseCalendarController.ts`

**API æ¥å£**ï¼š
- `GET /api/icalink/v1/course-calendar/tree` - è·å–è¯¾ç¨‹æ—¥å†æ ‘
- `GET /api/icalink/v1/course-calendar/:calendar_id/participants` - è·å–å‚ä¸è€…
- `GET /api/icalink/v1/course-calendar/:calendar_id/courses` - è·å–è¯¾ç¨‹è¯¦æƒ…

### å‰ç«¯æ¶æ„ï¼ˆagendaedu-webï¼‰

#### 1. ç±»å‹å®šä¹‰

**æ–‡ä»¶ä½ç½®**ï¼š
- `apps/agendaedu-web/src/types/course-calendar.types.ts`

**ä¸»è¦ç±»å‹**ï¼š
- `CourseCalendarTreeNode`: æ ‘èŠ‚ç‚¹ç±»å‹
- `CourseDetail`: è¯¾ç¨‹è¯¦æƒ…
- `CalendarParticipant`: æ—¥å†å‚ä¸è€…

#### 2. API æœåŠ¡

**æ–‡ä»¶ä½ç½®**ï¼š
- `apps/agendaedu-web/src/api/course-calendar.api.ts`

**ä¸»è¦æ–¹æ³•**ï¼š
- `getCourseCalendarTree()`: è·å–æ ‘å½¢ç»“æ„
- `getCalendarParticipants()`: è·å–å‚ä¸è€…
- `getCourseDetails()`: è·å–è¯¾ç¨‹è¯¦æƒ…

#### 3. é¡µé¢ç»„ä»¶

**æ–‡ä»¶ä½ç½®**ï¼š
- `apps/agendaedu-web/src/routes/_authenticated/course-calendar/index.tsx` - è¯¾ç¨‹è¡¨é¡µé¢
- `apps/agendaedu-web/src/routes/_authenticated/course-calendar/student.tsx` - å­¦ç”Ÿè¯¾ç¨‹è¡¨é¡µé¢

**ä¸»è¦åŠŸèƒ½**ï¼š
- å·¦ä¾§æ ‘å½¢ç»“æ„å±•ç¤º
- å³ä¾§Tabé¡µåˆ‡æ¢
  - Tab 1: æ—¥å†å‚ä¸è€…åˆ—è¡¨
  - Tab 2: è¯¾èŠ‚è¯¦æƒ…åˆ—è¡¨

#### 4. å¯¼èˆªèœå•

**æ–‡ä»¶ä½ç½®**ï¼š
- `apps/agendaedu-web/src/components/layout/data/sidebar-data.ts`

**èœå•ç»“æ„**ï¼š
```
è¯¾ç¨‹æ—¥å†
â”œâ”€â”€ è¯¾ç¨‹è¡¨ (/course-calendar)
â””â”€â”€ å­¦ç”Ÿè¯¾ç¨‹è¡¨ (/course-calendar/student)
```

## ğŸ”§ æŠ€æœ¯å®ç°è¦ç‚¹

### 1. ä¾èµ–æ³¨å…¥

æ‰€æœ‰ Repository å’Œ Service éƒ½é€šè¿‡æ„é€ å‡½æ•°æ³¨å…¥ä¾èµ–ï¼š

```typescript
constructor(
  private readonly logger: Logger,
  private readonly calendarMappingRepository: CalendarMappingRepository,
  private readonly attendanceCourseRepository: AttendanceCourseRepository,
  private readonly wpsCalendarAdapter: WpsCalendarAdapter
)
```

### 2. WPS API é›†æˆ

é€šè¿‡ `@stratix/was-v7` åŒ…çš„ `WpsCalendarAdapter` è°ƒç”¨ WPS æ—¥å† APIï¼š

```typescript
const permissionsResponse = await this.wpsCalendarAdapter.getAllCalendarPermissions({
  calendar_id: calendarId
});
```

### 3. å‡½æ•°å¼ç¼–ç¨‹

ä½¿ç”¨ `@stratix/utils/functional` æä¾›çš„å‡½æ•°å¼å·¥å…·ï¼š

```typescript
import { isSome, fromNullable } from '@stratix/utils/functional';
```

### 4. ç»Ÿä¸€é”™è¯¯å¤„ç†

ä½¿ç”¨ `ServiceResult` ç±»å‹ç»Ÿä¸€è¿”å›æ ¼å¼ï¼š

```typescript
return {
  success: true,
  data: rootNode
};

// æˆ–
return {
  success: false,
  error: {
    code: ServiceErrorCode.RESOURCE_NOT_FOUND,
    message: 'æ—¥å†ä¸å­˜åœ¨'
  }
};
```

### 5. React Query æ•°æ®ç®¡ç†

å‰ç«¯ä½¿ç”¨ TanStack Query è¿›è¡Œæ•°æ®è·å–å’Œç¼“å­˜ï¼š

```typescript
const { data: treeData, isLoading } = useQuery({
  queryKey: ['course-calendar-tree'],
  queryFn: getCourseCalendarTree,
});
```

## ğŸ“ æ–‡ä»¶æ¸…å•

### åç«¯æ–‡ä»¶ï¼ˆapp-icalinkï¼‰

```
apps/app-icalink/src/
â”œâ”€â”€ repositories/
â”‚   â”œâ”€â”€ CalendarMappingRepository.ts                    # æ—¥å†æ˜ å°„ä»“å‚¨å®ç°
â”‚   â””â”€â”€ interfaces/
â”‚       â”œâ”€â”€ ICalendarMappingRepository.ts               # æ—¥å†æ˜ å°„ä»“å‚¨æ¥å£
â”‚       â””â”€â”€ index.ts                                    # æ¥å£å¯¼å‡ºï¼ˆå·²æ›´æ–°ï¼‰
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ CourseCalendarService.ts                        # è¯¾ç¨‹æ—¥å†æœåŠ¡å®ç°
â”‚   â””â”€â”€ interfaces/
â”‚       â”œâ”€â”€ ICourseCalendarService.ts                   # è¯¾ç¨‹æ—¥å†æœåŠ¡æ¥å£
â”‚       â””â”€â”€ index.ts                                    # æ¥å£å¯¼å‡ºï¼ˆå·²æ›´æ–°ï¼‰
â””â”€â”€ controllers/
    â””â”€â”€ CourseCalendarController.ts                     # è¯¾ç¨‹æ—¥å†æ§åˆ¶å™¨
```

### å‰ç«¯æ–‡ä»¶ï¼ˆagendaedu-webï¼‰

```
apps/agendaedu-web/src/
â”œâ”€â”€ types/
â”‚   â””â”€â”€ course-calendar.types.ts                        # ç±»å‹å®šä¹‰
â”œâ”€â”€ api/
â”‚   â””â”€â”€ course-calendar.api.ts                          # API æœåŠ¡
â”œâ”€â”€ routes/_authenticated/course-calendar/
â”‚   â”œâ”€â”€ index.tsx                                       # è¯¾ç¨‹è¡¨é¡µé¢
â”‚   â””â”€â”€ student.tsx                                     # å­¦ç”Ÿè¯¾ç¨‹è¡¨é¡µé¢
â””â”€â”€ components/layout/data/
    â””â”€â”€ sidebar-data.ts                                 # å¯¼èˆªèœå•é…ç½®ï¼ˆå·²æ›´æ–°ï¼‰
```

### æ–‡æ¡£æ–‡ä»¶

```
docs/
â””â”€â”€ è¯¾ç¨‹æ—¥å†åŠŸèƒ½å®ç°æ€»ç»“.md                              # æœ¬æ–‡æ¡£
```

## ğŸš€ ä½¿ç”¨è¯´æ˜

### åç«¯å¯åŠ¨

```bash
cd apps/app-icalink
pnpm run dev
```

### å‰ç«¯å¯åŠ¨

```bash
cd apps/agendaedu-web
pnpm run dev
```

### è®¿é—®è·¯å¾„

- è¯¾ç¨‹è¡¨é¡µé¢: `http://localhost:5173/web/course-calendar`
- å­¦ç”Ÿè¯¾ç¨‹è¡¨é¡µé¢: `http://localhost:5173/web/course-calendar/student`

## âœ… åŠŸèƒ½éªŒè¯

### 1. åç«¯ API æµ‹è¯•

```bash
# è·å–è¯¾ç¨‹æ—¥å†æ ‘
curl http://localhost:8090/api/icalink/v1/course-calendar/tree

# è·å–æ—¥å†å‚ä¸è€…
curl http://localhost:8090/api/icalink/v1/course-calendar/{calendar_id}/participants

# è·å–è¯¾ç¨‹è¯¦æƒ…
curl http://localhost:8090/api/icalink/v1/course-calendar/{calendar_id}/courses
```

### 2. å‰ç«¯åŠŸèƒ½æµ‹è¯•

1. ç™»å½•ç³»ç»Ÿ
2. åœ¨å·¦ä¾§å¯¼èˆªæ æ‰¾åˆ°"è¯¾ç¨‹æ—¥å†"èœå•
3. ç‚¹å‡»"è¯¾ç¨‹è¡¨"è¿›å…¥ä¸»é¡µé¢
4. å·¦ä¾§æ ‘å½¢ç»“æ„å±•ç¤ºæ‰€æœ‰æ—¥å†
5. ç‚¹å‡»æ—¥å†èŠ‚ç‚¹ï¼Œå³ä¾§æ˜¾ç¤ºå‚ä¸è€…å’Œè¯¾ç¨‹è¯¦æƒ…
6. åˆ‡æ¢ Tab é¡µæŸ¥çœ‹ä¸åŒä¿¡æ¯

## ğŸ¯ æ ¸å¿ƒç‰¹æ€§

### 1. æ ‘å½¢ç»“æ„

- âœ… ä¸‰çº§æ ‘å½¢ç»“æ„ï¼ˆæ ¹èŠ‚ç‚¹ â†’ æ—¥å† â†’ è¯¾ç¨‹ï¼‰
- âœ… èŠ‚ç‚¹å±•å¼€/æ”¶èµ·åŠŸèƒ½
- âœ… èŠ‚ç‚¹é€‰ä¸­çŠ¶æ€
- âœ… å›¾æ ‡åŒºåˆ†ä¸åŒèŠ‚ç‚¹ç±»å‹

### 2. æ•°æ®å±•ç¤º

- âœ… æ—¥å†å‚ä¸è€…åˆ—è¡¨ï¼ˆç”¨æˆ·IDã€æƒé™è§’è‰²ï¼‰
- âœ… è¯¾ç¨‹è¯¦æƒ…åˆ—è¡¨ï¼ˆè¯¾ç¨‹åç§°ã€æ•™å­¦å‘¨ã€æ•™å¸ˆã€åœ°ç‚¹ã€æ—¶é—´ç­‰ï¼‰
- âœ… æƒé™è§’è‰²æ ‡ç­¾ï¼ˆæ‰€æœ‰è€…ã€ç¼–è¾‘è€…ã€æŸ¥çœ‹è€…ï¼‰
- âœ… ç­¾åˆ°çŠ¶æ€æ ‡è¯†

### 3. ç”¨æˆ·ä½“éªŒ

- âœ… åŠ è½½çŠ¶æ€éª¨æ¶å±
- âœ… ç©ºæ•°æ®æç¤º
- âœ… é”™è¯¯å¤„ç†å’Œæç¤º
- âœ… å“åº”å¼å¸ƒå±€

## ğŸ“Š æ•°æ®æµç¨‹

```
ç”¨æˆ·æ“ä½œ
  â†“
å‰ç«¯ç»„ä»¶ (React)
  â†“
API æœåŠ¡ (axios)
  â†“
åç«¯ Controller
  â†“
Service å±‚ï¼ˆä¸šåŠ¡é€»è¾‘ï¼‰
  â†“
Repository å±‚ï¼ˆæ•°æ®è®¿é—®ï¼‰
  â†“
æ•°æ®åº“ / WPS API
```

## ğŸ” æƒé™æ§åˆ¶

æ‰€æœ‰åŠŸèƒ½éƒ½éœ€è¦ä»¥ä¸‹è§’è‰²ä¹‹ä¸€ï¼š
- `teacher` - æ•™å¸ˆ
- `admin` - ç®¡ç†å‘˜
- `super_admin` - è¶…çº§ç®¡ç†å‘˜

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“ä¾èµ–**ï¼šç¡®ä¿ `icasync_calendar_mapping` å’Œ `icasync_attendance_courses` è¡¨å·²åˆ›å»º
2. **WPS API é…ç½®**ï¼šéœ€è¦æ­£ç¡®é…ç½® WPS V7 çš„ appId å’Œ appSecret
3. **æƒé™éªŒè¯**ï¼šæ‰€æœ‰æ¥å£éƒ½éœ€è¦é€šè¿‡æƒé™éªŒè¯
4. **å­¦ç”Ÿè¯¾ç¨‹è¡¨**ï¼šå½“å‰ä¸ºå ä½é¡µé¢ï¼Œåç»­éœ€è¦å®ç°å…·ä½“åŠŸèƒ½

## ğŸ”„ åç»­ä¼˜åŒ–å»ºè®®

1. **å­¦ç”Ÿè¯¾ç¨‹è¡¨åŠŸèƒ½**ï¼šå®ç°å­¦ç”Ÿä¸ªäººè¯¾ç¨‹è¡¨æŸ¥çœ‹
2. **æœç´¢è¿‡æ»¤**ï¼šæ·»åŠ è¯¾ç¨‹æœç´¢å’Œç­›é€‰åŠŸèƒ½
3. **å¯¼å‡ºåŠŸèƒ½**ï¼šæ”¯æŒè¯¾ç¨‹è¡¨å¯¼å‡ºä¸º Excel/PDF
4. **æ—¥å†åŒæ­¥**ï¼šå®ç°ä¸ WPS æ—¥å†çš„åŒå‘åŒæ­¥
5. **æ€§èƒ½ä¼˜åŒ–**ï¼šå¤§æ•°æ®é‡æ—¶çš„è™šæ‹Ÿæ»šåŠ¨
6. **ç¼“å­˜ç­–ç•¥**ï¼šä¼˜åŒ–æ•°æ®ç¼“å­˜å’Œæ›´æ–°ç­–ç•¥

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœ‰é—®é¢˜ï¼Œè¯·è”ç³»å¼€å‘å›¢é˜Ÿæˆ–æŸ¥é˜… Stratix æ¡†æ¶æ–‡æ¡£ã€‚

