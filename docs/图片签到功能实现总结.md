# 图片签到功能实现总结

## 功能概述

当学生签到时位置校验失败，系统提供图片签到作为备选方案。学生可以上传现场照片，签到记录将进入"待审批"状态，需要教师审核通过后才能完成签到。

## 实现范围

### 后端改动（app-icalink）

#### 1. 数据库层面
- ✅ 确认 `icalink_attendance_records` 表已支持所需字段：
  - `metadata` (JSON类型) - 存储图片路径和相关元数据
  - `status` 枚举包含 'pending_approval' - 待审批状态
  - `last_checkin_source` 枚举已扩展支持 'photo' - 图片签到来源

#### 2. 类型定义
**文件**: `apps/app-icalink/src/types/api.ts`
- 扩展 `CheckinRequest` 接口：
  ```typescript
  export interface CheckinRequest {
    // ... 现有字段
    photo_url?: string;        // 图片OSS路径（图片签到时必填）
    checkin_type?: 'normal' | 'photo'; // 签到类型
  }
  ```

**文件**: `apps/app-icalink/src/types/database.ts`
- 扩展 `IcalinkAttendanceRecord` 接口：
  ```typescript
  last_checkin_source?: 'regular' | 'window' | 'manual' | 'photo';
  ```

#### 3. 业务逻辑层
**文件**: `apps/app-icalink/src/services/AttendanceService.ts`

**修改点1**: 签到请求验证（第789-797行）
```typescript
// 验证图片签到参数
const isPhotoCheckin = checkinData.checkin_type === 'photo';
if (isPhotoCheckin && !checkinData.photo_url) {
  return left({
    code: String(ServiceErrorCode.VALIDATION_FAILED),
    message: '图片签到缺少图片路径参数'
  });
}
```

**修改点2**: 跳过时间窗口验证（第896-903行）
```typescript
// 图片签到跳过时间窗口验证
if (isPhotoCheckin) {
  timeWindowValid = true;
  this.logger.info({
    studentId: studentInfo.userId,
    checkinType: 'photo'
  }, 'Photo checkin - skipping time window validation');
}
```

**修改点3**: 保存图片签到数据（第1041-1058行）
```typescript
// 保存图片签到元数据
if (isPhotoCheckin && checkinData.photo_url) {
  checkinRecordData.metadata = {
    photo_url: checkinData.photo_url,
    checkin_type: 'photo',
    reason: '位置校验失败，使用图片签到'
  };
  checkinRecordData.last_checkin_source = 'photo';
  checkinRecordData.last_checkin_reason = '位置校验失败，使用图片签到';
  checkinRecordData.status = 'pending_approval'; // 设置为待审批状态
}
```

#### 4. 图片上传接口
**文件**: `apps/app-icalink/src/controllers/AttendanceController.ts`

**新增接口**: `POST /api/icalink/v1/attendance/upload-checkin-photo`
- 接收base64编码的图片数据
- 上传到OSS存储（bucket: checkin-photos）
- 返回图片OSS路径

```typescript
@Post('/api/icalink/v1/attendance/upload-checkin-photo')
async uploadCheckinPhoto(
  request: FastifyRequest<{
    Body: {
      image: string;      // Base64编码的图片
      fileName: string;
      mimeType: string;
    };
  }>,
  reply: FastifyReply
): Promise<void>
```

**依赖注入**: 添加 `OsspStorageService` 依赖

### 前端改动（agendaedu-app）

#### 1. 位置校验失败对话框组件
**文件**: `apps/agendaedu-app/src/components/LocationFailedDialog.tsx`（新建）

**功能**:
- 显示位置校验失败提示
- 显示当前距离教室的距离
- 提供两个操作按钮：
  - **重新获取位置** - 重新触发签到流程
  - **使用图片签到** - 进入图片上传流程

**Props**:
```typescript
interface LocationFailedDialogProps {
  isOpen: boolean;
  onClose: () => void;
  onRetry: () => void;
  onPhotoCheckin: () => void;
  isLoading?: boolean;
  distance?: number;
}
```

#### 2. 学生签到页面改动
**文件**: `apps/agendaedu-app/src/pages/StudentDashboard.tsx`

**状态管理**:
```typescript
// 位置校验失败对话框状态
const [showLocationFailedDialog, setShowLocationFailedDialog] = useState(false);
const [locationValidationDistance, setLocationValidationDistance] = useState<number | undefined>(undefined);
const [pendingLocationData, setPendingLocationData] = useState<LocationInfo | null>(null);
```

**修改点1**: 位置校验失败处理（第182-200行）
```typescript
// 原来：直接显示错误toast
// 现在：显示对话框让用户选择
if (!locationValidation.valid && attendanceData.student.xh !== '0306012409428') {
  setPendingLocationData(locationData);
  setLocationValidationDistance(locationValidation.distance);
  setShowLocationFailedDialog(true);
  return;
}
```

**新增函数1**: `handleRetryLocation` - 重试获取位置
```typescript
const handleRetryLocation = async () => {
  setShowLocationFailedDialog(false);
  setPendingLocationData(null);
  setLocationValidationDistance(undefined);
  await handleCheckin(); // 重新触发签到流程
};
```

**新增函数2**: `handlePhotoCheckin` - 图片签到流程
```typescript
const handlePhotoCheckin = async () => {
  // 1. 创建文件输入元素
  // 2. 用户选择/拍摄图片
  // 3. 上传图片到OSS
  // 4. 构建签到payload（包含photo_url和checkin_type）
  // 5. 调用签到接口
  // 6. 显示成功提示并刷新数据
};
```

**新增函数3**: `uploadPhotoToOSS` - 上传图片到OSS
```typescript
const uploadPhotoToOSS = async (file: File): Promise<string> => {
  const response = await attendanceApi.uploadCheckinPhoto(file);
  if (!response.success || !response.data?.photo_url) {
    throw new Error(response.message || '图片上传失败');
  }
  return response.data.photo_url;
};
```

#### 3. API客户端改动
**文件**: `apps/agendaedu-app/src/lib/attendance-api.ts`

**新增方法**: `uploadCheckinPhoto`
```typescript
async uploadCheckinPhoto(file: File): Promise<{
  success: boolean;
  message?: string;
  data?: {
    photo_url: string;
    bucket_name: string;
  };
}>
```

**辅助方法**: `fileToBase64` - 将文件转换为base64字符串

## 技术要点

### 1. 图片签到的特殊处理
- **跳过时间窗口验证**: 图片签到作为备选方案，不受时间窗口限制
- **状态设置**: 自动设置为 'pending_approval' 状态
- **元数据存储**: 图片路径、签到类型、失败原因存储在metadata字段

### 2. 图片上传流程
1. 前端通过文件输入元素获取图片
2. 将图片转换为base64编码
3. 调用上传接口传递给后端
4. 后端解码base64并上传到OSS
5. 返回OSS路径给前端
6. 前端使用OSS路径调用签到接口

### 3. OSS存储配置
- **Bucket名称**: `checkin-photos`
- **文件命名**: `{userId}_{timestamp}.{extension}`
- **元数据**: 包含用户ID和上传时间
- **缩略图**: 签到图片不生成缩略图

### 4. 用户体验优化
- 位置校验失败时不直接拒绝，提供备选方案
- 清晰的UI提示和操作引导
- 图片上传进度反馈
- 成功提示区分普通签到和待审批签到

## 待实现功能

### 教师端审核功能
目前后端已支持图片签到数据存储，但教师端审核功能需要单独实现：

1. **查询待审批签到记录**
   - 筛选 `status = 'pending_approval'` 的记录
   - 显示学生信息、签到时间、图片等

2. **审核操作**
   - 查看签到图片
   - 批准/拒绝操作
   - 更新签到记录状态

3. **审核历史**
   - 记录审核人、审核时间、审核意见
   - 可能需要新增审核记录表

## 测试建议

### 后端测试
1. 测试图片上传接口
   - 正常图片上传
   - 非图片文件上传（应拒绝）
   - 大文件上传
   - 未认证用户上传（应拒绝）

2. 测试图片签到流程
   - 验证photo_url必填
   - 验证状态设置为pending_approval
   - 验证metadata正确保存
   - 验证跳过时间窗口验证

### 前端测试
1. 测试位置校验失败对话框
   - 对话框正确显示
   - 重试按钮功能
   - 图片签到按钮功能
   - 关闭对话框

2. 测试图片上传
   - 选择图片
   - 拍摄照片（移动端）
   - 上传进度
   - 错误处理

3. 测试完整流程
   - 位置校验失败 → 显示对话框 → 选择图片 → 上传 → 签到成功
   - 验证签到记录状态为待审批

## 文件清单

### 后端文件
- ✅ `apps/app-icalink/src/types/api.ts` - 扩展CheckinRequest接口
- ✅ `apps/app-icalink/src/types/database.ts` - 扩展IcalinkAttendanceRecord接口
- ✅ `apps/app-icalink/src/services/AttendanceService.ts` - 图片签到业务逻辑
- ✅ `apps/app-icalink/src/controllers/AttendanceController.ts` - 图片上传接口

### 前端文件
- ✅ `apps/agendaedu-app/src/components/LocationFailedDialog.tsx` - 位置校验失败对话框（新建）
- ✅ `apps/agendaedu-app/src/pages/StudentDashboard.tsx` - 学生签到页面改动
- ✅ `apps/agendaedu-app/src/lib/attendance-api.ts` - API客户端改动

### 文档文件
- ✅ `docs/图片签到功能实现总结.md` - 本文档

## 总结

本次实现完成了图片签到功能的核心流程，包括：
1. ✅ 后端数据模型扩展
2. ✅ 后端业务逻辑实现
3. ✅ 图片上传接口
4. ✅ 前端UI交互
5. ✅ 前端图片上传流程
6. ✅ 完整的签到流程集成

所有代码遵循Stratix框架规范，使用依赖注入、分层架构、统一错误处理等最佳实践。

**下一步工作**: 实现教师端的审核功能，包括查看待审批签到记录、查看签到图片、批准/拒绝操作等。

