# 前端路径上传功能快速测试指南

## 🚀 快速开始

### 1. 启动服务

```bash
# 终端1: 启动后端
cd apps/app-icalink
pnpm run dev

# 终端2: 启动前端
cd apps/agendaedu-web
pnpm run dev
```

### 2. 访问页面

打开浏览器访问：`http://localhost:3000`（或前端配置的端口）

导航到 WPS 云盘管理页面

---

## 🧪 测试步骤

### 测试1: 基本上传（不使用路径）

**目的**：验证向后兼容性

**步骤**：
1. 选择一个驱动盘
2. 点击 "上传文件" 按钮
3. 选择一个文件（如 `test.txt`）
4. **留空** "父文件夹路径" 字段
5. 点击 "开始上传"

**预期结果**：
- ✅ 文件成功上传到驱动盘根目录
- ✅ 显示成功提示
- ✅ 文件列表自动刷新
- ✅ 对话框关闭

**验证**：
- 在文件列表中看到上传的文件
- 后端日志显示：
  ```
  [INFO] Starting integrated file upload: {
    driveId: 'xxx',
    parentId: '0',
    parentPath: undefined
  }
  ```

---

### 测试2: 单层路径上传

**目的**：验证单层路径功能

**步骤**：
1. 选择一个驱动盘
2. 点击 "上传文件" 按钮
3. 选择一个文件（如 `document.pdf`）
4. 在 "父文件夹路径" 中输入：`/documents`
5. 点击 "开始上传"

**预期结果**：
- ✅ 文件成功上传到 `/documents` 路径
- ✅ 如果 `documents` 文件夹不存在，自动创建
- ✅ 显示成功提示

**验证**：
- 后端日志显示：
  ```
  [INFO] Starting integrated file upload: {
    driveId: 'xxx',
    parentId: '0',
    parentPath: '/documents'
  }
  
  [DEBUG] Converted parent_path: {
    original: '/documents',
    array: ['documents']
  }
  ```

---

### 测试3: 多层路径上传

**目的**：验证多层路径功能

**步骤**：
1. 选择一个驱动盘
2. 点击 "上传文件" 按钮
3. 选择一个文件（如 `photo.jpg`）
4. 在 "父文件夹路径" 中输入：`/2024/photos/vacation`
5. 点击 "开始上传"

**预期结果**：
- ✅ 文件成功上传到 `/2024/photos/vacation` 路径
- ✅ 所有层级的文件夹自动创建
- ✅ 显示成功提示

**验证**：
- 后端日志显示：
  ```
  [DEBUG] Converted parent_path: {
    original: '/2024/photos/vacation',
    array: ['2024', 'photos', 'vacation']
  }
  ```

---

### 测试4: 路径格式测试

**目的**：验证路径格式处理

**测试用例**：

| 输入路径 | 预期结果 |
|---------|---------|
| `folder1/folder2` | ✅ 自动处理（无开头斜杠） |
| `/folder1/folder2` | ✅ 标准格式 |
| `//folder1///folder2//` | ✅ 自动过滤多余斜杠 |
| `/2024/photos` | ✅ 正常工作 |

**步骤**：
1. 依次测试上述路径格式
2. 每次上传一个文件
3. 观察后端日志

**预期结果**：
- ✅ 所有格式都能正确处理
- ✅ 后端日志显示正确的数组格式

---

### 测试5: 批量上传

**目的**：验证批量上传到同一路径

**步骤**：
1. 选择一个驱动盘
2. 点击 "上传文件" 按钮
3. 选择 **多个文件**（如 3 个文件）
4. 在 "父文件夹路径" 中输入：`/batch-test`
5. 点击 "开始上传"

**预期结果**：
- ✅ 所有文件都上传到 `/batch-test` 路径
- ✅ 进度条显示总体进度
- ✅ 显示成功提示（如 "成功上传 3 个文件"）

**验证**：
- 在 `/batch-test` 文件夹中看到所有上传的文件

---

### 测试6: UI 交互测试

**目的**：验证 UI 交互和状态管理

**测试用例**：

1. **输入框禁用状态**：
   - 上传过程中，输入框应该被禁用
   - 上传完成后，输入框恢复可用

2. **状态重置**：
   - 上传完成后，"父文件夹路径" 应该清空
   - 文件选择器应该重置

3. **取消操作**：
   - 点击 "取消" 按钮，对话框关闭
   - 输入的路径应该保留（下次打开时清空）

**步骤**：
1. 打开上传对话框
2. 输入路径
3. 选择文件
4. 点击 "取消"
5. 重新打开对话框

**预期结果**：
- ✅ 路径字段已清空
- ✅ 文件选择器已重置

---

## 🔍 浏览器控制台检查

### 打开控制台

按 `F12` 或 `Cmd+Option+I`

### 查看前端日志

**不使用路径**：
```
开始上传文件: test.txt 到驱动盘: q60YOE5
父目录ID: 0
FormData 内容:
  - parent_id: 0
  - file: test.txt 1024 bytes
```

**使用路径**：
```
开始上传文件: photo.jpg 到驱动盘: q60YOE5
父目录ID: 0
父目录路径: /2024/photos
FormData 内容:
  - parent_id: 0
  - parent_path: /2024/photos
  - file: photo.jpg 123456 bytes
```

---

## 📊 后端日志检查

### 查看后端控制台

**成功上传（使用路径）**：
```
[INFO] Starting integrated file upload: {
  driveId: 'q60YOE5',
  parentId: '0',
  fileName: 'photo.jpg',
  fileSize: 123456,
  contentType: 'image/jpeg',
  hasHash: true,
  parentPath: '/2024/photos'
}

[DEBUG] Converted parent_path: {
  original: '/2024/photos',
  array: ['2024', 'photos']
}

[DEBUG] Step 1: Requesting upload permission
[DEBUG] Step 2: Uploading file to storage server
[DEBUG] Step 3: Completing upload
[INFO] Integrated file upload completed successfully
[DEBUG] Step 4: Enabling file sharing
[INFO] File sharing configured successfully: {
  shareUrl: 'https://wps.cn/share/xxx'
}
```

---

## ✅ 测试检查清单

### 功能测试

- [ ] 基本上传（不使用路径）
- [ ] 单层路径上传（`/documents`）
- [ ] 多层路径上传（`/2024/photos/vacation`）
- [ ] 路径格式：无开头斜杠（`folder1/folder2`）
- [ ] 路径格式：多余斜杠（`//folder1///folder2//`）
- [ ] 批量上传到同一路径

### UI 交互测试

- [ ] 输入框在上传时禁用
- [ ] 上传完成后状态重置
- [ ] 取消操作正常工作
- [ ] 帮助文本显示正确

### 日志验证

- [ ] 前端日志显示正确
- [ ] 后端日志显示路径转换
- [ ] 后端日志显示上传成功
- [ ] 后端日志显示共享成功

---

## 🐛 常见问题

### 问题1: 路径字段不显示

**原因**：前端代码未正确更新

**解决**：
1. 确认 `apps/agendaedu-web/src/features/wps-drive/index.tsx` 已更新
2. 重启前端服务
3. 清除浏览器缓存

---

### 问题2: 路径未传递到后端

**原因**：FormData 字段顺序或条件判断问题

**检查**：
1. 查看浏览器控制台的 FormData 日志
2. 确认 `parent_path` 字段存在
3. 确认字段顺序：`parent_id` → `parent_path` → `file`

---

### 问题3: 后端未解析路径

**原因**：后端 Controller 未更新

**检查**：
1. 确认 `apps/app-icalink/src/controllers/WpsDriveController.ts` 已更新
2. 查看后端日志是否有 `parent_path` 字段
3. 重启后端服务

---

## 🎉 测试成功标志

1. ✅ 所有测试用例通过
2. ✅ 前端日志正确
3. ✅ 后端日志正确
4. ✅ 文件出现在正确的路径
5. ✅ 共享链接返回
6. ✅ UI 交互流畅
7. ✅ 无错误提示

---

## 📝 测试报告模板

```markdown
## 测试报告

**测试日期**：2025-11-05
**测试人员**：[你的名字]
**测试环境**：
- 前端：http://localhost:3000
- 后端：http://localhost:8080

### 测试结果

| 测试用例 | 状态 | 备注 |
|---------|------|------|
| 基本上传（不使用路径） | ✅ / ❌ | |
| 单层路径上传 | ✅ / ❌ | |
| 多层路径上传 | ✅ / ❌ | |
| 路径格式处理 | ✅ / ❌ | |
| 批量上传 | ✅ / ❌ | |
| UI 交互 | ✅ / ❌ | |

### 发现的问题

1. [问题描述]
2. [问题描述]

### 建议

1. [建议内容]
2. [建议内容]
```

---

**祝测试顺利！** 🚀

