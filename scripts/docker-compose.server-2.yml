# Server-2 备份服务器 Docker Compose 配置
# 内网服务，提供备份和故障转移支持

version: '3.8'

# 网络配置
networks:
  obsync-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# 数据卷配置
volumes:
  nginx_logs:
    driver: local
  app_logs:
    driver: local

services:
  # API Gateway 服务 - 端口 8090 (备份实例)
  api-gateway:
    image: g-rrng9518-docker.pkg.coding.net/obsync/sync/stratix-gateway:latest
    container_name: obsync-api-gateway-s2
    restart: unless-stopped
    ports:
      - "8090:8090"
    environment:
      NODE_ENV: production
      TZ: Asia/Shanghai
      PORT: 8090
      HOST: 0.0.0.0
      # 服务发现配置
      SERVER_ROLE: backup
      SERVER_ID: server-2
      CLUSTER_MODE: enabled
      # 健康检查配置
      HEALTH_CHECK_INTERVAL: 30000
      # 加密配置
      STRATIX_SENSITIVE_CONFIG: 196004d6817f606f1fdddc365b0613f8.5ce49e5498027df2cbfaf53615dd8906.ASGZPs/d65964f88Y5yPH8rep1BgAn71ODytci9CeO9koBY9/oM0wFlsuTgLsYTohzEv9FIUnA+lYZg6sYywBwAlG3xPF2nX+dA0UI9169fUHU2JdzhYQyBmO8xrydmmWcGEX/8gwHNKR2J+/bRMhdrfpX7mkgy+iL4CSxJRHIKXf+MxKCkoQeCBUFX83/m2RqeE323nEELPv0KzNoMbfOqi4nCe5sronvKq5U2xn1yv3Je7iWju1vT2lkSsuJQc87djq802o0/IV4h4aGm+ZoPf0Gk0qwxdgcZ93o4eAasg554prZiEc+DYdTEDkLI/sK2JK/OBA36WPqhz05ON5D+iCQ/f0Qj5lxVneP864a1/9ARBrP8fnsrdlGShXzYMYxFtnaEKGNMX/AGxn5DdXkdFASmId9EAl9qW
    networks:
      obsync-network:
        ipv4_address: 172.20.0.20
    volumes:
      - app_logs:/app/logs
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: '2.0'
          memory: 2G
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  # ICA Link 签到服务 - 端口 3002 (备份实例)
  app-icalink:
    image: g-rrng9518-docker.pkg.coding.net/obsync/sync/app-icalink:latest
    container_name: obsync-app-icalink-s2
    restart: unless-stopped
    ports:
      - "3002:3002"
    environment:
      NODE_ENV: production
      TZ: Asia/Shanghai
      PORT: 3002
      HOST: 0.0.0.0
      # 服务发现配置
      SERVER_ROLE: backup
      SERVER_ID: server-2
      CLUSTER_MODE: enabled
      # 加密配置
      STRATIX_SENSITIVE_CONFIG: ${ICALINK_SENSITIVE_CONFIG}
    networks:
      obsync-network:
        ipv4_address: 172.20.0.21
    volumes:
      - app_logs:/app/logs
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      api-gateway:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1.5G
        reservations:
          cpus: '0.3'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  # ICA Sync 课程表同步服务 - 端口 3001 (备份实例)
  app-icasync:
    image: g-rrng9518-docker.pkg.coding.net/obsync/sync/app-icasync:latest
    container_name: obsync-app-icasync-s2
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      NODE_ENV: production
      TZ: Asia/Shanghai
      PORT: 3001
      HOST: 0.0.0.0
      # 服务发现配置
      SERVER_ROLE: backup
      SERVER_ID: server-2
      CLUSTER_MODE: enabled
      # 加密配置
      STRATIX_SENSITIVE_CONFIG: ${ICASYNC_SENSITIVE_CONFIG}
    networks:
      obsync-network:
        ipv4_address: 172.20.0.22
    volumes:
      - app_logs:/app/logs
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    depends_on:
      api-gateway:
        condition: service_healthy
    deploy:
      resources:
        limits:
          cpus: '1.5'
          memory: 1.5G
        reservations:
          cpus: '0.3'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  # Nginx 内网代理服务器
  nginx:
    image: nginx:1.24-alpine
    container_name: obsync-nginx-s2
    restart: unless-stopped
    ports:
      - "80:80"
    environment:
      TZ: Asia/Shanghai
    volumes:
      # Nginx 配置
      - ./nginx/server-2-nginx.conf:/etc/nginx/conf.d/default.conf:ro
      # 日志
      - nginx_logs:/var/log/nginx
    networks:
      obsync-network:
        ipv4_address: 172.20.0.10
    depends_on:
      api-gateway:
        condition: service_healthy
      app-icalink:
        condition: service_healthy
      app-icasync:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 30s
    deploy:
      resources:
        limits:
          cpus: '0.5'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 64M
    logging:
      driver: "json-file"
      options:
        max-size: "100m"
        max-file: "5"

  # 健康检查和监控服务
  healthcheck:
    image: alpine:latest
    container_name: obsync-healthcheck-s2
    restart: unless-stopped
    environment:
      TZ: Asia/Shanghai
      CHECK_INTERVAL: 30
      PRIMARY_SERVER: "10.0.0.102"  # Server-1 IP
    volumes:
      - ./scripts/healthcheck.sh:/healthcheck.sh:ro
      - app_logs:/app/logs
    networks:
      obsync-network:
        ipv4_address: 172.20.0.31
    command: ["/bin/sh", "-c", "apk add --no-cache curl && chmod +x /healthcheck.sh && /healthcheck.sh"]
    depends_on:
      - api-gateway
      - app-icalink
      - app-icasync
    deploy:
      resources:
        limits:
          cpus: '0.2'
          memory: 128M
        reservations:
          cpus: '0.05'
          memory: 32M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"

  # 日志轮转服务
  logrotate:
    image: alpine:latest
    container_name: obsync-logrotate-s2
    restart: unless-stopped
    environment:
      TZ: Asia/Shanghai
    volumes:
      - app_logs:/app/logs
      - nginx_logs:/var/log/nginx
      - ./scripts/logrotate.conf:/etc/logrotate.conf:ro
    networks:
      obsync-network:
        ipv4_address: 172.20.0.32
    command: ["/bin/sh", "-c", "apk add --no-cache logrotate && while true; do logrotate /etc/logrotate.conf; sleep 3600; done"]
    deploy:
      resources:
        limits:
          cpus: '0.1'
          memory: 64M
        reservations:
          cpus: '0.02'
          memory: 16M
    logging:
      driver: "json-file"
      options:
        max-size: "50m"
        max-file: "3"
