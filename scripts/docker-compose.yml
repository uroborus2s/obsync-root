# WPS ObSync Docker Compose 配置
# 网络配置
networks:
  obsync-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

# 数据卷配置
volumes:
  app_logs:
    driver: local
  nginx_logs:
    driver: local

services:
  # API Gateway 服务 - 端口 8090
  api-gateway:
    image: g-rrng9518-docker.pkg.coding.net/obsync/sync/stratix-gateway:${DOCKER_TAG:-latest}
    container_name: gateway
    restart: unless-stopped
    ports:
      - "${GATEWAY_PORT:-8090}:8090"
    environment:
      NODE_ENV: ${NODE_ENV:-production}
      TZ: ${TZ:-Asia/Shanghai}
      # 加密配置
      STRATIX_SENSITIVE_CONFIG: 196004d6817f606f1fdddc365b0613f8.5ce49e5498027df2cbfaf53615dd8906.ASGZPs/d65964f88Y5yPH8rep1BgAn71ODytci9CeO9koBY9/oM0wFlsuTgLsYTohzEv9FIUnA+lYZg6sYywBwAlG3xPF2nX+dA0UI9169fUHU2JdzhYQyBmO8xrydmmWcGEX/8gwHNKR2J+/bRMhdrfpX7mkgy+iL4CSxJRHIKXf+MxKCkoQeCBUFX83/m2RqeE323nEELPv0KzNoMbfOqi4nCe5sronvKq5U2xn1yv3Je7iWju1vT2lkSsuJQc87djq802o0/IV4h4aGm+ZoPf0Gk0qwxdgcZ93o4eAasg554prZiEc+DYdTEDkLI/sK2JK/OBA36WPqhz05ON5D+iCQ/f0Qj5lxVneP864a1/9ARBrP8fnsrdlGShXzYMYxFtnaEKGNMX/AGxn5DdXkdFASmId9EAl9qW
    networks:
      obsync-network:
        ipv4_address: 172.20.0.20
    volumes:
      - app_logs:/app/logs
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          cpus: ${CPU_LIMIT_GATEWAY:-2.0}
          memory: ${MEMORY_LIMIT_GATEWAY:-2G}
        reservations:
          cpus: '0.5'
          memory: 512M
    logging:
      driver: "json-file"
      options:
        max-size: ${LOG_MAX_SIZE:-100m}
        max-file: ${LOG_MAX_FILES:-5}
  # ICA Link 签到服务 - 端口 3002
  # app-icalink:
  #   image: ${DOCKER_REGISTRY:-g-rrng9518-docker.pkg.coding.net/obsync/sync}/app-icalink:${DOCKER_TAG:-latest}
  #   container_name: obsync-app-icalink
  #   restart: unless-stopped
  #   ports:
  #     - "${ICALINK_PORT:-3002}:3002"
  #   environment:
  #     NODE_ENV: ${NODE_ENV:-production}
  #     TZ: ${TZ:-Asia/Shanghai}
  #     PORT: 3002
  #     HOST: 0.0.0.0
  #     # 服务发现配置
  #     SERVER_ROLE: ${SERVER_ROLE:-primary}
  #     SERVER_ID: ${SERVER_ID:-server-1}
  #     CLUSTER_MODE: ${CLUSTER_MODE:-enabled}
  #     # 加密配置
  #     STRATIX_SENSITIVE_CONFIG: ${ICALINK_SENSITIVE_CONFIG}
  #   networks:
  #     obsync-network:
  #       ipv4_address: 172.20.0.21
  #   volumes:
  #     - app_logs:/app/logs
  #   healthcheck:
  #     test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3002/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 60s
  #   depends_on:
  #     api-gateway:
  #       condition: service_healthy
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: ${CPU_LIMIT_ICALINK:-1.5}
  #         memory: ${MEMORY_LIMIT_ICALINK:-1.5G}
  #       reservations:
  #         cpus: '0.3'
  #         memory: 256M
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: ${LOG_MAX_SIZE:-100m}
  #       max-file: ${LOG_MAX_FILES:-5}

  # # ICA Sync 课程表同步服务 - 端口 3001
  # app-icasync:
  #   image: ${DOCKER_REGISTRY:-g-rrng9518-docker.pkg.coding.net/obsync/sync}/app-icasync:${DOCKER_TAG:-latest}
  #   container_name: obsync-app-icasync
  #   restart: unless-stopped
  #   ports:
  #     - "${ICASYNC_PORT:-3001}:3001"
  #   environment:
  #     NODE_ENV: ${NODE_ENV:-production}
  #     TZ: ${TZ:-Asia/Shanghai}
  #     PORT: 3001
  #     HOST: 0.0.0.0
  #     # 服务发现配置
  #     SERVER_ROLE: ${SERVER_ROLE:-primary}
  #     SERVER_ID: ${SERVER_ID:-server-1}
  #     CLUSTER_MODE: ${CLUSTER_MODE:-enabled}
  #     # 加密配置
  #     STRATIX_SENSITIVE_CONFIG: ${ICASYNC_SENSITIVE_CONFIG}
  #   networks:
  #     obsync-network:
  #       ipv4_address: 172.20.0.22
  #   volumes:
  #     - app_logs:/app/logs
  #   healthcheck:
  #     test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3001/health"]
  #     interval: 30s
  #     timeout: 10s
  #     retries: 3
  #     start_period: 60s
  #   depends_on:
  #     api-gateway:
  #       condition: service_healthy
  #   deploy:
  #     resources:
  #       limits:
  #         cpus: ${CPU_LIMIT_ICASYNC:-1.5}
  #         memory: ${MEMORY_LIMIT_ICASYNC:-1.5G}
  #       reservations:
  #         cpus: '0.3'
  #         memory: 256M
  #   logging:
  #     driver: "json-file"
  #     options:
  #       max-size: ${LOG_MAX_SIZE:-100m}
  #       max-file: ${LOG_MAX_FILES:-5}
