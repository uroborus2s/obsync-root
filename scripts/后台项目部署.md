# 模块化部署脚本使用指南

## 概述

`scripts/deploy.sh` 是一个支持模块化部署的增强脚本，提供四种独立的部署模式，支持精确控制部署过程。

## 功能特性

### ✅ 四种部署模式

1. **仅更新Nginx配置** (`--nginx-only`)
2. **仅更新SSL证书** (`--ssl-only`) 
3. **仅更新Docker配置** (`--docker-only`)
4. **拉取最新镜像并部署** (`--update-images`)

### ✅ 高级选项

- `--dry-run`: 预演模式，显示将要执行的操作但不实际执行
- `--verbose`: 详细输出模式，显示完整的执行过程
- `--server1` / `--server2`: 指定目标服务器
- `--help`: 显示详细的使用说明

### ✅ 安全特性

- 配置语法验证
- 自动备份现有配置
- 滚动更新减少服务中断
- 完整的错误处理和回滚

## 使用示例

### 基本用法

```bash
# 完整部署到两台服务器
./scripts/deploy.sh

# 仅更新Nginx配置
./scripts/deploy.sh --nginx-only

# 仅更新SSL证书
./scripts/deploy.sh --ssl-only

# 仅更新Docker配置
./scripts/deploy.sh --docker-only

# 更新Docker镜像
./scripts/deploy.sh --update-images
```

### 指定目标服务器

```bash
# 仅在Server-1上更新Nginx配置
./scripts/deploy.sh --nginx-only --server1

# 仅在Server-2上更新SSL证书
./scripts/deploy.sh --ssl-only --server2
```

### 预演和调试

```bash
# 预演完整部署过程
./scripts/deploy.sh --dry-run

# 详细输出模式更新Nginx配置
./scripts/deploy.sh --nginx-only --verbose

# 预演仅在Server-1上的Docker更新
./scripts/deploy.sh --docker-only --server1 --dry-run
```

## 部署模式详解

### 1. Nginx配置更新 (`--nginx-only`)

**执行步骤：**
- 上传新的Nginx配置文件
- 备份现有配置
- 测试配置语法
- 重新加载Nginx（不重启）
- 验证配置生效

**适用场景：**
- 修改路由规则
- 调整负载均衡配置
- 更新安全头设置
- 修改缓存策略

### 2. SSL证书更新 (`--ssl-only`)

**执行步骤：**
- 上传新的SSL证书和私钥
- 备份现有证书
- 设置正确的文件权限
- 验证证书有效性和匹配性
- 重新加载Nginx应用新证书

**适用场景：**
- SSL证书即将过期
- 更换证书颁发机构
- 添加新的域名证书

### 3. Docker配置更新 (`--docker-only`)

**执行步骤：**
- 上传新的docker-compose.yml
- 备份现有配置
- 验证配置文件语法
- 重新启动受影响的容器
- 验证容器健康状态

**适用场景：**
- 修改环境变量
- 调整资源限制
- 更改端口映射
- 添加新的服务

### 4. 镜像更新 (`--update-images`)

**执行步骤：**
- 拉取最新的Docker镜像
- 执行滚动更新
- 逐个重启服务
- 验证新版本部署成功
- 清理未使用的镜像

**适用场景：**
- 应用版本升级
- 安全补丁更新
- 功能更新部署

## 服务器配置

### Server-1 (主服务器)
- **主机**: jlufe_12.6
- **用户**: ubuntu
- **功能**: 主要服务节点

### Server-2 (备份服务器)
- **主机**: jlufe_10.128
- **用户**: ubutu
- **功能**: 备份和负载分担

## 安全考虑

### 1. 权限管理
- SSL私钥权限设置为600
- SSL证书权限设置为644
- 配置文件属主为root

### 2. 备份策略
- 自动备份现有配置
- 带时间戳的备份文件名
- 配置错误时自动回滚

### 3. 验证机制
- Nginx配置语法检查
- SSL证书有效性验证
- Docker容器健康检查
- 服务可用性测试

## 故障排除

### 常见问题

1. **SSH连接失败**
   ```bash
   # 检查SSH配置
   ssh ubuntu@jlufe_12.6 "echo 'Connection OK'"
   ```

2. **权限不足**
   ```bash
   # 确保用户有sudo权限
   ssh ubuntu@jlufe_12.6 "sudo whoami"
   ```

3. **配置文件不存在**
   ```bash
   # 检查必要文件
   ls -la scripts/configs/
   ls -la scripts/nginx/
   ```

### 调试技巧

1. **使用预演模式**
   ```bash
   ./scripts/deploy.sh --dry-run --verbose
   ```

2. **查看详细日志**
   ```bash
   ./scripts/deploy.sh --nginx-only --verbose
   ```

3. **单独测试每个步骤**
   ```bash
   ./scripts/deploy.sh --ssl-only --server1
   ./scripts/deploy.sh --nginx-only --server1
   ./scripts/deploy.sh --docker-only --server1
   ```

## 最佳实践

### 1. 部署前检查
- 使用`--dry-run`预演部署过程
- 确认所有必要文件存在
- 验证SSH连接正常

### 2. 分步部署
- 先在一台服务器上测试
- 逐步推广到所有服务器
- 监控服务状态

### 3. 回滚准备
- 保留配置备份
- 记录部署时间
- 准备快速回滚方案

## 版本历史

- **v2.0**: 模块化部署支持
- **v1.0**: 基础部署功能

---

**注意**: 在生产环境中使用前，请先在测试环境中验证所有功能。
