
# /Users/uroborus/NodeProject/wps/obsync-root/scripts/deploy/swarm/nginx.conf

# Nginx 工作进程数，通常设置为 CPU 核心数
worker_processes auto;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    # 定义后端业务服务的上游 (upstream)
    # Nginx 会通过 Docker Swarm 的内部 DNS 将 "api-gateway" 解析为所有副本的 IP 地址
    upstream api_gateway_backend {
        # least_conn; # 可以选用 "最少连接" 负载均衡算法
        server api-gateway:8090;
    }

    # 如果您也想代理其他服务，可以添加更多的 upstream
    # upstream app_icasync_backend {
    #     server app-icasync:3000; # 假设它在3000端口
    # }

    server {
        listen 80;
        server_name your_domain.com; # 替换为您的域名

        # 日志格式
        access_log /var/log/nginx/access.log;
        error_log /var/log/nginx/error.log;

        # 代理到 API Gateway
        location / {
            proxy_pass http://api_gateway_backend;

            # 设置必要的代理头，以便后端服务能获取真实的客户端信息
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;

            # WebSocket 支持 (如果需要)
            proxy_http_version 1.1;
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
        }

        # 您可以添加其他 location 块来代理其他服务
        # location /icasync/ {
        #     proxy_pass http://app_icasync_backend/;
        # }
    }
}
