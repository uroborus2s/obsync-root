# Docker Swarm Stack 配置文件 - 优化版 v3
# ObSync 高可用集群部署 - 资源优化配置
# 
# 优化说明:
# 1. 减少副本数: 9个实例 -> 7个实例 (节省22%资源)
# 2. 添加资源限制: 防止单个服务占用过多资源
# 3. 优化健康检查: 增加start_period避免启动时误判
# 4. 优化更新策略: 使用start-first确保零停机更新

services:
  # ==================== 业务服务 ====================
  
  # API Gateway - 网关服务
  # 优化: 3副本 -> 2副本 (网关是无状态服务,2个副本足够)
  api-gateway:
    image: g-rrng9518-docker.pkg.coding.net/obsync/sync/stratix-gateway:v1.0.1
    networks: [obsync-overlay]
    ports: ["8090:8090"]
    environment:
      NODE_ENV: production
      TZ: Asia/Shanghai
    command: sh -c "export STRATIX_SENSITIVE_CONFIG=$$(cat /run/secrets/api_gateway_config) && exec node /app/dist/index.js"
    secrets:
      - source: api_gateway_config
        target: /run/secrets/api_gateway_config
    deploy:
      mode: replicated
      replicas: 2  # 优化: 从3减少到2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first  # 先启动新实例再停止旧实例
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s  # 新增: 启动宽限期,避免启动时误判
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # App IcaLink - 核心业务服务
  # 保持: 3副本 (核心服务,需要高可用性)
  app-icalink:
    image: g-rrng9518-docker.pkg.coding.net/obsync/sync/app-icalink:v1.0.0
    networks: [obsync-overlay]
    environment:
      NODE_ENV: production
      TZ: Asia/Shanghai
    command: sh -c "export STRATIX_SENSITIVE_CONFIG=$$(cat /run/secrets/icalink_config) && exec node /app/dist/index.js"
    secrets:
      - source: icalink_config
        target: /run/secrets/icalink_config
    deploy:
      mode: replicated
      replicas: 3  # 保持3副本 (核心服务)
      update_config:
        parallelism: 1
        delay: 15s  # 增加延迟,确保服务稳定
        failure_action: rollback
        order: start-first
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '1.5'      # 新增: 限制CPU使用
          memory: 2G       # 新增: 限制内存使用
        reservations:
          cpus: '0.75'     # 新增: 预留CPU
          memory: 1G       # 新增: 预留内存
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # 新增: 更长的启动宽限期 (涉及数据库初始化)
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # App IcaSync - 同步服务
  # 优化: 3副本 -> 2副本 (后台同步服务,可以容忍短暂延迟)
  app-icasync:
    image: g-rrng9518-docker.pkg.coding.net/obsync/sync/app-icasync:v1.0.0
    networks: [obsync-overlay]
    environment:
      NODE_ENV: production
      TZ: Asia/Shanghai
    command: sh -c "export STRATIX_SENSITIVE_CONFIG=$$(cat /run/secrets/icasync_config) && exec node /app/dist/index.js"
    secrets:
      - source: icasync_config
        target: /run/secrets/icasync_config
    deploy:
      mode: replicated
      replicas: 2  # 优化: 从3减少到2
      update_config:
        parallelism: 1
        delay: 10s
        failure_action: rollback
        order: start-first
      restart_policy:
        condition: on-failure
        delay: 5s
        max_attempts: 3
      resources:
        limits:
          cpus: '1.0'      # 新增: 限制CPU使用
          memory: 1.5G     # 新增: 限制内存使用
        reservations:
          cpus: '0.5'      # 新增: 预留CPU
          memory: 768M     # 新增: 预留内存
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s  # 新增: 启动宽限期
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"

  # ==================== 日志系统 (部署在备份机) ====================
  loki:
    image: grafana/loki:2.9.3
    networks: [obsync-overlay]
    ports: ["3100:3100"]
    volumes:
      - loki-data:/loki
      - /opt/obsync/loki/loki-config.yml:/etc/loki/local-config.yaml:ro
    command: -config.file=/etc/loki/local-config.yaml
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.obsync.role == worker
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  promtail:
    image: grafana/promtail:2.9.3
    networks: [obsync-overlay]
    volumes:
      - promtail-positions:/tmp
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - /var/log:/var/log:ro
      - /var/lib/docker/containers:/var/lib/docker/containers:ro
      - /opt/obsync/promtail/promtail-config.yml:/etc/promtail/config.yml:ro
    command: -config.file=/etc/promtail/config.yml
    deploy:
      mode: global  # 每个节点都需要
      resources:
        limits:
          cpus: '0.25'
          memory: 256M
        reservations:
          cpus: '0.1'
          memory: 128M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  grafana:
    image: grafana/grafana:10.2.3
    networks: [obsync-overlay]
    ports: ["3000:3000"]
    volumes:
      - grafana-data:/var/lib/grafana
      - /opt/obsync/grafana/provisioning:/etc/grafana/provisioning:ro
    environment:
      GF_SECURITY_ADMIN_USER: admin
      GF_SECURITY_ADMIN_PASSWORD__FILE: /run/secrets/grafana_admin_password
      GF_USERS_ALLOW_SIGN_UP: "false"
    secrets:
      - source: grafana_admin_password
        target: /run/secrets/grafana_admin_password
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.obsync.role == worker
      resources:
        limits:
          cpus: '0.5'
          memory: 512M
        reservations:
          cpus: '0.25'
          memory: 256M
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # ==================== 基础设施服务 (分布式 MinIO) ====================
  # 注意: MinIO配置保持不变,需要4个节点确保数据冗余
  minio-1:
    image: quay.io/minio/minio:RELEASE.2025-04-22T22-12-26Z
    hostname: minio-1
    command: server http://minio-{1...4}/data --console-address ":9001"
    networks: [obsync-overlay]
    ports: ["9000:9000", "9001:9001"]
    volumes:
      - type: bind
        source: /mnt/minio/disk1
        target: /data
    environment:
      MINIO_ROOT_USER_FILE: /run/secrets/minio_root_user
      MINIO_ROOT_PASSWORD_FILE: /run/secrets/minio_root_password
    secrets:
      - minio_root_user
      - minio_root_password
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.minio-host == A
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
      interval: 30s
      timeout: 10s
      retries: 3

  minio-2:
    image: quay.io/minio/minio:RELEASE.2025-04-22T22-12-26Z
    hostname: minio-2
    command: server http://minio-{1...4}/data --console-address ":9001"
    networks: [obsync-overlay]
    ports: ["9002:9000", "9003:9001"]
    volumes:
      - type: bind
        source: /mnt/minio/disk2
        target: /data
    environment:
      MINIO_ROOT_USER_FILE: /run/secrets/minio_root_user
      MINIO_ROOT_PASSWORD_FILE: /run/secrets/minio_root_password
    secrets:
      - minio_root_user
      - minio_root_password
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.minio-host == A
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]

  minio-3:
    image: quay.io/minio/minio:RELEASE.2025-04-22T22-12-26Z
    hostname: minio-3
    command: server http://minio-{1...4}/data --console-address ":9001"
    networks: [obsync-overlay]
    volumes:
      - type: bind
        source: /mnt/minio/disk3
        target: /data
    environment:
      MINIO_ROOT_USER_FILE: /run/secrets/minio_root_user
      MINIO_ROOT_PASSWORD_FILE: /run/secrets/minio_root_password
    secrets:
      - minio_root_user
      - minio_root_password
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.minio-host == B
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]

  minio-4:
    image: quay.io/minio/minio:RELEASE.2025-04-22T22-12-26Z
    hostname: minio-4
    command: server http://minio-{1...4}/data --console-address ":9001"
    networks: [obsync-overlay]
    volumes:
      - type: bind
        source: /mnt/minio/disk4
        target: /data
    environment:
      MINIO_ROOT_USER_FILE: /run/secrets/minio_root_user
      MINIO_ROOT_PASSWORD_FILE: /run/secrets/minio_root_password
    secrets:
      - minio_root_user
      - minio_root_password
    deploy:
      replicas: 1
      placement:
        constraints:
          - node.labels.minio-host == B
      resources:
        limits:
          cpus: '1.0'
          memory: 1G
        reservations:
          cpus: '0.5'
          memory: 512M
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]

# ==================== 网络/卷/Secrets 定义 ====================
networks:
  obsync-overlay:
    driver: overlay
    attachable: true

volumes:
  promtail-positions:
    driver: local
  loki-data:
    driver: local
  grafana-data:
    driver: local

secrets:
  minio_root_user:
    external: true
  minio_root_password:
    external: true
  api_gateway_config:
    external: true
  icasync_config:
    external: true
  icalink_config:
    external: true
  grafana_admin_password:
    external: true

