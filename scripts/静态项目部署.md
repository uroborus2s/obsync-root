# 静态文件部署脚本使用指南

## 概述

`scripts/deploy-static.sh` 是一个增强的静态文件部署脚本，支持单独部署一个项目或同时部署两个前端项目，并提供多种部署模式和选项。

## 功能特性

### ✅ 项目选择支持

- **单独部署Web管理后台** (`--web-only`)
- **单独部署移动端应用** (`--app-only`)
- **同时部署两个项目** (`--all` 或默认)

### ✅ 操作模式支持

- **仅构建模式** (`--build-only` / `-b`)
- **仅部署模式** (`--deploy-only` / `-d`)
- **完整流程** (构建并部署，默认)

### ✅ 高级选项

- **预演模式** (`--dry-run`) - 显示操作但不执行
- **详细输出** (`--verbose` / `-v`) - 显示详细的执行过程
- **强制模式** (`--force` / `-f`) - 跳过确认直接执行
- **帮助信息** (`--help` / `-h`) - 显示完整使用说明

## 使用示例

### 基本用法

```bash
# 构建并部署两个项目（默认）
./scripts/deploy-static.sh

# 仅部署Web管理后台
./scripts/deploy-static.sh --web-only

# 仅部署移动端应用
./scripts/deploy-static.sh --app-only

# 明确指定部署两个项目
./scripts/deploy-static.sh --all
```

### 操作模式组合

```bash
# 仅构建Web管理后台
./scripts/deploy-static.sh --web-only --build-only

# 仅构建移动端应用
./scripts/deploy-static.sh --app-only -b

# 仅部署Web管理后台（跳过构建）
./scripts/deploy-static.sh --web-only --deploy-only

# 仅部署移动端应用（跳过构建）
./scripts/deploy-static.sh --app-only -d
```

### 高级选项使用

```bash
# 预演完整部署过程
./scripts/deploy-static.sh --dry-run

# 预演仅部署Web项目
./scripts/deploy-static.sh --web-only --dry-run

# 详细输出模式部署
./scripts/deploy-static.sh --web-only --verbose

# 强制部署（跳过确认）
./scripts/deploy-static.sh --app-only --force

# 组合使用多个选项
./scripts/deploy-static.sh --web-only --build-only --verbose --dry-run
```

## 项目说明

### agendaedu-web (Web管理后台)
- **源码路径**: `apps/agendaedu-web`
- **构建输出**: `apps/agendaedu-web/dist`
- **部署路径**: `/var/www/agendaedu-web`
- **访问地址**: https://kwps.jlufe.edu.cn/web/

### agendaedu-app (移动端应用)
- **源码路径**: `apps/agendaedu-app`
- **构建输出**: `apps/agendaedu-app/dist`
- **部署路径**: `/var/www/agendaedu-app`
- **访问地址**: https://kwps.jlufe.edu.cn/app/

## 部署流程

### 完整部署流程
1. **依赖检查** - 验证必要工具和文件
2. **项目构建** - 根据选择构建对应项目
3. **构建验证** - 验证构建产物完整性
4. **服务器备份** - 备份现有文件
5. **文件部署** - 上传并部署新文件
6. **权限设置** - 设置正确的文件权限
7. **部署验证** - 验证部署结果
8. **Nginx重载** - 重新加载Nginx配置
9. **清理备份** - 清理过期备份文件

### 仅构建流程
1. **依赖检查**
2. **项目构建**
3. **构建验证**

### 仅部署流程
1. **依赖检查**
2. **构建验证** (验证现有构建产物)
3. **服务器备份**
4. **文件部署**
5. **权限设置**
6. **部署验证**
7. **Nginx重载**
8. **清理备份**

## 安全特性

### 1. 权限管理
- 使用临时目录避免权限问题
- 自动设置正确的文件权限 (644) 和目录权限 (755)
- 文件所有者设置为 `www-data:www-data`

### 2. 备份机制
- 部署前自动备份现有文件
- 备份文件名包含时间戳
- 自动清理过期备份文件

### 3. 验证机制
- 构建产物完整性验证
- 部署结果验证
- Nginx配置语法检查

## 故障排除

### 常见问题

1. **权限错误**
   ```bash
   # 使用权限修复脚本
   ./scripts/fix-permissions.sh
   ```

2. **构建失败**
   ```bash
   # 检查项目依赖
   cd apps/agendaedu-web && pnpm install
   cd apps/agendaedu-app && pnpm install
   ```

3. **SSH连接失败**
   ```bash
   # 测试SSH连接
   ssh ubutu@jlufe_10.128 "echo 'Connection OK'"
   ```

### 调试技巧

1. **使用预演模式**
   ```bash
   ./scripts/deploy-static.sh --web-only --dry-run
   ```

2. **启用详细输出**
   ```bash
   ./scripts/deploy-static.sh --web-only --verbose
   ```

3. **分步执行**
   ```bash
   # 先仅构建
   ./scripts/deploy-static.sh --web-only --build-only
   
   # 再仅部署
   ./scripts/deploy-static.sh --web-only --deploy-only
   ```

## 最佳实践

### 1. 开发环境测试
```bash
# 先在本地构建测试
./scripts/deploy-static.sh --web-only --build-only

# 使用预演模式验证部署流程
./scripts/deploy-static.sh --web-only --dry-run
```

### 2. 生产环境部署
```bash
# 单独部署，降低风险
./scripts/deploy-static.sh --web-only --verbose

# 验证部署结果
curl -I https://kwps.jlufe.edu.cn/web/
```

### 3. 批量部署
```bash
# 强制模式批量部署
./scripts/deploy-static.sh --all --force
```

## 配置信息

### 服务器配置
- **主机**: jlufe_10.128
- **用户**: ubutu
- **Web路径**: /var/www/agendaedu-web
- **App路径**: /var/www/agendaedu-app

### 构建工具
- **包管理器**: pnpm
- **构建命令**: `pnpm run build`
- **输出目录**: `dist/`

## 版本历史

- **v2.0**: 模块化部署支持，项目选择功能
- **v1.1**: 权限问题修复，临时目录策略
- **v1.0**: 基础部署功能

---

**注意**: 在生产环境使用前，建议先使用 `--dry-run` 参数预演部署过程。
