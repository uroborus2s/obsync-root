## stratix/agendaedu插件需求说明
@stratix/icalink插件是stratix框架的一个插件。插件的功能是将学校课表的数据同步到wps协作的日程里 

## 功能说明
从教务系统获取课表数据，源数据包括u_jw_kcb_cur表、juhe_renwu表、out_jw_kcb_xs、out_xsxx
插件只需要从源数据表里查询数据，并在任务完成后更新源数据表的同步状态。
### u_jw_kcb_cur表
中间表是课表的源头数据表
```sql
CREATE TABLE `u_jw_kcb_cur` (
  `kkh` varchar(60) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT '开课号',
  `xnxq` varchar(20) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT '学年学期',
  `jxz` int(11) DEFAULT NULL COMMENT '教学周（1-20）',
  `zc` int(11) DEFAULT NULL COMMENT '周次（星期1-星期日）',
  `jc` int(11) DEFAULT NULL COMMENT '节次（1-10）',
  `lq` varchar(200) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT '楼群',
  `room` varchar(200) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT '房间',
  `xq` varchar(100) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT '校区',
  `ghs` varchar(255) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT '工号组',
  `lc` varchar(255) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT '楼层',
  `rq` varchar(255) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT '日期',
  `st` varchar(255) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT '开始时间',
  `ed` varchar(255) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT '结束时间',
  `sj` varchar(255) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT '来源库时间',
  `zt` varchar(30) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT '来源库状态标识（add、update、delete）',
  `gx_sj` varchar(255) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT '目标库更新时间',
  `gx_zt` varchar(30) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT '目标库更新状态',
  `kcmc` varchar(200) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT '课程名称',
  `xms` varchar(500) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT '教师姓名组',
  `sfdk` varchar(2) COLLATE utf8_unicode_ci DEFAULT NULL COMMENT '是否打卡(打卡，不打卡)，有些课程仅为占位给老师提醒，学生不打卡，无学生日历',
  KEY `idx_combined` (`kkh`,`rq`,`st`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 COLLATE=utf8_unicode_ci COMMENT='本学期课程表';
```

### juhe_renwu
juhe_renwu表表根据u_jw_kcb_cur表生成，将u_jw_kcb_cur表的课程信息聚合成一个日程，聚合表的每条记录对应一节课即一个日程。
根据聚合表创建日程，创建关联的人员的日程。即上这节课的学生和教师的日程。聚合表通过下面的代码生成：
```sql
CREATE TABLE juhe_renwu (
    id INT PRIMARY KEY AUTO_INCREMENT
) as
SELECT
	kkh,
	xnxq,
	jxz,
	zc,
	LEFT ( rq, 10 ) rq,kcmc,sfdk,
	GROUP_CONCAT( jc ORDER BY jc SEPARATOR '/' ) jc_s,
	GROUP_CONCAT( ifnull( room, '无' ) ORDER BY jc SEPARATOR '/' ) room_s,
	GROUP_CONCAT( DISTINCT ghs ) gh_s,
  GROUP_CONCAT( DISTINCT xms ) xm_s,
	SUBSTRING_INDEX( GROUP_CONCAT( lq ORDER BY st ), ',', 1 ) lq,
	SUBSTRING_INDEX( GROUP_CONCAT( st ORDER BY st ), ',', 1 ) sj_f,
	SUBSTRING_INDEX( GROUP_CONCAT( ed ORDER BY ed DESC ), ',', 1 ) sj_t,
	'am' sjd 
FROM
	u_jw_kcb_cur 
WHERE
	1 = 1 
	AND jc < 5 
GROUP BY
	kkh,
	xnxq,
	jxz,
	zc,
	rq ,kcmc,sfdk UNION
SELECT
	kkh,
	xnxq,
	jxz,
	zc,
	LEFT ( rq, 10 ) rq,kcmc,sfdk,
	GROUP_CONCAT( jc ORDER BY jc SEPARATOR '/' ) jc_s,
	GROUP_CONCAT( ifnull( room, '无' ) ORDER BY jc SEPARATOR '/' ) room_s,
	GROUP_CONCAT( DISTINCT ghs ) gh_s,
  GROUP_CONCAT( DISTINCT xms ) xm_s,
	SUBSTRING_INDEX( GROUP_CONCAT( lq ORDER BY st ), ',', 1 ) lq,
	SUBSTRING_INDEX( GROUP_CONCAT( st ORDER BY st ), ',', 1 ) sj_f,
	SUBSTRING_INDEX( GROUP_CONCAT( ed ORDER BY ed DESC ), ',', 1 ) sj_t,
	'pm' sjd 
FROM
	u_jw_kcb_cur 
WHERE
	1 = 1 
	AND jc > 4 
GROUP BY
	kkh,
	xnxq,
	jxz,
	zc,
	rq,kcmc,sfdk
以上代码是以节（1-4）为上午和（5-10）为下午两部分union而成。
```

### out_jw_kcb_xs
out_jw_kcb_xs表学生课表信息，通过kkh和xh获取每门课程的学生信息。
```sql
CREATE TABLE `out_jw_kcb_xs` (
  `kkh` varchar(60) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL COMMENT '开课号',
  `xh` varchar(40) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL COMMENT '学生编号',
  `xnxq` varchar(20) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL COMMENT '学年学期',
  `kcbh` varchar(40) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL COMMENT '课程编号',
  `pyfadm` varchar(50) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL COMMENT '培养方案代码',
  `xsyd` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL COMMENT '学生异动标识',
  `xgxklbdm` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL COMMENT '校公选课类别代码',
  `sj` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `zt` varchar(30) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  KEY `idx_out_jw_kcb_xs_kkh_xh_kcbh` (`kkh`,`xh`,`kcbh`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci COMMENT='u_学生课程表';
```
### out_xsxx
out_xsxx表学生信息，通过xh获取学生的信息。
```sql
CREATE TABLE `out_xsxx` (
  `id` varchar(32) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci NOT NULL,
  `xm` varchar(200) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `xh` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `xydm` varchar(30) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `xymc` varchar(90) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `zydm` varchar(30) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `zymc` varchar(90) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `bjdm` varchar(30) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `bjmc` varchar(90) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `xb` varchar(10) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `mz` varchar(100) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `sfzh` varchar(30) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `sjh` varchar(11) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `sznj` varchar(10) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `rxnf` varchar(10) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `email` varchar(200) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `lx` int DEFAULT '1' COMMENT '类型 1本科生 2研究生',
  `update_time` timestamp NULL DEFAULT NULL ON UPDATE CURRENT_TIMESTAMP,
  `ykth` varchar(50) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `sj` varchar(255) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  `zt` varchar(30) CHARACTER SET utf8mb3 COLLATE utf8mb3_unicode_ci DEFAULT NULL,
  PRIMARY KEY (`id`) USING BTREE,
  KEY `idx_out_xsxx_xh_bjdm` (`xh`,`bjdm`,`bjmc`)
) ENGINE=MyISAM DEFAULT CHARSET=utf8mb3 COLLATE=utf8mb3_unicode_ci;
```

### 全量同步
全量在每个学期前执行一次,执行逻辑如下：
1. 每学期期初要清空上学期u_jw_kcb_cur （中间表），重新同步完该学期数据后，提前一个星期生成聚合任务表。把gx_sj和gx_zt置初始状态。
2. 根据聚合任务表先全量推送教师日历（教师课表日历优先），推送完成给聚合表打标gx_zt=1，推送顺序以日期为标准。
3. 根据聚合任务表遍历全量推送学生日历，推送完成给聚合表打标gx_zt=2，推送顺序以日期为标准。
4. 在步骤3完成的同时，根据kkh,xnxq,jxz,zc,rq完成对u_jw_kcb_cur （中间表）状态的打标，把gx_sj和gx_zt置为完成状态，假设为1。
5. 以上为学期初的整体逻辑，在学校开学前要全部推送完毕，各种推送进度和日志要在后台显示清楚。如果这一步全部完成，则聚合表的gx_zt都为2（假设需要打卡），中间表的gx_zt都为1。

### 增量同步
增量在每学期的全量同步完成后每天执行，如果课程有更新，数据u_jw_kcb_cur （中间表）会更新，通过读取u_jw_kcb_cur （中间表）的更新数据完成增量同步。
1. 学校每天更新u_jw_kcb_cur （中间表），其中增删改的逻辑，校方已经完成。更新标记为红框显示。gx_sj和gx_zt为null。
2. 每天需要查询中间表根据gx_zt is null取到未处理的数据。
4. 取到每天变化数据的kkh和rq。类似的sql伪代码：
```
select distinct kkh，rq from u_jw_kcb_cur where gx_zt is null
```
5、根据4查到的rq和kkh。软删除聚合表相关数据（修改聚合表的记录）。把gx_zt设置为3（软删除未处理）
6. 根据新附加的聚合表顺序执行，据gx_zt和rq顺序删除教师和学生日历对象。处理完毕gx_zt置为4（软删除处理完毕）
7. 然后重新聚合数据，根据变化数据生成聚合表，取到未处理的数据重新聚合，把新聚合的值附加到聚合表。聚合的语句类似于学期初生成聚合表的语句，只在where条件中增加gx_zt is null 和 zt !=’delete’(策略是全删全加，步骤4和5已经删除数据，这里新聚合的数据之需要新增即可）
```sql
SELECT
	kkh,
	xnxq,
	jxz,
	zc,
	LEFT ( rq, 10 ) rq,kcmc,sfdk,
	GROUP_CONCAT( jc ORDER BY jc SEPARATOR '/' ) jc_s,
	GROUP_CONCAT( ifnull( room, '无' ) ORDER BY jc SEPARATOR '/' ) room_s,
	GROUP_CONCAT( DISTINCT ghs ) gh_s,
  GROUP_CONCAT( DISTINCT xms ) xm_s,
	SUBSTRING_INDEX( GROUP_CONCAT( lq ORDER BY st ), ',', 1 ) lq,
	SUBSTRING_INDEX( GROUP_CONCAT( st ORDER BY st ), ',', 1 ) sj_f,
	SUBSTRING_INDEX( GROUP_CONCAT( ed ORDER BY ed DESC ), ',', 1 ) sj_t,
	'am' sjd 
FROM
	u_jw_kcb_cur 
WHERE
	1 = 1 
	AND jc < 5 
  and gx_zt is null and zt !=’delete’
GROUP BY
	kkh,
	xnxq,
	jxz,
	zc,
	rq ,kcmc,sfdk UNION
SELECT
	kkh,
	xnxq,
	jxz,
	zc,
	LEFT ( rq, 10 ) rq,kcmc,sfdk,
	GROUP_CONCAT( jc ORDER BY jc SEPARATOR '/' ) jc_s,
	GROUP_CONCAT( ifnull( room, '无' ) ORDER BY jc SEPARATOR '/' ) room_s,
	GROUP_CONCAT( DISTINCT ghs ) gh_s,
  GROUP_CONCAT( DISTINCT xms ) xm_s,
	SUBSTRING_INDEX( GROUP_CONCAT( lq ORDER BY st ), ',', 1 ) lq,
	SUBSTRING_INDEX( GROUP_CONCAT( st ORDER BY st ), ',', 1 ) sj_f,
	SUBSTRING_INDEX( GROUP_CONCAT( ed ORDER BY ed DESC ), ',', 1 ) sj_t,
	'pm' sjd 
FROM
	u_jw_kcb_cur 
WHERE
	1 = 1 
	AND jc > 4 
  and gx_zt is null and zt !=’delete’
GROUP BY
	kkh,
	xnxq,
	jxz,
	zc,
	rq,kcmc,sfdk
```
8. 新增时此时聚合表的gx_sj和gx_zt置初始状态。
9. 根据增量数据，顺序的推送教师日历，学生日历，更新gx_zt 字段（处理顺序和gx_zt赋值类似于初始的逻辑）
10. 根据kkh,xnxq,jxz,zc,rq完成对u_jw_kcb_cur （中间表）状态的打标，把gx_sj和gx_zt置为完成状态，假设为
1
11. 每节需要打卡的课程需要在打卡表内生成打卡记录。需要做考勤功能

## 方案实现要求说明
1. 生成全量任务和每天的增量任务（主任务）
2. 根据聚合表juhe_renwu 生成子任务，一节课是一个子任务
3. 根据主任务关联关联的教师和学生生成 创建日程子任务/删除日程子任务
4. 使用@stratix/tasks创建日程子任务/删除日程子任务添加到异步消息栈中，并定义消息完成回调函数
5. 异步消息栈按顺序执行，上个消息完成后才能执行下一条消息，使用@stratix/queue插件实现消息栈功能
6. 添加任务和消息执行并行处理。使用@stratix/tasks添加并运行任务
7. 使用@stratix/queue将调用调用wps api添加日程的形象添加到异步消息栈中
8. 异步消息栈执行完成后，更新主任务状态，同时按照要求更新u_jw_kcb_cur状态和聚合表状态
9. 每天执行一次增量任务，增量任务的逻辑和全量任务的逻辑类似，只是增量任务的where条件是gx_zt is null和zt!=’delete’
10. 每节课根据是否打卡创建打卡记录,打卡记录保存总人数、签到人数、旷课人数、请假人数，要根据打卡信息生成签到url，用于签到。