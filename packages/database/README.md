# @stratix/database

## 功能概述

数据库模块提供了一个灵活、强大的ORM系统，支持多数据库连接、查询构建器、模型关系、缓存功能和自动迁移生成。

## 主要特性

- 基于Knex.js构建的强大查询构建器
- 支持多种数据库驱动，包括PostgreSQL、MySQL、SQLite等
- 完整的ORM模型系统
- 支持模型关系（一对一、一对多、多对多等）
- 生命周期钩子系统
- 查询和模型缓存支持
- 软删除功能
- 从模型自动生成数据库迁移文件
- 数据迁移和种子系统

## 安装

```bash
npm install @stratix/database @stratix/cache
```

## 基本用法

### 初始化数据库连接

```typescript
import { Database } from '@stratix/database';
import { CacheManager } from '@stratix/cache';

// 创建缓存管理器
const cacheManager = new CacheManager({
  driver: 'memory',
  // 或使用Redis
  // driver: 'redis',
  // connection: {
  //   host: 'localhost',
  //   port: 6379
  // }
});

// 配置数据库
const db = new Database({
  client: 'pg',
  connection: {
    host: 'localhost',
    user: 'postgres',
    password: 'password',
    database: 'mydb'
  },
  // 缓存配置
  cache: {
    enabled: true,
    prefix: 'db:',
    ttl: 60000, // 1分钟
    queries: {
      enabled: true,
      ttl: 30000 // 30秒
    },
    models: {
      enabled: true,
      ttl: 60000 // 1分钟
    }
  },
  // 迁移配置
  migrations: {
    directory: './migrations',
    // 自动从模型生成迁移
    autoGenerate: true,
    // 自动生成的迁移存放目录
    autoGenerateDirectory: './migrations/auto',
    // 表名前缀
    tablePrefix: 'app_'
  }
}, cacheManager);

// 连接数据库
await db.connect();
```

### 定义模型

```typescript
import { BaseModel } from '@stratix/database';
import { FieldType } from '@stratix/database/types';

export class User extends BaseModel {
  static tableName = 'users';
  
  static fields = {
    id: {
      type: FieldType.Increments,
      primaryKey: true
    },
    name: {
      type: FieldType.String,
      length: 100,
      nullable: false
    },
    email: {
      type: FieldType.String,
      unique: true
    },
    created_at: {
      type: FieldType.Timestamp
    },
    updated_at: {
      type: FieldType.Timestamp
    }
  };
  
  static relations = {
    posts: {
      type: 'hasMany',
      model: 'Post',
      foreignKey: 'user_id'
    }
  };
}

export class Post extends BaseModel {
  static tableName = 'posts';
  
  static fields = {
    id: {
      type: FieldType.Increments,
      primaryKey: true
    },
    title: {
      type: FieldType.String,
      length: 200,
      nullable: false
    },
    content: {
      type: FieldType.Text
    },
    user_id: {
      type: FieldType.Integer,
      unsigned: true,
      nullable: false
    },
    created_at: {
      type: FieldType.Timestamp
    },
    updated_at: {
      type: FieldType.Timestamp
    }
  };
  
  static relations = {
    user: {
      type: 'belongsTo',
      model: 'User',
      foreignKey: 'user_id',
      // 外键约束
      onDelete: 'CASCADE'
    }
  };
}
```

### 使用查询构建器

```typescript
// 基本查询
const users = await User.query().where('email', 'like', '%@example.com').get();

// 分页查询
const result = await User.query()
  .orderBy('created_at', 'desc')
  .paginate(1, 20);

// 关系查询
const usersWithPosts = await User.query()
  .with('posts')
  .get();

// 聚合查询
const count = await User.query().count();
```

### 缓存查询结果

```typescript
// 启用缓存的查询
const user = await User.query({ useCache: true })
  .where('id', 1)
  .first();

// 设置自定义缓存时间
const posts = await Post.query()
  .cache(true, 300000) // 5分钟缓存
  .where('user_id', userId)
  .get();
```

## 迁移系统

数据库模块支持从模型自动生成迁移文件，这大大简化了数据库架构的管理。

### 配置迁移

在数据库配置中通过`migrations`选项配置迁移：

```typescript
{
  // 其他配置...
  migrations: {
    // 迁移文件目录
    directory: './migrations',
    
    // 是否自动从模型生成迁移
    autoGenerate: true,
    
    // 自动生成的迁移存放目录
    autoGenerateDirectory: './migrations/auto',
    
    // 表名前缀
    tablePrefix: 'app_',
    
    // 自定义迁移模板文件
    templateFile: './templates/migration.js'
  }
}
```

### 手动生成迁移

```typescript
// 获取迁移管理器
const migrationManager = db.getMigrationManager();

// 注册模型
migrationManager.addModel(User);
migrationManager.addModel(Post);

// 从所有已注册模型生成迁移
const files = await migrationManager.generateMigrations();
console.log('已生成迁移文件:', files);

// 从单个模型生成迁移
const file = await migrationManager.generateMigrationFromModel(User);
console.log('已为User模型生成迁移文件:', file);
```

### 运行迁移

```typescript
// 执行所有待处理的迁移
const migratedFiles = await migrationManager.migrate();
console.log('已执行迁移:', migratedFiles);

// 回滚最后一批迁移
const rolledBackFiles = await migrationManager.rollback();
console.log('已回滚迁移:', rolledBackFiles);

// 回滚所有迁移
const resetFiles = await migrationManager.reset();
console.log('已重置所有迁移:', resetFiles);

// 查看迁移状态
const status = await migrationManager.status();
console.log('迁移状态:', status);
```

## 缓存系统

数据库模块内置了强大的缓存支持，可以缓存查询结果和模型实例，大幅提高应用性能。

### 缓存配置

缓存配置在数据库配置中通过`cache`选项指定：

```typescript
{
  // 其他数据库配置...
  cache: {
    // 是否启用缓存
    enabled: true,
    
    // 缓存键前缀
    prefix: 'db:',
    
    // 默认缓存时间（毫秒）
    ttl: 60000,
    
    // 查询缓存配置
    queries: {
      enabled: true,
      ttl: 30000
    },
    
    // 模型缓存配置
    models: {
      enabled: true,
      ttl: 60000
    }
  }
}
```

### 自动缓存

当缓存启用时，以下操作会自动使用缓存：

1. 通过ID查找模型实例：`Model.find(id)`
2. 获取第一条记录：`Model.query().first()`
3. 获取多条记录：`Model.query().get()`

### 手动控制缓存

您可以通过查询选项或`cache()`方法显式控制缓存行为：

```typescript
// 通过查询选项控制
const users = await User.query({ useCache: true, cacheTTL: 120000 }).get();

// 通过cache方法控制
const user = await User.query()
  .cache(true, 300000)
  .where('id', userId)
  .first();
```

### 缓存失效

当模型数据发生变化（插入、更新、删除）时，相关缓存会自动失效。

## 其他功能

- 软删除/恢复: `model.delete()`, `model.restore()`
- 事务支持: `db.transaction(async (trx) => { ... })`
- 生命周期钩子: `beforeCreate`, `afterSave`等

## 贡献

欢迎提交问题和PR到我们的Gitee仓库。 