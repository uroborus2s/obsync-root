# @stratix/icasync 需求分析文档

## 1. 项目概述

### 1.1 项目背景
@stratix/icasync 是 Stratix 框架的一个标准插件，用于将数据库中的课程数据同步到 WPS 协作平台的日历系统。该插件需要处理复杂的数据转换、同步状态管理和任务调度。

### 1.2 项目目标
- 实现课程数据的全量同步和增量同步
- 提供用户数据的统一管理和同步
- 建立可靠的任务管理和监控机制
- 确保数据同步的一致性和完整性

### 1.3 技术要求
- 基于 Stratix 框架的插件开发规范
- 采用函数式编程模式
- 集成 @stratix/tasks 任务管理系统
- 集成 @stratix/was-v7 WPS API 适配器
- 支持依赖注入和生命周期管理

## 2. 业务需求分析

### 2.1 数据源分析

#### 2.1.1 原始课程表 (u_jw_kcb_cur)
- **用途**：存储课程的原始数据
- **关键字段**：
  - `kkh`：开课号（课程唯一标识）
  - `xnxq`：学年学期
  - `jxz`：教学周
  - `zc`：周次（星期）
  - `jc`：节次
  - `room`：教室
  - `ghs`：教师工号组
  - `xms`：教师姓名组
  - `kcmc`：课程名称
  - `zt`：来源库状态标识（add、update、delete）
  - `gx_zt`：目标库更新状态

#### 2.1.2 聚合任务表 (juhe_renwu)
- **用途**：由原始课程表聚合而来，每条记录对应一个日程
- **关键字段**：
  - `id`：聚合任务ID
  - `kkh`：开课号
  - `rq`：日期
  - `jc_s`：节次合并
  - `room_s`：教室合并
  - `gh_s`：教师工号组
  - `xm_s`：教师姓名组
  - `sj_f`：开始时间
  - `sj_t`：结束时间
  - `gx_zt`：更新状态（0未处理，1教师日历已推送，2学生日历已推送，3软删除未处理，4软删除处理完毕）

#### 2.1.3 学生课程关联表 (out_jw_kcb_xs)
- **用途**：建立学生与课程的关联关系
- **关键字段**：
  - `kkh`：开课号
  - `xh`：学生编号
  - `xnxq`：学年学期

#### 2.1.4 用户信息表
- **学生信息表 (out_xsxx)**：学生基本信息
- **教师信息表 (out_jsxx)**：教师基本信息

### 2.2 同步业务流程

#### 2.2.1 全量同步流程
1. **数据聚合**：根据学期信息从 `u_jw_kcb_cur` 获取所有课程数据，聚合到 `juhe_renwu` 表
2. **日历创建**：为每个课程（kkh）创建对应的 WPS 日历
3. **参与者管理**：通过教学班信息和授课教师组成日历参与者
4. **日程同步**：将 `juhe_renwu` 的每条记录同步为 WPS 日程
5. **状态更新**：更新同步状态标识

#### 2.2.2 增量同步流程
1. **变更检测**：通过 `gx_sj` 和 `gx_zt` 字段获取未处理的增量数据
2. **删除处理**：软删除变化课程的 `juhe_renwu` 记录，调用 WPS API 删除对应日程
3. **数据重聚合**：根据 add 和 update 类型的数据重新聚合并添加到 `juhe_renwu`
4. **同步更新**：将新的聚合数据同步到 WPS 日历
5. **状态维护**：更新相关表的同步状态

#### 2.2.3 用户同步流程
1. **数据整合**：整合 `out_xsxx` 和 `out_jsxx` 创建统一用户视图
2. **变更检测**：根据用户表的状态字段检测用户变更
3. **参与者更新**：修改用户所属教学班时，更新日历参与者
4. **权限管理**：维护用户在日历中的权限设置

## 3. 功能需求

### 3.1 核心功能

#### 3.1.1 数据同步功能
- **全量同步**：支持指定学期的完整数据同步
- **增量同步**：支持基于变更检测的增量数据同步
- **用户同步**：支持用户信息的同步和参与者管理
- **状态管理**：完整的同步状态跟踪和管理

#### 3.1.2 任务管理功能
- **任务调度**：基于 @stratix/tasks 的任务树管理
- **进度监控**：实时任务执行进度跟踪
- **错误处理**：任务失败重试和错误恢复
- **并发控制**：防止多个同步任务并发执行

#### 3.1.3 数据管理功能
- **映射管理**：维护课程与日历、日程的映射关系
- **数据验证**：确保数据的完整性和一致性
- **缓存机制**：提高数据访问性能
- **清理机制**：定期清理过期和无效数据

### 3.2 API 接口功能

#### 3.2.1 同步控制接口
- 启动全量同步
- 启动增量同步
- 查询同步状态
- 取消同步任务

#### 3.2.2 任务管理接口
- 查询任务列表
- 获取任务详情
- 监控任务进度
- 重试失败任务

#### 3.2.3 数据查询接口
- 查询日历列表
- 查询日程信息
- 查询用户信息
- 查询同步统计

#### 3.2.4 监控报告接口
- 系统健康检查
- 同步统计报告
- 性能指标查询
- 错误日志查询

## 4. 非功能需求

### 4.1 性能需求
- **吞吐量**：支持每小时处理 10,000+ 课程记录
- **响应时间**：API 响应时间 < 2 秒
- **并发性**：支持 100+ 并发 API 请求
- **可扩展性**：支持水平扩展和负载均衡

### 4.2 可靠性需求
- **可用性**：系统可用性 ≥ 99.9%
- **数据一致性**：确保同步数据的强一致性
- **容错性**：支持网络中断和服务故障恢复
- **备份恢复**：支持数据备份和灾难恢复

### 4.3 安全性需求
- **访问控制**：基于角色的权限管理
- **数据加密**：敏感数据传输和存储加密
- **审计日志**：完整的操作审计日志
- **防护机制**：防止 SQL 注入和 XSS 攻击

### 4.4 可维护性需求
- **代码质量**：遵循编码规范和最佳实践
- **文档完整**：提供完整的技术文档
- **测试覆盖**：单元测试覆盖率 ≥ 80%
- **监控告警**：完善的监控和告警机制

## 5. 约束条件

### 5.1 技术约束
- 必须基于 Stratix 框架开发
- 必须使用 TypeScript 和函数式编程
- 必须集成现有的 @stratix/tasks 和 @stratix/was-v7 库
- 必须支持 MySQL 5.7+ 数据库

### 5.2 业务约束
- 同步过程不能影响原始数据表
- 必须保持与现有系统的兼容性
- 必须支持大量数据的批量处理
- 必须提供详细的同步日志和报告

### 5.3 环境约束
- 支持 Node.js 22+ 运行环境
- 支持容器化部署
- 支持集群和分布式部署
- 兼容主流云平台

## 6. 验收标准

### 6.1 功能验收
- 全量同步功能正常，数据准确率 100%
- 增量同步功能正常，变更检测准确
- 用户同步功能正常，权限管理正确
- API 接口功能完整，响应格式标准

### 6.2 性能验收
- 全量同步 10,000 条记录 < 30 分钟
- 增量同步 1,000 条变更 < 5 分钟
- API 响应时间 < 2 秒
- 系统资源占用合理

### 6.3 质量验收
- 代码质量检查通过
- 单元测试覆盖率 ≥ 80%
- 集成测试通过
- 性能测试通过

### 6.4 文档验收
- 技术文档完整准确
- API 文档详细清晰
- 部署文档可操作
- 用户手册易理解
