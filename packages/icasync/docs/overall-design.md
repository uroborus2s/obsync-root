# @stratix/icasync 总体设计文档

## 1. 项目概述

### 1.1 项目简介
@stratix/icasync 是基于 Stratix 框架开发的课表同步插件，用于将数据库中的课程数据同步到 WPS 协作平台的日历系统。该插件采用现代化的函数式编程范式，提供高性能、高可靠性的数据同步解决方案。

### 1.2 核心特性
- **函数式编程**：完全采用函数式编程范式，确保代码的可预测性和可测试性
- **插件化架构**：符合 Stratix 框架的插件开发规范，支持热插拔和模块化部署
- **任务管理**：基于 @stratix/tasks 的强大任务管理系统，支持复杂的任务编排和监控
- **外部集成**：深度集成 @stratix/was-v7，提供完整的 WPS API 调用能力
- **数据一致性**：确保同步过程中数据的强一致性和完整性
- **高性能**：支持大规模数据的批量处理和并发操作
- **可观测性**：完整的监控、日志和报告系统

### 1.3 技术栈
- **框架**：Stratix Framework (Fastify 5 + Awilix 12)
- **语言**：TypeScript 5.0+
- **数据库**：MySQL 5.7+ (Kysely 查询构建器)
- **任务管理**：@stratix/tasks
- **外部集成**：@stratix/was-v7 (WPS API)
- **工具库**：@stratix/utils

## 2. 业务场景

### 2.1 核心业务流程

#### 全量同步场景
- **触发条件**：新学期开始或数据重置
- **处理范围**：指定学期的所有课程数据
- **执行频率**：按需执行，通常每学期1-2次
- **数据量级**：10,000+ 课程记录，50,000+ 日程记录

#### 增量同步场景
- **触发条件**：课程数据发生变更
- **处理范围**：变更的课程数据
- **执行频率**：定时执行，通常每小时或每天
- **数据量级**：100-1,000 变更记录

#### 用户同步场景
- **触发条件**：用户信息变更或权限调整
- **处理范围**：变更的用户数据和权限
- **执行频率**：定时执行，通常每天
- **数据量级**：100-500 用户变更

### 2.2 数据流转

```
原始数据源 → 数据聚合 → 格式转换 → WPS API → 状态更新
     ↓           ↓          ↓         ↓         ↓
u_jw_kcb_cur → juhe_renwu → WPS格式 → 日历/日程 → 映射表
```

## 3. 架构设计

### 3.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                    @stratix/icasync                         │
├─────────────────────────────────────────────────────────────┤
│  API Layer (接口层)                                         │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐  │
│  │ 同步管理API │ 任务管理API │ 数据查询API │ 监控报告API │  │
│  └─────────────┴─────────────┴─────────────┴─────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  Business Layer (业务层)                                    │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐  │
│  │ 课程同步    │ 用户同步    │ 任务管理    │ 数据验证    │  │
│  │ 日历管理    │ 日程管理    │ 监控报告    │ 事件总线    │  │
│  └─────────────┴─────────────┴─────────────┴─────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  Integration Layer (集成层)                                 │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐  │
│  │ WPS日历适配 │ WPS日程适配 │ 任务适配    │ 数据转换    │  │
│  │ 缓存适配    │ 监控适配    │ 通知适配    │ 日志适配    │  │
│  └─────────────┴─────────────┴─────────────┴─────────────┘  │
├─────────────────────────────────────────────────────────────┤
│  Data Layer (数据层)                                        │
│  ┌─────────────┬─────────────┬─────────────┬─────────────┐  │
│  │ 原始数据仓库│ 同步数据仓库│ 映射数据仓库│ 任务数据仓库│  │
│  │ 用户数据仓库│ 日志数据仓库│ 缓存数据仓库│ 配置数据仓库│  │
│  └─────────────┴─────────────┴─────────────┴─────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 核心组件

#### 控制器层 (Controller Layer)
- **SyncController**：同步操作控制器
- **TaskController**：任务管理控制器
- **CalendarController**：日历管理控制器
- **MonitoringController**：监控报告控制器

#### 服务层 (Service Layer)
- **CourseSyncService**：课程同步业务逻辑
- **UserSyncService**：用户同步业务逻辑
- **TaskManagementService**：任务管理业务逻辑
- **MonitoringService**：监控报告业务逻辑

#### 适配器层 (Adapter Layer)
- **WpsCalendarAdapter**：WPS 日历 API 适配器
- **WpsScheduleAdapter**：WPS 日程 API 适配器
- **TaskManagementAdapter**：任务管理适配器
- **DataTransformAdapter**：数据转换适配器

#### 仓库层 (Repository Layer)
- **CourseRepository**：课程数据仓库
- **UserRepository**：用户数据仓库
- **SyncRepository**：同步数据仓库
- **TaskRepository**：任务数据仓库

## 4. 数据模型

### 4.1 核心数据表

#### 同步映射表
- **icasync_calendar_mapping**：课程与日历的映射关系
- **icasync_schedule_mapping**：聚合任务与日程的映射关系
- **icasync_calendar_participants**：日历参与者关系

#### 用户管理表
- **icasync_user_view**：统一用户视图
- **icasync_sync_tasks**：同步任务记录

### 4.2 数据关系

```
u_jw_kcb_cur (原始课程) 1:N juhe_renwu (聚合任务)
juhe_renwu 1:1 icasync_schedule_mapping (日程映射)
kkh (开课号) 1:1 icasync_calendar_mapping (日历映射)
icasync_calendar_mapping 1:N icasync_calendar_participants (参与者)
out_xsxx + out_jsxx → icasync_user_view (用户视图)
```

## 5. 任务管理

### 5.1 任务树结构

#### 全量同步任务树
```
全量同步 (Root)
├── 数据准备 (验证参数、检查连接、清理数据)
├── 数据聚合 (提取、聚合、验证)
├── 用户同步 (学生、教师、视图构建)
├── 日历创建 (创建、权限、参与者)
├── 日程同步 (创建、参与者、验证)
└── 完成清理 (状态更新、报告、清理)
```

#### 增量同步任务树
```
增量同步 (Root)
├── 变更检测 (课程变更、用户变更、影响分析)
├── 删除处理 (删除日程、移除参与者、软删除)
├── 更新处理 (重新聚合、更新日历、更新日程)
├── 新增处理 (创建日历、添加日程、设置权限)
└── 状态更新 (更新状态、记录日志、发送通知)
```

### 5.2 任务处理器

- **DataValidatorProcessor**：数据验证处理器
- **DataAggregatorProcessor**：数据聚合处理器
- **CalendarCreatorProcessor**：日历创建处理器
- **ScheduleCreatorProcessor**：日程创建处理器
- **ParticipantManagerProcessor**：参与者管理处理器
- **StatusUpdaterProcessor**：状态更新处理器

## 6. API 设计

### 6.1 API 分类

#### 同步管理 API
- `POST /api/icasync/sync/full` - 启动全量同步
- `POST /api/icasync/sync/incremental` - 启动增量同步
- `GET /api/icasync/sync/status` - 查询同步状态
- `DELETE /api/icasync/sync/{taskId}` - 取消同步任务

#### 任务管理 API
- `GET /api/icasync/tasks` - 查询任务列表
- `GET /api/icasync/tasks/{taskId}` - 查询任务详情
- `GET /api/icasync/tasks/{taskId}/progress` - 查询任务进度
- `POST /api/icasync/tasks/{taskId}/retry` - 重试失败任务

#### 数据查询 API
- `GET /api/icasync/calendars` - 查询日历列表
- `GET /api/icasync/schedules` - 查询日程列表
- `GET /api/icasync/users` - 查询用户列表

#### 监控报告 API
- `GET /api/icasync/health` - 系统健康检查
- `GET /api/icasync/statistics` - 同步统计报告
- `GET /api/icasync/metrics` - 性能指标查询

### 6.2 统一响应格式

```typescript
interface ApiResponse<T> {
  success: boolean;
  data?: T;
  error?: {
    code: string;
    message: string;
    details?: any;
  };
  timestamp: string;
  requestId: string;
}
```

## 7. 性能优化

### 7.1 批量处理策略
- **数据聚合**：批量处理原始课程数据
- **API 调用**：批量创建日历和日程
- **状态更新**：批量更新同步状态

### 7.2 缓存策略
- **用户映射缓存**：缓存用户ID映射关系
- **日历信息缓存**：缓存日历基本信息
- **配置信息缓存**：缓存系统配置信息

### 7.3 并发控制
- **全局锁**：防止多个同步任务并发执行
- **任务树锁**：任务树级别的互斥控制
- **资源锁**：共享资源的访问控制

## 8. 错误处理

### 8.1 错误分类
- **ValidationError**：参数验证错误
- **BusinessLogicError**：业务逻辑错误
- **ExternalServiceError**：外部服务错误
- **TaskExecutionError**：任务执行错误
- **SystemError**：系统错误

### 8.2 错误处理策略
- **自动重试**：网络错误和临时故障
- **人工干预**：业务逻辑错误和数据冲突
- **系统告警**：严重错误和系统故障
- **数据恢复**：支持断点续传和数据回滚

## 9. 监控和观测

### 9.1 监控指标
- **业务指标**：同步成功率、数据准确率、任务完成时间
- **性能指标**：API 响应时间、数据库查询时间、外部 API 调用时间
- **系统指标**：CPU 使用率、内存使用率、网络 I/O
- **错误指标**：错误率、错误类型分布、错误恢复时间

### 9.2 日志系统
- **业务日志**：同步操作日志、任务执行日志、数据变更日志
- **系统日志**：应用启动日志、错误异常日志、性能监控日志
- **审计日志**：用户操作日志、权限变更日志、配置修改日志

## 10. 部署和运维

### 10.1 部署架构
- **单机部署**：适用于开发和测试环境
- **集群部署**：适用于生产环境，支持负载均衡和故障转移
- **容器化部署**：支持 Docker 和 Kubernetes

### 10.2 配置管理
- **环境配置**：支持多环境配置管理
- **敏感信息**：支持配置加密和安全存储
- **动态配置**：支持运行时配置更新

### 10.3 运维工具
- **健康检查**：提供完整的健康检查接口
- **性能监控**：集成监控系统和告警机制
- **日志收集**：支持集中化日志收集和分析

## 11. 安全性

### 11.1 访问控制
- **身份认证**：支持 JWT Token 和 API Key 认证
- **权限控制**：基于角色的权限管理
- **接口保护**：防止恶意请求和 DDoS 攻击

### 11.2 数据安全
- **传输加密**：HTTPS 传输加密
- **存储加密**：敏感数据存储加密
- **数据脱敏**：日志中的敏感信息脱敏

### 11.3 审计合规
- **操作审计**：完整的操作审计日志
- **数据追踪**：数据变更的完整追踪
- **合规检查**：符合相关法规要求

## 12. 扩展性

### 12.1 水平扩展
- **多实例部署**：支持多实例负载均衡
- **数据分片**：支持大规模数据的分片处理
- **服务拆分**：支持微服务架构演进

### 12.2 功能扩展
- **插件机制**：支持功能插件扩展
- **适配器扩展**：支持新的外部系统集成
- **处理器扩展**：支持自定义任务处理器

### 12.3 技术演进
- **版本兼容**：向后兼容的版本升级
- **技术栈升级**：支持技术栈的平滑升级
- **架构演进**：支持架构的渐进式演进
