# å·¥ä½œæµå®šä¹‰è¿ç§»æŒ‡å— v3.0.0-enhanced

## æ¦‚è¿°

æœ¬æ–‡æ¡£æè¿°äº†ä»åŸæœ‰å·¥ä½œæµå®šä¹‰è¿ç§»åˆ°åŸºäºStratix Tasks v3.0.0-enhancedæ¶æ„çš„æ–°å·¥ä½œæµå®šä¹‰çš„è¯¦ç»†æ­¥éª¤å’Œä¸»è¦å˜æ›´ã€‚

## ä¸»è¦å˜æ›´

### 1. èŠ‚ç‚¹ç±»å‹å˜æ›´ âœ…

**å˜æ›´å†…å®¹**ï¼š
- åŸæœ‰çš„ `"type": "task"` èŠ‚ç‚¹ç±»å‹å·²æ›´æ”¹ä¸º `"type": "simple"`
- å…¶ä»–èŠ‚ç‚¹ç±»å‹ä¿æŒä¸å˜ï¼š`loop`, `subprocess`, `parallel`

**å½±å“èŒƒå›´**ï¼š
- æ‰€æœ‰ä»»åŠ¡æ‰§è¡ŒèŠ‚ç‚¹
- å­å·¥ä½œæµä¸­çš„ä»»åŠ¡èŠ‚ç‚¹

**è¿ç§»æ“ä½œ**ï¼š
```json
// æ—§æ ¼å¼
{
    "id": "data-aggregation",
    "name": "æ•°æ®èšåˆå‡†å¤‡",
    "type": "task",
    "executor": "dataAggregationProcessor"
}

// æ–°æ ¼å¼
{
    "id": "data-aggregation", 
    "name": "æ•°æ®èšåˆå‡†å¤‡",
    "type": "simple",
    "executor": "dataAggregationProcessor"
}
```

### 2. ç‰ˆæœ¬å·æ›´æ–° âœ…

**å˜æ›´å†…å®¹**ï¼š
- ä¸»å·¥ä½œæµç‰ˆæœ¬ï¼š`3.0.0` â†’ `3.0.0-enhanced`
- å­å·¥ä½œæµç‰ˆæœ¬ï¼š`3.0.0` â†’ `3.0.0-enhanced`

**å½±å“èŒƒå›´**ï¼š
- å·¥ä½œæµå®šä¹‰JSONä¸­çš„versionå­—æ®µ
- å­å·¥ä½œæµå¼•ç”¨ä¸­çš„versionå­—æ®µ
- SQLéªŒè¯æŸ¥è¯¢ä¸­çš„ç‰ˆæœ¬è¿‡æ»¤æ¡ä»¶

### 3. æ–°å¢å¢å¼ºåŠŸèƒ½é…ç½® âœ…

**å˜æ›´å†…å®¹**ï¼š
- æ·»åŠ äº†è‡ªåŠ¨é”ç»­æœŸé…ç½®
- æ·»åŠ äº†å®šæ—¶ä»»åŠ¡è°ƒåº¦å™¨é…ç½®
- å¢å¼ºäº†ç›‘æ§å’Œæ¢å¤æœºåˆ¶

**æ–°å¢é…ç½®**ï¼š
```json
{
    "config": {
        "lockRenewal": {
            "enabled": true,
            "renewalInterval": 60000,
            "lockExtension": 300000,
            "maxRetryAttempts": 3
        },
        "scheduler": {
            "enabled": true,
            "defaultTimezone": "Asia/Shanghai",
            "maxConcurrency": 10
        }
    }
}
```

### 4. æ•°æ®åº“è¡¨ç»“æ„å…¼å®¹æ€§ âœ…

**å˜æ›´å†…å®¹**ï¼š
- ç¡®ä¿ä¸æ–°çš„workflow_definitionsè¡¨ç»“æ„å…¼å®¹
- æ”¯æŒæ–°çš„å­—æ®µå¦‚external_id, instance_type, business_keyç­‰
- ä¿æŒå‘åå…¼å®¹æ€§

## æ–°å¢åŠŸèƒ½

### 1. å®šæ—¶ä»»åŠ¡æ”¯æŒ ğŸ†•

**åŠŸèƒ½æè¿°**ï¼š
- æ”¯æŒåŸºäºCronè¡¨è¾¾å¼çš„å®šæ—¶æ‰§è¡Œ
- æ”¯æŒæ—¶åŒºé…ç½®
- æ”¯æŒè‡ªåŠ¨é”ç»­æœŸæœºåˆ¶

**é…ç½®ç¤ºä¾‹**ï¼š
```sql
INSERT INTO workflow_schedules (
    name,
    workflow_definition_id,
    cron_expression,
    timezone,
    enabled,
    input_data,
    business_key,
    mutex_key
) VALUES (
    'daily-full-sync-schedule',
    (SELECT id FROM workflow_definitions WHERE name = 'full-sync-multi-loop-workflow'),
    '0 2 * * *',  -- æ¯å¤©å‡Œæ™¨2ç‚¹
    'Asia/Shanghai',
    true,
    JSON_OBJECT('xnxq', '2024-2025-1', 'forceSync', false),
    'daily-full-sync',
    'full-sync-workflow'
);
```

### 2. è‡ªåŠ¨é”ç»­æœŸ ğŸ†•

**åŠŸèƒ½æè¿°**ï¼š
- é•¿æ—¶é—´è¿è¡Œçš„å·¥ä½œæµè‡ªåŠ¨ç»­æœŸæ‰§è¡Œé”
- é˜²æ­¢é”è¶…æ—¶å¯¼è‡´çš„ä»»åŠ¡ä¸­æ–­
- å¯é…ç½®ç»­æœŸé—´éš”å’Œæœ€å¤§é‡è¯•æ¬¡æ•°

### 3. å¢å¼ºç›‘æ§ ğŸ†•

**åŠŸèƒ½æè¿°**ï¼š
- æ›´è¯¦ç»†çš„æ‰§è¡Œç»Ÿè®¡
- è‡ªå®šä¹‰æŒ‡æ ‡æ”¶é›†
- å®æ—¶çŠ¶æ€ç›‘æ§

## è¿ç§»æ­¥éª¤

### æ­¥éª¤1ï¼šå¤‡ä»½ç°æœ‰æ•°æ®
```sql
-- å¤‡ä»½ç°æœ‰å·¥ä½œæµå®šä¹‰
CREATE TABLE workflow_definitions_backup_v3 AS 
SELECT * FROM workflow_definitions 
WHERE name IN ('full-sync-multi-loop-workflow', 'calendar-group-sync-workflow');
```

### æ­¥éª¤2ï¼šæ‰§è¡Œè¿ç§»è„šæœ¬
```bash
# æ‰§è¡Œæ–°çš„éƒ¨ç½²è„šæœ¬
mysql -u username -p database_name < deploy-workflow-definition-v3.0.0.sql
```

### æ­¥éª¤3ï¼šéªŒè¯è¿ç§»ç»“æœ
```sql
-- éªŒè¯å·¥ä½œæµå®šä¹‰
SELECT name, version, status, is_active 
FROM workflow_definitions 
WHERE version = '3.0.0-enhanced';

-- éªŒè¯èŠ‚ç‚¹ç±»å‹
SELECT name, version,
    JSON_SEARCH(definition, 'all', 'simple') as has_simple_nodes,
    JSON_SEARCH(definition, 'all', 'task') as has_old_task_nodes
FROM workflow_definitions 
WHERE version = '3.0.0-enhanced';
```

### æ­¥éª¤4ï¼šé…ç½®å®šæ—¶ä»»åŠ¡ï¼ˆå¯é€‰ï¼‰
```sql
-- æ ¹æ®ä¸šåŠ¡éœ€æ±‚é…ç½®å®šæ—¶ä»»åŠ¡
-- å‚è€ƒdeploy-workflow-definition-v3.0.0.sqlä¸­çš„ç¤ºä¾‹
```

## å…¼å®¹æ€§è¯´æ˜

### å‘åå…¼å®¹æ€§ âœ…
- ç°æœ‰çš„å·¥ä½œæµå®ä¾‹å¯ä»¥ç»§ç»­è¿è¡Œ
- æ—§ç‰ˆæœ¬çš„å·¥ä½œæµå®šä¹‰ä»ç„¶æœ‰æ•ˆ
- æ–°æ—§ç‰ˆæœ¬å¯ä»¥å¹¶å­˜

### æ‰§è¡Œå™¨å…¼å®¹æ€§ âœ…
- æ‰€æœ‰ç°æœ‰çš„æ‰§è¡Œå™¨æ— éœ€ä¿®æ”¹
- æ‰§è¡Œå™¨æ¥å£ä¿æŒä¸å˜
- é…ç½®å‚æ•°æ ¼å¼ä¿æŒä¸€è‡´

### APIå…¼å®¹æ€§ âœ…
- å·¥ä½œæµå¯åŠ¨APIä¿æŒä¸å˜
- çŠ¶æ€æŸ¥è¯¢APIä¿æŒä¸å˜
- æ–°å¢äº†å®šæ—¶ä»»åŠ¡ç®¡ç†API

## æ³¨æ„äº‹é¡¹

### 1. ç‰ˆæœ¬ç®¡ç†
- å»ºè®®ä¿ç•™æ—§ç‰ˆæœ¬ä½œä¸ºå¤‡ä»½
- æ–°ç‰ˆæœ¬éƒ¨ç½²åï¼Œé€æ­¥åˆ‡æ¢åˆ°æ–°ç‰ˆæœ¬
- ç›‘æ§æ–°ç‰ˆæœ¬çš„è¿è¡ŒçŠ¶æ€

### 2. æ€§èƒ½å½±å“
- æ–°å¢çš„ç›‘æ§åŠŸèƒ½å¯èƒ½ç•¥å¾®å¢åŠ èµ„æºæ¶ˆè€—
- è‡ªåŠ¨é”ç»­æœŸä¼šäº§ç”Ÿé¢å¤–çš„æ•°æ®åº“æ“ä½œ
- å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒå……åˆ†éªŒè¯

### 3. é…ç½®è°ƒä¼˜
- æ ¹æ®å®é™…è´Ÿè½½è°ƒæ•´å¹¶å‘å‚æ•°
- æ ¹æ®ä»»åŠ¡æ‰§è¡Œæ—¶é—´è°ƒæ•´é”ç»­æœŸé—´éš”
- æ ¹æ®ä¸šåŠ¡éœ€æ±‚é…ç½®å®šæ—¶ä»»åŠ¡

## æ•…éšœæ’é™¤

### å¸¸è§é—®é¢˜

1. **èŠ‚ç‚¹ç±»å‹é”™è¯¯**
   - ç—‡çŠ¶ï¼šå·¥ä½œæµå¯åŠ¨å¤±è´¥ï¼Œæç¤ºæœªçŸ¥èŠ‚ç‚¹ç±»å‹
   - è§£å†³ï¼šæ£€æŸ¥æ˜¯å¦è¿˜æœ‰é—æ¼çš„"task"ç±»å‹èŠ‚ç‚¹

2. **ç‰ˆæœ¬ä¸åŒ¹é…**
   - ç—‡çŠ¶ï¼šå­å·¥ä½œæµæ— æ³•æ‰¾åˆ°
   - è§£å†³ï¼šç¡®ä¿ä¸»å·¥ä½œæµå’Œå­å·¥ä½œæµç‰ˆæœ¬å·ä¸€è‡´

3. **å®šæ—¶ä»»åŠ¡ä¸æ‰§è¡Œ**
   - ç—‡çŠ¶ï¼šå®šæ—¶ä»»åŠ¡åˆ›å»ºæˆåŠŸä½†ä¸æ‰§è¡Œ
   - è§£å†³ï¼šæ£€æŸ¥SchedulerServiceæ˜¯å¦å¯åŠ¨ï¼Œæ£€æŸ¥Cronè¡¨è¾¾å¼æ ¼å¼

### å›æ»šæ–¹æ¡ˆ

å¦‚æœè¿ç§»åå‡ºç°é—®é¢˜ï¼Œå¯ä»¥æŒ‰ä»¥ä¸‹æ­¥éª¤å›æ»šï¼š

```sql
-- 1. åœç”¨æ–°ç‰ˆæœ¬
UPDATE workflow_definitions 
SET is_active = false 
WHERE version = '3.0.0-enhanced';

-- 2. æ¿€æ´»æ—§ç‰ˆæœ¬
UPDATE workflow_definitions 
SET is_active = true 
WHERE version = '3.0.0';

-- 3. æ¸…ç†å®šæ—¶ä»»åŠ¡ï¼ˆå¦‚æœæœ‰ï¼‰
DELETE FROM workflow_schedules 
WHERE workflow_definition_id IN (
    SELECT id FROM workflow_definitions WHERE version = '3.0.0-enhanced'
);
```

## è”ç³»æ”¯æŒ

å¦‚æœåœ¨è¿ç§»è¿‡ç¨‹ä¸­é‡åˆ°é—®é¢˜ï¼Œè¯·è”ç³»æŠ€æœ¯æ”¯æŒå›¢é˜Ÿæˆ–æŸ¥é˜…ç›¸å…³æ–‡æ¡£ï¼š
- Stratixæ¡†æ¶æ–‡æ¡£
- TasksåŒ…v3.0.0-enhancedæ–‡æ¡£
- å·¥ä½œæµå¼•æ“ä½¿ç”¨æŒ‡å—
